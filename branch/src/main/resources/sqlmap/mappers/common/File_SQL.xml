<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.common.impl.FileMapper">


    <select id="selectFileGroupKey" resultType="int">
        SELECT SYS0070M_ATCH_FILE_GRP_ID_SEQ.NEXTVAL FROM DUAL
    </select>

    <insert id="insertFileGroup" parameterType="fileGroupVO">
        INSERT INTO SYS0070M (
        ATCH_FILE_GRP_ID
        , ATCH_FILE_ID
        , CHENAL_TYPE
        , CRT_USER_ID
        , CRT_DT
        , UPD_USER_ID
        , UPD_DT
        )VALUES (
        #{atchFileGrpId}
        ,#{atchFileId}
        ,#{chenalType}
        ,#{crtUserId}
        ,SYSDATE
        ,#{crtUserId}
        ,SYSDATE
        )
    </insert>

    <insert id="insertFileDetail" parameterType="fileVO">

        <selectKey keyProperty="atchFileId" resultType="int" order="BEFORE">
            SELECT SYS0071D_ATCH_FILE_ID_SEQ.NEXTVAL atchFileId
            FROM DUAL
        </selectKey>

        INSERT INTO SYS0071D (
        ATCH_FILE_ID
        , ATCH_FILE_NAME
        , FILE_SUB_PATH
        , PHYSICL_FILE_NAME
        , FILE_EXTSN
        , FILE_SIZE
        , FILE_PASSWORD
        )VALUES (
        #{atchFileId}
        ,#{atchFileName}
        ,#{fileSubPath}
        ,#{physiclFileName}
        ,#{fileExtsn}
        ,#{fileSize}
        ,#{filePassword}
        )
    </insert>

    <select id="selectFilesByGroupId" parameterType="int" resultType="fileVO">
        SELECT FILEDTL.ATCH_FILE_ID AS atchFileId
              ,FILEDTL.ATCH_FILE_NAME AS atchFileName
              ,FILEDTL.FILE_SUB_PATH AS fileSubPath
              ,FILEDTL.PHYSICL_FILE_NAME AS physiclFileName
              ,FILEDTL.FILE_EXTSN AS fileExtsn
              ,FILEDTL.FILE_SIZE AS fileSize
              ,FILEDTL.FILE_PASSWORD AS filePassword
          FROM SYS0071D FILEDTL
         WHERE FILEDTL.ATCH_FILE_ID IN (SELECT FILEGROUP.ATCH_FILE_ID
                                          FROM SYS0070M FILEGROUP
                                         WHERE FILEGROUP.ATCH_FILE_GRP_ID = #{groupId})
    </select>

    <select id="selectFileByFileId" parameterType="int" resultType="fileVO">
        SELECT FILEDTL.ATCH_FILE_ID AS atchFileId
        ,FILEDTL.ATCH_FILE_NAME AS atchFileName
        ,FILEDTL.FILE_SUB_PATH AS fileSubPath
        ,FILEDTL.PHYSICL_FILE_NAME AS physiclFileName
        ,FILEDTL.FILE_EXTSN AS fileExtsn
        ,FILEDTL.FILE_SIZE AS fileSize
        ,FILEDTL.FILE_PASSWORD AS filePassword
        FROM SYS0071D FILEDTL
        WHERE FILEDTL.ATCH_FILE_ID  = #{fileId}
    </select>

    <delete id="deleteFileGroupByGroupId" parameterType="int">
        DELETE
        FROM SYS0070M
        WHERE ATCH_FILE_GRP_ID = #{fileGroupId}
    </delete>

    <delete id="deleteFileByGroupId" parameterType="int">
        DELETE
        FROM SYS0071D
        WHERE ATCH_FILE_ID IN (
            SELECT  ATCH_FILE_ID
              FROM SYS0070M
            WHERE ATCH_FILE_GRP_ID = #{fileGroupId}
        )
    </delete>

    <delete id="deleteFileGroupByFileId" parameterType="int">
        DELETE
        FROM SYS0070M
        WHERE ATCH_FILE_ID = #{fileId}
    </delete>

    <delete id="deleteFileByFileId" parameterType="int">
        DELETE
        FROM SYS0071D
        WHERE ATCH_FILE_ID = #{fileId}
    </delete>

    <select id="selectFileGroupCountByFileId" parameterType="int" resultType="int">
        SELECT COUNT(1) CNT
        FROM SYS0070M
        WHERE  ATCH_FILE_GRP_ID = (
            SELECT GRP.ATCH_FILE_GRP_ID
              FROM SYS0070M GRP
             WHERE GRP.ATCH_FILE_ID = #{fileId}
        )
    </select>

    <update id="updateFileDetail" parameterType="fileVO">
        UPDATE SYS0071D
        SET ATCH_FILE_NAME = #{atchFileName}
	        , FILE_SUB_PATH = #{fileSubPath}
	        , PHYSICL_FILE_NAME = #{physiclFileName}
	        , FILE_EXTSN = #{fileExtsn}
	        , FILE_SIZE = #{fileSize}
	        , FILE_PASSWORD = #{filePassword}
        WHERE ATCH_FILE_ID = #{atchFileId}
    </update>
</mapper>