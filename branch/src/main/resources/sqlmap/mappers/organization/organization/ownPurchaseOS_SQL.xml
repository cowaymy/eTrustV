<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.organization.organization.impl.OwnPurchaseOSMapper">

    <select id="getOrgDtls" parameterType="Map" resultType="egovMap">
        SELECT
            B.MEM_ID,
            B.MEM_CODE,
            C.LAST_ORG_CODE ORG_CODE,
            C.LAST_GRP_CODE GRP_CODE,
            C.LAST_DEPT_CODE DEPT_CODE
        FROM SYS0047M A
        JOIN ORG0001D B
            ON A.HR_CODE = B.MEM_CODE
        JOIN ORG0005D C
            ON B.MEM_ID = C.MEM_ID
        WHERE A.USER_ID = #{userId}
    </select>

    <select id="searchOwnPurchase" parameterType="Map" resultType="egovMap">
        SELECT
            A.SALES_ORD_ID,
            A.SALES_ORD_NO,
            C.MEM_CODE,
            C.NAME MEM_NAME,
            ROUND(NVL(F.OS, 0), 2) OS,
            D.LAST_ORG_CODE ORG_CODE,
            D.LAST_GRP_CODE GRP_CODE,
            D.LAST_DEPT_CODE DEPT_CODE
        FROM SAL0001D A
        JOIN SAL0029D B
            ON A.CUST_ID = B.CUST_ID
        JOIN ORG0001D C
            ON B.NRIC = C.NRIC
            AND C.STUS = 1
        JOIN ORG0005D D
            ON C.MEM_ID = D.MEM_ID
        LEFT JOIN (
            SELECT
                RENT_SO_ID,
                SUM(RENT_AMT) OS
            FROM PAY0022D
            GROUP BY RENT_SO_ID
        ) F
            ON A.SALES_ORD_ID = F.RENT_SO_ID
        JOIN SAL0071D G
            ON A.SALES_ORD_ID = G.SALES_ORD_ID
            AND g.STUS_CODE_ID NOT IN ('WOF', 'WOF_1')
        WHERE 1=1
        AND A.APP_TYPE_ID = 66
        <if test="staffOwnPurch == 'false'">
            AND D.LAST_ORG_CODE = #{orgCode}
        </if>
        <if test="groupCode != null and groupCode != ''">
            AND D.LAST_GRP_CODE = #{groupCode}
        </if>
        <if test="deptCode != null and deptCode != ''">
            AND D.LAST_DEPT_CODE = #{deptCode}
        </if>
        <if test="memCode != null and memCode != ''">
            AND C.MEM_CODE = #{memCode}
        </if>
        ORDER BY MEM_CODE
    </select>

</mapper>