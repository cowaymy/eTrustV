<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.scm.impl.SalesPlanMngementMapper">

<select id="selectStockCtgrySummary" parameterType="Map" resultType="egovMap">
WITH SALES_PLAN_SUMMARY
  AS
  (
    SELECT
          SYS26M.STK_TYPE_ID,SYS13M2.CODE_NAME STK_TYPE_NM,SYS13M.CODE CATEGORY ,SCM02D.STOCK_CODE CODE,SYS26M.STK_DESC NAME
          ,SCM02D.M0_PLAN ,SCM02D.M0_ORD ,SCM02D.M1 ,SCM02D.M2 ,SCM02D.M3 ,SCM02D.M4 ,SCM02D.M1_ORD ,SCM02D.M2_ORD
          ,SCM02D.M3_ORD ,SCM02D.M_3 ,SCM02D.M_2 ,SCM02D.M_1
          ,SCM02D.W00 ,SCM02D.W01 ,SCM02D.W02 ,SCM02D.W03 ,SCM02D.W04 ,SCM02D.W05 ,SCM02D.W06 ,SCM02D.W07 ,SCM02D.W08 ,SCM02D.W09 ,SCM02D.W10 ,SCM02D.W11 ,SCM02D.W12 ,SCM02D.W13 ,SCM02D.W14
          ,SCM02D.W15 ,SCM02D.W16 ,SCM02D.W17 ,SCM02D.W18 ,SCM02D.W19 ,SCM02D.W20 ,SCM02D.W21 ,SCM02D.W22 ,SCM02D.W23 ,SCM02D.W24 ,SCM02D.W25 ,SCM02D.W26 ,SCM02D.W27 ,SCM02D.W28 ,SCM02D.W29
          ,SCM02D.W30 ,SCM02D.WS1 ,SCM02D.WS2 ,SCM02D.WS3 ,SCM02D.WS4 ,SCM02D.WS5
          ,SCM02D.PRE_M3_AVG_ORDED ,SCM02D.PRE_M3_AVG_ISSU ,SCM02D.PLAN_YEAR SCM_YEAR ,SCM02D.PLAN_MONTH SCM_MONTH ,SCM02D.PLAN_WEEK SCM_WEEK_TH
    FROM SYS0026M SYS26M, SYS0013M SYS13M, SYS0013M SYS13M2,
        (SELECT SCM01M.PLAN_YEAR, SCM01M.PLAN_MONTH, SCM01M.PLAN_WEEK, SCM02D.STOCK_CODE, SCM02D.M1 ,SCM02D.M2 ,SCM02D.M3 ,SCM02D.M4
                ,SCM02D.W00 ,SCM02D.W01 ,SCM02D.W02 ,SCM02D.W03 ,SCM02D.W04 ,SCM02D.W05 ,SCM02D.W06 ,SCM02D.W07 ,SCM02D.W08 ,SCM02D.W09 ,SCM02D.W10 ,SCM02D.W11 ,SCM02D.W12 ,SCM02D.W13 ,SCM02D.W14
                ,SCM02D.W15 ,SCM02D.W16 ,SCM02D.W17 ,SCM02D.W18 ,SCM02D.W19 ,SCM02D.W20 ,SCM02D.W21 ,SCM02D.W22 ,SCM02D.W23 ,SCM02D.W24 ,SCM02D.W25 ,SCM02D.W26 ,SCM02D.W27 ,SCM02D.W28 ,SCM02D.W29
                ,SCM02D.W30 ,SCM02D.WS1 ,SCM02D.WS2 ,SCM02D.WS3 ,SCM02D.WS4 ,SCM02D.WS5, SUM(SCM02D.PRE_M3_AVG_ORDED) PRE_M3_AVG_ORDED ,SUM(SCM02D.PRE_M3_AVG_ISSU) PRE_M3_AVG_ISSU ,SUM(SCM02D.M1_ORD) M1_ORD ,SUM(SCM02D.M2_ORD) M2_ORD
                ,SUM(SCM02D.M3_ORD) M3_ORD ,SUM(SCM02D.M_3) M_3 ,SUM(SCM02D.M_2) M_2 ,SUM(SCM02D.M_1) M_1 ,SUM(SCM02D.M0_PLAN) M0_PLAN ,SUM(SCM02D.M0_ORD) M0_ORD
           FROM SCM0001M SCM01M, SCM0002D SCM02D
          WHERE SCM01M.PLAN_ID = SCM02D.PLAN_MASTER_ID
            AND SCM01M.PLAN_YEAR  = #{scmYearCbBox}
            <if test="selectPlanMonth != null and selectPlanMonth !=''">
             AND SCM01M.PLAN_MONTH = #{selectPlanMonth}
            </if>
            <if test="scmPeriodCbBox != null and scmPeriodCbBox !=''">
             AND SCM01M.PLAN_WEEK = #{scmPeriodCbBox}
            </if>
            <if test="scmTeamCbBox != null and scmTeamCbBox !=''">
             AND SCM01M.TEAM = #{scmTeamCbBox}
            </if>
            GROUP BY SCM01M.PLAN_YEAR, SCM01M.PLAN_MONTH, SCM01M.PLAN_WEEK, SCM02D.STOCK_CODE, SCM02D.M1 ,SCM02D.M2 ,SCM02D.M3 ,SCM02D.M4
                ,SCM02D.W00 ,SCM02D.W01 ,SCM02D.W02 ,SCM02D.W03 ,SCM02D.W04 ,SCM02D.W05 ,SCM02D.W06 ,SCM02D.W07 ,SCM02D.W08 ,SCM02D.W09 ,SCM02D.W10 ,SCM02D.W11 ,SCM02D.W12 ,SCM02D.W13 ,SCM02D.W14
                ,SCM02D.W15 ,SCM02D.W16 ,SCM02D.W17 ,SCM02D.W18 ,SCM02D.W19 ,SCM02D.W20 ,SCM02D.W21 ,SCM02D.W22 ,SCM02D.W23 ,SCM02D.W24 ,SCM02D.W25 ,SCM02D.W26 ,SCM02D.W27 ,SCM02D.W28 ,SCM02D.W29
                ,SCM02D.W30 ,SCM02D.WS1 ,SCM02D.WS2 ,SCM02D.WS3 ,SCM02D.WS4 ,SCM02D.WS5
            ) SCM02D
       WHERE SCM02D.STOCK_CODE  = SYS26M.STK_CODE
         AND SYS26M.STK_CTGRY_ID    = SYS13M.CODE_ID
         AND SYS26M.STK_TYPE_ID = SYS13M2.CODE_ID
         AND SYS13M2.code_master_id = '15'
  )
  SELECT
          SALES_PLAN_SUMMARY.SCM_YEAR
         , SALES_PLAN_SUMMARY.SCM_MONTH
         , SALES_PLAN_SUMMARY.SCM_WEEK_TH
         , SALES_PLAN_SUMMARY.STK_TYPE_NM STK_TYPE_ID
         , SALES_PLAN_SUMMARY.CATEGORY
         , ROUND(AVG(M_1 + M_2 + M_3)) ||'/'|| ROUND(AVG(M1_ORD + M2_ORD + M3_ORD)) M3_AVG_ISSUE_ORDER
         , ROUND(SUM(M_1)) ||'/'|| ROUND(SUM(M1_ORD)) M1_ISSUE_ORDER
         , ROUND(SUM(M0_PLAN)) ||'/'|| ROUND(SUM(M0_ORD)) M0_PLAN_ORDER
         , SUM(M1) M1
         , SUM(M2) M2
         , SUM(M3) M3
         , SUM(M4) M4
         , SUM(W00)  AS W00 ,SUM(W01)  AS W01 ,SUM(W02)  AS W02 ,SUM(W03)  AS W03 ,SUM(W04)  AS W04
         , SUM(W05)  AS W05 ,SUM(W06)  AS W06 ,SUM(W07)  AS W07 ,SUM(W08)  AS W08 ,SUM(W09)  AS W09
         , SUM(W10)  AS W10 ,SUM(W11)  AS W11 ,SUM(W12)  AS W12 ,SUM(W13)  AS W13 ,SUM(W14)  AS W14
         , SUM(W15)  AS W15 ,SUM(W16)  AS W16 ,SUM(W17)  AS W17 ,SUM(W18)  AS W18 ,SUM(W19)  AS W19
         , SUM(W20)  AS W20 ,SUM(W21)  AS W21 ,SUM(W22)  AS W22 ,SUM(W23)  AS W23 ,SUM(W24)  AS W24
         , SUM(W25)  AS W25 ,SUM(W26)  AS W26 ,SUM(W27)  AS W27 ,SUM(W28)  AS W28 ,SUM(W29)  AS W29 ,SUM(W30)  AS W30
         , ROUND(AVG(M1_ORD + M2_ORD + M3_ORD)) AS PRE_M3_AVG_ORDERED

    FROM SALES_PLAN_SUMMARY
   WHERE 1 = 1
     <choose>
      <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
       AND SALES_PLAN_SUMMARY.STK_TYPE_ID IN
          <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
              #{item}
          </foreach>
      </when>
    </choose>

    <choose>
      <when test='stkCategories != null and !stkCategories.isEmpty  '>
         AND SALES_PLAN_SUMMARY.CATEGORY IN (SELECT CODE FROM SYS0013M WHERE CODE_ID IN
            <foreach item="item" collection="stkCategories" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </when>
      </choose>

    GROUP BY SALES_PLAN_SUMMARY.SCM_YEAR ,SALES_PLAN_SUMMARY.SCM_MONTH
           , SALES_PLAN_SUMMARY.SCM_WEEK_TH, SALES_PLAN_SUMMARY.STK_TYPE_NM, SALES_PLAN_SUMMARY.CATEGORY
  ORDER BY SALES_PLAN_SUMMARY.CATEGORY
</select>

    <select id="selectCalendarHeader" parameterType="Map" resultType="egovMap">
			SELECT
             STOCK_PH1
            ,TEAM_H1
            ,PLAN_MASTER_ID_H
            ,CATEGORY_H1
            ,CODE_H1
            ,NAME_H1
            ,ISUUEORDER_H
            ,MONTHLY_PH2
            ,BEFORE_DAY_H2
            ,TODAY_H2
            ,M1_H2
            ,M2_H2
            ,M3_H3
            ,M4_H4
            ,SUPPLY_CORP_H_PSI
            ,SUPPLY_CORP_H_OVERDUE
            ,IS_SAVED
            ,DIV_ODD
            ,STK_TYPE_ID_H1
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W1_WEEK_SEQ ,1,5) ELSE SUBSTR(W1_WEEK_SEQ ,1,3) END) W1_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W2_WEEK_SEQ ,1,5) ELSE SUBSTR(W2_WEEK_SEQ ,1,3) END) W2_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W3_WEEK_SEQ ,1,5) ELSE SUBSTR(W3_WEEK_SEQ ,1,3) END) W3_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W4_WEEK_SEQ ,1,5) ELSE SUBSTR(W4_WEEK_SEQ ,1,3) END) W4_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W5_WEEK_SEQ ,1,5) ELSE SUBSTR(W5_WEEK_SEQ ,1,3) END) W5_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W6_WEEK_SEQ ,1,5) ELSE SUBSTR(W6_WEEK_SEQ ,1,3) END) W6_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W7_WEEK_SEQ ,1,5) ELSE SUBSTR(W7_WEEK_SEQ ,1,3) END) W7_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W8_WEEK_SEQ ,1,5) ELSE SUBSTR(W8_WEEK_SEQ ,1,3) END) W8_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W9_WEEK_SEQ ,1,5) ELSE SUBSTR(W9_WEEK_SEQ ,1,3) END) W9_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W10_WEEK_SEQ,1,5) ELSE SUBSTR(W10_WEEK_SEQ,1,3) END) W10_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W11_WEEK_SEQ,1,5) ELSE SUBSTR(W11_WEEK_SEQ,1,3) END) W11_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W12_WEEK_SEQ,1,5) ELSE SUBSTR(W12_WEEK_SEQ,1,3) END) W12_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W13_WEEK_SEQ,1,5) ELSE SUBSTR(W13_WEEK_SEQ,1,3) END) W13_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W14_WEEK_SEQ,1,5) ELSE SUBSTR(W14_WEEK_SEQ,1,3) END) W14_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W15_WEEK_SEQ,1,5) ELSE SUBSTR(W15_WEEK_SEQ,1,3) END) W15_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W16_WEEK_SEQ,1,5) ELSE SUBSTR(W16_WEEK_SEQ,1,3) END) W16_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W17_WEEK_SEQ,1,5) ELSE SUBSTR(W17_WEEK_SEQ,1,3) END) W17_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W18_WEEK_SEQ,1,5) ELSE SUBSTR(W18_WEEK_SEQ,1,3) END) W18_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W19_WEEK_SEQ,1,5) ELSE SUBSTR(W19_WEEK_SEQ,1,3) END) W19_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W20_WEEK_SEQ,1,5) ELSE SUBSTR(W20_WEEK_SEQ,1,3) END) W20_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W21_WEEK_SEQ,1,5) ELSE SUBSTR(W21_WEEK_SEQ,1,3) END) W21_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W22_WEEK_SEQ,1,5) ELSE SUBSTR(W22_WEEK_SEQ,1,3) END) W22_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W23_WEEK_SEQ,1,5) ELSE SUBSTR(W23_WEEK_SEQ,1,3) END) W23_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W24_WEEK_SEQ,1,5) ELSE SUBSTR(W24_WEEK_SEQ,1,3) END) W24_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W25_WEEK_SEQ,1,5) ELSE SUBSTR(W25_WEEK_SEQ,1,3) END) W25_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W26_WEEK_SEQ,1,5) ELSE SUBSTR(W26_WEEK_SEQ,1,3) END) W26_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W27_WEEK_SEQ,1,5) ELSE SUBSTR(W27_WEEK_SEQ,1,3) END) W27_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W28_WEEK_SEQ,1,5) ELSE SUBSTR(W28_WEEK_SEQ,1,3) END) W28_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W29_WEEK_SEQ,1,5) ELSE SUBSTR(W29_WEEK_SEQ,1,3) END) W29_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W30_WEEK_SEQ,1,5) ELSE SUBSTR(W30_WEEK_SEQ,1,3) END) W30_WEEK_SEQ
      FROM
          (
            WITH HEAD_DATA
              AS (
                   SELECT
                         'STOCK' STOCK_PH1
                        ,'team' TEAM_H1
                        ,'planMasterId' PLAN_MASTER_ID_H
                        ,'category' CATEGORY_H1
                        ,'code' CODE_H1
                        ,'name' NAME_H1
                        ,'m3AvgIssueOrder' ISUUEORDER_H
                        ,'MONTHLY' MONTHLY_PH2
                        ,'m1IssueOrder' BEFORE_DAY_H2
                        ,'m0PlanOrder' TODAY_H2
                        ,'m1' M1_H2
                        ,'m2' M2_H2
                        ,'m3' M3_H3
                        ,'m4' M4_H4
                        ,'psi' SUPPLY_CORP_H_PSI
                        ,'overdue' SUPPLY_CORP_H_OVERDUE
                        ,'isSaved' IS_SAVED
                        ,'divOdd' DIV_ODD
                        ,'stkTypeId' STK_TYPE_ID_H1
                        , DECODE(LEAD(WEEK_TH_SN) OVER(ORDER BY 'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN)
                                ,NULL
                                ,'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN ||'-'|| '9'
                                ,'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN ||'-'|| LEAD(WEEK_TH_SN) OVER(ORDER BY 'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN))
                          WEEK_SEQ
                        , ROWNUM RNO
                     FROM  (select * from SCM0018M where to_char(week_th_sn_start,'YYYYMM') <![CDATA[ >= ]]>  #{calendarFrom} and to_char(week_th_sn_start,'YYYYMM') <![CDATA[ <= ]]> #{calendarTo})
              )
              SELECT *
                FROM
                    (
                      SELECT
                            STOCK_PH1
                          , TEAM_H1
                          , PLAN_MASTER_ID_H
                          , CATEGORY_H1
                          , CODE_H1
                          , NAME_H1
                          , ISUUEORDER_H
                          , MONTHLY_PH2
                          , BEFORE_DAY_H2
                          , TODAY_H2
                          , M1_H2
                          , M2_H2
                          , M3_H3
                          , M4_H4
                          , SUPPLY_CORP_H_PSI
                          , SUPPLY_CORP_H_OVERDUE
                          , IS_SAVED
                          , DIV_ODD
                          , STK_TYPE_ID_H1
                          , WEEK_SEQ
                          , DECODE(RNO ,1 ,'1' ,2,'2',3,'3',4,'4' ,5,'5',6,'6',7,'7' ,8,'8',9,'9' ,10,'10',11,'11' ,12,'12',13,'13' ,14,'14',15,'15' ,16,'16'
                                       ,17,'17',18,'18',19,'19',20,'20',21,'21',22,'22',23,'23' ,24,'24',25,'25' ,26,'26',27,'27' ,28,'28',29,'29' ,30,'30'
                                  ) RNO
                         FROM HEAD_DATA
                    )
                    PIVOT
                   (
                     MAX(WEEK_SEQ) WEEK_SEQ
                         FOR RNO IN ( 1 AS W1,2 AS W2,3 AS W3,4 AS W4,5 AS W5,6 AS W6,7 AS W7,8 AS W8,9 AS W9,10 AS W10,11 AS W11,12 AS W12,13 AS W13,14 AS W14,15 AS W15,16 AS W16
                                     ,17 AS W17,18 AS W18,19 AS W19,20 AS W20, 21 AS W21,22 AS W22,23 AS W23, 24 AS W24, 25 AS W25 ,26 AS W26,27 AS W27,28 AS W28,29 AS W29,30 AS W30
                         )
                   )
        )
    </select>

    <select id="selectSalesCnt" parameterType="Map" resultType="egovMap">
		 SELECT
		       SUM(ORD_CNT) SALE_CNT
		  FROM SCM0030S
		  WHERE SCM_YEAR= #{scmYearCbBox}
		    AND SCM_MONTH= #{selectPlanMonth}
		    AND SCM_WEEK_TH = #{weekTh}
		    AND TEAM=  #{scmTeamCbBox}
		    AND STOCK_CODE  = #{stockCode}
		  GROUP BY SCM_YEAR, SCM_MONTH,SCM_WEEK_TH,TEAM
    </select>

    <select id="selectRemainWeekTh" parameterType="Map" resultType="egovMap">
		   SELECT SCM_YEAR
		         ,WEEK_TH
			  FROM SCM0018M
			  WHERE SCM_YEAR =  #{scmYearCbBox}
			   AND SCM_MONTH =  #{selectPlanMonth}
			   AND WEEK_TH <![CDATA[ < ]]> #{scmPeriodCbBox}
			   AND USE_YN = 'Y'
			   /*AND NVL(USE_YN,'Y')='Y' */
    </select>

    <select id="selectChildField" parameterType="Map" resultType="egovMap">
		   SELECT SCM_YEAR
		        ,SCM_MONTH
		        ,WEEK_TH
		        ,WEEK_TH_SN
		        ,IS_SRPTD
		        ,SCM_YYYYMM
		        ,ROWNUM ROW_SEQ
		  FROM SCM0018M
		 WHERE to_char(week_th_sn_end,'YYYYMM') = #{scmYearCbBox}||LPAD(#{selectPlanMonth},2,0) AND USE_YN = 'Y'  /* AND NVL (USE_YN, 'Y') = 'Y' */
		 ORDER BY WEEK_TH
    </select>

<select id="selectWeekThSn" parameterType="Map" resultType="egovMap">
  SELECT SCM_YEAR
        ,SCM_MONTH
        ,WEEK_TH
        ,WEEK_TH_SN
        ,IS_SRPTD
        ,SCM_YYYYMM
        ,ROWNUM ROW_SEQ
   FROM SCM0018M
  WHERE SCM_YEAR =  #{scmYearCbBox}
    AND SCM_MONTH = #{selectPlanMonth}
    AND USE_YN = 'Y'
    /*AND NVL(USE_YN,'Y')='Y'*/
    AND WEEK_TH_SN = 1
  ORDER BY WEEK_TH
</select>

  <!--  Accuracy -->
<select id="selectAccuracyMonthlyHeaderList" parameterType="Map" resultType="egovMap">
  SELECT W1_WEEK_TH W1
        ,W2_WEEK_TH W2
        ,W3_WEEK_TH W3
        ,W4_WEEK_TH W4
        ,W5_WEEK_TH W5
        ,W6_WEEK_TH W6
        ,W7_WEEK_TH W7
    FROM(
				  WITH HEAD_DATA
            AS
            (
               SELECT
                      WEEK_TH
                    , ROWNUM RNO
                 FROM SCM0018M
                WHERE SCM_YEAR  = #{scmYearCbBox}
                  AND SCM_MONTH = #{scmMonthCbBox}
                  AND USE_YN = 'Y'
                  /*AND NVL(USE_YN,'Y')='Y'*/
                  AND WEEK_TH_SN = 1
            )
            SELECT *
              FROM HEAD_DATA
             PIVOT
                 (
                   MAX(WEEK_TH) WEEK_TH FOR RNO IN ( 1 AS W1,2 AS W2,3 AS W3,4 AS W4,5 AS W5,6 AS W6,7 AS W7)
                 )
        )
</select>

<select id="selectSeperation" parameterType="Map" resultType="egovMap">
		 SELECT M0.SCM_YEAR
			    , M0.SCM_MONTH
			    , M0.REC_CNT M0_TOT_CNT
			    , M1.REC_CNT M1_TOT_CNT
			    , M2.REC_CNT M2_TOT_CNT
			    , M3.REC_CNT M3_TOT_CNT
			FROM
					(
					  SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					  FROM SCM0018M
					 WHERE SCM_YEAR =  #{scmYearCbBox}
					   AND SCM_MONTH = #{selectPlanMonth}
					   /*AND NVL(USE_YN,'Y')='Y'*/
					   AND USE_YN = 'Y'
					   GROUP BY SCM_YEAR,SCM_MONTH
					  ) M0
					,
					(
					  SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					    FROM SCM0018M
      <choose>
        <when test=' selectPlanMonth != null and (selectPlanMonth +1) > 12 '>
           WHERE SCM_YEAR =  (#{scmYearCbBox} +1)
             AND SCM_MONTH = 1
        </when>
        <otherwise>
           WHERE SCM_YEAR =  #{scmYearCbBox}
             AND SCM_MONTH = (#{selectPlanMonth} +1)
        </otherwise>
      </choose>
 			       /*AND NVL(USE_YN,'Y')='Y'*/
 			       AND USE_YN = 'Y'
					 GROUP BY SCM_YEAR,SCM_MONTH
					) M1
					,
					(
					  SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					    FROM SCM0018M
      <choose>
        <when test=' selectPlanMonth != null and (selectPlanMonth +1) > 12 '>
           WHERE SCM_YEAR =  (#{scmYearCbBox} +1)
             AND SCM_MONTH = 2
        </when>
        <otherwise>
           WHERE SCM_YEAR =  #{scmYearCbBox}
             AND SCM_MONTH = (#{selectPlanMonth} +2)
        </otherwise>
      </choose>
					   /*AND NVL(USE_YN,'Y')='Y'*/
					   AND USE_YN = 'Y'
					   GROUP BY SCM_YEAR,SCM_MONTH
					) M2
					,
					(
				    SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					   FROM SCM0018M
      <choose>
        <when test=' selectPlanMonth != null and (selectPlanMonth +1) > 12 '>
           WHERE SCM_YEAR =  (#{scmYearCbBox} +1)
             AND SCM_MONTH = 3
        </when>
        <otherwise>
           WHERE SCM_YEAR =  #{scmYearCbBox}
             AND SCM_MONTH = (#{selectPlanMonth} +3)
        </otherwise>
      </choose>
					   /*AND NVL(USE_YN,'Y')='Y'*/
					   AND USE_YN = 'Y'
					   GROUP BY SCM_YEAR,SCM_MONTH
					) M3
			WHERE ROWNUM = 1
    </select>


    <select id="selectExcuteYear" parameterType="Map" resultType="egovMap">
			SELECT TO_CHAR((SYSDATE-365),'YYYY') YEAR FROM DUAL
			UNION
			SELECT TO_CHAR(SYSDATE,'YYYY') YEAR FROM DUAL
    </select>

    <select id="selectMonthCombo" parameterType="Map" resultType="egovMap">
      SELECT
             SCM_MONTH
        FROM SCM0018M
       WHERE SCM_YEAR = #{scmYearCbBox}
         AND SCM_WEEK  = #{scmPeriodCbBox}
         AND SCM_WEEK_SEQ = 1
         /*AND NVL(USE_YN,'Y')='Y'*/
         AND USE_YN = 'Y'
    </select>

    <select id="selectPeriodByYear" parameterType="Map" resultType="egovMap">
      SELECT SCM_YEAR
           , SCM_WEEK ||'-'|| SCM_WEEK_SEQ ||decode(length(SCM_WEEK),1,'  [','[')||TO_CHAR(SCM_WEEK_START,'YYYY-MM-DD') || ' ~ ' ||  SCM_WEEK_END ||']' SCM_PERIOD
           , SCM_MONTH
           , SCM_WEEK
        FROM SCM0018M
       WHERE SCM_YEAR = #{year}
         AND SCM_WEEK_SEQ = 1
         AND NVL(USE_YN,'Y')='Y'
         AND USE_YN = 'Y'
    </select>

    <select id="selectScmTeamCode" parameterType="Map" resultType="egovMap">
	     SELECT CODE
	           ,CODE_NAME
	      FROM SYS0013M
	     WHERE CODE_MASTER_ID = #{codeMasterId}
	     ORDER BY CODE_ID
    </select>

    <select id="selectDefaultStockCode" parameterType="Map" resultType="egovMap">
			SELECT STOCK_CODE AS STK_CODE
			     ,  STOCK_CODE||'-'||T1.STK_DESC AS STK_DESC
        FROM SCM0008M T0 LEFT JOIN SYS0026M T1 ON T1.STK_CODE=T0.STOCK_CODE
    </select>

    <select id="selectStockCategoryCode" parameterType="Map" resultType="egovMap">
	     SELECT CODE_ID
				    , CODE
				    , CODE CODE_NAME
				  FROM
				     (
				       SELECT Extent1.STK_ID STK_ID  ,
				              Extent1.STK_CODE STK_CODE  ,
				              Extent2.CODE_ID CODE_ID  ,
				              Extent2.CODE CODE  ,
				              Extent1.STK_DESC STK_DESC  ,
				              Extent3.CODE_ID CODEID1  ,
				              Extent3.CODE CODE1
				         FROM SYS0026M Extent1
				               JOIN SYS0013M Extent2   ON Extent1.STK_CTGRY_ID = Extent2.CODE_ID
				               JOIN SYS0013M Extent3   ON Extent1.STK_TYPE_ID = Extent3.CODE_ID
				               JOIN SCM0008M Extent4   ON Extent1.STK_ID = Extent4.STOCK_ID
				    ) GROUP BY CODE_ID, CODE
				      ORDER BY CODE_ID, CODE
	  </select>

    <select id="selectStockCode" parameterType="Map" resultType="egovMap">
			SELECT SYS26M.STK_ID
			     , SYS26M.STK_CODE
			     , SYS26M.STK_CODE ||' - '|| SYS26M.STK_DESC  STK_DESC
			     , Extent2.CODE_ID
			     , Extent2.CODE CODE
			     , Extent3.CODE_ID CODE_ID2
			     , Extent3.CODE CODE2
			  FROM SYS0026M SYS26M
			  JOIN SYS0013M Extent2   ON SYS26M.STK_CTGRY_ID = Extent2.CODE_ID
			  JOIN SYS0013M Extent3   ON SYS26M.STK_TYPE_ID = Extent3.CODE_ID
			<choose>
        <when test=' codeIds != null and codeIds != "" '>
        WHERE EXISTS ( SELECT 1 C1
                         FROM SCM0008M Extent4
                        WHERE  Extent4.STOCK_ID = SYS26M.STK_ID
                     )
		     AND ( 1 = SYS26M.STUS_CODE_ID )
		     AND ( 0 = TO_NUMBER(SYS26M.IS_NCV) )
         AND  Extent2.CODE_ID IN ( SELECT REGEXP_SUBSTR (#{codeIds}, '[^,]+', 1, LEVEL)
                                     FROM DUAL
                                  CONNECT BY REGEXP_SUBSTR (#{codeIds}, '[^,]+', 1, LEVEL) IS NOT NULL
                                 )
        </when>
        <otherwise>
          JOIN SCM0008M Extent4   ON SYS26M.STK_ID = Extent4.STOCK_ID
        </otherwise>
      </choose>
			 ORDER BY SYS26M.STK_DESC   ASC
    </select>

<select id="selectPlanId" parameterType="Map" resultType="egovMap">
SELECT A.PLAN_ID
     , A.PLAN_YEAR
     , A.PLAN_MONTH
     , A.PLAN_WEEK
     , A.TEAM
     , DECODE(A.PLAN_STUS_ID, 4, 'Active', 'Confirmed') AS PLAN_STUS_NM
     , TO_CHAR(A.CRT_DT, 'YYYY/MM/DD HH24:MI:SS') AS CRT_DT
     , A.STUS_DT
     , A.CRT_USER_ID
     , A.PLAN_STUS_ID
     , DECODE(A.CRT_DT, NULL, '0', '1') AS CREATED
  FROM SCM0001M A
 WHERE A.PLAN_YEAR = #{scmYearCbBox}
   AND A.PLAN_WEEK = #{scmPeriodCbBox}
	<if test="scmTeamCbBox != null and scmTeamCbBox !=''">
   AND A.TEAM = #{scmTeamCbBox}
	</if>
</select>

<select id="selectSalesPlanMngmentGroupList" parameterType="Map" resultType="egovMap">
SELECT 0 AS PLAN_MASTER_ID
     , A.PLAN_YEAR
     , A.PLAN_MONTH
     , A.PLAN_WEEK
     , A.CHECK_FLAG
     , 'ALL' AS TEAM
     , 0 AS PLAN_DTL_ID
     , A.STK_TYPE_ID
     , A.CATEGORY
     , A.CODE
     , A.NAME
     , SUM(A.M3_AVG_ISSUE_ORDER) AS M3_AVG_ISSUE_ORDER
     , SUM(A.M1_ISSUE_ORDER) AS M1_ISSUE_ORDER
     , SUM(A.M0_PLAN_ORDER) AS M0_PLAN_ORDER
     , SUM(A.M1) AS M1
     , SUM(A.M2) AS M2
     , SUM(A.M3) AS M3
     , SUM(A.M4) AS M4
     , SUM(A.BEF_4_WEEK_TH) AS BEF_4_WEEK_TH
     , SUM(A.BEF_3_WEEK_TH) AS BEF_3_WEEK_TH
     , SUM(A.BEF_2_WEEK_TH) AS BEF_2_WEEK_TH
     , SUM(A.BEF_1_WEEK_TH) AS BEF_1_WEEK_TH
     , SUM(A.W00) AS W00
     , SUM(A.W01) AS W01, SUM(A.W02) AS W02, SUM(A.W03) AS W03, SUM(A.W04) AS W04, SUM(A.W05) AS W05, SUM(A.W06) AS W06, SUM(A.W07) AS W07, SUM(A.W08) AS W08, SUM(A.W09) AS W09, SUM(A.W10) AS W10
     , SUM(A.W11) AS W11, SUM(A.W12) AS W12, SUM(A.W13) AS W13, SUM(A.W14) AS W14, SUM(A.W15) AS W15, SUM(A.W16) AS W16, SUM(A.W17) AS W17, SUM(A.W18) AS W18, SUM(A.W19) AS W19, SUM(A.W20) AS W20
     , SUM(A.W21) AS W21, SUM(A.W22) AS W22, SUM(A.W23) AS W23, SUM(A.W24) AS W24, SUM(A.W25) AS W25, SUM(A.W26) AS W26, SUM(A.W27) AS W27, SUM(A.W28) AS W28, SUM(A.W29) AS W29, SUM(A.W30) AS W30
     , SUM(A.WS1) AS WS1, SUM(A.WS2) AS WS2, SUM(A.WS3) AS WS3, SUM(A.WS4) AS WS4, SUM(A.WS5) AS WS5
  FROM (
SELECT A.PLAN_ID AS PLAN_MASTER_ID
     , A.PLAN_YEAR
     , A.PLAN_MONTH
     , A.PLAN_WEEK
     , A.PLAN_STUS_ID AS CHECK_FLAG
     , A.TEAM
     , B.PLAN_DTL_ID
     , C.STK_TYPE_ID
     , C.STK_CTGRY_ID AS CATEGORY
     , C.STK_CODE AS CODE
     , C.STK_DESC AS NAME
     , (SELECT ROUND(COUNT(*)/3)
          FROM GBSLCVD.SCM0051S Z
         WHERE Z.STOCK_CODE = C.STK_CODE
           AND Z.TEAM = A.TEAM
           AND Z.ISS_DT BETWEEN #{m3YearFrom} || LPAD(#{m3MonthFrom}, 2, '0') || '01' AND #{m3YearTo} || LPAD(#{m3MonthTo}, 2, '0') || '31') AS M3_AVG_ISSUE_ORDER
     , (SELECT COUNT(*)
          FROM GBSLCVD.SCM0051S Z
         WHERE Z.STOCK_CODE = C.STK_CODE
           AND Z.TEAM = A.TEAM
           AND Z.ISS_DT BETWEEN #{m1YearFrom} || LPAD(#{m1MonthFrom}, 2, '0') || '01' AND #{m1YearTo} || LPAD(#{m1MonthTo}, 2, '0') || '31') AS M1_ISSUE_ORDER
     , (SELECT COUNT(*)
          FROM GBSLCVD.SCM0050S Z
         WHERE Z.STOCK_CODE = C.STK_CODE
           AND Z.TEAM = A.TEAM
           AND Z.ORD_DT BETWEEN #{scmYearCbBox} || LPAD(#{selectPlanMonth}, 2, '0') || '01' AND #{scmYearCbBox} || LPAD(#{selectPlanMonth}, 2, '0') || '31') AS M0_PLAN_ORDER
     , B.M1
     , B.M2
     , B.M3
     , B.M4
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-4)) AS BEF_4_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-3)) AS BEF_3_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-2)) AS BEF_2_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-1)) AS BEF_1_WEEK_TH
     , B.W00
     , B.W01, B.W02, B.W03, B.W04, B.W05, B.W06, B.W07, B.W08, B.W09, B.W10
     , B.W11, B.W12, B.W13, B.W14, B.W15, B.W16, B.W17, B.W18, B.W19, B.W20
     , B.W21, B.W22, B.W23, B.W24, B.W25, B.W26, B.W27, B.W28, B.W29, B.W30
     , B.WS1, B.WS2, B.WS3, B.WS4, B.WS5
  FROM SCM0001M A
  LEFT OUTER JOIN SCM0002D B ON (A.PLAN_ID = B.PLAN_MASTER_ID)
  LEFT OUTER JOIN SYS0026M C ON (B.STOCK_CODE = C.STK_CODE)
 WHERE A.PLAN_YEAR = #{scmYearCbBox}
   AND A.PLAN_WEEK = #{scmPeriodCbBox}
	<if test="scmTeamCbBox != null and scmTeamCbBox !='' ">
   AND A.TEAM = #{scmTeamCbBox}
	</if>
	<choose>
		<when test="scmStockTypes != null and !scmStockTypes.isEmpty">
   AND C.STK_TYPE_ID IN
			<foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
       #{item}
			</foreach>
		</when>
	</choose>
	<choose>
		<when test="stkCategories != null and !stkCategories.isEmpty">
   AND C.STK_CTGRY_ID IN
			<foreach item="item" collection="stkCategories" index="index" open="(" separator="," close=")">
       #{item}
			</foreach>
		</when>
	</choose>
	<choose>
		<when test="stkCodes != null and !stkCodes.isEmpty">
   AND C.STK_CODE IN
			<foreach item="item" collection="stkCodes" index="index" open="(" separator="," close=")">
       #{item}
			</foreach>
		</when>
	</choose>
 ) A
 GROUP BY A.PLAN_YEAR
     , A.PLAN_MONTH
     , A.PLAN_WEEK
     , A.CHECK_FLAG
     , A.STK_TYPE_ID
     , A.CATEGORY
     , A.CODE
     , A.NAME
 ORDER BY A.STK_TYPE_ID, A.CATEGORY, A.CODE
</select>

<select id="selectSalesPlanMngmentList" parameterType="Map" resultType="egovMap">
SELECT A.PLAN_ID AS PLAN_MASTER_ID
     , A.PLAN_YEAR
     , A.PLAN_MONTH
     , A.PLAN_WEEK
     , A.PLAN_STUS_ID AS CHECK_FLAG
     , A.TEAM
     , B.PLAN_DTL_ID
     , C.STK_TYPE_ID
     , C.STK_CTGRY_ID AS CATEGORY
     , C.STK_CODE AS CODE
     , C.STK_DESC AS NAME
     , (SELECT ROUND(COUNT(*)/3)
          FROM GBSLCVD.SCM0051S Z
         WHERE Z.STOCK_CODE = C.STK_CODE
           AND Z.TEAM = A.TEAM
           AND Z.ISS_DT BETWEEN #{m3YearFrom} || LPAD(#{m3MonthFrom}, 2, '0') || '01' AND #{m3YearTo} || LPAD(#{m3MonthTo}, 2, '0') || '31') AS M3_AVG_ISSUE_ORDER
     , (SELECT COUNT(*)
          FROM GBSLCVD.SCM0051S Z
         WHERE Z.STOCK_CODE = C.STK_CODE
           AND Z.TEAM = A.TEAM
           AND Z.ISS_DT BETWEEN #{m1YearFrom} || LPAD(#{m1MonthFrom}, 2, '0') || '01' AND #{m1YearTo} || LPAD(#{m1MonthTo}, 2, '0') || '31') AS M1_ISSUE_ORDER
     , (SELECT COUNT(*)
          FROM GBSLCVD.SCM0050S Z
         WHERE Z.STOCK_CODE = C.STK_CODE
           AND Z.TEAM = A.TEAM
           AND Z.ORD_DT BETWEEN #{scmYearCbBox} || LPAD(#{selectPlanMonth}, 2, '0') || '01' AND #{scmYearCbBox} || LPAD(#{selectPlanMonth}, 2, '0') || '31') AS M0_PLAN_ORDER
     , B.M1
     , B.M2
     , B.M3
     , B.M4
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-4)) AS BEF_4_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-3)) AS BEF_3_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-2)) AS BEF_2_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(C.STK_CODE, 'STOCK_CODE', A.PLAN_ID, C.STK_TYPE_ID), FN_GET_SCM_SCM0002D(C.STK_CODE, 'TEAM', A.PLAN_ID, C.STK_TYPE_ID), #{scmYearCbBox}, #{selectPlanMonth}, (#{scmPeriodCbBox}-1)) AS BEF_1_WEEK_TH
     , B.W00
     , B.W01, B.W02, B.W03, B.W04, B.W05, B.W06, B.W07, B.W08, B.W09, B.W10
     , B.W11, B.W12, B.W13, B.W14, B.W15, B.W16, B.W17, B.W18, B.W19, B.W20
     , B.W21, B.W22, B.W23, B.W24, B.W25, B.W26, B.W27, B.W28, B.W29, B.W30
     , B.WS1, B.WS2, B.WS3, B.WS4, B.WS5
  FROM SCM0001M A
  LEFT OUTER JOIN SCM0002D B ON (A.PLAN_ID = B.PLAN_MASTER_ID)
  LEFT OUTER JOIN SYS0026M C ON (B.STOCK_CODE = C.STK_CODE)
 WHERE A.PLAN_YEAR = #{scmYearCbBox}
   AND A.PLAN_WEEK = #{scmPeriodCbBox}
	<if test="scmTeamCbBox != null and scmTeamCbBox !='' ">
   AND A.TEAM = #{scmTeamCbBox}
	</if>
	<choose>
		<when test="scmStockTypes != null and !scmStockTypes.isEmpty">
   AND C.STK_TYPE_ID IN
			<foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
       #{item}
			</foreach>
		</when>
	</choose>
	<choose>
		<when test="stkCategories != null and !stkCategories.isEmpty">
   AND C.STK_CTGRY_ID IN
			<foreach item="item" collection="stkCategories" index="index" open="(" separator="," close=")">
       #{item}
			</foreach>
		</when>
	</choose>
	<choose>
		<when test="stkCodes != null and !stkCodes.isEmpty">
   AND C.STK_CODE IN
			<foreach item="item" collection="stkCodes" index="index" open="(" separator="," close=")">
       #{item}
			</foreach>
		</when>
	</choose>
 ORDER BY A.TEAM, C.STK_TYPE_ID, C.STK_CTGRY_ID, C.STK_CODE
</select>
<!--
<select id="selectSalesPlanMngmentList" parameterType="Map" resultType="egovMap">
SELECT (SELECT Z.PLAN_STUS_ID
          FROM SCM0001M Z
         WHERE Z.PLAN_ID = S_O.PLAN_MASTER_ID
        ) AS CHECK_FLAG
     , S_O.PLAN_MASTER_ID
     , S_O.TEAM
     , S_O.STK_TYPE_ID
     , S_O.CATEGORY
     , S_O.CODE
     , S_O.NAME
     , ROUND(FN_GET_SCM_SCM0002D(S_O.CODE, 'PRE_M3_AVG_ISSU', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID)) || '/' ||
       ROUND(FN_GET_SCM_SCM0002D(S_O.CODE, 'PRE_M3_AVG_ORDED', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID)) AS M3_AVG_ISSUE_ORDER
     , ROUND(FN_GET_SCM_SCM0002D(S_O.CODE, 'M_1', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID)) || '/' ||
       ROUND(FN_GET_SCM_SCM0002D(S_O.CODE, 'M1_ORD', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID)) AS M1_ISSUE_ORDER
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'M0_PLAN' ,S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) || '/' ||
       FN_GET_SCM_SCM0002D(S_O.CODE, 'M0_ORD' ,S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS M0_PLAN_ORDER
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'M1', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS M1
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'M2', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS M2
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'M3', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS M3
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'M4', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS M4
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(S_O.CODE, 'STOCK_CODE', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), FN_GET_SCM_SCM0002D(S_O.CODE, 'TEAM', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), '2018', '2', ('6'-4)) AS BEF_4_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(S_O.CODE, 'STOCK_CODE', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), FN_GET_SCM_SCM0002D(S_O.CODE, 'TEAM', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), '2018', '2', ('6'-3)) AS BEF_3_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(S_O.CODE, 'STOCK_CODE', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), FN_GET_SCM_SCM0002D(S_O.CODE, 'TEAM', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), '2018', '2', ('6'-2)) AS BEF_2_WEEK_TH
     , FN_GET_COUNT_SCM_WEEK_TH(FN_GET_SCM_SCM0002D(S_O.CODE, 'STOCK_CODE', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), FN_GET_SCM_SCM0002D(S_O.CODE, 'TEAM', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID), '2018', '2', ('6'-1)) AS BEF_1_WEEK_TH
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W00', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W00
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W01', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W01
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W02', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W02
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W03', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W03
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W04', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W04
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W05', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W05
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W06', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W06
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W07', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W07
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W08', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W08
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W09', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W09
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W10', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W10
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W11', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W11
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W12', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W12
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W13', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W13
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W14', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W14
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W15', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W15
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W16', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W16
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W17', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W17
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W18', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W18
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W19', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W19
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W20', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W20
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W21', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W21
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W22', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W22
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W23', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W23
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W24', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W24
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W25', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W25
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W26', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W26
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W27', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W27
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W28', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W28
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W29', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W29
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'W30', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS W30
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'WS1', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS WS1
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'WS2', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS WS2
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'WS3', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS WS3
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'WS4', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS WS4
     , FN_GET_SCM_SCM0002D(S_O.CODE, 'WS5', S_O.PLAN_MASTER_ID, S_O.STK_TYPE_ID) AS WS5
  FROM (
        SELECT SCM39V.PLAN_DTL_ID
             , SCM39V.PLAN_MASTER_ID
             , SCM39V.TEAM AS TEAM
             , SCM39V.STK_TYPE_ID
             , SCM39V.STOCK_CODE AS CODE
             , SCM39V.PRE_M3_AVG_ORDED
             , SCM39V.PRE_M3_AVG_ISSU
             , SCM39V.M1_ORD
             , SCM39V.M2_ORD
             , SCM39V.M3_ORD
             , SCM39V.M_3
             , SCM39V.M_2
             , SCM39V.M_1
             , SCM39V.M0_PLAN M0_PLAN
             , SCM39V.M0_ORD M0_ORD
             , SCM39V.M1
             , SCM39V.M2
             , SCM39V.M3
             , SCM39V.M4
             , SCM39V.W00
             , SCM39V.W01
             , SCM39V.W02
             , SCM39V.W03
             , SCM39V.W04
             , SCM39V.W05
             , SCM39V.W06
             , SCM39V.W07
             , SCM39V.W08
             , SCM39V.W09
             , SCM39V.W10
             , SCM39V.W11
             , SCM39V.W12
             , SCM39V.W13
             , SCM39V.W14
             , SCM39V.W15
             , SCM39V.W16
             , SCM39V.W17
             , SCM39V.W18
             , SCM39V.W19
             , SCM39V.W20
             , SCM39V.W21
             , SCM39V.W22
             , SCM39V.W23
             , SCM39V.W24
             , SCM39V.W25
             , SCM39V.W26
             , SCM39V.W27
             , SCM39V.W28
             , SCM39V.W29
             , SCM39V.W30
             , SCM39V.WS1
             , SCM39V.WS2
             , SCM39V.WS3
             , SCM39V.WS4
             , SCM39V.WS5
             , SCM39V.STOCK_NAME AS NAME
             , SCM39V.STOCK_CTGRY AS CATEGORY
          FROM SCM0039V SCM39V
         WHERE PLAN_MASTER_ID IN (
                                  SELECT PLAN_ID
                                    FROM SCM0001M
                                   WHERE PLAN_YEAR = #{scmYearCbBox}
                                     AND PLAN_WEEK = #{scmPeriodCbBox}
	<if test="scmTeamCbBox != null and scmTeamCbBox !='' ">
                                     AND TEAM = #{scmTeamCbBox}
	</if>
                                  )
	<choose>
		<when test="scmStockTypes != null and !scmStockTypes.isEmpty">
           AND SCM39V.STK_TYPE_ID IN
			<foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
               #{item}
			</foreach>
		</when>
	</choose>
	<choose>
		<when test="stkCodes != null and !stkCodes.isEmpty">
           AND SCM39V.STOCK_CODE IN
			<foreach item="item" collection="stkCodes" index="index" open="(" separator="," close=")">
               #{item}
			</foreach>
		</when>
	</choose>
        ) S_O
 ORDER BY S_O.TEAM, S_O.STK_TYPE_ID, S_O.CATEGORY, S_O.CODE
</select>
-->

    <select id="selectSalesPlanMngmentPeriod" parameterType="Map" resultType="egovMap">
			SELECT SCM_YEAR   ,
			       WEEK_TH ||'-'|| WEEK_TH_SN ||'['||TO_CHAR(WEEK_TH_SN_START,'YYYY-MM-DD') || ' ~ ' ||  WEEK_TH_SN_END ||']' SCM_PERIOD  ,
			       SCM_MONTH  ,
			       WEEK_TH
			  FROM SCM0018M
			 WHERE SCM_YEAR = #{year}
			   AND WEEK_TH_SN = 1
			   /*AND NVL(USE_YN,'Y')='Y'*/
			   AND USE_YN = 'Y'
    </select>

    <update id="updateScmPlanMaster" parameterType="Map">
      UPDATE SCM0002D
         SET PLAN_MASTER_ID = #{planMasterId}
		 <if test='m0 != null'>
               , m0_plan = #{m0}
         </if>
         <if test='m1 != null'>
               , m1 = #{m1}
         </if>
         <if test='m2 != null'>
               , m2 = #{m2}
         </if>
         <if test='m3 != null'>
               , m3 = #{m3}
         </if>
         <if test='m4 != null'>
               , m4 = #{m4}
         </if>
         <if test='w00 != null'>
               , W00 = #{w00}
         </if>
         <if test='w01 != null'>
               , W01 = #{w01}
         </if>
         <if test='w02 != null'>
               , W02 = #{w02}
         </if>
         <if test='w03 != null'>
               , W03 = #{w03}
         </if>
         <if test='w04 != null'>
               , W04 = #{w04}
         </if>
         <if test='w05 != null'>
               , W05 = #{w05}
         </if>

         <if test='w06 != null'>
               , W06 = #{w06}
         </if>
         <if test='w07 != null'>
               , W07 = #{w07}
         </if>
         <if test='w08 != null'>
               , W08 = #{w08}
         </if>
         <if test='w09 != null'>
               , W09 = #{w09}
         </if>
         <if test='w10 != null'>
               , W10 = #{w10}
         </if>

         <if test='w11 != null'>
               , W11 = #{w11}
         </if>
         <if test='w12 != null'>
               , W12 = #{w12}
         </if>
         <if test='w13 != null'>
               , W13 = #{w13}
         </if>
         <if test='w14 != null'>
               , W14 = #{w14}
         </if>
         <if test='w15 != null'>
               , W15 = #{w15}
         </if>
         <if test='w16 != null'>
               , W16 = #{w16}
         </if>
         <if test='w17 != null'>
               , W17 = #{w17}
         </if>
         <if test='w18 != null'>
               , W18 = #{w18}
         </if>
         <if test='w19 != null'>
               , W19 = #{w19}
         </if>
         <if test='w20 != null'>
               , W20 = #{w20}
         </if>

         <if test='w21 != null'>
               , W21 = #{w21}
         </if>
         <if test='w22 != null'>
               , W22 = #{w22}
         </if>
         <if test='w23 != null'>
               , W23 = #{w23}
         </if>
         <if test='w24 != null'>
               , W24 = #{w24}
         </if>
         <if test='w25 != null'>
               , W25 = #{w25}
         </if>
         <if test='w26 != null'>
               , W26 = #{w26}
         </if>
         <if test='w27 != null'>
               , W27 = #{w27}
         </if>
         <if test='w28 != null'>
               , W28 = #{w28}
         </if>
         <if test='w29 != null'>
               , W29 = #{w29}
         </if>
         <if test='w30 != null'>
               , W30 = #{w30}
         </if>

       WHERE PLAN_MASTER_ID = #{planMasterId}
         AND STOCK_CODE = #{code}
         AND TEAM  = #{team}
    </update>

<select id="selectPlanDetailIdSeq" parameterType="Map" resultType="egovMap">
SELECT SCM0002D_PLAN_DTL_ID_SEQ.NEXTVAL SCM0002D_PLAN_DTL_ID_SEQ
  FROM DUAL
</select>

<select id="selectPlanMasterId" parameterType="Map" resultType="egovMap">
SELECT PLAN_ID PLAN_MASTER_ID
  FROM SCM0001M
 WHERE PLAN_YEAR = #{scmYearCbBox}
   AND PLAN_WEEK = #{scmPeriodCbBox}
   AND TEAM      = #{scmTeamCbBox}
</select>

<select id="selectStockIdByStCode" parameterType="Map" resultType="egovMap">
SELECT STK_ID
  FROM SYS0026M
 WHERE STK_CODE    = #{newStockCode}
   AND STK_TYPE_ID = #{newStockTypeId}
   AND ROWNUM = 1
</select>

<insert id="insertSalesPlanDetail" parameterType="Map">
 <selectKey keyProperty="scm0002dPlanDtlIdSeq,getPlanMasterId" resultType="egovMap" order="BEFORE">
   SELECT SCM0002D_PLAN_DTL_ID_SEQ.NEXTVAL AS SCM0002D_PLAN_DTL_ID_SEQ
        ,(
           SELECT PLAN_ID
						 FROM SCM0001M
						WHERE PLAN_YEAR = #{scmGrYear}
						  AND PLAN_WEEK = #{scmGrWeek}
						  AND TEAM      = #{team}
         ) GET_PLAN_MASTER_ID
  FROM DUAL
 </selectKey>

 INSERT INTO SCM0002D
           (
             PLAN_DTL_ID
            ,PLAN_MASTER_ID
            ,TEAM
            ,STOCK_CODE

            <if test='preM3AvgOrded != null and preM3AvgOrded !="" '>
            ,PRE_M3_AVG_ORDED
            </if>
            <if test='preM3AvgIssu != null and preM3AvgIssu !="" '>
            ,PRE_M3_AVG_ISSU
            </if>
            <if test='m1Ord != null and m1Ord !="" '>
            ,M1_ORD
            </if>
            <if test='m2Ord != null and m2Ord !="" '>
            ,M2_ORD
            </if>
            <if test='m3Ord != null and m3Ord !="" '>
            ,M3_ORD
            </if>
            <if test='m33 != null and m33 !="" '>
            ,M_3      /*m33*/
            </if>
            <if test='m22 != null and m22 !="" '>
            ,M_2      /*m22*/
            </if>
            <if test='m11 != null and m11 !="" '>
            ,M_1      /*m11*/
            </if>
            <if test='m0Plan != null and m0Plan !="" '>
            ,M0_PLAN
            </if>
            <if test='m0Ord != null and m0Ord !="" '>
            ,M0_ORD
            </if>

            <if test='m1 != null and m1 !="" '>
            ,M1
            </if>
            <if test='m2 != null and m2 !="" '>
            ,M2
            </if>
            <if test='m3 != null and m3 !="" '>
            ,M3
            </if>
            <if test='m4 != null and m4 !="" '>
            ,M4
            </if>

            <if test='w00 != null and w00 !="" '>
            ,W00
            </if>
            <if test='w01 != null and w01 !="" '>
            ,W01
            </if>
            <if test='w02 != null and w02 !="" '>
            ,W02
            </if>
            <if test='w03 != null and w03 !="" '>
            ,W03
            </if>
            <if test='w04 != null and w04 !="" '>
            ,W04
            </if>
            <if test='w05 != null and w05 !="" '>
            ,W05
            </if>
            <if test='w06 != null and w06 !="" '>
            ,W06
            </if>
            <if test='w07 != null and w07 !="" '>
            ,W07
            </if>
            <if test='w08 != null and w08 !="" '>
            ,W08
            </if>
            <if test='w09 != null and w09 !="" '>
            ,W09
            </if>

            <if test='w10 != null and w10 !="" '>
            ,W10
            </if>
            <if test='w11 != null and w11 !="" '>
            ,W11
            </if>
            <if test='w12 != null and w12 !="" '>
            ,W12
            </if>
            <if test='w13 != null and w13 !="" '>
            ,W13
            </if>
            <if test='w14 != null and w14 !="" '>
            ,W14
            </if>
            <if test='w15 != null and w15 !="" '>
            ,W15
            </if>
            <if test='w16 != null and w16 !="" '>
            ,W16
            </if>
            <if test='w17 != null and w17 !="" '>
            ,W17
            </if>
            <if test='w18 != null and w18 !="" '>
            ,W18
            </if>
            <if test='w19 != null and w19 !="" '>
            ,W19
            </if>

            <if test='w20 != null and w20 !="" '>
            ,W20
            </if>
            <if test='w21 != null and w21 !="" '>
            ,W21
            </if>
            <if test='w22 != null and w22 !="" '>
            ,W22
            </if>
            <if test='w23 != null and w23 !="" '>
            ,W23
            </if>
            <if test='w24 != null and w24 !="" '>
            ,W24
            </if>
            <if test='w25 != null and w25 !="" '>
            ,W25
            </if>
            <if test='w26 != null and w26 !="" '>
            ,W26
            </if>
            <if test='w27 != null and w27 !="" '>
            ,W27
            </if>
            <if test='w28 != null and w28 !="" '>
            ,W28
            </if>
            <if test='w29 != null and w29 !="" '>
            ,W29
            </if>
            <if test='w30 != null and w30 !="" '>
            ,W30
            </if>

            <if test='ws1 != null and ws1 !="" '>
            ,WS1
            </if>
            <if test='ws2 != null and ws2 !="" '>
            ,WS2
            </if>
            <if test='ws3 != null and ws3 !="" '>
            ,WS3
            </if>
            <if test='ws4 != null and ws4 !="" '>
            ,WS4
            </if>
            <if test='ws5 != null and ws5 !="" '>
            ,WS5
            </if>
            )
      VALUES
           (
             #{scm0002dPlanDtlIdSeq}
            ,#{getPlanMasterId}
            ,#{team}
            ,#{newStockCode}

            <if test='preM3AvgOrded != null and preM3AvgOrded !="" '>
            ,#{preM3AvgOrded}
            </if>
            <if test='preM3AvgIssu != null and preM3AvgIssu !="" '>
            ,#{preM3AvgIssu}
            </if>

            <if test='m1Ord != null and m1Ord !="" '>
            ,#{m1Ord}
            </if>
            <if test='m2Ord != null and m2Ord !="" '>
            ,#{m2Ord}
            </if>
            <if test='m3Ord != null and m3Ord !="" '>
            ,#{m3Ord}
            </if>

            <if test='m33 != null and m33 !="" '>
            ,#{m33}
            </if>
            <if test='m22 != null and m22 !="" '>
            ,#{m22}
            </if>
            <if test='m11 != null and m11 !="" '>
            ,#{m11}
            </if>

            <if test='m0Plan != null and m0Plan !="" '>
            ,#{m0Plan}
            </if>
            <if test='m0Ord != null and m0Ord !="" '>
            ,#{m0Ord}
            </if>

            <if test='m1 != null and m1 !="" '>
            ,#{m1}
            </if>
            <if test='m2 != null and m2 !="" '>
            ,#{m2}
            </if>
            <if test='m3 != null and m3 !="" '>
            ,#{m3}
            </if>
            <if test='m4 != null and m4 !="" '>
            ,#{m4}
            </if>

            <if test='w00 != null and w00 !="" '>
            ,#{w00}
            </if>
            <if test='w01 != null and w01 !="" '>
            ,#{w01}
            </if>
            <if test='w02 != null and w02 !="" '>
            ,#{w02}
            </if>
            <if test='w03 != null and w03 !="" '>
            ,#{w03}
            </if>
            <if test='w04 != null and w04 !="" '>
            ,#{w04}
            </if>
            <if test='w05 != null and w05 !="" '>
            ,#{w05}
            </if>
            <if test='w06 != null and w06 !="" '>
            ,#{w06}
            </if>
            <if test='w07 != null and w07 !="" '>
            ,#{w07}
            </if>
            <if test='w08 != null and w08 !="" '>
            ,#{w08}
            </if>
            <if test='w09 != null and w09 !="" '>
            ,#{w09}
            </if>

            <if test='w10 != null and w10 !="" '>
            ,#{w10}
            </if>
            <if test='w11 != null and w11 !="" '>
            ,#{w11}
            </if>
            <if test='w12 != null and w12 !="" '>
            ,#{w12}
            </if>
            <if test='w13 != null and w13 !="" '>
            ,#{w13}
            </if>
            <if test='w14 != null and w14 !="" '>
            ,#{w14}
            </if>
            <if test='w15 != null and w15 !="" '>
            ,#{w15}
            </if>
            <if test='w16 != null and w16 !="" '>
            ,#{w16}
            </if>
            <if test='w17 != null and w17 !="" '>
            ,#{w17}
            </if>
            <if test='w18 != null and w18 !="" '>
            ,#{w18}
            </if>
            <if test='w19 != null and w19 !="" '>
            ,#{w19}
            </if>
            <if test='w20 != null and w20 !="" '>
            ,#{w20}
            </if>

            <if test='w21 != null and w21 !="" '>
            ,#{w21}
            </if>
            <if test='w22 != null and w22 !="" '>
            ,#{w22}
            </if>
            <if test='w23 != null and w23 !="" '>
            ,#{w23}
            </if>
            <if test='w24 != null and w24 !="" '>
            ,#{w24}
            </if>
            <if test='w25 != null and w25 !="" '>
            ,#{w25}
            </if>
            <if test='w26 != null and w26 !="" '>
            ,#{w26}
            </if>
            <if test='w27 != null and w27 !="" '>
            ,#{w27}
            </if>
            <if test='w28 != null and w28 !="" '>
            ,#{w28}
            </if>
            <if test='w29 != null and w29 !="" '>
            ,#{w29}
            </if>
            <if test='w30 != null and w30 !="" '>
            ,#{w30}
            </if>

            <if test='ws1 != null and ws1 !="" '>
            ,#{ws1}
            </if>
            <if test='ws2 != null and ws2 !="" '>
            ,#{ws2}
            </if>
            <if test='ws3 != null and ws3 !="" '>
           ,#{ws3}
            </if>
            <if test='ws4 != null and ws4 !="" '>
            ,#{ws4}
            </if>
            <if test='ws5 != null and ws5 !="" '>
            ,#{ws5}
            </if>
           )

</insert>

<!-- fin -->
<!-- 
<insert id="insertSalesPlanMaster" parameterType="Map">
	<selectKey keyProperty="salesPlanMstSeq" resultType="int" order="BEFORE">
	SELECT SCM0001M_PLAN_ID_SEQ.NEXTVAL FROM DUAL
	</selectKey>
INSERT INTO SCM0001M
(
       PLAN_ID
     , TEAM
     , PLAN_YEAR
     , PLAN_MONTH
     , PLAN_WEEK
     , PLAN_STUS_ID
     , CRT_DT
     , CRT_USER_ID
 )
VALUES
(
       #{salesPlanMstSeq}
     , #{scmTeamCbBox}
     , #{scmYearCbBox}
     , (SELECT SCM_MONTH FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = 1)
     , #{scmPeriodCbBox}
     , 4
     , SYSDATE
     , #{crtUserId}
 )
</insert>
 -->
<delete id="deleteStockCode" parameterType="Map">

    DELETE
      FROM SCM0002D
     WHERE PLAN_MASTER_ID = #{planMasterId}
       AND TEAM = #{team}
       AND STOCK_CODE = #{code}
       AND (SELECT PLAN_STUS_ID
             FROM SCM0001M
            WHERE PLAN_ID = #{planMasterId}
           ) <![CDATA[ <> ]]>  4

</delete>

<!-- fin -->
<update id="updateSalesPlanUnConfirm" parameterType="Map">
UPDATE SCM0001M
   SET PLAN_STUS_ID = 4
 WHERE PLAN_ID = #{planId}
</update>
<!--
<update id="updateSalesPlanUnConfirm" parameterType="Map">
UPDATE SCM0001M
   SET PLAN_STUS_ID = 4
 WHERE PLAN_YEAR = #{scmYearCbBox}
   AND PLAN_WEEK = #{scmPeriodCbBox}
   AND PLAN_MONTH = (SELECT SCM_MONTH FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = 1)
</update> -->
<!-- fin -->
<update id="updateSalesPlanConfirm" parameterType="Map">
UPDATE SCM0001M
   SET PLAN_STUS_ID = 1
 WHERE PLAN_ID = #{planId}
</update>
<!--
<update id="updateSalesPlanConfirm" parameterType="Map">
  UPDATE SCM0001M
     SET PLAN_STUS_ID = 1
   WHERE PLAN_YEAR = #{scmYearCbBox}
     AND PLAN_WEEK = #{scmPeriodCbBox}
     AND PLAN_MONTH= (SELECT SCM_MONTH
                FROM SCM0018M
               WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = 1)
</update>
 -->

<select id="selectAccuracyWeeklyDetail" parameterType="Map" resultType="egovMap">
  SELECT *
    FROM(
         SELECT
               #{scmMonthCbBox} MONTH
             , 'W' || #{scmPeriodCbBox} WEEK
             , STOCK_CODE
             , STOCK_NAME
             , STOCK_CTGRY
             , STK_TYPE_ID

             ,TEAM
             ,SUM(W12_WEEK_00) W12
             ,SUM(W11_WEEK_00) W11
             ,SUM(W10_WEEK_00) W10
             ,SUM(W9_WEEK_00)  W9
             ,SUM(W8_WEEK_00)  W8
             ,SUM(W7_WEEK_00)  W7
             ,SUM(W6_WEEK_00)  W6
             ,SUM(W5_WEEK_00)  W5
             ,SUM(W4_WEEK_00)  W4
             ,SUM(W3_WEEK_00)  W3
             ,SUM(W2_WEEK_00)  W2
             ,SUM(W1_WEEK_00)  W1
             ,SUM(ORD_VALUE) SALES_ORDER
             ,ROUND(AVG(SHORT_TERM_AVG))||'%' SHORT_TERM_AVG
             ,ROUND(AVG(MID_TERM_AVG))||'%'  MID_TERM_AVG

          FROM (
                SELECT
                       TEAM,STOCK_CODE,STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID,ORD_VALUE
                      ,W1_WEEK_00 ,W2_WEEK_00  ,W3_WEEK_00  ,W4_WEEK_00  ,W5_WEEK_00  ,W6_WEEK_00
                      ,W7_WEEK_00 ,W8_WEEK_00  ,W9_WEEK_00  ,W10_WEEK_00 ,W11_WEEK_00 ,W12_WEEK_00
                      ,DECODE(SHORT_TERM_CNT, 0 , 0,  ROUND(SHORT_TERM_SUM / SHORT_TERM_CNT) ) SHORT_TERM_AVG
                      ,DECODE(MID_TERM_CNT, 0, 0,  ROUND(MID_TERM_SUM / MID_TERM_CNT) ) MID_TERM_AVG
                  FROM
                  (
                   SELECT STEP5_DATA.*
                        ,(W1_RATTING + W2_RATTING + W3_RATTING + W4_RATTING + W5_RATTING + W6_RATTING + W7_RATTING +W8_RATTING) SHORT_TERM_SUM
                        ,(W9_RATTING + W10_RATTING + W11_RATTING + W12_RATTING ) MID_TERM_SUM
                        ,( CASE WHEN W1_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W2_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W3_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W4_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         + CASE WHEN W5_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W6_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W7_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W8_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         ) SHORT_TERM_CNT
                        ,( CASE WHEN W9_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W10_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W11_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W12_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END) MID_TERM_CNT
                    FROM
                        (
                           WITH STEP4_DATA
                             AS
                                (
                                  SELECT STEP3_DATA.*
                                       , CASE WHEN ( STEP3_DATA.ORD_VALUE <![CDATA[<]]> STEP3_DATA.WEEK_00  )
                                              THEN ROUND((STEP3_DATA.ORD_VALUE / STEP3_DATA.WEEK_00)*100)
                                              WHEN ( STEP3_DATA.WEEK_00   <![CDATA[<]]> STEP3_DATA.ORD_VALUE  )
                                              THEN ROUND((STEP3_DATA.WEEK_00 / STEP3_DATA.ORD_VALUE)*100)
                                         ELSE
                                            0
                                         END ACCURACY_RATTING
                                  FROM (
                                        SELECT STEP2_DATA.*
                                              ,(SELECT M0_ORD FROM SCM0052V SCM52V WHERE SCM52V.PLAN_YEAR = #{scmYearCbBox}  AND SCM52V.PLAN_MONTH = #{scmMonthCbBox} AND SCM52V.PLAN_WEEK = #{scmPeriodCbBox} AND SCM52V.TEAM = STEP2_DATA.TEAM AND SCM52V.STOCK_CODE = STEP2_DATA.STOCK_CODE) ORD_VALUE
                                          FROM
                                              (
                                                SELECT STEP1_DATA.*
                                                  FROM
                                                      (
                                                        SELECT   1 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year1}
                                                            AND PLAN_WEEK = #{weekTh1}

                                                        UNION ALL

                                                        SELECT  2 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year2}
                                                            AND PLAN_WEEK = #{weekTh2}

                                                          UNION ALL

                                                        SELECT  3 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year3}
                                                            AND PLAN_WEEK = #{weekTh3}

                                                          UNION ALL

                                                        SELECT  4 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year4}
                                                            AND PLAN_WEEK = #{weekTh4}

                                                          UNION ALL

                                                        SELECT  5 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year5}
                                                            AND PLAN_WEEK = #{weekTh5}

                                                          UNION ALL

                                                        SELECT  6 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year6}
                                                            AND PLAN_WEEK = #{weekTh6}

                                                          UNION ALL

                                                        SELECT  7 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year7}
                                                            AND PLAN_WEEK = #{weekTh7}

                                                          UNION ALL

                                                        SELECT  8 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year8}
                                                            AND PLAN_WEEK = #{weekTh8}

                                                          UNION ALL

                                                        SELECT  9 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year9}
                                                            AND PLAN_WEEK = #{weekTh9}

                                                          UNION ALL

                                                        SELECT  10 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year10}
                                                            AND PLAN_WEEK = #{weekTh10}

                                                          UNION ALL

                                                        SELECT  11 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year11}
                                                            AND PLAN_WEEK = #{weekTh11}

                                                          UNION ALL

                                                        SELECT  12 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE
                                                               ,STOCK_NAME
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID
                                                               ,W00 WEEK_00

                                                           FROM SCM0052V
                                                          WHERE PLAN_YEAR = #{year12}
                                                            AND PLAN_WEEK = #{weekTh12}
                                                      )  STEP1_DATA

                                              )  STEP2_DATA
                                        ) STEP3_DATA
                                )
                                SELECT *
                                  FROM STEP4_DATA

                                  PIVOT
                                       (
                                         MAX(WEEK_00) WEEK_00 ,  MAX(ACCURACY_RATTING) RATTING
                                             FOR SEQ IN ( 1 AS W1  ,2 AS W2 ,3 AS W3 , 4 AS W4  , 5 AS W5  , 6 AS W6
                                                         ,7 AS W7  ,8 AS W8 ,9 AS W9 ,10 AS W10 ,11 AS W11 ,12 AS W12
                                                        )
                                       )

                        ) STEP5_DATA

                  )STEP6_DATA

               ) STEP7_DATA
		       <choose>
		        <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
		        WHERE  STK_TYPE_ID IN
		            <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
		                #{item}
		            </foreach>

		        </when>
		      </choose>
          GROUP BY  TEAM ,STOCK_CODE,STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID

        /******************************/

        UNION ALL

        /******************************/

        SELECT  #{scmMonthCbBox}  MONTH
               ,'W' || #{scmPeriodCbBox}  WEEK
               , STOCK_CODE
               , STOCK_NAME
               , STOCK_CTGRY
               , STK_TYPE_ID

               ,'ALL' TEAM
               ,ALL_W12_WEEK_00 W12
               ,ALL_W11_WEEK_00 W11
               ,ALL_W10_WEEK_00 W10
               ,ALL_W9_WEEK_00  W9
               ,ALL_W8_WEEK_00  W8
               ,ALL_W7_WEEK_00  W7
               ,ALL_W6_WEEK_00  W6
               ,ALL_W5_WEEK_00  W5
               ,ALL_W4_WEEK_00  W4
               ,ALL_W3_WEEK_00  W3
               ,ALL_W2_WEEK_00  W2
               ,ALL_W1_WEEK_00  W1
               ,ORD_VALUE SALES_ORDER
               , CASE WHEN ALL_SHORT_CNT <![CDATA[>]]> 0 THEN ROUND(( (ALL_W8_RATTING + ALL_W7_RATTING + ALL_W6_RATTING + ALL_W5_RATTING
                                                        + ALL_W4_RATTING + ALL_W3_RATTING + ALL_W2_RATTING + ALL_W1_RATTING) / ALL_SHORT_CNT ))
                                            ELSE 0 END  ||'%'
                 SHORT_TERM_AVG
               , CASE WHEN ALL_MID_CNT <![CDATA[>]]> 0 THEN ROUND(((ALL_W12_RATTING + ALL_W11_RATTING + ALL_W10_RATTING + ALL_W9_RATTING ) / ALL_MID_CNT ))
                                           ELSE 0 END  ||'%'
                 MID_TERM_AVG

          FROM (
                  /* ALL_RATING_AVG */
                  SELECT SUM_TEMP2.*

                        ,( CASE WHEN ALL_W1_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W2_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W3_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W4_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         + CASE WHEN ALL_W5_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W6_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W7_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W8_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         ) ALL_SHORT_CNT
                        ,( CASE WHEN ALL_W9_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W10_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W11_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W12_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         ) ALL_MID_CNT

                   FROM (
                            SELECT TEAM, STOCK_CODE, STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID, ORD_VALUE
                                  ,ALL_W1_WEEK_00  ,ALL_W2_WEEK_00 ,ALL_W3_WEEK_00 ,ALL_W4_WEEK_00 ,ALL_W5_WEEK_00 ,ALL_W6_WEEK_00
                                  ,ALL_W7_WEEK_00  ,ALL_W8_WEEK_00 ,ALL_W9_WEEK_00 ,ALL_W10_WEEK_00 ,ALL_W11_WEEK_00 ,ALL_W12_WEEK_00
                                  ,CASE WHEN ALL_W12_WEEK_00   <![CDATA[<]]> ALL_W12_ORD_VALUE THEN ROUND((ALL_W12_WEEK_00 / ALL_W12_ORD_VALUE )*100)
                                        WHEN ALL_W12_ORD_VALUE <![CDATA[<]]> ALL_W12_WEEK_00 THEN ROUND((ALL_W12_ORD_VALUE / ALL_W12_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W12_RATTING
                                  ,CASE WHEN ALL_W11_WEEK_00   <![CDATA[<]]> ALL_W11_ORD_VALUE THEN ROUND((ALL_W11_WEEK_00 / ALL_W11_ORD_VALUE )*100)
                                        WHEN ALL_W11_ORD_VALUE <![CDATA[<]]> ALL_W11_WEEK_00 THEN ROUND((ALL_W11_ORD_VALUE / ALL_W11_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W11_RATTING
                                  ,CASE WHEN ALL_W10_WEEK_00   <![CDATA[<]]> ALL_W10_ORD_VALUE THEN ROUND((ALL_W10_WEEK_00 / ALL_W10_ORD_VALUE )*100)
                                        WHEN ALL_W10_ORD_VALUE <![CDATA[<]]> ALL_W10_WEEK_00 THEN ROUND((ALL_W10_ORD_VALUE / ALL_W10_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W10_RATTING
                                  ,CASE WHEN ALL_W9_WEEK_00   <![CDATA[<]]> ALL_W9_ORD_VALUE THEN ROUND((ALL_W9_WEEK_00 / ALL_W9_ORD_VALUE )*100)
                                        WHEN ALL_W9_ORD_VALUE <![CDATA[<]]> ALL_W9_WEEK_00 THEN ROUND((ALL_W9_ORD_VALUE / ALL_W9_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W9_RATTING
                                  ,CASE WHEN ALL_W8_WEEK_00   <![CDATA[<]]> ALL_W8_ORD_VALUE THEN ROUND((ALL_W8_WEEK_00 / ALL_W8_ORD_VALUE )*100)
                                        WHEN ALL_W8_ORD_VALUE <![CDATA[<]]> ALL_W8_WEEK_00 THEN ROUND((ALL_W8_ORD_VALUE / ALL_W8_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W8_RATTING
                                  ,CASE WHEN ALL_W7_WEEK_00   <![CDATA[<]]> ALL_W7_ORD_VALUE THEN ROUND((ALL_W7_WEEK_00 / ALL_W7_ORD_VALUE )*100)
                                        WHEN ALL_W7_ORD_VALUE <![CDATA[<]]> ALL_W7_WEEK_00 THEN ROUND((ALL_W7_ORD_VALUE / ALL_W7_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W7_RATTING
                                  ,CASE WHEN ALL_W6_WEEK_00   <![CDATA[<]]> ALL_W6_ORD_VALUE THEN ROUND((ALL_W6_WEEK_00 / ALL_W6_ORD_VALUE )*100)
                                        WHEN ALL_W6_ORD_VALUE <![CDATA[<]]> ALL_W6_WEEK_00 THEN ROUND((ALL_W6_ORD_VALUE / ALL_W6_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W6_RATTING
                                  ,CASE WHEN ALL_W5_WEEK_00   <![CDATA[<]]> ALL_W5_ORD_VALUE THEN ROUND((ALL_W5_WEEK_00 / ALL_W5_ORD_VALUE )*100)
                                        WHEN ALL_W5_ORD_VALUE <![CDATA[<]]> ALL_W5_WEEK_00 THEN ROUND((ALL_W5_ORD_VALUE / ALL_W5_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W5_RATTING
                                  ,CASE WHEN ALL_W4_WEEK_00   <![CDATA[<]]> ALL_W4_ORD_VALUE THEN ROUND((ALL_W4_WEEK_00 / ALL_W4_ORD_VALUE )*100)
                                        WHEN ALL_W4_ORD_VALUE <![CDATA[<]]> ALL_W4_WEEK_00 THEN ROUND((ALL_W4_ORD_VALUE / ALL_W4_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W4_RATTING
                                  ,CASE WHEN ALL_W3_WEEK_00   <![CDATA[<]]> ALL_W3_ORD_VALUE THEN ROUND((ALL_W3_WEEK_00 / ALL_W3_ORD_VALUE )*100)
                                        WHEN ALL_W3_ORD_VALUE <![CDATA[<]]> ALL_W3_WEEK_00 THEN ROUND((ALL_W3_ORD_VALUE / ALL_W3_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W3_RATTING
                                  ,CASE WHEN ALL_W2_WEEK_00   <![CDATA[<]]> ALL_W2_ORD_VALUE THEN ROUND((ALL_W2_WEEK_00 / ALL_W2_ORD_VALUE )*100)
                                        WHEN ALL_W2_ORD_VALUE <![CDATA[<]]> ALL_W2_WEEK_00   THEN ROUND((ALL_W2_ORD_VALUE / ALL_W2_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W2_RATTING
                                  ,CASE WHEN ALL_W1_WEEK_00   <![CDATA[<]]> ALL_W1_ORD_VALUE THEN ROUND((ALL_W1_WEEK_00 / ALL_W1_ORD_VALUE )*100)
                                        WHEN ALL_W1_ORD_VALUE <![CDATA[<]]> ALL_W1_WEEK_00   THEN ROUND((ALL_W1_ORD_VALUE / ALL_W1_WEEK_00 )*100)
                                        ELSE 0
                                   END ALL_W1_RATTING

                                  FROM
                                      (
                                        SELECT 'ALL' TEAM, STOCK_CODE, STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID
				                                       ,SUM(ORD_VALUE) ORD_VALUE
				                                       ,SUM(W1_WEEK_00) ALL_W1_WEEK_00 ,SUM(ORD_VALUE) ALL_W1_ORD_VALUE
				                                       ,SUM(W2_WEEK_00) ALL_W2_WEEK_00 ,SUM(ORD_VALUE) ALL_W2_ORD_VALUE
				                                       ,SUM(W3_WEEK_00) ALL_W3_WEEK_00 ,SUM(ORD_VALUE) ALL_W3_ORD_VALUE
				                                       ,SUM(W4_WEEK_00) ALL_W4_WEEK_00 ,SUM(ORD_VALUE) ALL_W4_ORD_VALUE
				                                       ,SUM(W5_WEEK_00) ALL_W5_WEEK_00 ,SUM(ORD_VALUE) ALL_W5_ORD_VALUE
				                                       ,SUM(W6_WEEK_00) ALL_W6_WEEK_00 ,SUM(ORD_VALUE) ALL_W6_ORD_VALUE
				                                       ,SUM(W7_WEEK_00) ALL_W7_WEEK_00 ,SUM(ORD_VALUE) ALL_W7_ORD_VALUE
				                                       ,SUM(W8_WEEK_00) ALL_W8_WEEK_00 ,SUM(ORD_VALUE) ALL_W8_ORD_VALUE
				                                       ,SUM(W9_WEEK_00) ALL_W9_WEEK_00 ,SUM(ORD_VALUE) ALL_W9_ORD_VALUE
				                                       ,SUM(W10_WEEK_00) ALL_W10_WEEK_00 ,SUM(ORD_VALUE) ALL_W10_ORD_VALUE
				                                       ,SUM(W11_WEEK_00) ALL_W11_WEEK_00 ,SUM(ORD_VALUE) ALL_W11_ORD_VALUE
				                                       ,SUM(W12_WEEK_00) ALL_W12_WEEK_00 ,SUM(ORD_VALUE) ALL_W12_ORD_VALUE
                                  FROM (
                                        SELECT
                                             TEAM,STOCK_CODE, STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID,ORD_VALUE
                                              ,W1_WEEK_00 ,W1_RATTING  ,W2_WEEK_00 ,W2_RATTING  ,W3_WEEK_00,W3_RATTING  ,W4_WEEK_00,W4_RATTING   ,W5_WEEK_00,W5_RATTING   ,W6_WEEK_00  ,W6_RATTING
                                              ,W7_WEEK_00 ,W7_RATTING  ,W8_WEEK_00,W8_RATTING   ,W9_WEEK_00,W9_RATTING  ,W10_WEEK_00,W10_RATTING ,W11_WEEK_00,W11_RATTING ,W12_WEEK_00 ,W12_RATTING
                                              ,DECODE(SHORT_TERM_CNT, 0, 0,  ROUND(SHORT_TERM_SUM / SHORT_TERM_CNT) ) SHORT_TERM_AVG
                                              ,DECODE(MID_TERM_CNT  , 0, 0,  ROUND(MID_TERM_SUM   / MID_TERM_CNT) ) MID_TERM_AVG
                                          FROM
                                          (
                                           SELECT STEP5_DATA.*
                                                ,(W1_RATTING + W2_RATTING + W3_RATTING + W4_RATTING + W5_RATTING + W6_RATTING + W7_RATTING +W8_RATTING) SHORT_TERM_SUM
                                                ,(W9_RATTING + W10_RATTING + W11_RATTING + W12_RATTING ) MID_TERM_SUM
                                                ,( CASE WHEN W1_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W2_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W3_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W4_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                                                 + CASE WHEN W5_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W6_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W7_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W8_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                                                 ) SHORT_TERM_CNT
                                                ,( CASE WHEN W9_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W10_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W11_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W12_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END) MID_TERM_CNT
                                            FROM
                                                (
                                                   WITH STEP4_DATA
                                                     AS
                                                        (
                                                          SELECT STEP3_DATA.*
                                                               , CASE WHEN ( STEP3_DATA.ORD_VALUE <![CDATA[<]]> STEP3_DATA.WEEK_00  )
                                                                      THEN ROUND((STEP3_DATA.ORD_VALUE / STEP3_DATA.WEEK_00)*100)
                                                                      WHEN ( STEP3_DATA.WEEK_00   <![CDATA[<]]> STEP3_DATA.ORD_VALUE  )
                                                                      THEN ROUND((STEP3_DATA.WEEK_00 / STEP3_DATA.ORD_VALUE)*100)
                                                                 ELSE
                                                                    0
                                                                 END ACCURACY_RATTING
                                                          FROM (
                                                                SELECT STEP2_DATA.*
                                                                      ,(SELECT M0_ORD FROM SCM0052V SCM52V WHERE SCM52V.PLAN_YEAR = #{scmYearCbBox}  AND SCM52V.PLAN_MONTH = #{scmMonthCbBox} AND SCM52V.PLAN_WEEK = #{scmPeriodCbBox} AND SCM52V.TEAM = STEP2_DATA.TEAM AND SCM52V.STOCK_CODE = STEP2_DATA.STOCK_CODE) ORD_VALUE
                                                                  FROM
                                                                      (
                                                                        SELECT STEP1_DATA.*
                                                                          FROM
                                                                              (
                                                                                SELECT   1 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year1}
                                                                                    AND PLAN_WEEK = #{weekTh1}

                                                                                UNION ALL

                                                                                SELECT  2 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year2}
                                                                                    AND PLAN_WEEK = #{weekTh2}

                                                                                  UNION ALL

                                                                                SELECT  3 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year3}
                                                                                    AND PLAN_WEEK = #{weekTh3}

                                                                                  UNION ALL

                                                                                SELECT  4 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year4}
                                                                                    AND PLAN_WEEK = #{weekTh4}

                                                                                  UNION ALL

                                                                                SELECT  5 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year5}
                                                                                    AND PLAN_WEEK = #{weekTh5}

                                                                                  UNION ALL

                                                                                SELECT  6 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year6}
                                                                                    AND PLAN_WEEK = #{weekTh6}

                                                                                  UNION ALL

                                                                                SELECT  7 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year7}
                                                                                    AND PLAN_WEEK = #{weekTh7}

                                                                                  UNION ALL

                                                                                SELECT  8 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year8}
                                                                                    AND PLAN_WEEK = #{weekTh8}

                                                                                  UNION ALL

                                                                                SELECT  9 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year9}
                                                                                    AND PLAN_WEEK = #{weekTh9}

                                                                                  UNION ALL

                                                                                SELECT  10 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year10}
                                                                                    AND PLAN_WEEK = #{weekTh10}

                                                                                  UNION ALL

                                                                                SELECT  11 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year11}
                                                                                    AND PLAN_WEEK = #{weekTh11}

                                                                                  UNION ALL

                                                                                SELECT  12 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE
                                                                                       ,STOCK_NAME
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID
                                                                                       ,W00 WEEK_00

                                                                                   FROM SCM0052V
                                                                                  WHERE PLAN_YEAR = #{year12}
                                                                                    AND PLAN_WEEK = #{weekTh12}
                                                                              )  STEP1_DATA
                                                                      )  STEP2_DATA
                                                                ) STEP3_DATA
                                                        )
                                                        SELECT *
                                                          FROM STEP4_DATA

                                                          PIVOT
                                                               (
                                                                 MAX(WEEK_00) WEEK_00 ,  MAX(ACCURACY_RATTING) RATTING
                                                                     FOR SEQ IN ( 1 AS W1  ,2 AS W2 ,3 AS W3 ,4 AS W4   ,5 AS W5   ,6 AS W6
                                                                                 ,7 AS W7  ,8 AS W8 ,9 AS W9 ,10 AS W10 ,11 AS W11 ,12 AS W12
                                                                                )
                                                               )

                                                ) STEP5_DATA

                                          )STEP6_DATA

                                       ) STEP7_DATA
                                       GROUP BY STOCK_CODE,STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID
                                      ) SUM_TEMP1

                         ) SUM_TEMP2

           ) SUM_TEMP3

      ) WEEKLY_DETAIL
       <choose>
        <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
        WHERE  STK_TYPE_ID IN
            <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>

        </when>
      </choose>
  ORDER BY STOCK_CODE, DECODE(TEAM,'CODY',1,'DST',2 ,3)

</select>

<select id="selectAccuracyMonthlyReport" parameterType="Map" resultType="egovMap">
  WITH HEAD_MONTHLY1
  AS
    (
	     SELECT AB.*
	       FROM (
	             SELECT *
	               FROM (
	                     SELECT GBN||'_TERM' GBN, TEAM,WEEK,ROUND(TERM_AVG/TERM_AVG_CNT) ACCRU_RAT
	                       FROM (
		                            SELECT 'MID' GBN, TEAM,WEEK, SUM(MID_TERM_AVG) TERM_AVG, COUNT(*) TERM_AVG_CNT
		                              FROM GBL_TEMP_ACCURACY
		                             WHERE (MID_TERM_AVG > 0 )
		                           <choose>
												        <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
												           AND  STK_TYPE_ID IN
												            <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
												                #{item}
												            </foreach>

												        </when>
												      </choose>
		                             GROUP BY TEAM,WEEK

		                            UNION ALL

		                            SELECT 'SHORT' GBN,  TEAM,WEEK, SUM(SHORT_TERM_AVG) TERM_AVG, COUNT(*) TERM_AVG_CNT
		                              FROM GBL_TEMP_ACCURACY
		                             WHERE (SHORT_TERM_AVG > 0 )
                               <choose>
                                <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
                                   AND  STK_TYPE_ID IN
                                    <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
                                        #{item}
                                    </foreach>

                                </when>
                              </choose>
		                             GROUP BY TEAM,WEEK
	                           )
	                    )

	                      PIVOT
	                            (
	                              MAX(ACCRU_RAT)
	                                 FOR WEEK IN (   1 AS W1  , 2 AS W2   ,3 AS W3   ,4 AS W4   ,5 AS W5   ,6 AS W6   ,7 AS W7   ,8 AS W8   ,9 AS W9   ,10 AS W10
	                                               ,11 AS W11 ,12 AS W12 ,13 AS W13 ,14 AS W14 ,15 AS W15 ,16 AS W16 ,17 AS W17 ,18 AS W18 ,19 AS W19 ,20 AS W20
	                                               ,21 AS W21 ,22 AS W22 ,23 AS W23 ,24 AS W24 ,25 AS W25 ,26 AS W26 ,27 AS W27 ,28 AS W28 ,29 AS W29 ,30 AS W30
	                                               ,31 AS W31 ,32 AS W32 ,33 AS W33 ,34 AS W34 ,35 AS W35 ,36 AS W36 ,37 AS W37 ,38 AS W38 ,39 AS W39 ,40 AS W40
	                                               ,41 AS W41 ,42 AS W42 ,43 AS W43 ,44 AS W44 ,45 AS W45 ,46 AS W46 ,47 AS W47 ,48 AS W48 ,49 AS W49 ,50 AS W50
	                                               ,51 AS W51 ,52 AS W52)
	                            )
	            )  AB
    )

  , HEAD_MONTHLY2
    AS
    (
      SELECT
             TEAM
            ,GBN||'_TERM' GBN
            ,ROUND(SUM(ACCRU_RAT) / ( SELECT COUNT(1) CNT FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND SCM_MONTH = #{scmMonthCbBox} AND WEEK_TH_SN = 1) ) MONTHLY_ACCRURAY
        FROM(
	             SELECT GBN, TEAM,WEEK, ROUND((SUM_TERM_AVG/TERM_AVG_CNT)) ACCRU_RAT
	               FROM (
		                     SELECT 'MID' GBN, TEAM,WEEK, SUM(MID_TERM_AVG) SUM_TERM_AVG, COUNT(*) TERM_AVG_CNT
		                      FROM GBL_TEMP_ACCURACY
		                     WHERE (MID_TERM_AVG > 0 )
                       <choose>
                        <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
                           AND  STK_TYPE_ID IN
                            <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
                                #{item}
                            </foreach>

                        </when>
                      </choose>
		                     GROUP BY TEAM,WEEK

		                    UNION ALL

		                    SELECT 'SHORT' GBN, TEAM,WEEK, SUM(SHORT_TERM_AVG) SUM_TERM_AVG, COUNT(*) TERM_AVG_CNT
		                      FROM GBL_TEMP_ACCURACY
		                     WHERE (SHORT_TERM_AVG > 0 )
                       <choose>
                        <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
                           AND  STK_TYPE_ID IN
                            <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
                                #{item}
                            </foreach>

                        </when>
                      </choose>
		                     GROUP BY TEAM,WEEK
	                   )
            )
      GROUP BY ROLLUP ( GBN ,TEAM )
      HAVING  TEAM IS NOT NULL
    )
     SELECT  H1.TEAM
            ,H1.GBN TERM
            ,H2.MONTHLY_ACCRURAY
            ,H1.*
       FROM HEAD_MONTHLY1 H1
           ,HEAD_MONTHLY2 H2
      WHERE H1.GBN  = H2.GBN
        AND H1.TEAM = H2.TEAM
      ORDER BY DECODE(H1.TEAM,'ALL',1,'DST',2,3), DECODE(TERM,'SHORT_TERM',1,2)

</select>

<resultMap id="salePlanDetailInsertMap" type="egovMap"></resultMap>
<select id="callSpCreateSalesPlanDetail" statementType="CALLABLE" parameterType="Map">
    { call SP_CREATE_SALES_PLAN_DETAIL(
		                                    #{salesPlanMstSeq}
		                                  , #{scmYearCbBox}
		                                  , #{scmPeriodCbBox}
		                                  , #{scmTeamCbBox}
		                                  , #{p1, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=salePlanDetailInsertMap})
    }
</select>

<resultMap id="salePlanAccuracyInsertMap" type="egovMap"></resultMap>
<select id="callSpCreateMonthlyAccuracy" statementType="CALLABLE" parameterType="Map">
    { call SP_INS_SCM_ACCURACY(
                                  #{scmYearCbBox}
                                , #{scmMonthCbBox}
                                , #{scmPeriodCbBox}
                                , #{rtnVal,  mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=salePlanAccuracyInsertMap})
    }
</select>


	<select id="selectSeperation2" parameterType="Map" resultType="egovMap">
		 SELECT
	               M0.REC_CNT M0_TOT_CNT,
			       M1.REC_CNT M1_TOT_CNT,
			       M2.REC_CNT M2_TOT_CNT,
			       M3.REC_CNT M3_TOT_CNT,
			       M4.REC_CNT M4_TOT_CNT
			       FROM (  SELECT COUNT (SCM_YEAR) REC_CNT
			       FROM SCM0018M
			       WHERE to_char(week_th_sn_end,'YYYYMM') = #{scmYearCbBox}||LPAD(#{selectPlanMonth},2,0)  AND USE_YN = 'Y'/*  AND NVL (USE_YN, 'Y') = 'Y'*/
			      ) M0,
			     (  SELECT  COUNT (SCM_YEAR) REC_CNT
			     FROM SCM0018M
			     WHERE    to_char(week_th_sn_end,'YYYYMM')=(SELECT TO_CHAR(ADD_MONTHS(TO_DATE(#{scmYearCbBox}||LPAD(#{selectPlanMonth},2,0),'YYYYMM'),1),'YYYYMM') FROM DUAL)
			     AND USE_YN = 'Y'/*AND NVL (USE_YN, 'Y') = 'Y'*/
			     ) M1,
			     (  SELECT  COUNT (SCM_YEAR) REC_CNT
			     FROM SCM0018M
			     WHERE     to_char(week_th_sn_end,'YYYYMM')=(SELECT TO_CHAR(ADD_MONTHS(TO_DATE(#{scmYearCbBox}||LPAD(#{selectPlanMonth},2,0),'YYYYMM'),2),'YYYYMM') FROM DUAL)
			      AND USE_YN = 'Y'/*AND NVL (USE_YN, 'Y') = 'Y'*/
			      ) M2,
			     (  SELECT  COUNT (SCM_YEAR) REC_CNT
			     FROM SCM0018M
			     WHERE     to_char(week_th_sn_end,'YYYYMM')=(SELECT TO_CHAR(ADD_MONTHS(TO_DATE(#{scmYearCbBox}||LPAD(#{selectPlanMonth},2,0),'YYYYMM'),3),'YYYYMM') FROM DUAL)
			     AND USE_YN = 'Y'/*AND NVL (USE_YN, 'Y') = 'Y'*/
			     ) M3,
			     (  SELECT  COUNT (SCM_YEAR) REC_CNT
			      FROM SCM0018M
			      WHERE     to_char(week_th_sn_end,'YYYYMM')=(SELECT TO_CHAR(ADD_MONTHS(TO_DATE(#{scmYearCbBox}||LPAD(#{selectPlanMonth},2,0),'YYYYMM'),4),'YYYYMM') FROM DUAL)
			        AND USE_YN = 'Y'/*AND NVL (USE_YN, 'Y') = 'Y'*/
			      ) M4
			     WHERE ROWNUM = 1
    </select>

    <select id="selectSupplyPlanListByCdc" parameterType="Map" resultType="egovMap">
			SELECT STOCK_CODE, NVL(MOQ,0) MOQ FROM SCM0017M
			 WHERE CDC_CODE = DECODE(#{cdcCbBox},'2010','KL','2020','PN','2030','JB','2040','KK','2050','KC',#{cdcCbBox})
		  	   AND IS_TRGET = '1'
    </select>

    <select id="selectSalesPlanList" parameterType="Map" resultType="egovMap">
			SELECT STOCK_CODE
			  FROM SCM0008M
			 WHERE IS_TRGET = '1'
			   AND ((SELECT WEEK_TH_SN_START FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1') BETWEEN START_DT AND END_DT
       				 OR (SELECT WEEK_TH_SN_END FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1') BETWEEN START_DT AND END_DT)
    </select>

    <select id="selectSalesPlanByStockCode" parameterType="Map" resultType="egovMap">
			SELECT WEEKSUM.STOCK_CODE,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W00 * (RATING/100)),0) END AS W00,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W01 * (RATING/100)),0) END AS W01,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W02 * (RATING/100)),0) END AS W02,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W03 * (RATING/100)),0) END AS W03,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W04 * (RATING/100)),0) END AS W04,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W05 * (RATING/100)),0) END AS W05,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W06 * (RATING/100)),0) END AS W06,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W07 * (RATING/100)),0) END AS W07,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W08 * (RATING/100)),0) END AS W08,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W09 * (RATING/100)),0) END AS W09,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W10 * (RATING/100)),0) END AS W10,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W11 * (RATING/100)),0) END AS W11,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W12 * (RATING/100)),0) END AS W12,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W13 * (RATING/100)),0) END AS W13,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W14 * (RATING/100)),0) END AS W14,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W15 * (RATING/100)),0) END AS W15,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W16 * (RATING/100)),0) END AS W16,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W17 * (RATING/100)),0) END AS W17,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W18 * (RATING/100)),0) END AS W18,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W19 * (RATING/100)),0) END AS W19,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W20 * (RATING/100)),0) END AS W20,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W21 * (RATING/100)),0) END AS W21,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W22 * (RATING/100)),0) END AS W22,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W23 * (RATING/100)),0) END AS W23,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W24 * (RATING/100)),0) END AS W24,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W25 * (RATING/100)),0) END AS W25,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W26 * (RATING/100)),0) END AS W26,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W27 * (RATING/100)),0) END AS W27,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W28 * (RATING/100)),0) END AS W28,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W29 * (RATING/100)),0) END AS W29,
			       CASE WHEN RATING = 0 THEN 0 ELSE NVL(ROUND(W30 * (RATING/100)),0) END AS W30 FROM
			(SELECT STOCK_CODE, SUM(W00) AS W00 ,SUM(W01)  AS W01 ,SUM(W02)  AS W02 ,SUM(W03)  AS W03 ,SUM(W04)  AS W04
			     , SUM(W05)  AS W05 ,SUM(W06)  AS W06 ,SUM(W07)  AS W07 ,SUM(W08)  AS W08 ,SUM(W09)  AS W09
			     , SUM(W10)  AS W10 ,SUM(W11)  AS W11 ,SUM(W12)  AS W12 ,SUM(W13)  AS W13 ,SUM(W14)  AS W14
			     , SUM(W15)  AS W15 ,SUM(W16)  AS W16 ,SUM(W17)  AS W17 ,SUM(W18)  AS W18 ,SUM(W19)  AS W19
			     , SUM(W20)  AS W20 ,SUM(W21)  AS W21 ,SUM(W22)  AS W22 ,SUM(W23)  AS W23 ,SUM(W24)  AS W24
			     , SUM(W25)  AS W25 ,SUM(W26)  AS W26 ,SUM(W27)  AS W27 ,SUM(W28)  AS W28 ,SUM(W29)  AS W29 ,SUM(W30)  AS W30
			  FROM SCM0001M SCM01M, SCM0002D SCM02D
			 WHERE SCM01M.PLAN_ID = SCM02D.PLAN_MASTER_ID
			   AND SCM01M.PLAN_YEAR = #{scmYearCbBox}
			   AND SCM01M.PLAN_WEEK = #{scmPeriodCbBox}
			   AND SCM02D.STOCK_CODE = #{stockCode}
			   GROUP BY STOCK_CODE) WEEKSUM,
			(WITH ALIST
			             AS(
			                SELECT STOCK_CODE,STOCK_NAME,CDC,M3,M2,M1,ROUND(((M3+M2+M1)/3),0) AVG
			                FROM(
			                      SELECT DECODE(CDC,'ALL','TOT',STOCK_CODE) STOCK_CODE
			                            ,STOCK_NAME
			                            ,NVL(CDC,'ALL') CDC
			                            ,SUM(M_3) M3
			                            ,SUM(M_2) M2
			                            ,SUM(M_1) M1
			                      FROM(
			                            SELECT T0.STOCK_CODE
			                                 ,STK.STK_DESC AS STOCK_NAME
			                                 ,T0.CDC
			                                 ,NVL(T3.M3_TOTAL,0) AS M_3
			                                 ,NVL(T2.M2_TOTAL,0) AS M_2
			                                 ,NVL(T1.M1_TOTAL,0) AS M_1
			                             FROM (
			                                     SELECT DISTINCT T0.CDC_CODE AS CDC,T1.STOCK_CODE
			                                     FROM SCM0016M T0
			                                     CROSS JOIN SCM0008M T1
			                                     CROSS JOIN (SELECT DISTINCT SCM_YEAR, SCM_MONTH FROM SCM0031S T1
			                                                  WHERE (T1.SCM_YEAR= EXTRACT(YEAR FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),-1))) AND T1.SCM_MONTH=EXTRACT(MONTH FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),-1))))
			                                                     OR (T1.SCM_YEAR= EXTRACT(YEAR FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),-2))) AND T1.SCM_MONTH=EXTRACT(MONTH FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),-2))))
			                                                     OR (T1.SCM_YEAR= EXTRACT(YEAR FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),-3))) AND T1.SCM_MONTH=EXTRACT(MONTH FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),-3))))
			                                                ) T2
			                                  ) T0
			                             LEFT JOIN (
			                                 SELECT SCM_YEAR,SCM_MONTH,CDC,STOCK_CODE,M_1 AS M1_TOTAL
			                                 FROM SCM0030S T1
			                                 WHERE T1.SCM_YEAR=EXTRACT(YEAR FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),0))) AND T1.SCM_MONTH=EXTRACT(MONTH FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),0)))
			                             ) T1 ON T1.CDC=T0.CDC AND T1.STOCK_CODE=T0.STOCK_CODE
			                             LEFT JOIN (
			                                 SELECT SCM_YEAR,SCM_MONTH,CDC,STOCK_CODE,M_2 AS M2_TOTAL
			                                 FROM SCM0030S T1
			                                 WHERE T1.SCM_YEAR=EXTRACT(YEAR FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),0))) AND T1.SCM_MONTH=EXTRACT(MONTH FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),0)))
			                             ) T2 ON T2.CDC=T0.CDC AND T2.STOCK_CODE=T0.STOCK_CODE
			                             LEFT JOIN (
			                                 SELECT SCM_YEAR,SCM_MONTH,CDC,STOCK_CODE,M_3 AS M3_TOTAL
			                                 FROM SCM0030S T1
			                                 WHERE T1.SCM_YEAR=EXTRACT(YEAR FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),0))) AND T1.SCM_MONTH=EXTRACT(MONTH FROM(ADD_MONTHS(TO_DATE((SELECT SCM_YYYYMM FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'),'YYYYMM'),0)))
			                             ) T3 ON T3.CDC=T0.CDC AND T3.STOCK_CODE=T0.STOCK_CODE
			                             JOIN SYS0026M STK ON STK.STK_CODE=T0.STOCK_CODE
			                             WHERE T0.STOCK_CODE= #{stockCode}
			                       )
			                       GROUP BY ROLLUP (STOCK_CODE,STOCK_NAME,CDC)
			                       HAVING GROUPING(STOCK_CODE) = 0 AND STOCK_NAME IS NOT NULL
			                      )
			              )
			              SELECT STOCK_CODE, DECODE(A.AVG,0,0,ROUND(((A.AVG / (SELECT  B.AVG FROM ALIST B WHERE A.STOCK_CODE = B.STOCK_CODE AND CDC ='ALL')) * 100),2)) RATING
			                FROM ALIST A
			               WHERE CDC = DECODE(#{cdcCbBox},'2010','KL','2020','PN','2030','JB','2040','KK','2050','KC',#{cdcCbBox})) RATINGLIST
						   WHERE WEEKSUM.STOCK_CODE = RATINGLIST.STOCK_CODE(+)
    </select>

    <select id="selectCountasIn" parameterType="Map" resultType="int">
			SELECT COUNT(1) CNT FROM SCM0018M WHERE SCM_YEAR= #{scmYearCbBox} AND SCM_MONTH = #{selectPlanMonth} AND WEEK_TH  <![CDATA[ < ]]>  #{scmPeriodCbBox}
    </select>

    <select id="selectBeforeOrdCnt" parameterType="Map" resultType="int">
			SELECT NVL(SUM(ORD_CNT),0) ORD_CNT
			  FROM SCM0008M SCM08M,
			  (SELECT ORD_CNT, STOCK_CODE
			     FROM SCM0044S
			    WHERE SCM_YEAR = #{scmYearCbBox}
			      AND SCM_WEEK_TH= #{scmPeriodCbBoxBefore}
			      AND STOCK_CODE = #{stockCode}
			      AND CDC = DECODE(#{cdcCbBox},'2010','KL','2020','PN','2030','JB','2040','KK','2050','KC',#{cdcCbBox})) SCM30S
			 WHERE SCM08M.STOCK_CODE = SCM30S.STOCK_CODE(+)
			   AND SCM08M.STOCK_CODE = #{stockCode}
    </select>

    <select id="selectSafetyStock" parameterType="Map" resultType="int">
			SELECT SAFETY_STOCK FROM SCM0008M WHERE STOCK_CODE = #{stockCode}
    </select>

    <select id="selectLeadTimeByCdc" parameterType="Map" resultType="egovMap">
			SELECT LEAD_TM FROM SCM0008M WHERE STOCK_CODE = #{stockCode}
    </select>

    <select id="selectEndingInventory" parameterType="Map" resultType="int">
			SELECT NVL(SUM(QTY)+SUM(MOV_QTY),0) QTY
			  FROM LOG0088M LOG88M, SYS0028M SYS28M
			 WHERE SYS28M.WH_LOC_ID  = LOG88M.LOG_ID
			   AND SYS28M.CDC_CODE = #{cdcCbBox}
			   AND LOG88M.ZMONTH = (#{selectYearBefore} || LPAD(#{selectPlanMonthBefore},2,0))
			   AND LOG88M.STK_CODE = #{stockCode}
    </select>

    <select id="selectBeforeWeekYear" parameterType="Map" resultType="int">
			SELECT MAX(WEEK_TH) FROM SCM0018M WHERE SCM_YEAR = #{selectYearBeforeWeekParam}
    </select>

    <select id="selectBeforePoCnt" parameterType="Map" resultType="int">
			SELECT NVL(SUM(QTY),0) QTY FROM
				(SELECT SCM10D.STOCK_CODE, SCM10D.PO_ITM_APPV_STUS, NVL(SCM10D.QTY,0) QTY, SCM09M.BAS_YEAR, SCM09M.EST_WEEK, SCM09M.GR_WEEK
				   FROM SCM0009M SCM09M, SCM0010D SCM10D
				  WHERE SCM09M.PO_NO = SCM10D.PO_NO
				    AND SCM10D.PO_ITM_APPV_STUS = '5'
				    AND SCM09M.CDC = DECODE(#{cdcCbBox},'2010','KL','2020','PN','2030','JB','2040','KK','2050','KC',#{cdcCbBox})
				    AND BAS_YEAR = #{scmYearCbBox}
		            AND EST_WEEK = #{scmPeriodCbBoxBefore}
				  ) A, SCM0008M SCM08M
				WHERE SCM08M.STOCK_CODE = A.STOCK_CODE(+)
				  AND SCM08M.STOCK_CODE = #{stockCode}
    </select>

    <select id="selectAfterPoCnt" parameterType="Map" resultType="int">
    SELECT NVL(SUM(QTY),0) QTY FROM
		(SELECT SCM10D.STOCK_CODE, SCM10D.PO_ITM_APPV_STUS, NVL(SCM10D.QTY,0) QTY, SCM09M.BAS_YEAR, SCM09M.EST_WEEK, SCM09M.GR_WEEK
		   FROM SCM0009M SCM09M, SCM0010D SCM10D
		  WHERE SCM09M.PO_NO = SCM10D.PO_NO
		    AND SCM10D.PO_ITM_APPV_STUS = '5'
		    AND SCM09M.CDC = DECODE(#{cdcCbBox},'2010','KL','2020','PN','2030','JB','2040','KK','2050','KC',#{cdcCbBox})
		    AND BAS_YEAR = FN_GET_CALYEAR(#{scmYearCbBox},#{selectPlanMonth},#{scmPeriodCbBox},#{scmPeriodCbBoxAfter})
			AND EST_WEEK =  FN_GET_CALWEEK(#{scmYearCbBox},#{selectPlanMonth},#{scmPeriodCbBox},#{scmPeriodCbBoxAfter})
		  ) A, SCM0008M SCM08M
		WHERE SCM08M.STOCK_CODE = A.STOCK_CODE(+)
		  AND SCM08M.STOCK_CODE = #{stockCode}
    </select>

    <select id="selectScmMonth" parameterType="Map" resultType="egovMap">
			SELECT SCM_MONTH FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = '1'
    </select>

    <select id="selectScmYearMonthWeek" parameterType="Map" resultType="egovMap">
			SELECT PLAN_YEAR, PLAN_MONTH, PLAN_WEEK FROM SCM0001M WHERE plan_id = #{planMasterId}
    </select>

    <select id="selectSalesPlanWeekCnt" parameterType="Map" resultType="egovMap">
			SELECT     W00
		             , W01
		             , W02
		             , W03
		             , W04
		             , W05
		             , W06
		             , W07
		             , W08
		             , W09
		             , W10
		             , W11
		             , W12
		             , W13
		             , W14
		             , W15
		             , W16
		             , W17
		             , W18
		             , W19
		             , W20
		             , W21
		             , W22
		             , W23
		             , W24
		             , W25
		             , W26
		             , W27
		             , W28
		             , W29
		             , W30
			  FROM SCM0001M A, SCM0002D B
			 WHERE A.PLAN_ID = B.PLAN_MASTER_ID
			   AND A.PLAN_YEAR = #{scmYearCbBox}
			   AND A.PLAN_WEEK = #{scmPeriodCbBox}
			   AND B.STOCK_CODE = #{stockCode}
			   AND A.TEAM = #{scmTeamCbBox}
    </select>

    <insert id="insertSalesCdcDetailNew" parameterType="Map">
    INSERT INTO SCM0006D
            ( PLAN_DTL_ID ,PLAN_MASTER_ID ,PSI_ID ,STOCK_CODE ,CMPLT ,PSI_NAME, STOCK_CTGRY ,STOCK_NAME
             ,M0_PLAN ,M1  ,M2  ,M3  ,M4 ,OVERDUE  ,WS0 ,WS1 ,WS2 ,WS3
             ,W00 ,W01 ,W02 ,W03 ,W04 ,W05 ,W06 ,W07 ,W08 ,W09 ,W10 ,W11 ,W12 ,W13 ,W14 ,W15
             ,W16 ,W17 ,W18 ,W19 ,W20 ,W21 ,W22 ,W23 ,W24 ,W25 ,W26 ,W27 ,W28 ,W29 ,W30
            )
    SELECT SCM0006D_PLAN_DETAIL_SEQ.NEXTVAL,
    	   #{salesPlanMstCdcSeq},
    	   #{psiId},
    	   #{stockCode},
    	   '1',
    	   #{psiName},
    	   (SELECT A.CODE FROM SYS0013M A, SYS0026M B WHERE A.CODE_ID = B.STK_CTGRY_ID AND B.STK_CODE = #{stockCode}),
    	   (SELECT STK_DESC FROM SYS0026M WHERE STK_CODE = #{stockCode}),
    	   NVL(#{m0},0),
    	   NVL(#{m1},0),
    	   NVL(#{m2},0),
    	   NVL(#{m3},0),
    	   NVL(#{m4},0),
    	   0,
    	   NVL(#{ws0},0),
    	   NVL(#{ws1},0),
    	   NVL(#{ws2},0),
    	   NVL(#{ws3},0),
    	   NVL(#{w00},0),
		   NVL(#{w01},0),
    	   NVL(#{w02},0),
		   NVL(#{w03},0),
		   NVL(#{w04},0),
		   NVL(#{w05},0),
		   NVL(#{w06},0),
			NVL(#{w07},0),
			NVL(#{w08},0),
			NVL(#{w09},0),
			NVL(#{w10},0),
			NVL(#{w11},0),
			NVL(#{w12},0),
			NVL(#{w13},0),
			NVL(#{w14},0),
			NVL(#{w15},0),
			NVL(#{w16},0),
			NVL(#{w17},0),
			NVL(#{w18},0),
			NVL(#{w19},0),
			NVL(#{w20},0),
			NVL(#{w21},0),
			NVL(#{w22},0),
			NVL(#{w23},0),
			NVL(#{w24},0),
			NVL(#{w25},0),
			NVL(#{w26},0),
			NVL(#{w27},0),
			NVL(#{w28},0),
			NVL(#{w29},0),
			NVL(#{w30},0)
		FROM DUAL
    </insert>
<!-- 
    <insert id="updateSalesPlanDetailMonthly" parameterType="Map">
    UPDATE SCM0002D SET M0_PLAN = #{m0}, M1 = #{m1}, M2 = #{m2}, M3 = #{m3}, M4 = #{m4}
      WHERE PLAN_MASTER_ID = (SELECT PLAN_ID FROM SCM0001M WHERE PLAN_YEAR = #{scmYearCbBox} AND PLAN_WEEK = #{scmPeriodCbBox} AND TEAM = #{scmTeamCbBox})
        AND STOCK_CODE = #{stockCode}
    </insert>
 -->

   <insert id="insertITF189" parameterType="Map">
      INSERT INTO itf0189m (IF_KEY,
                      SEQ,
                      IF_TYPE,
                      TRAN_STATUS_CD,
                      ERR_CD,
                      ERR_MSG,
                      TRAN_DT,
                      TRAN_TM,
                      RGST_DT,
                      RGST_TM,
                      RGST_ID,
                      PLAN_YEAR,
                      PLAN_MONTH,
                      PLAN_WEEK,
                      TEAM,
                      STOCK_CODE,
                      PRE_M3_AVG_ORDED,
                      PRE_M3_AVG_ISSU,
                      M1_ORD,
                      M2_ORD,
                      M3_ORD,
                      M_3,
                      M_2,
                      M_1,
                      M0_PLAN,
                      M0_ORD,
                      M1,
                      M2,
                      M3,
                      M4,
                      W00,
                      W01,
                      W02,
                      W03,
                      W04,
                      W05,
                      W06,
                      W07,
                      W08,
                      W09,
                      W10,
                      W11,
                      W12,
                      W13,
                      W14,
                      W15,
                      W16,
                      W17,
                      W18,
                      W19,
                      W20,
                      W21,
                      W22,
                      W23,
                      W24,
                      W25,
                      W26,
                      W27,
                      W28,
                      W29,
                      W30,
                      WS1,
                      WS2,
                      WS3,
                      WS4,
                      WS5)
     SELECT
     FN_CRT_IFKEY('189'),
      1,
      '189',
      '10',
      '',
      '',
      null,
      null,
<!--       TO_CHAR(SYSDATE,'YYYYMMDD') AS TRAN_DT,
      TO_CHAR(SYSDATE,'HH24MISS') AS TRAN_TM, -->
      TO_CHAR(SYSDATE,'YYYYMMDD') AS RGST_DT,
      TO_CHAR(SYSDATE,'HH24MISS') AS RGST_TM,
      '',
      a.PLAN_YEAR,
      a.PLAN_MONTH,
      a.PLAN_WEEK,
      a.TEAM,
       STOCK_CODE,
       PRE_M3_AVG_ORDED,
       PRE_M3_AVG_ISSU,
       M1_ORD,
       M2_ORD,
       M3_ORD,
       M_3,
       M_2,
       M_1,
       M0_PLAN,
       M0_ORD,
       M1,
       M2,
       M3,
       M4,
       W00,
       W01,
       W02,
       W03,
       W04,
       W05,
       W06,
       W07,
       W08,
       W09,
       W10,
       W11,
       W12,
       W13,
       W14,
       W15,
       W16,
       W17,
       W18,
       W19,
       W20,
       W21,
       W22,
       W23,
       W24,
       W25,
       W26,
       W27,
       W28,
       W29,
       W30,
       WS1,
       WS2,
       WS3,
       WS4,
       WS5
  FROM SCM0001M a ,SCM0002D b
 WHERE
 a.PLAN_ID=b.PLAN_MASTER_ID
 AND a.PLAN_STUS_ID ='4'
 AND b.PLAN_MASTER_ID =  #{planId}
 <!-- AND b.STOCK_CODE = '112110'; -->
 </insert>

<select id="selectCreateCount" parameterType="Map" resultType="int">
SELECT COUNT(*)
  FROM SCM0001M A
 WHERE A.PLAN_YEAR = #{scmYearCbBox}
   AND A.PLAN_WEEK = #{scmPeriodCbBox}
   AND A.TEAM = #{scmTeamCbBox}
</select>
<!--
<select id="selectCreateCount" parameterType="Map" resultType="int">
        select count(*) From SCM0001M where PLAN_YEAR= #{scmYearCbBox} and PLAN_WEEK= #{scmPeriodCbBox} and TEAM= #{scmTeamCbBox}
</select>
 -->

<select id="selectUnConfirmCnt" parameterType="Map" resultType="int">
        select count(*) From scm0005m where PLAN_YEAR=#{scmYearCbBox}and PLAN_WEEK=#{scmPeriodCbBox} and PLAN_MONTH=(SELECT SCM_MONTH FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox}  AND WEEK_TH_SN = 1)
</select>




</mapper>