<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.organization.organization.impl.AllocationMapper">

    <select id="selectList" parameterType="Map" resultType="egovMap">
              <![CDATA[ 
                select   ct ,
                        (select MEM_CODE  from org0001d a  where   ct =a.MEM_ID )  MEM_CODE,
                        C_DATE ,  
                        to_char (to_date(C_DATE,'yyyy-mm-dd'),'dd/mm/yyyy') D_DATE, 
                        ASCNT||'-'||SUMSESION_CNT ascnt,
                        INSCNT||'-'||SUMSESION_CNT inscnt,
                        0||'-'||SUMSESION_CNT rtncnt
                from (                        
                        SELECT  MEM_ID  ct  ,  
                                INS_DATE  C_DATE,
                                (SELECT COUNT (*) CNT  FROM  SAL0046D  AA
                                 WHERE  1=1
                                 AND  AA.CT_ID =MEM_ID
                                 AND  AA.STUS_CODE_ID =1
                                 AND  TO_CHAR (AA.INSTALL_DT,'YYYY-MM-DD'  ) = TO_CHAR( ( to_date(INS_DATE,'yyyy-mm-dd') ) ,'yyyy-mm-dd')  )INSCNT ,
                                (SELECT COUNT (*) CNT  FROM  SVC0001D  AA
                                 WHERE  1=1
                                 AND  AA.AS_MEM_ID =MEM_ID
                                 AND  AA.AS_STUS_ID =1
                                 AND  TO_CHAR (AA.AS_APPNT_DT,'YYYYMMDD'  )  = TO_CHAR( ( to_date(INS_DATE,'yyyy-mm-dd') ) ,'yyyy-mm-dd')   ) ASCNT,
                                NVL(( SELECT  SUM(NVL(MORNG_SESION_INS,0) + NVL(AFTNON_SESION_INS,0) + NVL(EVNG_SESION_INS,0) ) SUMSESION_CNT  FROM ORG0015M S WHERE  S.CT_ID = MEM_ID ),0)SUMSESION_CNT 
                 FROM     ( 
                          select  
                                distinct MEM_ID  
                          from  ORG0005D t 
                          where  CT_SUB_GRP in(
                                SELECT
                                     F.CT_SUB_GRP
                                FROM SAL0001D  A , 
                                     SAL0045D B ,
                                     SAL0023D E , 
                                     SYS0064M F
                                WHERE 1=1
                                    AND A.SALES_ORD_ID =#{ORD_ID}
                                    AND A.SALES_ORD_ID = B.SALES_ORD_ID
                                    AND B.ADD_ID = E.CUST_ADD_ID
                                    AND E.AREA_ID = F.AREA_ID
                           )
                      )C ,(  SELECT   TO_CHAR( (SYSDATE -1) +level ,'yyyy-mm-dd') INS_DATE    FROM DUAL connect by level <= 5) TB  
                ORDER BY MEM_ID  ,INS_DATE ASC
                )                                           
                
        ]]>
        
    </select>
    
    
    <select id="selectDetailList" parameterType="Map" resultType="egovMap">
   
                
                SELECT MEM_ID,
                       MEM_CODE ,
                       SUM_AS_CNT   ||'-'|| NVL(AS_SESION_SUM,0)         sumAsCnt, 
                       SUM_INS_CNT  ||'-'|| NVL(INS_SESION_SUM ,0)       sumInsCnt,
                       SUM_RTN_CNT  ||'-'||NVL(RTN_SESION_SUM ,0)       sumRtnCnt,
                       AS_M_CNT     ||'-'|| NVL(MORNG_SESION_SUM,0)      morAsCnt,
                       INS_M_CNT    ||'-'|| NVL(MORNG_SESION_SUM,0)      morInsCnt,
                       RTN_M_CNT    ||'-'||NVL(MORNG_SESION_SUM,0)      morRtnCnt,
                       AS_A_CNT     ||'-'||NVL(AFTNON_SESION_SUM ,0)    aftAsCnt,
                       INS_A_CNT    ||'-'||NVL(AFTNON_SESION_SUM ,0)    aftInsCnt,
                       RTN_A_CNT    ||'-'||NVL(AFTNON_SESION_SUM ,0)    aftRtnCnt,
                       AS_E_CNT     ||'-'||NVL(EVNG_SESION_SUM,0)       evnAsCnt,
                       INS_E_CNT    ||'-'||NVL(EVNG_SESION_SUM ,0)      evnInsCnt, 
                       RTN_E_CNT    ||'-'||NVL(EVNG_SESION_SUM,0)       evnRtnCnt,
                       AS_O_CNT     ||'-'||NVL(EVNG_SESION_SUM ,0)      othAsCnt,
                       INS_O_CNT    ||'-'||NVL(EVNG_SESION_SUM ,0)      othInsCnt,
                       RTN_O_CNT    ||'-'||NVL(EVNG_SESION_SUM ,0)      othRtnCnt
                FROM(   
                        SELECT   #{CT_ID}  MEM_ID ,
                                (SELECT MEM_CODE  FROM ORG0001D   where MEM_ID = #{CT_ID}) MEM_CODE ,
                                (SELECT    nvl(MORNG_SESION_AS,0)+    
                                           nvl(AFTNON_SESION_AS,0)+     
                                           nvl(EVNG_SESION_AS,0) as  AS_SESION_SUM  FROM   ORG0015M  WHERE  CT_ID  = #{CT_ID}) AS_SESION_SUM,
                                (SELECT    nvl(MORNG_SESION_INS,0)+    
                                           nvl(AFTNON_SESION_INS,0)+     
                                           nvl(EVNG_SESION_INS,0) as  INS_SESION_SUM  FROM   ORG0015M  WHERE  CT_ID  = #{CT_ID}) INS_SESION_SUM,
                                (SELECT    nvl(MORNG_SESION_RTN,0)+    
                                           nvl(AFTNON_SESION_RTN,0)+     
                                           nvl(EVNG_SESION_RTN,0) as  RTN_SESION_SUM  FROM   ORG0015M  WHERE  CT_ID  = #{CT_ID}) RTN_SESION_SUM,
                                (SELECT    nvl(MORNG_SESION_AS,0)+    
                                           nvl(MORNG_SESION_INS,0)+     
                                           nvl(MORNG_SESION_RTN,0) as  MORNG_SESION_SUM  FROM   ORG0015M  WHERE  CT_ID  = #{CT_ID}) MORNG_SESION_SUM,
                                (SELECT    nvl(AFTNON_SESION_AS,0)+    
                                           nvl(AFTNON_SESION_INS,0)+     
                                           nvl(AFTNON_SESION_RTN,0) as  AFTNON_SESION_SUM  FROM   ORG0015M  WHERE  CT_ID  = #{CT_ID}) AFTNON_SESION_SUM,
                                (SELECT    nvl(EVNG_SESION_AS,0)+    
                                           nvl(EVNG_SESION_INS,0)+     
                                           nvl(EVNG_SESION_RTN,0) as   EVNG_SESION_SUM  FROM   ORG0015M  WHERE  CT_ID  = #{CT_ID}) EVNG_SESION_SUM,
                                SUM_AS_CNT,
                                SUM_INS_CNT,
                                SUM_RTN_CNT ,
                                AS_M_CNT,
                                AS_A_CNT,
                                AS_E_CNT,
                                INS_M_CNT,
                                INS_A_CNT,
                                INS_E_CNT,
                                RTN_M_CNT,
                                RTN_A_CNT,
                                RTN_E_CNT,
                                AS_O_CNT,
                                INS_O_CNT,
                                RTN_O_CNT
                     FROM (
                                SELECT  
                                        (MAX(A01)  +  MAX(A02) + MAX(A03))   SUM_AS_CNT ,
                                        (MAX(I01)  +  MAX(I02) + MAX(I03))   SUM_INS_CNT ,
                                        (MAX(R01)  +  MAX(R02) +MAX(R03))    SUM_RTN_CNT ,
                                        MAX(A01) AS_M_CNT  , MAX(A02)  AS_A_CNT,   MAX(A03)  AS_E_CNT , MAX(A04)  AS_O_CNT  ,
                                        MAX(I01) INS_M_CNT , MAX(I02)  INS_A_CNT , MAX(I03)  INS_E_CNT, MAX(I04)  INS_O_CNT ,
                                        MAX(R01) RTN_M_CNT , MAX(R02)  RTN_A_CNT , MAX(R03)  RTN_E_CNT, MAX(R04)  RTN_O_CNT 
                                FROM(
                                            SELECT 
                                                 NVL(SUM(DECODE(B.AS_SESION_CODE,'M',1,0)),0)   A01 ,
                                                 NVL(SUM(DECODE(B.AS_SESION_CODE,'A',1,0)),0)   A02 ,
                                                 NVL(SUM(DECODE(B.AS_SESION_CODE,'E',1,0)),0)   A03 ,
                                                 NVL(SUM(DECODE(B.AS_SESION_CODE,'O',1,0)),0)   A04 ,
                                                 0 I01,
                                                 0 I02,
                                                 0 I03,
                                                 0 I04,
                                                 0 R01 ,
                                                 0 R02 ,
                                                 0 R03 ,
                                                 0 R04 
                                              FROM SVC0001D B 
                                            WHERE  1=1
                                              AND to_char(B.AS_APPNT_DT,'YYYYMMDD')  =  TO_CHAR(TO_DATE(#{P_DATE},'YYYY-MM-DD'),'YYYYMMDD')  
                                              AND B.AS_STUS_ID =1 
                                              AND B.AS_MEM_ID = #{CT_ID}
                                         UNION ALL    
                                             SELECT 
                                                 0 A01,
                                                 0 A02,
                                                 0 A03,
                                                 0 A04,
                                                 NVL(SUM(DECODE(D.SESION_CODE,'A',1,0)),0)   I01 ,
                                                 NVL(SUM(DECODE(D.SESION_CODE,'M',1,0)),0)   I02 ,
                                                 NVL(SUM(DECODE(D.SESION_CODE,'E',1,0)),0)   I03 ,
                                                 NVL(SUM(DECODE(D.SESION_CODE,'O',1,0)),0)   I04 ,
                                                 0 R01 ,
                                                 0 R02 ,
                                                 0 R03 ,
                                                 0 R04 
                                               FROM SAL0046D D
                                             WHERE 1=1
                                                AND D.CT_ID = #{CT_ID}
                                                AND D.STUS_CODE_ID =1  
                                                AND to_char(D.INSTALL_DT,'YYYYMMDD')  =  TO_CHAR(TO_DATE(#{P_DATE},'YYYY-MM-DD'),'YYYYMMDD')  
                                         UNION ALL    
                                             SELECT 
                                                 0 A01,
                                                 0 A02,
                                                 0 A03,
                                                 0 A04,
                                                 0 I01 ,
                                                 0 I02 ,
                                                 0 I03 ,
                                                 0 I04 ,
                                                 0 R01 ,
                                                 0 R02 ,
                                                 0 R03 ,
                                                 0 R04 
                                               FROM SAL0046D D
                                             WHERE 1=1
                                                AND D.CT_ID = #{CT_ID}
                                                AND D.STUS_CODE_ID =1  
                                                AND to_char(D.INSTALL_DT,'YYYYMMDD')  =  TO_CHAR(TO_DATE(#{P_DATE},'YYYY-MM-DD'),'YYYYMMDD')         
                                    )
                                  )
                             )
    </select>
    
    
    
</mapper>