<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.logistics.stocktransfer.impl.StockTransferMapper">
   
    <select id="selectStockTransferSeq" resultType="String">
	 SELECT
	       'STO' 
	       ||TO_CHAR (SYSDATE, 'YYMMDD')
	       || NVL (TO_CHAR (MAX (SUBSTR (REQST_NO, 10, 5) + 1), 'FM00000'), '00001') AS REQST_NO
	  FROM LOG0047M
	   WHERE SUBSTR (REQST_NO, 1, 9) =  'STO'||TO_CHAR (SYSDATE, 'YYMMDD') 
    </select>
    <select id="selectStockTransferMainList" parameterType="Map" resultType="egovMap">
        select ROWNUM rnum , l47.REQST_STUS     status
		     , reqs.code_name     staname
		     , l47.reqst_no       reqstno
		     , l48.reqst_no_itm   reqitmno
		     , l47.trnsc_type     ttype
		     , tran.code_name     ttext
		     , l47.trnsc_type_dtl mtype
		     , trand.code_name    mtext
		     , decode(l47.PRIDIC_FRQNCY , 'A' , 'Auto' , 'M' , 'Manual' ,l47.PRIDIC_FRQNCY) froncy
		     , to_char(l47.reqst_crt_dt , 'yyyy-mm-dd')     crtdt
		     , to_char(l47.reqst_require_dt , 'yyyy-mm-dd') reqdt
		     , l47.REF_DOC_NO docno
		     , l47.DOC_HDER_TXT headtitle
		     , l47.GOODS_RCIPT grcipt
		     , l47.RCIV_CDC_RDC rcvloc
		     , s28c.wh_loc_code rcvlocnm
		     , s28c.wh_loc_code ||'-'|| DBMS_LOB.SUBSTR (s28c.wh_loc_desc, 4000) rcvlocdesc
		     , l47.reqst_cdc_rdc reqloc
		     , s28q.wh_loc_code  reqlocnm
		     , s28q.wh_loc_code ||'-'|| DBMS_LOB.SUBSTR (s28q.wh_loc_desc, 4000) reqlocdesc
		     , l48.itm_code      itmcd
		     , (select SERIAL_CHK from sys0026m where stk_code = l48.itm_code) serialchk
		     , l48.itm_name      itmname
		     , l48.reqst_qty     reqstqty
		     , NVL (l55.DELVRY_QTY, 0) AS delyqty
		     , nvl(l55.RCIPT_QTY , 0) as rciptqty
		     , l48.uom
		     , uomt.code_name uomnm
		     , NVL((SELECT USER_NAME FROM SYS0047M WHERE USER_ID = l47.CRT_USER_ID),l47.CRT_USER_ID) user_Name
		  from log0047m l47
		     , log0048d l48
		     , (select * from sys0013m where code_master_id = 306) tran
		     , (select * from sys0013m where code_master_id = 308) trand
		     , (select * from sys0013m where code_master_id = 42) uomt
		     , (select * from sys0013m where code_master_id = 309) reqs
		     , sys0028m s28c
		     , sys0028m s28q
		     , (select reqst_no , itm_code , sum(DELVRY_QTY) DELVRY_QTY , sum(RCIPT_QTY) RCIPT_QTY from log0055d group by reqst_no , itm_code )l55
		 where 1 =1 
		   and l47.reqst_no       = l48.reqst_no
		   and l47.trnsc_type     = tran.code(+)
		   and l47.trnsc_type_dtl = trand.code(+)
		   and l47.rciv_cdc_rdc   = s28c.wh_loc_id(+)
		   and l47.reqst_cdc_rdc  = s28q.wh_loc_id(+)
		   and l48.uom            = uomt.code_id
		   AND l48.reqst_no       = l55.reqst_no(+)
           AND l48.itm_code       = l55.itm_code(+)
		   and l47.reqst_stus     = reqs.code(+)
		   <if test="streq !=null and streq !=''">
		      and l47.reqst_no LIKE #{streq}||'%'
		   </if>
		   <if test="smtype !=null and smtype !=''">
              and l47.trnsc_type_dtl = #{smtype}
           </if>
           <if test="sttype !=null and sttype !=''">
              and l47.trnsc_type = #{sttype}
           </if>
           <if test="flocation !=null and flocation !=''">
              and (l47.reqst_cdc_rdc = #{flocation} or s28q.wh_loc_desc like '%'||#{flocationnm}||'%')
           </if>
           <if test="tlocation !=null and tlocation !=''">
              and (l47.rciv_cdc_rdc = #{tlocation} or s28c.wh_loc_desc like '%'||#{tlocationnm}||'%')
           </if>
           <if test="refdocno !=null and refdocno !=''">
              and l47.REF_DOC_NO LIKE #{refdocno}||'%'
           </if>
           <if test="sam !=null and sam !=''">
              and l47.PRIDIC_FRQNCY = #{sam}
           </if>
           <if test="crtsdt !=null and crtsdt !=''">
              and to_char(l47.reqst_crt_dt , 'yyyymmdd') <![CDATA[>=]]> to_char(to_date(#{crtsdt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
           <if test="crtedt !=null and crtedt !=''">
              and to_char(l47.reqst_crt_dt , 'yyyymmdd') <![CDATA[<=]]> to_char(to_date(#{crtedt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
            <if test="reqsdt !=null and reqsdt !=''">
              and to_char(l47.reqst_require_dt , 'yyyymmdd') <![CDATA[>=]]> to_char(to_date(#{reqsdt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
           <if test="reqedt !=null and reqedt !=''">
              and to_char(l47.reqst_require_dt , 'yyyymmdd') <![CDATA[<=]]> to_char(to_date(#{reqedt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
           <if test="sstatus !=null and sstatus !=''">
              and l47.reqst_stus = #{sstatus}
           </if>
           ORDER BY l47.reqst_no DESC
    </select> 
  
    <insert id="insStockTransfer" parameterType="Map">
        MERGE INTO LOG0048D A
             USING DUAL
                ON (A.REQST_NO = #{reqno} and REQST_NO_ITM = #{resnoitm})
            WHEN MATCHED THEN
                UPDATE SET 
                       A.REQST_QTY = #{rqty}
                     , A.UOM       = #{uom}
                     , A.CRT_USER_ID = #{userId}
                     , A.CRT_DT      = SYSDATE
            WHEN NOT MATCHED THEN 
                INSERT ( REQST_NO, REQST_NO_ITM
                        ,ITM_CODE, ITM_NAME, REQST_QTY, UOM, CRT_USER_ID, CRT_DT)
                VALUES ( #{reqno} , (select decode(count(reqst_no_itm) , 0 , 1 , max(reqst_no_itm +1)) from log0048d where REQST_NO = #{reqno})
                        ,#{itmcd} , #{itmname}, #{rqty} ,#{uom} , #{userId}       , SYSDATE)
    </insert> 
    
    <update id="insStockTransferHead" parameterType="Map">
        MERGE INTO LOG0047M  a
             USING dual
                on (a.REQST_NO=#{reqno}) 
              WHEN MATCHED THEN
                   UPDATE SET
                          a.REQST_CRT_DT    =   to_date(#{reqcrtdate}|| to_char(sysdate , 'hh24miss') , 'dd/mm/yyyyhh24miss') 
                       ,  a.DOC_HDER_TXT    =   #{dochdertxt}                                                                 
                       ,  a.CRT_USER_ID     =   #{userId}                                                                     
                       ,  a.CRT_DT          =   SYSDATE 
              WHEN NOT MATCHED THEN
                       INSERT (REQST_NO,
                              TRNSC_TYPE,
                              TRNSC_TYPE_DTL,
                              PRIDIC_FRQNCY,
                              REQST_CRT_DT,
                              REQST_REQUIRE_DT,
                              DOC_HDER_TXT,
                              RCIV_CDC_RDC,
                              REQST_CDC_RDC,
                              REQST_STUS,
                              CRT_USER_ID,
			                  CRT_DT,
			                  REQST_TYPE,
			                  REQST_TYPE_DTL
                              )
                            VALUES (  #{reqno}
		                            , #{sttype}
		                            , #{smtype}
		                            , #{pridic}
		                            , SYSDATE
		                            , to_date(#{reqcrtdate}|| to_char(sysdate , 'hh24miss') , 'dd/mm/yyyyhh24miss')
		                            , #{dochdertxt}
		                            , #{tlocation}
		                            , #{flocation}
                                    , 'O'
		                            , #{userId}
		                            , SYSDATE
                                    , #{sttype}
                                    , #{smtype}
		                            )
    </update>
    
    <select id="selectStockTransferNoList" parameterType="Map" resultType="egovMap">
        SELECT REQST_NO CODE_ID , REQST_NO CODE_NAME FROM log0047m where reqst_no in (select reqst_no from log0048d) AND SUBSTR(REQST_NO , 0,3) = 'STO' ORDER BY CRT_DT DESC
    </select>
    
    <select id="selectDeliveryNoList" parameterType="Map" resultType="egovMap">
        SELECT DELVRY_NO CODE_ID , DELVRY_NO CODE_NAME FROM log0054m  where nvl(delvry_gi_cmplt , 'N') <![CDATA[<>]]> 'Y' ORDER BY CRT_DT DESC
    </select>
    
    <select id="selectStockTransferHead" parameterType="String" resultType="egovMap">
        SELECT REQST_NO REQNO , TRNSC_TYPE TRNTYPE , TRNSC_TYPE_DTL TRNDTL , PRIDIC_FRQNCY PRIFR , TO_CHAR(REQST_CRT_DT , 'DD/MM/YYYY') REQCRTDT
		     , DOC_HDER_TXT DOCTXT , RCIV_CDC_RDC RCIVCR , REQST_CDC_RDC REQCR, REQST_STUS REQST
		  FROM LOG0047M
		 WHERE REQST_NO = #{param} 
    </select>
    <select id="selectStockTransferItem" parameterType="String" resultType="egovMap">
        SELECT l48.REQST_NO_ITM resnoitm ,s26.STK_ID itmid, l48.ITM_CODE itmcd, l48.ITM_NAME itmname 
             , l48.REQST_QTY rqty
             , l48.UOM uom
             , l55.delvry_no delyno 
             , l55.delvry_qty delyqty
		  FROM LOG0048D l48, sys0026m s26 , 
		       log0055d l55		        
		 WHERE l48.ITM_CODE = s26.STK_CODE
		   AND l48.ITM_CODE = l55.ITM_CODE(+)
		   AND l48.REQST_NO = l55.REQST_NO(+)
		   AND l48.REQST_NO = #{param}           
		 ORDER BY l48.REQST_NO_ITM 
    </select>
    
    <select id="selectStockTransferToItem" parameterType="Map" resultType="egovMap">
        select rownum rnum
             , l56.loc_id locid, l56.stk_code stkcd, dbms_lob.substr (l56.stk_desc, 4000) stknm
             , l56.stk_type_id typeid , s15.code_name typenm
             , l56.stk_ctgry_id cateid , s11.code_name catenm
             , (l56.qty - nvl(l75.bookqty , 0)) as qty , s26.stk_id stkid
             ,S26.SERIAL_CHK SERIALCHCK
             ,(SELECT CODE_ID FROM SYS0013M WHERE CODE_ID=S26.UOM) uom
          from log0056m l56 , sys0026m s26
             ,(select loc_id , itm_code , sum(nvl(reqst_qty , 0)) - sum(nvl(mov_qty , 0)) as bookqty from log0075m where nvl(final_cmplt , 'N') <![CDATA[<>]]> 'Y'
                group by loc_id , itm_code ) l75
             , (select * from sys0013m where code_master_id = 15) s15
             , (select * from sys0013m where code_master_id = 11) s11 
         where 1 = 1
           and l56.stk_code = l75.itm_code(+)
           and l56.loc_id = l75.loc_id(+)
           and l56.stk_type_id = s15.code_id
           and l56.stk_ctgry_id = s11.code_id
           and l56.stk_code = s26.stk_code
		   and l56.loc_id = #{toloc}
		   <if test="ctype != null and ctype !=''">
		      and l56.stk_type_id in
		      <foreach item="item" collection="ctype" index="index" open="(" separator="," close=")">
               #{item}
               </foreach>
		   </if>
		   <if test="catetype != null and catetype !=''">
              and l56.stk_ctgry_id in
              <foreach item="item" collection="catetype" index="index" open="(" separator="," close=")">
               #{item}
               </foreach>
           </if>
           <if test="mcode != null and mcode != '' ">
                and l56.stk_code = #{mcode}
           </if>
    </select>
    
    <select id="stockTransferItemDeliveryQty" parameterType="Map" resultType="egovMap">
        select qty 
		  from log0056m l56 
		 where 1 = 1
		   and l56.loc_id = #{toloc}
		   and l56.stk_code = #{itmcd}
    </select>
    
    <select id="selectDeliveryNobyReqsNo" parameterType="Map" resultType="String">
        select decode(count(1) , 0 , '0' ,max( DELVRY_NO)) dno from log0054m where reqst_no = #{reqno}
    </select>
    
    <select id="selectDeliveryStockTransferSeq" resultType="String">
	SELECT
	       'DVR' 
	       ||TO_CHAR (SYSDATE, 'YYMMDD')
	       || NVL (TO_CHAR (MAX (SUBSTR (DELVRY_NO, 10, 5) + 1), 'FM00000'), '00001') AS DELVRY_NO
	  FROM LOG0054M
	 WHERE SUBSTR (DELVRY_NO, 4, 6) = TO_CHAR (SYSDATE, 'YYMMDD')
    </select>
    <insert id="deliveryStockTransferIns" parameterType="Map">
        MERGE INTO LOG0054M A
             USING DUAL
                ON (DELVRY_NO = #{delno}) 
              WHEN MATCHED THEN
                     UPDATE SET
                                A.DOC_HDER_TXT= #{headtxt}
                              , A.UPD_USER_ID = #{userId}
                              , A.UPD_DT      = SYSDATE
              WHEN NOT MATCHED THEN              
                     INSERT (
                                DELVRY_NO
                              , TRNSC_TYPE
                              , TRNSC_TYPE_DTL
                              , DELVRY_DT
                              , CRT_USER_ID
                              , CRT_DT
                            ) VALUES(
                                #{delno}
                              , #{ttype}
                              , #{mtype}
                              , to_char(sysdate , 'yyyymmdd')
                              , #{userId}
                              , SYSDATE
                            )
    </insert>
    
    <insert id="deliveryStockTransferDetailIns" parameterType="Map">
        MERGE INTO LOG0055D A
             USING DUAL
               ON (DELVRY_NO = #{delno} and ITM_CODE = #{itmcd} and REQST_NO = #{reqstno})
               WHEN MATCHED THEN
                     UPDATE SET
                                A.DELVRY_QTY  = #{delyqty}
                              , A.REQST_NO_ITM = #{reqitmno}
                              , A.UPD_USER_ID = #{userId}
                              , A.UPD_DT      = SYSDATE
               WHEN NOT MATCHED THEN    
                     INSERT (  DELVRY_NO, DELVRY_NO_ITM
		                     , ITM_CODE, ITM_NAME, DELVRY_QTY, REQST_NO, CRT_USER_ID, CRT_DT, REQST_NO_ITM)
		             VALUES (  #{delno} , (select decode(count(DELVRY_NO_ITM) , 0 , 1 , max(DELVRY_NO_ITM +1)) from log0055d where DELVRY_NO = #{delno})
		                     , #{itmcd} , #{itmname}, #{delyqty} , #{reqstno} , ${userId} , SYSDATE , #{reqitmno})
    </insert>
    <delete id="deliveryStockTransferItmDel" parameterType="Map">
        delete from LOG0055D where DELVRY_NO = #{delyno} and ITM_CODE = #{itmcd}
    </delete>
    <delete id="StockTransferItmDel" parameterType="Map">
        delete from LOG0048D where REQST_NO = #{reqno} and REQST_NO_ITM = #{resnoitm}
    </delete>
    
    <select id="selectStockTransferDeliveryList" parameterType="Map" resultType="egovMap">
        SELECT Rownum rnum , T.* FROM (
        select 
               l47.reqst_no reqstno
             , l48.reqst_no_itm reqitmno
		     , l55.delvry_no delyno
		     , l55.delvry_no_itm 
		     , l47.trnsc_type ttype
		     , tran.code_name     ttext
             , l47.trnsc_type_dtl mtype
             , trand.code_name    mtext
		     , l54.delvry_dt delydt
		     , l54.delvry_gi_dt gidt
		     , l54.delvry_gr_dt grdt
		     , l48.itm_code itmcd
		     , l48.itm_name itmname
		     , l55.delvry_qty delyqty
		     , l48.uom uom
		     , uomt.code_name uomnm
		     , l47.RCIV_CDC_RDC rcvloc
		     , s28c.wh_loc_code rcvlocnm
		     , s28c.wh_loc_code ||'-'|| DBMS_LOB.SUBSTR (s28c.wh_loc_desc, 4000) rcvlocdesc
		     , l47.reqst_cdc_rdc reqloc
		     , s28q.wh_loc_code  reqlocnm
		     , s28q.wh_loc_code ||'-'|| DBMS_LOB.SUBSTR (s28q.wh_loc_desc, 4000) reqlocdesc
		     , l48.reqst_no_itm ritmno
		     , nvl(l55.rcipt_qty , 0) rciptqty
		     , NVL (L54.DELVRY_GR_CMPLT , 'N') grcmplt
		     , NVL (L54.DELVRY_GI_CMPLT , 'N') gicmplt
		     , case when s26.stk_type_id= 61 then case when s26.SERIAL_CHK = 'Y' and  s28q.serial_pd_chk = 'Y' then 'Y' else 'N' end
               when s26.stk_type_id= 62 then case when s26.SERIAL_CHK = 'Y' and  s28q.serial_ft_chk = 'Y'  then 'Y' else 'N' end
               when s26.stk_type_id= 63 then case when s26.SERIAL_CHK = 'Y' and  s28q.serial_pt_chk = 'Y' then 'Y' else 'N' end
               else 'N' end serialchk
              , l47.REF_DOC_NO docno 
		  from log0047m l47
		     , log0048d l48
		     , log0054m l54
		     , log0055d l55
		     , (select * from sys0013m where code_master_id = 306) tran
		     , (select * from sys0013m where code_master_id = 308) trand
		     , (select * from sys0013m where code_master_id = 42) uomt
		     , sys0028m s28c
		     , sys0028m s28q
		     , sys0026m s26
		 where 1 = 1
		   AND l48.itm_code = s26.stk_code(+)   
		   and l47.trnsc_type     = tran.code
		   and l47.trnsc_type_dtl = trand.code
		   and l47.rciv_cdc_rdc   = s28c.wh_loc_id
		   and l47.reqst_cdc_rdc  = s28q.wh_loc_id
		   and l48.uom            = uomt.code_id
		   and l48.itm_code  = l55.itm_code
		   and l54.delvry_no = l55.delvry_no
		   and l48.reqst_no  = l55.reqst_no
		   and l47.reqst_no  = l48.reqst_no
		   AND NVL(L54.DELVRY_GR_CMPLT,'N') <![CDATA[<>]]> 'Y'
		   <if test="reqstno != null and reqstno != ''">
		      and l47.reqst_no  LIKE #{reqstno}||'%'
		   </if>
		   <if test="seldelno != null and seldelno != ''">
              and l54.delvry_no   LIKE #{seldelno}||'%'
           </if>
		   <if test="smtype !=null and smtype !=''">
              and l47.trnsc_type_dtl = #{smtype}
           </if>
           <if test="sttype !=null and sttype !=''">
              and l47.trnsc_type = #{sttype}
           </if>
           <if test="flocation !=null and flocation !=''">
              and (l47.reqst_cdc_rdc = #{flocation} or s28q.wh_loc_desc like '%'||#{flocationnm}||'%')
           </if>
           <if test="tlocation !=null and tlocation !=''">
              and (l47.rciv_cdc_rdc = #{tlocation} or s28c.wh_loc_desc like '%'||#{tlocationnm}||'%')
           </if>
           <if test="refdocno !=null and refdocno !=''">
              and l47.REF_DOC_NO LIKE #{refdocno}||'%'
           </if>
           <if test="sam !=null and sam !=''">
              and l47.PRIDIC_FRQNCY = #{sam}
           </if>
           <if test="crtsdt !=null and crtsdt !=''">
              and L54.DELVRY_DT <![CDATA[>=]]> to_char(to_date(#{crtsdt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
           <if test="crtedt !=null and crtedt !=''">
              and L54.DELVRY_DT <![CDATA[<=]]> to_char(to_date(#{crtedt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
             <if test="reqsdt !=null and reqsdt !=''">
              and l54.DELVRY_GI_DT <![CDATA[>=]]> to_char(to_date(#{reqsdt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
           <if test="reqedt !=null and reqedt !=''">
              and l54.DELVRY_GI_DT<![CDATA[<=]]> to_char(to_date(#{reqedt},'dd/mm/yyyy'),'yyyymmdd')
           </if>
           <if test="gtype !=null and gtype =='receipt'">
              and L54.DELVRY_GI_CMPLT <![CDATA[=]]> 'Y'
           </if>
           <if test="gtype !=null and gtype =='receiptList'">
              and L54.DELVRY_GR_CMPLT <![CDATA[=]]> 'Y'
           </if>
           ORDER BY l54.delvry_no DESC
           ) T
    </select>
    <resultMap id="STOPRCDATA" type="egovMap" />
    <select id="StockTransferiSsue"  statementType="CALLABLE" parameterType="Map"> 
             { call SP_LOGISTIC_DELIVERY
                     (#{parray , mode=IN,typeHandler=com.coway.trust.util.OracleCallBackHandler}, #{gtype}, #{doctext}, #{gipfdate}, #{giptdate}, #{prgnm}, #{refdocno}, #{salesorder}, #{userId} , #{rdata , mode=OUT , jdbcType=VARCHAR , javaType=String , resultMap=STOPRCDATA} )
             } 
     </select>
     <resultMap id="PRCCANCLEDATA" type="egovMap" />
     <select id="StockTransferCancelIssue"  statementType="CALLABLE" parameterType="Map"> 
             { call SP_LOGISTIC_DELIVERY_CANCEL
                     (#{parray , mode=IN,typeHandler=com.coway.trust.util.OracleCallBackHandler}, #{gtype}, #{doctext}, #{gipfdate}, #{giptdate}, #{prgnm}, #{refdocno}, #{salesorder}, #{userId} , #{rdata , mode=OUT , jdbcType=VARCHAR , javaType=String , resultMap=PRCCANCLEDATA} )
             } 
     </select>
     
     <select id="selectStockTransferMtrDocInfoList"  parameterType="Map" resultType="egovMap">
        SELECT
					lg59m.MATRL_DOC_NO,
					lg60d.MATRL_DOC_ITM,
					lg59m.TRNSC_TYPE_CODE,
					tran.CODE_NAME,
					lg60d.INVNTRY_MOV_TYPE,
					tranD.CODE_NAME,
					lg59m.MATRL_DOC_YEAR,
					lg60d.AUTO_CRT_ITM,
					lg60d.DEBT_CRDIT_INDICT,
					lg60d.MATRL_NO,
					lg48d.ITM_NAME,
					lg60d.QTY,
					lg48d.UOM,
					uomt.CODE_NAME uomnm,
					lg47m.REQST_CDC_RDC rqloc,
					sy28rq.WH_LOC_ID rqlocid,
					sy28rq.WH_LOC_DESC rqlocnm,
					lg60d.DELVRY_NO,
					lg48d.ITM_CODE,
					lg60d.STOCK_TRNSFR_REQST,
					lg47m.RCIV_CDC_RDC rcloc,
					sy28rc.WH_LOC_ID rclocid,
					sy28rc.WH_LOC_DESC rclocnm
			FROM LOG0059M lg59m JOIN LOG0060D lg60d
				    ON (lg59m.MATRL_DOC_NO = lg60d.MATRL_DOC_NO) 
				JOIN LOG0047M lg47m
				    ON (LG60D.STOCK_TRNSFR_REQST = lg47m.REQST_NO)
				JOIN LOG0048D lg48d 
				    ON (LG60D.STOCK_TRNSFR_REQST = lg48d.REQST_NO 
				          AND lg60d.MATRL_NO = lg48d.ITM_CODE)
				JOIN (SELECT * FROM SYS0013M WHERE CODE_MASTER_ID = 306) tran
				    ON (lg47m.TRNSC_TYPE = tran.CODE)
				JOIN (SELECT * FROM SYS0013M WHERE CODE_MASTER_ID = 308) tranD
				    ON (lg47m.TRNSC_TYPE_DTL = tranD.CODE)
				JOIN (SELECT * FROM SYS0013M WHERE CODE_MASTER_ID = 42) uomt
				    ON (lg48d.UOM = uomt.CODE_ID)
				JOIN SYS0028M sy28rq
				    ON (lg47m.REQST_CDC_RDC = sy28rq.WH_LOC_ID)
				JOIN SYS0028M sy28rc
				    ON (lg47m.RCIV_CDC_RDC = sy28rc.WH_LOC_ID)
			WHERE lg60d.STOCK_TRNSFR_REQST= #{reqstno}				
			ORDER BY lg59m.MATRL_DOC_NO, lg60d.MATRL_DOC_ITM
        
     </select>
     <update id="updateRequestTransfer" parameterType="String">
        UPDATE LOG0047M 
           SET REQST_STUS = 'P'
         WHERE REQST_NO = #{param}
     </update>
     <insert id="insertStockBooking" parameterType="Map">
        INSERT INTO LOG0075M (REQST_NO, SEQ, LOC_ID, TRNSC_TYPE_DTL, ITM_CODE, REQST_QTY, REQST_CRT_DT, CRT_DT)
					SELECT L47.REQST_NO
					     , L48.REQST_NO_ITM
					     , L47.RCIV_CDC_RDC 
					     , L47.TRNSC_TYPE_DTL 
					     , L48.ITM_CODE 
					     , L48.REQST_QTY 
					     , REQST_CRT_DT 
					     , SYSDATE
					  FROM LOG0047M L47 , LOG0048D L48
					 WHERE 1 = 1
					   AND L47.REQST_NO = L48.REQST_NO
					   AND L47.REQST_NO = #{reqno}
     </insert>
     
     <insert id="insertTransferSerial" parameterType="Map">
     INSERT INTO LOG0061D (
                                        SERIAL_NO,
                                        DELVRY_NO,
                                        PDELVRY_NO_ITM,
                                        TTYPE,
                                        CRT_DT,
                                        CRT_USER_ID
                                        )
                          SELECT
                                   #{serial},
                                   #{delno},
                                   DELVRY_NO_ITM,
                                    (SELECT TRNSC_TYPE FROM LOG0047M WHERE REQST_NO= #{reqstno}) ,
                                    SYSDATE,
                                    #{userId}
                                    FROM LOG0055D
                                    WHERE 1=1
                                              AND DELVRY_NO= #{delno}
                                              AND ITM_CODE =#{itmcd}
                                              AND REQST_NO =#{reqstno}                                      
                                                       
     </insert>
     <delete id="deliveryDelete54" parameterType="Map">
        delete from LOG0054M WHERE DELVRY_NO = #{delyno}
     </delete>
     <delete id="deliveryDelete55" parameterType="Map">
        delete from LOG0055D WHERE DELVRY_NO = #{delyno}
     </delete>
     <delete id="deliveryDelete61" parameterType="Map">
        delete from LOG0061D WHERE DELVRY_NO = #{delyno}
     </delete>
     <delete id="updateRequestTransferStus" parameterType="Map">
        update LOG0047M set REQST_STUS = 'O' where REQST_NO = #{reqstno} 
     </delete>
</mapper>