<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.logistics.replenishment.impl.ReplenishmentMapper">
    <select id="excelDataSearch" parameterType="Map" resultType="Map">
        SELECT #{period} as PERIOD , WH_LOC_ID as LOCID, WH_LOC_CODE as LOCCD , WH_LOC_DESC as LOCNM,
		       #{materialcode} as ITMCD , (SELECT STK_DESC FROM SYS0026M WHERE STK_CODE = #{materialcode}) as ITMNM,
		       #{maximumqty} as MAXQTY, #{reorderqty} as REORDQTY
		       ,nvl(#{safetyqty} , 0) as SFTYQTY
		       ,#{plannedqty} AS PlANNEDQTY <!-- RDC 용 세팅  -->
		  FROM SYS0028M WHERE WH_LOC_CODE = #{locationcode}
    </select>
    
    <insert id="relenishmentSave" parameterType="Map">
        MERGE INTO LOG0077M A
             USING DUAL
                ON (A.PERIOD = to_char(to_date(#{period},'mm/yyyy') , 'yyyymm') AND LOC_CODE = #{loccd} AND STK_CODE = #{itmcd})
            WHEN MATCHED THEN
                UPDATE SET 
                       A.MAX_QTY   = #{maxqty}
                      ,A.REORD_QTY = #{reordqty}
                      ,A.SFTY_QTY  = #{sftyqty}
                      ,A.CRT_DT    = SYSDATE
                      ,A.CRT_USER  = #{userid}
                      ,A.PLANNED_QTY  = #{planqty}
            WHEN NOT MATCHED THEN 
                INSERT ( PERIOD, LOC_CODE, STK_CODE, MAX_QTY, REORD_QTY, SFTY_QTY, CRT_DT, CRT_USER,PLANNED_QTY)
                VALUES ( to_char(to_date(#{period},'mm/yyyy') , 'yyyymm') , 
                         #{loccd} , #{itmcd} , #{maxqty}, #{reordqty} ,#{sftyqty} , SYSDATE , #{userid},#{planqty})
    </insert>
    
    <select id="selectSearchList" parameterType="Map" resultType="egovMap">
        select ROWNUM          AS rnum
             , to_char(to_date(L77.PERIOD , 'yyyymm') , 'mm/yyyy')      AS period  
		     , S28.WH_LOC_ID      AS locid
		     , L77.LOC_CODE    AS loccd
		     , S28.WH_LOC_DESC AS locnm
		     , L77.STK_CODE    AS itmcd
		     , S26.STK_DESC    AS itmnm
		     , S13.CODE        AS locgb
		     , L77.MAX_QTY     AS maxqty
		     , L77.REORD_QTY   AS reordqty
		     , L77.SFTY_QTY    AS sftyqty
		  from LOG0077M L77 ,
		       SYS0028M S28 , 
		       SYS0026M S26 ,
		       (SELECT * FROM SYS0013M WHERE CODE_MASTER_ID = 339) S13
		 WHERE 1 = 1
		   AND S28.WH_LOC_GB = S13.CODE
		   AND L77.LOC_CODE = S28.WH_LOC_CODE
		   AND L77.STK_CODE = S26.STK_CODE
		   <if test="slocgb != null and slocgb !=''">
		      AND S28.WH_LOC_GB = #{slocgb}
		   </if>
		   <if test="sloccode != null and sloccode !=''">
		      AND L77.LOC_CODE = #{sloccode}
           </if>
           <if test="speriod != null and speriod !=''">
              AND L77.PERIOD = to_char(to_date(#{speriod},'mm/yyyy') , 'yyyymm')
           </if>
           <if test="sttype != null and sttype !=''">
              AND S26.STK_TYPE_ID = #{sttype}
           </if>
           <if test="scate != null and scate !=''">
              AND S26.STK_CTGRY_ID = #{scate}
           </if>
    </select>
    <select id="searchListRdc" parameterType="Map" resultType="EgovMap">
    <![CDATA[ 
			SELECT
			       ROWNUM                                                                         AS rnum
			      ,TO_CHAR (TO_DATE (LG77.PERIOD, 'YYYYMM'), 'MM/YYYY')      AS period
			      ,LG77.LOC_CODE                                                                AS loccd
			      ,NVL ( (SELECT USER_NAME
			                FROM SYS0047M
			               WHERE USER_ID = SY28.WH_LOC_ID), SY28.WH_LOC_ID) CT_NAME
			      ,LG77.STK_CODE                                                                 AS itmcd
			      ,SY26.STK_DESC                                                                 AS itmnm
			      ,SY26.STK_CTGRY_ID
			      , (SELECT CODE_NAME
			           FROM SYS0013M
			          WHERE CODE_ID = SY26.STK_CTGRY_ID) STK_CTGRY_NAME
			      ,SY26.STK_TYPE_ID
			      , (SELECT CODE_NAME
			           FROM SYS0013M
			          WHERE CODE_ID = SY26.STK_TYPE_ID) STK_TYPE_NAME
			      ,SY26.UOM
			      , (SELECT CODE_NAME
			           FROM SYS0013M
			          WHERE CODE_ID = SY26.UOM) UOM_NAME
			      ,NVL(LG77.MAX_QTY,0)                                                     AS maxqty
			      ,NVL(LG77.REORD_QTY,0)                                                  AS reordqty
			      ,NVL(LG77.SFTY_QTY,0)                                                    AS sftyqty
			      ,NVL(LG77.PLANNED_QTY,0)                                                AS planqty
			      ,TO_CHAR(LG77.CRT_DT,'DD/MM/YYYY') CRT_DT
			      ,LG77.CRT_USER
			      ,NVL ( (SELECT USER_NAME
			                FROM SYS0047M
			               WHERE USER_ID = LG77.CRT_USER), LG77.CRT_USER) USER_NAME
			      ,NVL(AV.AVG_QTY,0) AVG_QTY
			  FROM LOG0077M LG77
			      ,SYS0028M SY28
			      ,SYS0026M SY26
			      , (SELECT A.STORG_LOC
			               ,A.MATRL_NO
			               ,ROUND (A.H / (A.H + A.S) ) AVG_QTY
			           FROM (SELECT   STORG_LOC
			                         ,MATRL_NO
			                         ,DEBT_CRDIT_INDICT
			                         ,NVL (DECODE (DEBT_CRDIT_INDICT, 'H', SUM (QTY) * -1), 0) H
			                         ,NVL (DECODE (DEBT_CRDIT_INDICT, 'S', SUM (QTY) ), 0) S
			                     FROM LOG0059M LG59, LOG0060D LG60
			                    WHERE LG59.MATRL_DOC_NO = LG60.MATRL_DOC_NO
			                      AND SUBSTR (LG60.INVNTRY_MOV_TYPE, 0, 2) = 'OD'
			                      AND LG59.CRT_DT BETWEEN ADD_MONTHS (TRUNC (TO_DATE(#{speriod},'MM/YYYY'), 'MM'), -3)
			                                          AND LAST_DAY (ADD_MONTHS (TRUNC (TO_DATE(#{speriod},'MM/YYYY'), 'MM'), -1) )
			                 GROUP BY STORG_LOC, MATRL_NO, DEBT_CRDIT_INDICT
			                 ORDER BY STORG_LOC, MATRL_NO) A) AV
			 WHERE LG77.LOC_CODE = SY28.WH_LOC_CODE
			   AND LG77.STK_CODE = SY26.STK_CODE
			   AND LG77.LOC_CODE = AV.STORG_LOC(+)
			   AND LG77.STK_CODE = AV.MATRL_NO(+)
			   AND SY28.WH_LOC_GB IN ('02','05')
			    ]]>
			    <!-- 데이터 안나와서 아우터 함 -->
		    <if test="speriod != null and speriod !=''">
              AND LG77.PERIOD = TO_CHAR(TO_DATE(#{speriod},'MM/YYYY') , 'YYYYMM')
            </if>
			<choose>
			     <when test="sttype != null and sttype !=''">
			      AND SY26.STK_TYPE_ID = #{sttype}
			     </when>
			     <otherwise>
			     AND SY26.STK_TYPE_ID IN(62,63)
			     </otherwise>
			</choose>
		   <if test="slocgb != null and slocgb !=''">
              AND SY28.WH_LOC_GB = #{slocgb}
           </if>
           <if test="sloccode != null and sloccode !=''">
              AND LG77.LOC_CODE = #{sloccode}
           </if>
           <if test="scate != null and scate !=''">
              AND SY26.STK_CTGRY_ID = #{scate}
           </if>
			   ORDER BY LG77.LOC_CODE    
    </select>
    
    <select id="searchAutoCTList" parameterType="Map" resultType="egovMap">
                select ROWNUM          AS rnum
                 , to_char(to_date(L77.PERIOD , 'yyyymm') , 'mm/yyyy')      AS period  
                 , S28.WH_LOC_ID      AS locid
                 , L77.LOC_CODE    AS loccd
                 , S28.WH_LOC_DESC AS locnm
                 , L77.STK_CODE    AS itmcd
                 , S26.STK_DESC    AS itmnm
                 , S13.CODE        AS locgb
                 , L77.MAX_QTY     AS maxqty
                 , L77.REORD_QTY   AS reordqty
                 , L77.SFTY_QTY    AS sftyqty
                 ,nvl(T1.AverageQty,0) AS avgqty
                ,O01.MEM_CODE AS ct_No
                ,O01.NAME AS ct_Name
                , (SELECT CODE_NAME
                           FROM SYS0013M
                          WHERE CODE_ID = S26.STK_TYPE_ID) STK_TYPE_NAME
              from LOG0077M L77 ,
                   SYS0028M S28 , 
                   SYS0026M S26 ,
                   ORG0001D O01,
                   (SELECT * FROM SYS0013M WHERE CODE_MASTER_ID = 339) S13,
                   (SELECT STORG_LOC , MATRL_NO ,  MAX(BB) + MAX(AA) AS AverageQty
                      FROM (
                        SELECT L60.STORG_LOC , L60.MATRL_NO ,  L60.DEBT_CRDIT_INDICT  , SUM(L60.QTY) QTY,
                               NVL(DECODE( L60.DEBT_CRDIT_INDICT , 'H' , NVL(SUM(L60.QTY) , 0)*-1),0) AA , NVL(DECODE( L60.DEBT_CRDIT_INDICT , 'S' , NVL(SUM(L60.QTY),0)*1),0) BB
                          FROM LOG0059M L59 , LOG0060D L60 
                         WHERE TO_DATE(L59.DOC_DT,'YYYYMMDD') BETWEEN ADD_MONTHS(TO_DATE(to_char(to_date(#{searchperiod},'mm/yyyy') , 'yyyymm'),'YYYYMM') , -3) AND (TO_DATE(to_char(to_date(#{searchperiod},'mm/yyyy') , 'yyyymm'),'YYYYMM') -1)
                           AND L59.MATRL_DOC_NO = L60.MATRL_DOC_NO
                           AND L59.TRNSC_TYPE_CODE = 'OD'
                        GROUP BY L60.STORG_LOC , L60.MATRL_NO , L60.DEBT_CRDIT_INDICT
                    )
                 GROUP BY STORG_LOC , MATRL_NO
                ORDER BY STORG_LOC , MATRL_NO)T1              
             WHERE 1 = 1
               AND S28.WH_LOC_GB = S13.CODE
               AND L77.LOC_CODE = S28.WH_LOC_CODE
               AND L77.STK_CODE = S26.STK_CODE
               AND L77.STK_CODE = T1.MATRL_NO(+)
               AND L77.LOC_CODE=T1.STORG_LOC(+) 
              AND S28.WH_LOC_CODE =O01.MEM_CODE
           <if test="searchCtNo != null and searchCtNo !=''">
              AND L77.LOC_CODE = #{searchCtNo}
           </if>
           <if test="searchMatCode != null and searchMatCode !=''">
              AND L77.STK_CODE = #{searchMatCode}
           </if>
            <choose>
                 <when test="searchType != null and searchType !=''">
                  AND S26.STK_TYPE_ID = #{searchType}
                 </when>
                 <otherwise>
                 AND S26.STK_TYPE_ID IN(62,63)
                 </otherwise>
            </choose>
    </select>
    
</mapper>