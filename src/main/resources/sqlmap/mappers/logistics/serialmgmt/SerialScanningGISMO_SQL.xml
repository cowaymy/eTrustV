<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.logistics.serialmgmt.impl.SerialScanningGISMOMapper">

    <select id="selectSerialScanningGISMOList" parameterType="Map" resultType="egovMap">
    /* [com.coway.trust.biz.logistics.serialmgmt.impl.SerialScanningGISMOMapper.selectSerialScanningGISMOList] 20191121 - KR OHK */
    SELECT  /* SMO */
			    /*l55.DELVRY_NO AS delno,*/
			    l47.REQST_NO AS reqstno,
			    TO_CHAR(l47.REQST_CRT_DT, 'dd/mm/yyyy') AS reqstdt,
			    L47.REQST_TYPE as reqstType,
			    l47.trnsc_type AS trnscType,   -- US : STO, UM and L47.REQST_TYPE = 'PO' : Inbound SMO, UM and L47.REQST_TYPE <![CDATA[<>]]> 'PO' : SMO
			    l47.TRNSC_TYPE_DTL as trnsctypedtl,
			    --DBMS_LOB.SUBSTR (s28c.WH_LOC_DESC, 4000) AS frmloc,
			    DBMS_LOB.SUBSTR (s28q.WH_LOC_DESC, 4000) AS toloc,
			    l47.RCIV_CDC_RDC AS frmlocid,
			    l47.REQST_CDC_RDC AS tolocid,
			    NVL(TO_CHAR(TO_DATE(MAX(l54.DELVRY_DT), 'yyyymmdd'), 'dd/mm/yyyy'), '-') AS deldate,
			    SUM(NVL(l48.reqst_qty,0)) AS reqstQty,
			    SUM(NVL(l55.DELVRY_QTY,0)) AS delqty,
			    (SUM(NVL(l48.reqst_qty,0)) - SUM(NVL(l55.DELVRY_QTY,0))) AS remainQty
			--select l48.*--l54.DELVRY_GI_CMPLT
			FROM log0047m l47,
			    log0048d l48,
			    LOG0055D l55,
			    LOG0054M l54,
			    sys0028m s28q
			WHERE 1 = 1
			 AND l47.reqst_no = l48.reqst_no
			 AND l48.REQST_NO = l55.REQST_NO(+)
			 AND l48.REQST_NO_ITM = l55.REQST_NO_ITM(+)
			 AND l55.DELVRY_NO = l54.DELVRY_NO(+)
			 AND l47.reqst_cdc_rdc = s28q.WH_LOC_ID(+)
			 AND l47.REQST_CRT_DT  <![CDATA[>=]]>  to_date(#{searchDeliverySDate},'dd/mm/yyyy')   -- FROM
			 AND l47.REQST_CRT_DT <![CDATA[ <= ]]>  to_date(#{searchDeliveryEDate} || ' 23:59:59','dd/mm/yyyy HH24:MI:SS')   -- TO
		 <if test="locCode != null">
			 AND (1, l47.RCIV_CDC_RDC) IN
                <foreach item="item" collection="locCode" index="index" open="(" separator="," close=")">
                  (1, #{item})
                </foreach>
         </if>
             AND l47.trnsc_type IN ('UM')
			 AND L47.REQST_TYPE <![CDATA[<>]]>  'PO'
			 AND NVL(l47.REQST_STUS, 'N') <![CDATA[<>]]> 'C'
			 AND NVL(l55.del_flag,'N')  <![CDATA[<>]]>  'Y'
			 AND NVL(l47.REQST_DEL , 'N') = 'N'
			 AND NVL(l48.REQST_DEL , 'N') = 'N'
			 AND s28q.SERIAL_REQUIRE_CHK_YN = 'Y'
         <if test="searchRequestNo !=null and searchRequestNo != ''">
            AND l47.REQST_NO = #{searchRequestNo}
         </if>
			 GROUP BY /*l55.DELVRY_NO,*/ l47.REQST_NO, l47.REQST_CRT_DT, L47.REQST_TYPE, l47.trnsc_type, l48.reqst_qty,
			 l47.TRNSC_TYPE_DTL, s28q.WH_LOC_DESC, l47.RCIV_CDC_RDC, l47.REQST_CDC_RDC
			 HAVING SUM(NVL(l48.reqst_qty,0)) > SUM(NVL(l55.DELVRY_QTY,0))
			 ORDER BY l47.REQST_CRT_DT, l47.REQST_NO
    </select>
</mapper>