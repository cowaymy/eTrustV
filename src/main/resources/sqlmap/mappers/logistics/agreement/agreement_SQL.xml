<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.logistics.agreement.impl.agreementMapper">

    <select id="memberList" parameterType="Map" resultType="EgovMap">
        SELECT
            A.MEM_CODE memCode,
            A.MEM_TYPE memType,
            A.FULL_NAME name,
            A.NRIC nric,
            B.DEPTCODE deptCode,
            B.GRPCODE grpCode,
            B.ORGCODE orgCode,
            E.ROLE_DESC userRole,
            F.NAME status,
            NVL(TO_CHAR(A.PROMO_DT, 'DD/MM/YYYY'), '-') promoDt,
            CASE WHEN A.MEM_TYPE = '2' THEN TO_CHAR(G.CNFM_DT, 'DD/MM/YYYY') END AS CD_CNFM_DT,
            TO_CHAR(A.JOIN_DT, 'DD/MM/YYYY') JOIN_DT,
            G.CNFM AGMT_STUS
        FROM ORG0001D A
        INNER JOIN (
            SELECT
                B1.MEM_ID,
                CASE WHEN B1.DEPT_CODE = '' THEN B1.LAST_DEPT_CODE ELSE B1.DEPT_CODE END AS DEPTCODE,
                B1.LAST_GRP_CODE GRPCODE,
                B1.LAST_ORG_CODE ORGCODE,
                B1.MEM_LVL MEMLVL
                FROM ORG0005D B1
        ) B
            ON B.MEM_ID = A.MEM_ID
        INNER JOIN SYS0047M C
            ON C.USER_NAME = A.MEM_CODE
        INNER JOIN SYS0045M D
            ON D.USER_ID = C.USER_ID
        INNER JOIN SYS0044M E
            ON E.ROLE_ID = D.ROLE_ID
        INNER JOIN SYS0038M F
            ON F.STUS_CODE_ID = C.USER_STUS_ID
        LEFT JOIN ORG0003D G
            ON A.APLICNT_ID = G.APLCTN_ID
        WHERE
            A.MEM_TYPE = #{memTypeCom}
            <if test="code !=null and code !=''">
                AND A.MEM_CODE LIKE '%' || #{code} || '%'
            </if>
            <if test="name !=null and name !=''">
                AND A.FULL_NAME LIKE '%' || #{name} || '%'
            </if>
            <if test="icNum !=null and icNum !=''">
                AND A.NRIC LIKE '%' || #{icNum} || '%'
            </if>
            <if test="deptCode !=null and deptCode !=''">
                AND B.DEPTCODE LIKE '%' || #{deptCode} || '%'
            </if>
            <if test="grpCode !=null and grpCode !=''">
                AND B.GRPCODE LIKE '%' || #{grpCode} || '%'
            </if>
            <if test="orgCode !=null and orgCode !=''">
                AND B.ORGCODE LIKE '%' || #{orgCode} || '%'
            </if>
            <if test="memStusCmb != null and memStusCmb !='' ">
                AND C.USER_STUS_ID = #{memStusCmb}
            </if>
            <if test="memLevelCom != null and memLevelCom !='' ">
                AND B.MEMLVL = #{memLevelCom}
            </if>
            <if test="selectBranch != 0 ">
                AND A.BRNCH = #{selectBranch}
            </if>
        ORDER BY B.ORGCODE, B.GRPCODE, B.DEPTCODE, B.MEMLVL, C.USER_STUS_ID, A.MEM_CODE
    </select>

    <select id="getMemberInfo" parameterType="Map" resultType="EgovMap">
        <![CDATA[
            SELECT
                A.FULL_NAME NAME,
                A.NRIC NRIC,
                CASE WHEN B.DEPT_CODE = '' THEN B.LAST_DEPT_CODE ELSE B.DEPT_CODE END DEPTCDE,
                B.LAST_GRP_CODE GRPCDE,
                B.LAST_ORG_CODE ORGCDE,
                B.MEM_LVL MEMLVL,
                A.STUS,
                CASE
                    WHEN A.MEM_TYPE = '1' THEN (
                        CASE
                            WHEN C.UPD_DT <= TO_DATE('2017/05/01', 'YYYY/MM/DD') THEN '201604'
                            WHEN C.UPD_DT >= TO_DATE('2017/05/02', 'YYYY/MM/DD') AND C.UPD_DT < TO_DATE('2018/05/01', 'YYYY/MM/DD') THEN '201704'
                            WHEN C.UPD_DT >= TO_DATE('2018/05/01', 'YYYY/MM/DD') AND C.UPD_DT < TO_DATE('2018/06/09', 'YYYY/MM/DD') THEN '201805'
                            WHEN C.UPD_DT >= TO_DATE('2018/06/09', 'YYYY/MM/DD') THEN '201806'
                        END)
                    ELSE '2017'
                END AS CNFMDT,
                CASE WHEN A.MEM_TYPE = '2' THEN TO_CHAR(C.CNFM_DT, 'DD/MM/YYYY') END AS CD_CNFM_DT,
                NVL(TO_CHAR(A.PROMO_DT, 'DD/MM/YYYY'), '-') PROMO_DT,
                TO_CHAR(A.JOIN_DT, 'DD/MM/YYYY') JOIN_DT
            FROM ORG0001D A
            INNER JOIN ORG0005D B
                ON A.MEM_ID = B.MEM_ID
            LEFT JOIN ORG0003D C
                ON A.APLICNT_ID = C.APLCTN_ID
            WHERE A.MEM_CODE = #{memID}
        ]]>
    </select>

    <select id="getMemHPpayment" parameterType="Map" resultType="EgovMap">
        SELECT
            B.BILL_AMT VERSION
        FROM
            ORG0001D A
        INNER JOIN PAY0007D B
            ON A.MEM_ID = B.BILL_MEM_ID
        WHERE A.MEM_CODE = #{memID}
            <if test="memType !=null and memType !=''">
                AND A.MEM_TYPE = #{memType}
            </if>
            AND B.BILL_TYPE_ID = '222'
        ORDER BY
            A.MEM_ID DESC
    </select>

    <select id="getMemStatus" parameterType="Map" resultType="egovMap">
        SELECT
            A.STUS_CODE_ID CODE_ID,
            A.CODE,
            A.NAME CODE_NAME
        FROM SYS0038M A
        INNER JOIN (
            SELECT DISTINCT STUS FROM ORG0001D
        )B
        ON A.STUS_CODE_ID = B.STUS
    </select>

    <select id="getMemLevel" parameterType="Map" resultType="egovMap">
        SELECT
            MEM_ORG_LVL CODE_ID,
            MEM_ORG_LVL CODE,
            MEM_ORG_DESC_CODE || ' - ' || MEM_ORG_DESC CODE_NAME
        FROM ORG0012D
        <if test="groupCode != null and groupCode != '' ">
            WHERE MEM_TYPE_ID = #{groupCode}
        </if>
        <if test="userTypeId !=null and userTypeId !='' ">
            WHERE MEM_TYPE_ID = #{userTypeId}
        </if>
        ORDER BY CODE
    </select>

    <select id="getAgreementVersion" parameterType="Map" resultType="egovMap">
        SELECT * FROM (
        <if test="groupCode == 1 ">
            SELECT
                '201604' CODE_ID,
                '201604 VERSION' CODE_NAME
            FROM DUAL

            UNION ALL

            SELECT
                '201704' CODE_ID,
                '201704 VERSION' CODE_NAME
            FROM DUAL

            UNION ALL

            SELECT
                '201805' CODE_ID,
                '201805 VERSION' CODE_NAME
            FROM DUAL

            UNION ALL

            SELECT
                '201806' CODE_ID,
                '201806 VERSION' CODE_NAME
            FROM DUAL

        </if>
        <if test="groupCode == 2 ">
            SELECT
                '2017' CODE_ID,
                '2017 - 5.0 Version' CODE_NAME
            FROM DUAL

            /* to re-enable when new version is ready
            UNION ALL

            SELECT
                '2018' CODE_ID,
                '2018 - XXXX' CODE_NAME
            FROM DUAL*/
        </if>
        )
    </select>

    <select id="getBranchCd" parameterType="Map" resultType="EgovMap">
        SELECT
            USER_BRNCH_ID BRANCH
        FROM SYS0047M
        WHERE USER_ID = #{userId}
    </select>

    <select id="branch" parameterType="Map" resultType="egovMap">
        SELECT BRNCH_ID,CODE BRANCH_CODE, NAME BRANCH_NAME FROM SYS0005M WHERE STUS_ID = 1 AND TYPE_ID IN (42) ORDER BY CODE
    </select>

    <select id="cdEagmt1" parameterType="Map" resultType="egovMap">
        SELECT *
        FROM ORG0003D
        WHERE APLICNT_CODE = #{memID}
    </select>
</mapper>