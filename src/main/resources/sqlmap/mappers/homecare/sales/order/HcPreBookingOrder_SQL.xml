<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.homecare.sales.order.impl.HcPreBookingOrderMapper">
	<select id="selectHcPreBookingOrderList" parameterType="Map" resultType="egovMap">
		SELECT
		T1.PRE_BOOK_ID ,
		T1.PRE_BOOK_NO ,
		TO_CHAR(T1.PRE_BOOK_DT, 'DD/MM/YYYY') AS
		PRE_BOOK_DT ,
		T1.CUST_VERIFY_STUS ,
		T1.MEM_CODE ,
		T1.CUST_ID ,
		T2.NAME AS
		CUST_NAME ,
		T1.SALES_ORD_ID_OLD ,
		T3.STK_DESC ,
		T4.SALES_ORD_NO ,
		T5.ITM_STK_ID,
		T6.STK_DESC AS PREV_STK_DESC ,
		T7.CODE AS STUS_CODE
		FROM SAL0404M T1
		LEFT JOIN SAL0029D T2 ON T1.CUST_ID = T2.CUST_ID
		JOIN SYS0026M T3 ON T1.STK_ID = T3.STK_ID
		LEFT JOIN SAL0001D T4 ON T1.SALES_ORD_ID_OLD = T4.SALES_ORD_ID
		LEFT JOIN SAL0002D T5 ON T4.SALES_ORD_ID = T5.SALES_ORD_ID
		LEFT JOIN SYS0026M T6 ON T5.ITM_STK_ID = T6.STK_ID
		LEFT JOIN SYS0038M T7 ON T1.STUS_ID = T7.STUS_CODE_ID
		LEFT JOIN ORG0001D T8 ON T1.MEM_CODE = T8.MEM_CODE

		WHERE
		T3.STK_CTGRY_ID IN (SELECT AA.CODE_ID FROM SYS0013M AA, SYS0094M BB
                                                          WHERE AA.CODE = BB.CODE
                                                              AND AA.CODE_MASTER_ID = 11 AND BB.IND = 'HOMECARE')
		<if test='_ordNo != null and _ordNo != ""'>
			AND T1.PRE_BOOK_NO = #{_ordNo}
		</if>
		<if test='_memCode != null and _memCode != ""'>
			AND T1.MEM_CODE = #{_memCode}
		</if>
		<if test='memType != null and memType != ""'>
			AND T8.MEM_TYPE = #{memType}
		</if>
		<if test='verifyStatus != null and verifyStatus != ""'>
			AND T1.CUST_VERIFY_STUS = #{verifyStatus}
		</if>
		<if
			test='_reqstStartDt != null and _reqstStartDt != "" and _reqstEndDt != null and _reqstEndDt != "" and _reqstStartTime != null and _reqstStartTime != "" and _reqstEndTime != null and _reqstEndTime != ""'>
			AND T1.PRE_BOOK_DT BETWEEN TO_DATE(#{_reqstStartDt} ||
			#{_reqstStartTime}, 'dd/mm/yyyy hh24:mi') AND TO_DATE(#{_reqstEndDt}
			|| #{_reqstEndTime}, 'dd/mm/yyyy hh24:mi')
		</if>
		<if test='arrOrdProudctList != null and arrOrdProudctList != ""'>
			AND T1.STK_ID IN
			<foreach item="item" collection="arrOrdProudctList" index="index"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test='_nric != null and _nric != ""'>
			AND T2.NRIC = #{_nric}
		</if>
		<if test='arrCustType != null and arrCustType != ""'>
			AND T2.TYPE_ID IN
			<foreach item="item" collection="arrCustType" index="index"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test='_name != null and _name != ""'>
			AND T2.NAME LIKE #{_name}||'%'
		</if>
		<if test='arrPreOrdStusId != null and arrPreOrdStusId != ""'>
            AND T7.CODE IN
            <foreach item="item" collection="arrPreOrdStusId" index="index" open="(" separator="," close=")">
                #{item, jdbcType=VARCHAR}
            </foreach>
        </if>
        <if test='_sofNo != null and _sofNo != ""'>
			AND T4.REF_NO LIKE #{_sofNo}||'%'
		</if>
		ORDER BY T1.PRE_BOOK_ID ASC
	</select>

	<insert id="insertPreBookingOrder" parameterType="com.coway.trust.biz.sales.order.vo.PreBookingOrderVO">
		<selectKey keyProperty="preBookOrdId" resultType="Integer" order="BEFORE">
			SELECT SAL0404M_PRE_BOOK_ID.NEXTVAL FROM DUAL
		</selectKey>
		INSERT
		INTO SAL0404M
		(
		PRE_BOOK_ID ,
		PRE_BOOK_NO ,
		PRE_BOOK_DT ,
		CUST_ID ,
		CUST_VERIFY_STUS ,
		SALES_ORD_ID_OLD ,
		MEM_CODE ,
		STK_ID ,
		REM ,
		STUS_ID ,
		CRT_USER_ID ,
		CRT_DT ,
		UPD_USER_ID ,
		UPD_DT ,
		DISC_WAIVE
		)
		VALUES
		( #{preBookOrdId}
		, #{preBookOrdNo}
		, SYSDATE
		, #{custId}
		, #{custVerifyStus}
		, #{salesOrdIdOld}
		, #{memCode}
		, #{stkId}
		, #{rem}
		, #{stusId}
		, #{crtUserId}
		, SYSDATE
		, #{updUserId}
		, SYSDATE
		, #{discWaive}
		)
	</insert>

	<select id="selectHcPrevOrderNoList" parameterType="Map" resultType="egovMap">
        SELECT T1.SALES_ORD_NO
             , T4.CODE_NAME AS APP_TYPE
             , T3.STK_CODE
             , T3.STK_DESC
             , T1.PROMO_ID
             , T1.SALES_ORD_ID
             , (SELECT sys3.IND FROM SYS0026M SYS1, SYS0013M SYS2,SYS0094M SYS3
                   WHERE SYS1.STK_CTGRY_ID = SYS2.CODE_ID AND sys2.cODE_MASTER_ID
                   = 11 AND SYS2.CODE = SYS3.CODE(+) AND SYS1.STK_id = T2.ITM_STK_ID)
                   BUS_TYPE
          FROM SAL0001D T1
          JOIN SAL0002D T2
            ON T2.SALES_ORD_ID = T1.SALES_ORD_ID
          JOIN SYS0026M T3
            ON T3.STK_ID = T2.ITM_STK_ID
          JOIN SYS0013M T4
            ON T4.CODE_ID = T1.APP_TYPE_ID
         WHERE T1.CUST_ID = #{custId}
           AND T1.STUS_CODE_ID = 4
           AND T1.APP_TYPE_ID = 66
		   AND T3.STK_CTGRY_ID = 55
               AND T1.SALES_ORD_ID IN (
            SELECT A.SALES_ORD_ID
    FROM
                   SAL0070D A
                   JOIN
                   (
                   SELECT SALES_ORD_ID,MAX(RENT_INST_NO) RENT_INST_NO FROM SAL0070D WHERE RENT_INST_TYPE_ID = 159 GROUP BY SALES_ORD_ID
                   ) BB ON BB.SALES_ORD_ID = A.SALES_ORD_ID AND BB.RENT_INST_NO = A.RENT_INST_NO
                    JOIN SAL0001D B ON B.SALES_ORD_ID = A.SALES_ORD_ID AND B.STUS_CODE_ID = 4 AND B.BNDL_ID IS NULL
                     JOIN SAL0002D C ON C.SALES_ORD_ID = B.SALES_ORD_ID
                     JOIN SYS0026M D ON D.STK_ID = C.ITM_STK_ID AND D.STK_CTGRY_ID = 55
                    WHERE
                   A.RENT_INST_TYPE_ID = 159
                   AND B.CUST_ID = #{custId}
                   AND MONTHS_BETWEEN(TO_DATE(LAST_DAY(A.RENT_INST_DT)),TO_DATE(LAST_DAY(SYSDATE))) BETWEEN 1 AND 4
            )

    </select>

    <select id="selectHcPreBookingOrderInfo" parameterType="Map" resultType="egovMap">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcPreOrderMapper.selectHcPreBookingOrderInfo */
        SELECT
        T1.PRE_BOOK_ID ,
		T1.PRE_BOOK_NO ,
		T1.CUST_VERIFY_STUS ,
		T1.MEM_CODE ,
		T1.CUST_ID ,
		T1.STK_ID ,
		T1.REM ,
		T1.SALES_ORD_ID_OLD ,
		T2.SALES_ORD_NO AS SALES_ORD_NO_OLD ,
		T3.STK_DESC ,
		T1.STUS_ID ,
		T4.CODE AS STUS_CODE
		FROM SAL0404M T1
		LEFT JOIN SAL0001D T2 ON T1.SALES_ORD_ID_OLD = T2.SALES_ORD_ID
		LEFT JOIN SYS0026M T3 ON T1.STK_ID = T3.STK_ID
		LEFT JOIN SYS0038M T4 ON T1.STUS_ID = T4.STUS_CODE_ID
		WHERE
		T1.PRE_BOOK_ID = #{preBookId}
    </select>

  <select id="selectPreBookOrderVerifyStus" parameterType="Map" resultType="egovMap">
        SELECT
		T1.CUST_VERIFY_STUS , T1.PRE_BOOK_NO
		FROM SAL0404M T1
		LEFT JOIN SAL0001D T2 ON T1.SALES_ORD_ID_OLD = T2.SALES_ORD_ID
		WHERE
		T1.STUS_ID = 1
		AND T1.CUST_ID = #{custId}
		AND T1.SALES_ORD_ID_OLD = #{salesOrdIdOld}
		AND T1.CUST_VERIFY_STUS NOT IN ('N')
		<![CDATA[
		AND ROWNUM <= 1
		]]>
  </select>

      <update id="updateHcPreBookOrderCancel" parameterType="Map">
        UPDATE SAL0404M SET
                      UPD_DT                = SYSDATE
                    , UPD_USER_ID           = #{updUserId}
                    , STUS_ID               = #{stusId}
                    , REM                   = #{rem}
                  WHERE PRE_BOOK_ID         = #{preBookId}
    </update>

    <select id="selectPreBookOrderCancelStatus" parameterType="Map" resultType="egovMap">
     <![CDATA[
    SELECT
	    T2.NAME AS STUS
	    , REM
	    , T3.USER_NAME AS UPD_USER_ID
	    , UPD_DT
	    , CASE WHEN TO_CHAR(UPD_DT, 'HH12') < 12 THEN  TO_CHAR(UPD_DT, 'HH12:MI AM')
          ELSE TO_CHAR(UPD_DT, 'HH12:MI PM') END AS UPD_TIME
    FROM SAL0404M T1
	    JOIN SYS0038M T2 on T1.STUS_ID = T2.STUS_CODE_ID
	    JOIN SYS0047M T3 on T1.UPD_USER_ID = T3.USER_ID
    WHERE
    T1.PRE_BOOK_ID = #{preBookId}
    AND T1.STUS_ID = 10
    ORDER BY UPD_DT DESC
     ]]>
    </select>

    <select id="selectPreBookSalesPerson" parameterType="Map" resultType="egovMap">
      SELECT T1.MEM_ID
             , T1.MEM_CODE
             , T1.NAME
             , T1.NRIC
             , T1.MEM_TYPE
             , T2.CODE_NAME

      FROM ORG0001D T1
      LEFT JOIN SYS0013M T2 ON T1.MEM_TYPE = T2.CODE_ID
      WHERE 1=1
      <if test='memId != null and memId !=0'>
                AND T1.MEM_ID = #{memId}
      </if>
      <if test='memCode != null and memCode !=""'>
                AND T1.MEM_CODE = #{memCode}
      </if>
      <if test='memType != null and !memType.isEmpty()'>
      AND T1.MEM_TYPE IN
      <foreach item="item" collection="memType" index="index" open="(" separator="," close=")">
                #{item.paramVal, jdbcType=INTEGER}
      </foreach>
      </if>
    </select>

    <select id="selectPreBookConfigurationPerson" parameterType="Map" resultType="egovMap">

       SELECT T2.MEM_ID
             , T2.MEM_CODE
             , T2.NAME
             , T2.NRIC
             , T2.MEM_TYPE
             , T3.CODE_NAME
             , T5.SALES_ORD_ID
             , T5.SALES_ORD_NO
             , T4.SRV_EXPR_DT
      FROM SAL0090D T1
      LEFT JOIN ORG0001D T2 ON T1.SRV_CODY_ID = T2.MEM_ID
      LEFT JOIN SYS0013M T3 ON T2.MEM_TYPE = T3.CODE_ID
      LEFT JOIN SAL0095D T4 ON T1.SRV_SO_ID = T4.SRV_SALES_ORD_ID
      LEFT JOIN SAL0001D T5 ON T1.SRV_SO_ID = T5.SALES_ORD_ID
      WHERE
      T1.SRV_STUS_ID = 1
      AND T4.SRV_STUS_CODE_ID = 4
	  <if test='salesOrdId != null and salesOrdId !=0'>
                AND T5.SALES_ORD_ID = #{salesOrdId}
      </if>
      <if test='salesOrdNo != null and salesOrdNo !=""'>
                AND T5.SALES_ORD_NO = #{salesOrdNo}
      </if>
      <if test='memId != null and memId !=0'>
                AND T2.MEM_ID = #{memId}
      </if>
      <if test='memCode != null and memCode !=""'>
                AND T2.MEM_CODE = #{memCode}
      </if>
      <if test='memType != null and !memType.isEmpty()'>
      AND T2.MEM_TYPE IN
      <foreach item="item" collection="memType" index="index" open="(" separator="," close=")">
                #{item.paramVal, jdbcType=INTEGER}
      </foreach>
      </if>
    </select>

</mapper>