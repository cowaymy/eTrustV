<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.homecare.sales.order.impl.HcOrderListMapper">

    <!-- Homecare 주문내역 조회 -->
    <select id="selectHcOrderList" parameterType="Map" resultType="egovMap">
         /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderListMapper.selectHcOrderList */
        SELECT T.APP_TYPE_CODE
                 , T.APP_TYPE_NAME
                 , T.CRT_USER_ID
                 , T.CUST_IC
                 , T.CUST_NAME
                 , T.CUST_VA_NO
                 , T.DSC_BRNCH_ID
                 , T.KEYIN_BRNCH_ID
                 , T.ORD_ID
                 , T.ORD_NO
                 , T.ORD_STUS_CODE
                 , T.PO_NO
                 , T.PRODUCT_CODE
                 , T.PRODUCT_NAME
                 , T.REF_NO
                 , T.RENT_STUS
                 , T.SALESMAN_MEM_ID
                 , T.SALESMAN_CODE
                 , T.SALESMAN_MEM_TYPE_ID
                 , T.BILLING_GRP_ID
                 , T.MAIL_TEL_MOB
                 , T.MAIL_TEL_FAX
                 , T.MAIL_TEL_OFF
                 , T.MAIL_TEL_RES
                 , T.INST_TEL_FAX
                 , T.INST_TEL_MOB
                 , T.INST_TEL_OFF
                 , T.INST_TEL_RES
                 , T.SIRIM_NO
                 , T.SERIAL_NO
                 , T.PROMO_CODE
                 , T.PROMO_DESC
                 , T.RELATED_NO
                 , T.RELATED_ID
                 , 1 C1
                 , NVL(T.APP_TYPE_ID, 0) AS APP_TYPE_ID
                 , NVL(T.CUST_ID, 0) AS CUST_ID
                 , TO_CHAR(T.ORD_DT, 'DD/MM/YYYY') AS ORD_DT
                 , NVL(T.ORD_STUS_ID, 0) AS ORD_STUS_ID
                 , NVL(T.PRODUCT_ID, 0) AS PRODUCT_ID
                 , T.PV_MONTH
                 , T.PV_YEAR
                 , T.BNDL_NO

         FROM ( SELECT /*+ use_nl( V1.som V1.ir V1.ie V1.ei V1.i V1.sod V1.cp3 V1.cp2 V1.rs V1.c V1.u V1.mem V1.cd V1.stk V1.pm V1.S ) */
                              V1.APP_TYPE_CODE
                            , V1.APP_TYPE_ID
                            , V1.APP_TYPE_NAME
                            , V1.CRT_USER_ID
                            , V1.CUST_IC
                            , V1.CUST_NAME
                            , V1.CUST_ID
                            , V1.CUST_VA_NO
                            , V1.DSC_BRNCH_ID
                            , V1.KEYIN_BRNCH_ID
                            , V1.ORD_DT
                            , V1.ORD_ID
                            , V1.ORD_NO
                            , V1.ORD_STUS_CODE
                            , V1.ORD_STUS_ID
                            , V1.PO_NO
                            , V1.PRODUCT_ID
                            , V1.PRODUCT_CODE
                            , V1.PRODUCT_NAME
                            , V1.REF_NO
                            , V1.RENT_STUS
                            , V1.SALESMAN_MEM_ID
                            , V1.SALESMAN_CODE
                            , V1.SALESMAN_MEM_TYPE_ID
                            , V1.BILLING_GRP_ID
                            , V1.MAIL_TEL_MOB
                            , V1.MAIL_TEL_FAX
                            , V1.MAIL_TEL_OFF
                            , V1.MAIL_TEL_RES
                            , V1.INST_TEL_FAX
                            , V1.INST_TEL_MOB
                            , V1.INST_TEL_OFF
                            , V1.INST_TEL_RES
                            , V1.SIRIM_NO
                            , V1.SERIAL_NO
                            , V1.ITM_PRC_ID
                            , V1.PV_MONTH
                            , V1.PV_YEAR
                            , V1.PROMO_CODE
                            , V1.PROMO_DESC
                            , V1.RELATED_NO
                            , V1.RELATED_ID
                            , D1.BNDL_NO
                    FROM SAL1013V  V1
                      JOIN SYS0026M S1 ON V1.PRODUCT_CODE = S1.STK_CODE
               LEFT JOIN HMC0011D D1 ON V1.BNDL_ID = D1.ORD_SEQ_NO
                    <if test='(serialNo != null and serialNo != "") || sirimNo != null and sirimNo != ""'>
                        INNER JOIN ( SELECT IE.SALES_ORD_ID
                                            FROM SAL0047D IR
                            LEFT OUTER JOIN SAL0046D IE ON IE.INSTALL_ENTRY_ID = IR.ENTRY_ID WHERE
                                    <choose>
                                        <when test='serialNo != null and serialNo != ""'>
                                            UPPER(IR.SERIAL_NO) = UPPER(#{serialNo})
                                            <if test='sirimNo != null and sirimNo != ""'>
                                                AND UPPER(IR.SIRIM_NO) = UPPER(#{sirimNo})
                                            </if>
                                        </when>
                                        <otherwise>
                                            <if test='sirimNo != null and sirimNo != ""'>
                                                IR.SIRIM_NO = UPPER(#{sirimNo})
                                            </if>
                                        </otherwise>
                                    </choose>
                                          ) A on V1.ORD_ID = A.SALES_ORD_ID
                    </if>

                    WHERE 1 = 1
                       AND S1.STK_CTGRY_ID IN (SELECT AA.CODE_ID FROM SYS0013M AA, SYS0094M BB
                                                             WHERE AA.CODE = BB.CODE
                                                                 AND AA.CODE_MASTER_ID = 11 AND BB.IND = 'HOMECARE')      /* STKCATEGORYID_HOMECARE */
                        <if test='ordDt == null || ordDt == ""'>
                             AND V1.SALES_DT BETWEEN TO_DATE(#{ordStartDt}, 'YYYY-MM-DD') AND TO_DATE(#{ordEndDt}||' 23:59:59', 'YYYY-MM-DD HH24:MI:SS')
                        </if>
                        <if test='ordDt != null and ordDt != ""'>
                             AND V1.SALES_DT BETWEEN TO_DATE(#{ordDt}, 'DD/MM/YYYY') AND TO_DATE(#{ordDt}||' 23:59:59', 'DD/MM/YYYY HH24:MI:SS')
                        </if>
                        <if test='ordNo != null and ordNo != ""'>
                             AND V1.ORD_NO = #{ordNo}
                        </if>
                        <if test='arrAppType != null and arrAppType != ""'>
                             AND V1.APP_TYPE_ID IN
                             <foreach item="item" collection="arrAppType" index="index" open="(" separator="," close=")">
                                 #{item}
                             </foreach>
                        </if>
                        <if test='arrOrdStusId != null and arrOrdStusId != ""'>
                            AND V1.ORD_STUS_ID IN
                            <foreach item="item" collection="arrOrdStusId" index="index" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                        <if test='arrKeyinBrnchId != null and arrKeyinBrnchId != ""'>
                            AND V1.KEYIN_BRNCH_ID IN
                            <foreach item="item" collection="arrKeyinBrnchId" index="index" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                        <if test='arrDscBrnchId != null and arrDscBrnchId != ""'>
                            AND V1.DSC_BRNCH_ID IN
                            <foreach item="item" collection="arrDscBrnchId" index="index" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                        <if test='custId != null and custId != ""'>
                            AND V1.CUST_ID = #{custId}
                        </if>
                        <if test='custName != null and custName != ""'>
                            AND V1.CUST_NAME LIKE '%'||UPPER(#{custName})||'%'
                        </if>
                        <if test='custIc != null and custIc != ""'>
                            AND V1.CUST_IC LIKE '%'||UPPER(#{custIc})||'%'
                        </if>
                        <if test='productId != null and productId != ""'>
                            AND V1.PRODUCT_ID = #{productId}
                        </if>
                        <if test='salesmanCode != null and salesmanCode != ""'>
                            AND V1.SALESMAN_CODE = UPPER(#{salesmanCode})
                        </if>
                        <if test='arrRentStus != null and arrRentStus != ""'>
                            AND V1.RENT_STUS IN
                            <foreach item="item" collection="arrRentStus" index="index" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                        <if test='refNo != null and refNo != ""'>
                            AND V1.REF_NO = UPPER(#{refNo})
                        </if>
                        <if test='poNo != null and poNo != ""'>
                            AND V1.PO_NO = UPPER(#{poNo})
                        </if>
                        <if test='contactNo != null and contactNo != ""'>
                            AND #{contactNo} IN (V1.MAIL_TEL_MOB, V1.MAIL_TEL_OFF, V1.MAIL_TEL_RES)
                        </if>
                        <if test='vaNo != null and vaNo != ""'>
                            AND V1.CUST_VA_NO = UPPER(#{vaNo})
                        </if>
                        <if test='crtUserId != null and crtUserId != ""'>
                            AND V1.CRT_USER_ID = UPPER(#{crtUserId})
                        </if>
                        <if test='promoCode != null and promoCode != ""'>
                            AND V1.PROMO_CODE = UPPER(#{promoCode})
                        </if>
                        <if test='relatedNo != null and relatedNo != ""'>
                            AND V1.RELATED_NO = UPPER(#{relatedNo})
                        </if>
                        <if test='invoicePoNo != null and invoicePoNo != ""'>
                            AND V1.ORD_ID IN (SELECT DISTINCT PO_ORD_ID
                                                         FROM PAY0015D
                                                        WHERE PO_REF_NO = #{invoicePoNo})
                        </if>
                        <if test='isEKeyin != null and isEKeyin != ""'>
                            AND EKEY_IN_ID IS NOT NULL
                        </if>
                        <if test='bndlNo != null and bndlNo != ""'>
                            AND UPPER(D1.BNDL_NO) = UPPER(#{bndlNo})
                        </if>
         ) T
         ORDER BY T.ORD_NO ASC
    </select>

    <!-- Homecare 정보 조회(매핑테이블 조회) -->
    <select id="selectHcOrderInfo" parameterType="Map" resultType="egovMap">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderListMapper.selectHcOrderInfo */
        SELECT A.ORD_SEQ_NO
                 , A.CUST_ID
                 , A.SALES_DT
                 , A.SALES_DT_STR
                 , A.MAT_ORD_NO
                 , A.FRA_ORD_NO
                 , A.MAT_PRE_ORD_ID
                 , A.FRA_PRE_ORD_ID
                 , A.ORD_ID
                 , A.ANO_ORD_NO
                 , A.SRV_ORD_ID
                 , A.PRODUCT_CODE
                 , A.BNDL_NO
                 , (SELECT SAL1.SALES_ORD_ID FROM SAL0001D SAL1 WHERE SAL1.SALES_ORD_NO = A.ANO_ORD_NO) AS ANO_ORD_ID
                 , (SELECT SYS2.CODE FROM SYS0026M SYS1, SYS0013M SYS2
                   WHERE SYS1.STK_CTGRY_ID = SYS2.CODE_ID AND SYS1.STK_ID = A.PRODUCT_CODE) AS ORD_CTGRY_CD

         FROM (
                SELECT H1.ORD_SEQ_NO
		                 , H1.CUST_ID
		                 , H1.SALES_DT
		                 , TO_CHAR(H1.SALES_DT, 'MM/dd/YYYY') AS SALES_DT_STR
		                 , H1.MAT_ORD_NO
		                 , H1.FRA_ORD_NO
		                 , H1.MAT_PRE_ORD_ID
                         , H1.FRA_PRE_ORD_ID
		                 , S1.SALES_ORD_ID  AS ORD_ID
		                 , S2.ITM_STK_ID      AS PRODUCT_CODE
                        <choose>
		                  <when test='srvOrdId != null and srvOrdId != ""'>
	                           , H1.FRA_ORD_NO AS ANO_ORD_NO
	                      </when>
	                      <otherwise>
	                            , DECODE(#{ordNo}, H1.FRA_ORD_NO, H1.MAT_ORD_NO, H1.MAT_ORD_NO, H1.FRA_ORD_NO) AS ANO_ORD_NO
	                      </otherwise>
		                </choose>
		                 , H1.SRV_ORD_ID
		                 , H1.BNDL_NO

		         FROM HMC0011D H1
		                 , SAL0001D S1
                         , SAL0002D S2

		        WHERE H1.CUST_ID = S1.CUST_ID
		           AND S1.SALES_ORD_ID = S2.SALES_ORD_ID
	           <choose>
                       <when test='srvOrdId != null and srvOrdId != ""'>
                           AND S1.SALES_ORD_ID = H1.SRV_ORD_ID
                           AND H1.SRV_ORD_ID = #{srvOrdId}
                       </when>
                       <otherwise>
                           AND S1.SALES_ORD_NO = #{ordNo}
                           AND (H1.MAT_ORD_NO = #{ordNo} OR H1.FRA_ORD_NO = #{ordNo})
                       </otherwise>
	           </choose>
        ) A
    </select>

</mapper>