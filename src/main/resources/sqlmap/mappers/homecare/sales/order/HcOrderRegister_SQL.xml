<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper">

    <!-- Homecare Product 정보 조회 -->
    <select id="selectHcProductCodeList" parameterType="Map" resultType="egovMap">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.selectHcProductCodeList */
        SELECT STK_ID
                 , C1
                 , CODE_NAME
         FROM
         (
            <choose>
                <when test='stkType != null and stkType == "1"'>
                    SELECT DISTINCT T1.STK_ID
                             , T1.STK_CODE ||' - '||T1.STK_DESC C1
                             , CASE WHEN T2.DISCONTINUE = '1' THEN T3.CODE_NAME ||' ('||T5.CODE_NAME||')'
                               ELSE T3.CODE_NAME
                               END CODE_NAME
                             , T2.DISCONTINUE

                     FROM SYS0026M T1          /* InvStock */
                             , SAL0082D T2          /* ServiceContractPackage_Product */
                             , SYS0013M T3         /* CodeDetail */
                             , SYS0013M T5         /* CodeDetail */
                    WHERE T1.STK_ID = T2.SRV_PAC_ITM_PRODUCT_ID
                       AND T1.STK_CTGRY_ID = T3.CODE_ID
                       AND 1 = T2.SRV_PAC_ITM_STUS_ID
                       AND 61 = T1.STK_TYPE_ID
                       AND T2.SRV_CNTRCT_PAC_ID = #{srvPacId}
                       AND TO_CHAR(T2.DISCONTINUE) = T5.CODE
                       AND T5.CODE_MASTER_ID = '381'
<!--                         FOR Homecare MAIN/AUX unit handling    -->
                        <if test='productType != null and productType != ""'>
                             <if test='productType == "1"'>
                                AND T3.CODE != 'FRM' AND T3.CODE != 'ACO'
                             </if>
                             <if test='productType == "2"'>
                                AND (T3.CODE = 'FRM' OR T3.CODE = 'ACO')
                             </if>
                        </if>
                </when>
                <otherwise>
                    SELECT DISTINCT T1.STK_ID
                             , T1.STK_CODE ||' - '||T1.STK_DESC C1
                             , CASE WHEN T2.DISCONTINUE = '1' THEN T3.CODE_NAME ||' ('||T5.CODE_NAME||')'
                               ELSE T3.CODE_NAME
                               END CODE_NAME
                             , T2.DISCONTINUE

                     FROM SYS0026M T1          /* InvStock */
                             , SAL0092M T2         /* SrvMembershipPacD */
                             , SYS0013M T3         /* CodeDetail */
                             , SAL0016M T4         /* SalesPrice */
                             , SYS0013M T5         /* CodeDetail */

                    WHERE T1.STK_ID = T2.SRV_MEM_ITM_STK_ID
                        AND T1.STK_CTGRY_ID = T3.CODE_ID
                        AND 1 = T2.SRV_MEM_ITM_STUS_ID
                        AND 61 = T1.STK_TYPE_ID
                        AND T2.SRV_MEM_PAC_ID = #{srvPacId}
                        AND TO_CHAR(T2.DISCONTINUE) = T5.CODE
                        AND T5.CODE_MASTER_ID = '381'
<!--                         FOR Homecare MAIN/AUX unit handling    -->
                       <if test='productType != null and productType != ""'>
                             <if test='productType == "1"'>
                                AND T3.CODE != 'FRM' AND T3.CODE != 'ACO'
                             </if>
                             <if test='productType == "2"'>
                                AND (T3.CODE = 'FRM' OR T3.CODE = 'ACO')
                             </if>
                        </if>
                </otherwise>
            </choose>
        ) A
        <if test="postcode != null and postcode != ''">
            LEFT JOIN SYS0098M POSTCODE_BLOCK
                ON POSTCODE_BLOCK.PARAM_VAL = #{postcode}
                AND POSTCODE_BLOCK.MODULE = 'SALES'
                AND POSTCODE_BLOCK.SUB_MODULE = 'KEYIN_BLOCK'
                AND POSTCODE_BLOCK.PARAM_CODE = 'POSTCODE'
            LEFT JOIN SYS0098M STK_ID_BLOCK
                ON STK_ID_BLOCK.PARAM_VAL = TO_CHAR(A.STK_ID)
                AND STK_ID_BLOCK.MODULE = 'SALES'
                AND STK_ID_BLOCK.SUB_MODULE = 'KEYIN_BLOCK'
                AND STK_ID_BLOCK.PARAM_CODE = 'STK_ID'
            WHERE POSTCODE_BLOCK.SEQ IS NULL
            OR STK_ID_BLOCK.SEQ IS NULL
        </if>
        ORDER BY DISCONTINUE, CODE_NAME ASC, STK_ID ASC
    </select>

    <!-- get Order Seq No -->
    <select id="getOrdSeqNo" resultType="int">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.getOrdSeqNo */
        SELECT HMC0011D_SEQ.NEXTVAL FROM DUAL
    </select>

    <!-- get Order Seq No -->
    <select id="getBndlNo" parameterType="int" resultType="string">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.getBndlNo */
        SELECT 'SB' || LPAD(#{ordSeqNo}, 8, '0') FROM DUAL
    </select>

    <!-- Homecare Mapping Table Insert -->
    <insert id="insertHcRegisterOrder" parameterType="com.coway.trust.biz.homecare.sales.order.vo.HcOrderVO">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.insertHcRegisterOrder */
        INSERT INTO HMC0011D (
               ORD_SEQ_NO
             , CUST_ID
             , SALES_DT
             , MAT_ORD_NO
             , FRA_ORD_NO
             , CRT_DT
             , CRT_USER_ID
             , UPD_DT
             , UPD_USER_ID
             , MAT_PRE_ORD_ID      /* eKeyin Mat ord_id */
             , FRA_PRE_ORD_ID       /* eKeyin Fra Ord_id */
             , STUS_ID
             , BNDL_NO
             , SRV_ORD_ID

        ) VALUES (
               #{ordSeqNo}
             , #{custId}
             , SYSDATE
             , #{matOrdNo}
             , #{fraOrdNo}
             , SYSDATE
             , #{crtUserId}
             , SYSDATE
             , #{updUserId}
             , #{matPreOrdId}
             , #{fraPreOrdId}
             , #{stusId}
             , #{bndlNo}
             , #{srvOrdId}
        )
    </insert>

    <!-- Homecare Mapping Table update -->
    <update id="updateHcPreOrder" parameterType="com.coway.trust.biz.homecare.sales.order.vo.HcOrderVO">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.updateHcPreOrder */
        UPDATE HMC0011D SET
                      UPD_DT                  = SYSDATE
                    , UPD_USER_ID           = #{updUserId}
                <if test='custId != null and custId != ""'>
                    , CUST_ID                  = #{custId}
                </if>
                <if test='matOrdNo != null and matOrdNo != ""'>
                    , MAT_ORD_NO          = #{matOrdNo}       /* Mat ord_no */
                </if>
                <if test='fraOrdNo != null and fraOrdNo != ""'>
                    , FRA_ORD_NO           = #{fraOrdNo}         /* Fra Ord_no */
                </if>
                <if test='matPreOrdId != null and matPreOrdId != ""'>
                    , MAT_PRE_ORD_ID     = #{matPreOrdId}    /* eKeyin Mat ord_id */
                </if>
                <if test='fraPreOrdId != null and fraPreOrdId != ""'>
                    , FRA_PRE_ORD_ID      = #{fraPreOrdId}      /* eKeyin Fra Ord_id */
                </if>
                <if test='stusId != null and stusId != ""'>
                    , STUS_ID                  = #{stusId}
                </if>
                <if test='srvOrdId != null and srvOrdId != ""'>
                    , SRV_ORD_ID            = #{srvOrdId}
                </if>
           WHERE ORD_SEQ_NO          = #{ordSeqNo}
    </update>

    <!-- Get Product Size -->
    <select id="getProductSize" parameterType="string" resultType="string">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.getProductSize */
        SELECT STK_SIZE FROM SYS0026M WHERE STK_ID = #{product}
    </select>

    <!-- Select Promotion By Frame -->
    <select id="selectPromotionByFrame" parameterType="Map" resultType="egovMap">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.selectPromotionByFrame */
        SELECT DISTINCT T2.PROMO_ID CODE
                 , T2.PROMO_CODE || '-' || T2.PROMO_DESC CODE_NAME

         FROM SAL0018D T1
           JOIN SAL0017D T2
             ON T2.PROMO_ID = T1.PROMO_ID

        WHERE T2.PROMO_ID = 31723
    </select>

    <select id="getCountHcPreOrder" parameterType="int" resultType="int">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.getCountHcPreOrder */
        SELECT COUNT(ORD_SEQ_NO) FROM HMC0011D WHERE ORD_SEQ_NO = #{ordSeqNo}
    </select>

    <select id="getCountExistBndlId" parameterType="String" resultType="int">
        SELECT COUNT(BNDL_ID) FROM API0005D WHERE BNDL_ID = #{bndlId}
    </select>

    <select id="getPrevOrdSeq" parameterType="String" resultType="int">
        SELECT A.ORD_SEQ_NO
		FROM HMC0011D A
		JOIN SAL0001D B ON A.ORD_SEQ_NO = B.BNDL_ID
		JOIN API0005D C ON C.ECOMM_ORD_ID = B.ECOMM_ORD_ID AND B.SALES_ORD_ID = C.SALES_ORD_ID
		WHERE C.BNDL_ID = #{bndlId}
    </select>

    <select id="getPrevOrdId" parameterType="Map" resultType="int">
        SELECT SALES_ORD_ID FROM API0005D WHERE BNDL_ID = #{ecommBndlId} AND ECOMM_ORD_ID != #{ecommOrdId}
    </select>

    <!-- Get Product Category -->
    <select id="getProductCategory" parameterType="string" resultType="string">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.getProductCategory */
        SELECT STK_CTGRY_ID FROM SYS0026M WHERE STK_ID = #{product}
    </select>
</mapper>