<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper">

    <!-- Homecare Product 정보 조회 -->
    <select id="selectHcProductCodeList" parameterType="Map" resultType="egovMap">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.selectHcProductCodeList */
        SELECT STK_ID
                 , C1
                 , CODE_NAME
         FROM
         (
            <choose>
                <when test='stkType != null and stkType == "1"'>
	                SELECT DISTINCT T1.STK_ID
	                         , T1.STK_CODE ||' - '||T1.STK_DESC C1
	                         , CASE WHEN T2.DISCONTINUE = '1' THEN T3.CODE_NAME ||' ('||T5.CODE_NAME||')'
	                           ELSE T3.CODE_NAME
	                           END CODE_NAME
	                         , T2.DISCONTINUE

	                 FROM SYS0026M T1          /* InvStock */
	                         , SAL0082D T2          /* ServiceContractPackage_Product */
	                         , SYS0013M T3         /* CodeDetail */
	                         , SYS0013M T5         /* CodeDetail */

	                WHERE T1.STK_ID = T2.SRV_PAC_ITM_PRODUCT_ID
	                   AND T1.STK_CTGRY_ID = T3.CODE_ID
	                   AND 1 = T2.SRV_PAC_ITM_STUS_ID
	                   AND 61 = T1.STK_TYPE_ID
	                   AND T2.SRV_CNTRCT_PAC_ID = #{srvPacId}
	                   AND TO_CHAR(T2.DISCONTINUE) = T5.CODE
	                   AND T5.CODE_MASTER_ID = '381'
	                   <if test='stkCtgryId != null and stkCtgryId != ""'>
	                       AND T1.STK_CTGRY_ID = #{stkCtgryId}         /* StkCategoryID */
	                   </if>
                </when>
                <otherwise>
	                SELECT DISTINCT T1.STK_ID
	                         , T1.STK_CODE ||' - '||T1.STK_DESC C1
	                         , CASE WHEN T2.DISCONTINUE = '1' THEN T3.CODE_NAME ||' ('||T5.CODE_NAME||')'
	                           ELSE T3.CODE_NAME
	                           END CODE_NAME
	                         , T2.DISCONTINUE

	                 FROM SYS0026M T1          /* InvStock */
	                         , SAL0092M T2         /* SrvMembershipPacD */
	                         , SYS0013M T3         /* CodeDetail */
	                         , SAL0016M T4         /* SalesPrice */
	                         , SYS0013M T5         /* CodeDetail */

	                WHERE T1.STK_ID = T2.SRV_MEM_ITM_STK_ID
	                    AND T1.STK_CTGRY_ID = T3.CODE_ID
	                    AND 1 = T2.SRV_MEM_ITM_STUS_ID
	                    AND 61 = T1.STK_TYPE_ID
	                    AND T2.SRV_MEM_PAC_ID = #{srvPacId}
	                    AND TO_CHAR(T2.DISCONTINUE) = T5.CODE
	                    AND T5.CODE_MASTER_ID = '381'
	                    <if test='stkCtgryId != null and stkCtgryId != ""'>
                           AND T1.STK_CTGRY_ID = #{stkCtgryId}          /* StkCategoryID */
                        </if>
                </otherwise>
            </choose>
        )
        ORDER BY DISCONTINUE, CODE_NAME ASC, STK_ID ASC
    </select>

    <!-- Homecare Mapping Table Insert -->
    <insert id="insertHcRegisterOrder" parameterType="com.coway.trust.biz.homecare.sales.order.vo.HcOrderVO">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.insertHcRegisterOrder */
        <selectKey keyProperty="ordSeqNo" resultType="Integer" order="BEFORE">
            SELECT HMC0011D_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO HMC0011D (
               ORD_SEQ_NO
             , CUST_ID
             , SALES_DT
             , MAT_ORD_NO
             , FRA_ORD_NO
             , CRT_DT
             , CRT_USER_ID
             , UPD_DT
             , UPD_USER_ID
             , MAT_PRE_ORD_ID      /* eKeyin Mat ord_id */
             , FRA_PRE_ORD_ID       /* eKeyin Fra Ord_id */
             , STUS_ID

        ) VALUES (
               #{ordSeqNo}
             , #{custId}
             , SYSDATE
             , #{matOrdNo}
             , #{fraOrdNo}
             , SYSDATE
             , #{crtUserId}
             , SYSDATE
             , #{updUserId}
             , #{matPreOrdId}
             , #{fraPreOrdId}
             , #{stusId}
        )
    </insert>

    <!-- Homecare Mapping Table update -->
    <update id="updateHcPreOrder" parameterType="com.coway.trust.biz.homecare.sales.order.vo.HcOrderVO">
        /* com.coway.trust.biz.homecare.sales.order.impl.HcOrderRegisterMapper.updateHcPreOrder */
        UPDATE HMC0011D SET
                      UPD_DT                  = SYSDATE
                    , UPD_USER_ID           = #{updUserId}
                <if test='custId != null and custId != ""'>
                    , CUST_ID                  = #{custId}
                </if>
                <if test='matOrdNo != null and matOrdNo != ""'>
                    , MAT_ORD_NO          = #{matOrdNo}       /* Mat ord_no */
                </if>
                <if test='fraOrdNo != null and fraOrdNo != ""'>
                    , FRA_ORD_NO           = #{fraOrdNo}         /* Fra Ord_no */
                </if>
                <if test='matPreOrdId != null and matPreOrdId != ""'>
                    , MAT_PRE_ORD_ID     = #{matPreOrdId}    /* eKeyin Mat ord_id */
                </if>
                <if test='fraPreOrdId != null and fraPreOrdId != ""'>
                    , FRA_PRE_ORD_ID      = #{fraPreOrdId}      /* eKeyin Fra Ord_id */
                </if>
                <if test='stusId != null and stusId != ""'>
                    , STUS_ID                  = #{stusId}
                </if>
           WHERE ORD_SEQ_NO          = #{ordSeqNo}
    </update>

</mapper>