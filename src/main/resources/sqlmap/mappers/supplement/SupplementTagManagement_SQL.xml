<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.supplement.impl.SupplementTagManagementMapper">

  <select id="selectTagManagementList" parameterType="Map" resultType="egovMap">
    SELECT Extent2.SUP_CUR_SEQNO AS COUNSELING_NO,
               Extent1.SUP_REF_NO AS SUP_REF_NO,
               Extent1.SUP_REF_ID AS SUP_REF_ID,
               Extent3.NAME AS CUST_NAME,
               TO_CHAR(Extent2.CRT_DT, 'DD-MM-YYYY') AS TAG_REGISTER_DT,
               Extent4.STUS_CODE_ID AS TAG_STATUS_ID,
               Extent5.NAME AS TAG_STATUS,
               Extent2.SUP_TAG_MAIN_INQ AS MAIN_TOPIC_ID,
               Extent2.SUP_TAG_SUB_INQ AS SUB_TOPIC_ID,
               UPPER(Extent6.DEFECT_CODE || '-' || Extent6.DEFECT_DESC) AS MAIN_TOPIC,
               UPPER(Extent7.DEFECT_CODE || '-' || Extent7.DEFECT_DESC) AS SUB_TOPIC,
               UPPER(Extent8.CODE || '-' || Extent8.CODE_NAME) AS INCHG_DEPT,
               UPPER(Extent9.CODE || '-' || Extent9.CODE_NAME) AS SUB_DEPT
    FROM SUP0001M Extent1
    JOIN SUP0006M Extent2 ON Extent2.SUP_TAG_ORD_ID = Extent1.SUP_REF_ID
    JOIN SAL0029D Extent3 ON Extent3.CUST_ID = Extent1.CUST_ID
    JOIN CCR0006D Extent4 ON Extent4.CUR_SEQ_NO = Extent2.SUP_CUR_SEQNO
    JOIN SYS0038M Extent5 ON Extent5.STUS_CODE_ID = Extent4.STUS_CODE_ID
    LEFT JOIN SYS0100M Extent6 ON Extent6.DEFECT_ID = Extent2.SUP_TAG_MAIN_INQ AND Extent6.DEFECT_TYP = 'SMI'
    LEFT JOIN SYS0100M Extent7 ON Extent7.DEFECT_ID = Extent2.SUP_TAG_SUB_INQ AND Extent7.DEFECT_TYP = 'SMI'
    LEFT JOIN SYS0013M Extent8 ON Extent8.CODE_MASTER_ID = '359' AND Extent8.CODE = Extent4.MAIN_DEPT
    LEFT JOIN SYS0013M Extent9 ON Extent9.CODE_MASTER_ID = '360' AND Extent9.CODE = Extent4.SUB_DEPT
    WHERE 1 = 1

    <if test=" null != supRefNo and '' != supRefNo">
      AND Extent1.SUP_REF_NO = #{supRefNo}
    </if>

    <if test=" null != counselingNo and '' != counselingNo">
      AND Extent2.SUP_CUR_SEQNO = #{counselingNo}
    </if>

    <if test="tagStus != null and tagStus != '' ">
       AND Extent4.STUS_CODE_ID = #{tagStus}
    </if>

    <if test="sDate != null and sDate != '' ">
      <![CDATA[
        AND Extent2.CRT_DT >=  TO_DATE(#{sDate}||' 00:00:00', 'DD-MM-YYYY HH24:MI:SS')
      ]]>
    </if>

    <if test="eDate != null and eDate != '' ">
      <![CDATA[
        AND Extent2.CRT_DT <= TO_DATE(#{eDate} ||' 23:59:59', 'DD-MM-YYYY HH24:MI:SS')
      ]]>
    </if>

    <if test=" null != mainTopic and '' != mainTopic">
      AND Extent2.SUP_TAG_MAIN_INQ = #{mainTopic}
    </if>

    <if test=" null != ddSubTopic and '' != ddSubTopic">
      AND Extent2.SUP_TAG_SUB_INQ = #{ddSubTopic}
    </if>

    <if test=" null != inchgDept and '' != inchgDept">
      AND Extent4.MAIN_DEPT = #{inchgDept}
    </if>

    <if test=" null != ddSubDept and '' != ddSubDept">
      AND Extent4.SUB_DEPT = #{ddSubDept}
    </if>

    <if test=" null != custName and '' != custName">
      AND Extent3.NAME = #{custName}
    </if>

  </select>

    <select id="selectTagStus"  parameterType="Map" resultType="egovMap">
    SELECT Extent1.STUS_CODE_ID CODE_ID
             , Extent1.CODE CODE
             , UPPER(Extent1.CODE || '-' || Extent1.NAME) CODE_NAME
    FROM SYS0038M Extent1
    WHERE Extent1.STUS_CODE_ID IN ( 1, 34, 10 )
  </select>

    <select id="getMainTopicList" parameterType="Map" resultType="egovMap">
   SELECT DEFECT_ID AS CODE_ID,
             UPPER(DEFECT_CODE || '-' || DEFECT_DESC) AS CODE_NAME,
             DEFECT_TYP AS PRODUCT_CTGRY_CODE
   FROM SYS0100M
   WHERE DEFECT_TYP = 'SMI'
   AND DEFECT_STATUS = '1'
   AND DEFECT_GRP = DEFECT_ID
  </select>

  <select id="getSubTopicList" parameterType="Map" resultType="egovMap">
    <![CDATA[
     SELECT DEFECT_TYP AS DEFECT_TYPE_CODE,
            DEFECT_ID AS CODE_ID,
            UPPER(DEFECT_CODE || '-' || DEFECT_DESC) AS CODE_NAME
     FROM SYS0100M
     WHERE DEFECT_GRP = #{DEFECT_GRP}
     AND DEFECT_ID != #{DEFECT_GRP}
    ]]>
  </select>

  <!-- <select id="getInchgDeptList" parameterType="Map" resultType="egovMap">
    SELECT DEFECT_ID AS CODE_ID,
               DEFECT_DESC AS CODE_NAME,
               DEFECT_TYP AS PRODUCT_CTGRY_CODE
   FROM SYS0100M
   WHERE DEFECT_TYP = 'ICD'
       AND DEFECT_STATUS = '1'
       AND DEFECT_GRP = DEFECT_ID
  </select> -->

  <select id="getInchgDeptList" parameterType="Map" resultType="egovMap">
    SELECT CODE AS CODE_ID,
               UPPER(CODE || '-' || CODE_NAME) AS CODE_NAME
    FROM SYS0013M
    WHERE CODE_MASTER_ID = '359'
  </select>

  <!-- <select id="getSubDeptList" parameterType="Map" resultType="egovMap">
    <![CDATA[
     SELECT DEFECT_TYP AS DEFECT_TYPE_CODE,
            DEFECT_ID AS CODE_ID,
            DEFECT_DESC AS CODE_NAME
     FROM SYS0100M
     WHERE DEFECT_GRP = #{DEFECT_GRP_DEPT}
     AND DEFECT_ID != #{DEFECT_GRP_DEPT}
     AND DEFECT_TYP = 'ICD'
    ]]>
  </select> -->

  <select id="getSubDeptList" parameterType="Map" resultType="egovMap">
    SELECT CODE CODE_ID
             , UPPER(CODE || '-' || CODE_DESC) CODE_NAME
    FROM SYS0013M
    WHERE CODE_MASTER_ID = 360

    <if test = "DEFECT_GRP_DEPT != null and DEFECT_GRP_DEPT != '' ">
      AND CODE IN (SELECT SUB_DEPT_CODE FROM SVC0063C WHERE MAIN_DEPT_CODE = #{DEFECT_GRP_DEPT})
    </if>
  </select>

   <select id="selectOrderBasicInfo"  parameterType="Map" resultType="egovMap">
            SELECT
            Extent2.SUP_CUR_SEQNO AS COUNSELING_NO,
            Extent1.SUP_REF_ID AS SUP_REF_ID,
            Extent1.SUP_REF_NO AS SUP_REF_NO,
            Extent1.CUST_ID AS CUST_ID,
            Extent3.NAME AS CUST_NAME,
            Extent2.CRT_DT AS TAG_REGISTER_DT,
            Extent4.STUS_CODE_ID AS TAG_STATUS_ID,
            Extent5.NAME AS TAG_STATUS,
            Extent2.SUP_TAG_MAIN_INQ AS MAIN_TOPIC_ID,
            Extent6.DEFECT_DESC AS MAIN_TOPIC,
            Extent2.SUP_TAG_SUB_INQ AS SUB_TOPIC_ID,
            Extent7.DEFECT_DESC AS SUB_TOPIC,
            Extent4.MAIN_DEPT AS INCHG_DEPT_ID,
            Extent8.DEFECT_DESC AS INCHG_DEPT_NAME,
            Extent4.SUB_DEPT AS SUB_DEPT_ID,
            Extent8.DEFECT_DESC AS SUB_DEPT_NAME,
            Extent2.SUP_TAG_FL_ATT_ID AS CARELINE_ATCH

            FROM SUP0001M Extent1
            JOIN SUP0006M Extent2   ON Extent2.SUP_TAG_ORD_ID = Extent1.SUP_REF_ID
            JOIN SAL0029D Extent3   ON Extent3.CUST_ID = Extent1.CUST_ID
            JOIN CCR0006D Extent4   ON Extent4.CUR_SEQ_NO = Extent2.SUP_CUR_SEQNO
            JOIN SYS0038M Extent5   ON Extent5.STUS_CODE_ID = Extent4.STUS_CODE_ID
            LEFT JOIN SYS0100M Extent6   ON Extent6.DEFECT_ID = Extent2.SUP_TAG_MAIN_INQ AND Extent6.DEFECT_TYP = 'SMI'
            LEFT JOIN SYS0100M Extent7   ON Extent7.DEFECT_ID = Extent2.SUP_TAG_SUB_INQ AND Extent7.DEFECT_TYP = 'SMI'
            LEFT JOIN SYS0100M Extent8   ON Extent8.DEFECT_CODE = Extent4.MAIN_DEPT AND Extent8.DEFECT_TYP = 'ICD'
            LEFT JOIN SYS0100M Extent9   ON Extent9.DEFECT_CODE = Extent4.SUB_DEPT AND Extent8.DEFECT_TYP = 'ICD'

    WHERE 1=1
        AND Extent1.DEL_FLG = 'N'
        AND Extent1.SUP_REF_ID = #{supRefId}
  </select>

  <select id="searchOrderBasicInfo"  parameterType="Map" resultType="egovMap">
    SELECT A.SUP_REF_ID,
               A.SUP_REF_NO,
               TO_CHAR(A.SUP_REF_DT, 'DD-MM-YYYY') AS ORD_DT,
               B.NAME AS SUP_REF_STUS,
               C.NAME AS CUST_NAME,
               C.NRIC AS CUST_NRIC
    FROM SUP0001M A
    JOIN SYS0038M B ON A.SUP_REF_STUS = B.STUS_CODE_ID
    JOIN SAL0029D C ON A.CUST_ID = C.CUST_ID

    WHERE 1 = 1

    <if test=" null != searchOrdNo and '' != searchOrdNo">
      AND A.SUP_REF_NO = #{searchOrdNo}
    </if>

    <if test=" null != searchOrdDate and '' != searchOrdDate">
      AND TO_CHAR(A.SUP_REF_DT, 'YYYYMMDD') = TO_CHAR(TO_DATE(#{searchOrdDate}, 'DD/MM/YYYY'), 'YYYYMMDD')
    </if>

    <if test=" null != searchOrdCustName and '' != searchOrdCustName">
      AND C.NAME = #{searchOrdCustName}
    </if>

    <if test=" null != searchOrdCustNric and '' != searchOrdCustNric">
      AND C.NRIC = #{searchOrdCustNric}
    </if>
  </select>

  <select id="selectViewBasicInfo"  parameterType="Map" resultType="egovMap">
    SELECT Extent1.SUP_REF_ID AS SUP_REF_ID,
               Extent1.SUP_REF_NO AS SUP_REF_NO,
               Extent1.SUP_SUBM_SOF AS SOF_NO,
               Extent9.CODE_NAME AS SUP_REF_DEL_STUS,
               TO_CHAR(Extent1.SUP_TTL_AMT, 'FM9999999990.00') AS SUP_TTL_AMT,
               Extent7.NAME AS SUP_REF_STUS,
               Extent1.SUP_REF_STUS AS SUP_REF_STUS_ID,
               Extent8.CODE_NAME AS SUP_REF_STG,
               Extent1.SUP_REF_STG AS SUP_REF_STG_ID,
               TO_CHAR(Extent1.SUP_REF_DT, 'DD-MM-YYYY hh:mi:ss AM') AS SUP_REF_DATE,
               Extent16.NAME AS SUBM_BRCH,
               Extent1.SUP_REF_PCL_TRKNO AS PARCEL_TRACK_NO,
               Extent1.PV_YEAR AS PV_YEAR,
               Extent1.PV_MONTH AS PV_MONTH,
               Extent1.TOT_PV AS TOT_PV,
               Extent1.SUP_REF_RTN_CSIGNO AS SUP_CONSG_NO,
               Extent5.USER_NAME AS REF_CREATE_BY,
               TO_CHAR(Extent1.CRT_DT, 'DD-MM-YYYY hh:mi:ss AM') AS REF_CREATE_DATE,
               TO_CHAR(Extent1.SUP_REF_DEL_DT, 'DD-MM-YYYY hh:mi:ss AM') AS SUP_REF_DEL_DT,
               Extent3.CUST_ID AS CUST_ID,
               Extent3.NAME AS CUST_NAME,
               Extent3.NRIC AS CUST_NRIC,
               Extent3.GENDER AS CUST_GENDER,
               Extent17.EMAIL AS CUST_EMAIL,
               Extent17.TEL_M1 AS CUST_MOBILE_NO,
               Extent17.TEL_O AS CUST_OFFICE_NO,
               Extent17.TEL_R AS CUST_RESIDENT_NO,
               Extent17.TELF AS CUST_FAX_NO,
               TO_CHAR(Extent3.VISA_EXPR, 'DD-MM-YYYY') AS VISA_EXPR,
               TO_CHAR(Extent3.PAS_SPORT_EXPR, 'DD-MM-YYYY') AS PAS_SPORT_EXPR,
               Extent10.CODE_NAME AS CUST_STATUS,
               Extent11.CODE_NAME AS RACE_NAME,
               Extent12.CODE_NAME AS CUST_TYPE_NAME,
               Extent4.NAME AS NATION_NAME,
               Extent13.ADDR_DTL AS ADDRESS_LINE_1,
               Extent13.STREET AS ADDRESS_LINE_2,
               Extent14.AREA AS AREA,
               Extent14.POSTCODE AS POSTCODE,
               Extent14.STATE AS STATE,
               Extent14.COUNTRY AS COUNTRY,
               Extent14.CITY AS CITY,
               Extent15.DEPT_CODE AS DEPT_CODE,
               Extent15.GRP_CODE AS GRP_CODE,
               Extent15.ORG_CODE AS ORG_CODE,
               Extent6.MEM_CODE AS SALESMAN_CODE,
               Extent6.NAME AS SALESMAN_NAME,
               Extent6.MEM_CODE AS SALESMAN_NRIC,
               Extent6.TEL_MOBILE AS SALESMAN_MOBILE,
               Extent6.TEL_OFFICE AS SALESMAN_OFFICE,
               Extent6.TEL_HUSE AS SALESMAN_RESIDENT,
               Extent18.ADDR_DTL AS BILL_ADDRESS_LINE_1,
               Extent18.STREET AS BILL_ADDRESS_LINE_2,
               Extent19.AREA AS BILL_AREA,
               Extent19.POSTCODE AS BILL_POSTCODE,
               Extent19.STATE AS BILL_STATE,
               Extent19.COUNTRY AS BILL_COUNTRY,
               Extent19.CITY AS BILL_CITY
    FROM SUP0001M Extent1
    JOIN SAL0029D Extent3 ON Extent3.CUST_ID = Extent1.CUST_ID
    LEFT JOIN SYS0015M Extent4 ON Extent4.CNTY_ID = Extent3.NATION
    JOIN SYS0047M Extent5 ON Extent5.USER_ID = Extent1.CRT_USR_ID
    LEFT JOIN ORG0001D Extent6 ON Extent6.MEM_ID = Extent1.MEM_ID
    JOIN SYS0038M Extent7 ON Extent7.STUS_CODE_ID = Extent1.SUP_REF_STUS
    LEFT JOIN SYS0013M Extent8 ON Extent8.CODE = Extent1.SUP_REF_STG AND Extent8.CODE_MASTER_ID = '586'
    LEFT JOIN SYS0013M Extent9 ON Extent9.CODE = Extent1.SUP_REF_DEL_STUS AND Extent9.CODE_MASTER_ID = '587'
    LEFT JOIN SYS0013M Extent10 ON Extent10.CODE_ID = Extent3.IS_EXST_CUST AND Extent10.CODE_MASTER_ID = '566'
    LEFT JOIN SYS0013M Extent11 ON Extent11.CODE_ID = Extent3.RACE_ID
    LEFT JOIN SYS0013M Extent12 ON Extent12.CODE_ID = Extent3.TYPE_ID
    LEFT JOIN SAL0023D Extent13 ON Extent13.CUST_ADD_ID = Extent1.CUST_DEL_ADDR_ID AND Extent1.CUST_ID = EXTENT13.CUST_ID
    LEFT JOIN SYS0064M Extent14 ON Extent14.AREA_ID = Extent13.AREA_ID
    LEFT JOIN ORG1001V Extent15 ON Extent15.MEM_ID = Extent1.MEM_ID
    LEFT JOIN SYS0005M Extent16 ON Extent16.BRNCH_ID = Extent1.MEM_BRNCH_ID
    LEFT JOIN SAL0027D Extent17 ON Extent17.CUST_ID = Extent1.CUST_ID AND Extent17.CUST_CNTC_ID = Extent1.CUST_CNTC_ID
    LEFT JOIN SAL0023D Extent18 ON Extent18.CUST_ID = Extent1.CUST_ID AND Extent18.CUST_ADD_ID = Extent1.CUST_BILL_ADDR_ID
    LEFT JOIN SYS0064M Extent19 ON Extent19.AREA_ID = Extent18.AREA_ID
    WHERE 1=1
        AND Extent1.DEL_FLG = 'N'
        AND Extent1.SUP_REF_NO = #{supRefNo}
  </select>

  <select id="getDocNo" parameterType="Integer" resultType="String">
    SELECT FN_GET_DOCNO(#{value}) from dual
  </select>

    <select id="getResponseLst"  parameterType="Map" resultType="egovMap">
    SELECT
        Extent4.DEFECT_DESC AS MAIN_DEPT ,
        Extent5.DEFECT_DESC AS SUB_DEPT ,
        Extent3.CALL_REM AS REMARK,
        Extent6.NAME AS TAG_STUS,
        Extent7.USER_FULL_NAME AS CALL_CRT_USER_ID ,
        Extent3.CALL_CRT_DT AS CALL_CRT_DT

    FROM SUP0006M Extent1
        JOIN CCR0006D Extent2   ON Extent2.CUR_SEQ_NO = Extent1.SUP_CUR_SEQNO
        JOIN CCR0007D Extent3   ON Extent3.CALL_RESULT_ID = Extent2.RESULT_ID
        LEFT JOIN SYS0100M Extent4   ON Extent4.DEFECT_CODE = Extent3.MAIN_DEPT AND Extent4.DEFECT_TYP = 'ICD'
        LEFT JOIN SYS0100M Extent5   ON Extent5.DEFECT_CODE = Extent3.SUB_DEPT AND Extent4.DEFECT_TYP = 'ICD'
        JOIN SYS0038M Extent6   ON Extent6.STUS_CODE_ID = Extent3.CALL_STUS_ID
        JOIN SYS0047M Extent7    ON Extent7.USER_ID = Extent3.CALL_CRT_USER_ID
    WHERE  Extent1.SUP_TAG_ORD_ID = #{supRefId}
    ORDER BY Extent3.CALL_CRT_DT DESC
  </select>

      <select id="selectNextFileId" resultType="int">
        SELECT SYS0071D_ATCH_FILE_ID_SEQ.NEXTVAL atchFileId FROM DUAL
      </select>

      <insert id="insertFileDetail" parameterType="Map">
        INSERT INTO SYS0071D (
        ATCH_FILE_ID
        , ATCH_FILE_NAME
        , FILE_SUB_PATH
        , PHYSICL_FILE_NAME
        , FILE_EXTSN
        , FILE_SIZE
        , FILE_PASSWORD
        , FILE_UNQ_KEY
        , FILE_KEY_SEQ
        )VALUES (
        #{atchFileId}
        ,#{atchFileName}
        ,#{fileSubPath}
        ,#{physiclFileName}
        ,#{fileExtsn}
        ,#{fileSize}
        ,#{filePassword}
        ,#{fileUnqKey}
        ,#{fileKeySeq}
        )
    </insert>

    <select id="getSeqSUP0006M" resultType="java.lang.Integer">
         SELECT SUP0006M_SUP_TAG_SEQ_ID.NEXTVAL FROM DUAL
    </select>

    <select id="getSeqCCR0006D" resultType="java.lang.Integer">
         SELECT CCR0006D_CALL_ENTRY_ID_SEQ.NEXTVAL FROM DUAL
    </select>

    <select id="getSeqCCR0007D" resultType="java.lang.Integer">
         SELECT CCR0007D_CALL_RESULT_ID_SEQ.NEXTVAL FROM DUAL
    </select>

</mapper>