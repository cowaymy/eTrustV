<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.scm.impl.ScmInterfaceManagementMapper">

<select id="selectInterfaceList" parameterType="Map" resultType="egovMap">
SELECT TO_CHAR(TO_DATE(A.IF_DATE, 'YYYY-MM-DD'), 'DD/MM/YYYY') AS IF_DATE
     , TO_CHAR(TO_DATE(A.IF_TIME, 'HH24MISS'), 'HH:MI:SS') AS IF_TIME
     , A.IF_SEQ
     , A.IF_TYPE
     , B.CODE_NAME AS IF_TYPE_NAME
     , A.IF_STATUS
     , C.CODE_NAME AS IF_STATUS_NAME
     , A.IF_CYCLE
     , D.CODE_NAME AS IF_CYCLE_NAME
     , A.EXEC_CNT
     , A.CONTS
     , A.ERR_MSG
  FROM SCM0055L A
  LEFT OUTER JOIN SYS0013M B ON (A.IF_TYPE = B.CODE AND B.CODE_MASTER_ID = 352) /* CODE_MASTER_ID = 352 : SCM Interface Type */
  LEFT OUTER JOIN SYS0013M C ON (A.IF_STATUS = C.CODE AND C.CODE_MASTER_ID = 405) /* CODE_MASTER_ID = 405 : SCM Interface Status */
  LEFT OUTER JOIN SYS0013M D ON (A.IF_CYCLE = D.CODE AND D.CODE_MASTER_ID = 404) /* CODE_MASTER_ID = 352 : SCM Interface Cycle */
 WHERE A.IF_DATE BETWEEN #{startDate} AND #{endDate}
	<if test="scmIfTypeCbBox != null and ! scmIfTypeCbBox.isEmpty">
   AND A.IF_TYPE IN
		<foreach item="item" collection="scmIfTypeCbBox" index="index" open="(" separator="," close=")">
		#{item}
		</foreach>
	</if>
	<if test="scmIfStatusCbBox != null and ! scmIfStatusCbBox.isEmpty">
   AND A.IF_STATUS IN
		<foreach item="item" collection="scmIfStatusCbBox" index="index" open="(" separator="," close=")">
		#{item}
		</foreach>
	</if>
 ORDER BY A.IF_DATE DESC, A.IF_TIME DESC, A.IF_SEQ DESC, A.IF_TYPE, A.IF_STATUS
</select>

<select id="doInterface" parameterType="Map" resultType="egovMap">
</select>

<insert id="scmIf155" parameterType="Map">
INSERT INTO ITF0155M
(
       IF_KEY
     , SEQ
     , IF_TYPE
     , TRAN_STATUS_CD
     , TRAN_DT
     , TRAN_TM
     , RGST_DT
     , RGST_TM
     , RGST_ID
     , PO_ID
     , PO_NO
     , PO_ITM_NO
     , VENDOR
     , PO_ISSU_DT
     , CDC
     , STOCK_CODE
     , QTY
     , FOB_AMT
     , FOB_PRC
     , PRC_UNIT
     , CUR
 )
SELECT '155' || TO_CHAR(SYSDATE, 'YYMMDD') || '_' || LPAD(A.IF_KEY + A.IF_KEY_SEQ, 7, '0') AS IF_KEY
     , A.SEQ
     , '155' AS IF_TYPE
     , '10' AS TRAN_STATUS_CD
     , TO_CHAR(SYSDATE, 'YYYYMMDD') AS TRAN_DT
     , TO_CHAR(SYSDATE, 'HH24MISS') AS TRAN_TM
     , TO_CHAR(SYSDATE, 'YYYYMMDD') AS RGST_DT
     , TO_CHAR(SYSDATE, 'HH24MISS') AS RGST_TM
     , #{crtUserId} AS RGST_ID
     , A.PO_ID
     , A.PO_NO
     , A.PO_ITM_NO
     , A.VENDOR
     , A.PO_ISSU_DT
     , A.CDC
     , A.STOCK_CODE
     , A.QTY
     , A.FOB_AMT
     , A.FOB_PRC
     , A.PRC_UNIT
     , A.CUR
  FROM (
        SELECT ROW_NUMBER() OVER (PARTITION BY A.PO_ID ORDER BY B.PO_NO, B.PO_ITEM_NO) AS IF_KEY
             , ROW_NUMBER() OVER (PARTITION BY B.PO_NO ORDER BY B.PO_ITEM_NO) AS SEQ
             , (
                SELECT CASE WHEN MAX(IF_KEY) IS NULL THEN 0
                            ELSE TO_NUMBER(SUBSTR(MAX(IF_KEY), 11))
                            END AS IF_KEY_SEQ
                  FROM ITF0155M
                 WHERE IF_KEY LIKE '155' || TO_CHAR(SYSDATE, 'YYMMDD') || '_' || '%'
                ) AS IF_KEY_SEQ
             , A.PO_ID
             , B.PO_NO
             , B.PO_ITEM_NO AS PO_ITM_NO
             , B.VENDOR
             , TO_CHAR(A.CRT_DT, 'YYYYMMDD') AS PO_ISSU_DT
             , A.CDC
             , B.STOCK_CODE
             , B.PO_QTY AS QTY
             , B.FOB_AMT
             , B.FOB_PRC
             , B.PRC_UNIT
             , B.CURR AS CUR
          FROM SCM0052M A
          LEFT OUTER JOIN SCM0053D B ON (A.PO_ID = B.PO_ID AND B.USE_YN = 'Y')
         WHERE B.PO_NO = #{poNo}
           AND B.PO_ITEM_NO = #{poItemNo}
        ) A
</insert>

<insert id="insertSCM0039M" parameterType="Map">
INSERT INTO SCM0039M
(
       PO_NO
     , PO_ITEM_NO
     , STOCK_CODE
     , PO_DT
     , PO_QTY
     , PO_ITEM_STUS_ID
 )
VALUES
(
       #{poNo}
     , #{poItemNo}
     , #{stockCode}
     , TO_CHAR(SYSDATE, 'YYYYMMDD')
     , #{poQty}
     , #{poItemStusId}
 )
</insert>

<resultMap id="executeSP_SCM_0039M_ITF0156Map" type="egovMap"></resultMap>
<select id="executeSP_SCM_0039M_ITF0156" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call SP_SCM_0039M_ITF0156(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_SCM_0039M_ITF0156Map}
                             , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_SCM_0039M_ITF0156Map})
 }
</select>

<resultMap id="executeSP_SCM_0039M_ITF0160Map" type="egovMap"></resultMap>
<select id="executeSP_SCM_0039M_ITF0160" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call SP_SCM_0039M_ITF0160(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_SCM_0039M_ITF0160Map}
                             , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_SCM_0039M_ITF0160Map})
 }
</select>

<resultMap id="executeSP_SCM_0050S_INSERTMap" type="egovMap"></resultMap>
<select id="executeSP_SCM_0050S_INSERT" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call executeSP_SCM_0050S_INSERT(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_SCM_0050S_INSERTMap}
                                   , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_SCM_0050S_INSERTMap})
 }
</select>

<resultMap id="executeSP_SCM_0051S_INSERTMap" type="egovMap"></resultMap>
<select id="executeSP_SCM_0051S_INSERT" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call executeSP_SCM_0051S_INSERT(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_SCM_0051S_INSERTMap}
                                   , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_SCM_0051S_INSERTMap})
 }
</select>

<resultMap id="executeSP_SCM_0051S_INSERT_CALLMap" type="egovMap"></resultMap>
<select id="executeSP_SCM_0051S_INSERT_CALL" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call executeSP_SCM_0051S_INSERT_CALL(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_SCM_0051S_INSERT_CALLMap}
                                        , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_SCM_0051S_INSERT_CALLMap})
 }
</select>

<resultMap id="executeSP_SCM_0052S_INSERTMap" type="egovMap"></resultMap>
<select id="executeSP_SCM_0052S_INSERT" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call executeSP_SCM_0052S_INSERT(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_SCM_0052S_INSERTMap}
                                   , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_SCM_0052S_INSERTMap})
 }
</select>

<resultMap id="executeSP_SCM_0053S_INSERTMap" type="egovMap"></resultMap>
<select id="executeSP_SCM_0053S_INSERT" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call executeSP_SCM_0053S_INSERT(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_SCM_0053S_INSERTMap}
                                   , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_SCM_0053S_INSERTMap})
 }
</select>

<resultMap id="executeSP_MTH_SCM_FILTER_FRCSTMap" type="egovMap"></resultMap>
<select id="executeSP_MTH_SCM_FILTER_FRCST" parameterType="Map" resultType="egovMap" statementType="CALLABLE">
{
     call executeSP_MTH_SCM_FILTER_FRCST(#{status, mode=OUT, jdbcType=DECIMAL, javaType=INTEGER, resultMap=executeSP_MTH_SCM_FILTER_FRCSTMap}
                                       , #{result, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=executeSP_MTH_SCM_FILTER_FRCSTMap})
 }
</select>

</mapper>