<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.scm.impl.SalesPlanMngementMapper"> 

    <select id="selectStockCtgrySummary" parameterType="Map" resultType="egovMap">
				SELECT 
				       SCM39V.STOCK_CTGRY  CATEGORY
				     , ROUND(AVG(M_1 + M_2 + M_3)) ||'/'|| ROUND(AVG(M1_ORD + M2_ORD + M3_ORD)) M3_AVG_Issue_Order
				     , ROUND(SUM(M_1)) ||'/'|| ROUND(SUM(M1_ORD)) M1_ISSUE_ORDER
				     , ROUND(SUM(M0_PLAN)) ||'/'|| ROUND(SUM(M0_ORD)) M0_PLAN_ORDER 
				     , SUM(M1) M1 
				     , SUM(M2) M2 
				     , SUM(M3) M3 
				     , SUM(M4) M4 
				     , SUM(W00)  AS W00 ,SUM(W01)  AS W01 ,SUM(W02)  AS W02 ,SUM(W03)  AS W03 ,SUM(W04)  AS W04 
				     , SUM(W05)  AS W05 ,SUM(W06)  AS W06 ,SUM(W07)  AS W07 ,SUM(W08)  AS W08 ,SUM(W09)  AS W09 
				     , SUM(W10)  AS W10 ,SUM(W11)  AS W11 ,SUM(W12)  AS W12 ,SUM(W13)  AS W13 ,SUM(W14)  AS W14  
				     , SUM(W15)  AS W15 ,SUM(W16)  AS W16 ,SUM(W17)  AS W17 ,SUM(W18)  AS W18 ,SUM(W19)  AS W19 
				     , SUM(W20)  AS W20 ,SUM(W21)  AS W21 ,SUM(W22)  AS W22 ,SUM(W23)  AS W23 ,SUM(W24)  AS W24
				     , SUM(W25)  AS W25 ,SUM(W26)  AS W26 ,SUM(W27)  AS W27 ,SUM(W28)  AS W28 ,SUM(W29)  AS W29 ,SUM(W30)  AS W30
				     
				     , SCM39V.PLAN_MASTER_ID
				     , SCM01M.PLAN_YEAR
				     , SCM01M.PLAN_MONTH
				     , SCM01M.PLAN_WEEK
				     , SCM39V.TEAM
				     , AVG(M1_ORD + M2_ORD + M3_ORD) AS PRE_M3_AVG_ORDERED 
				   
				FROM SCM0039V SCM39V    
				   , SCM0001M SCM01M 
				WHERE SCM01M.PLAN_YEAR  = #{scmYearCbBox}
				
				  AND SCM01M.PLAN_ID(+) = SCM39V.PLAN_MASTER_ID
				 <if test="selectPlanMonth != null and selectPlanMonth !=''">
				  AND SCM01M.PLAN_MONTH = #{selectPlanMonth}
				 </if>
				 <if test="scmPeriodCbBox != null and scmPeriodCbBox !=''">
				  AND SCM01M.PLAN_WEEK  = #{scmPeriodCbBox} 
				 </if>
				 <if test="scmTeamCbBox != null and scmTeamCbBox !=''">
				  AND SCM39V.TEAM       = #{scmTeamCbBox} 
				 </if>

        <choose>
        <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
         AND  STK_TYPE_ID IN
            <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </when>
        </choose>
				 
				 <choose>
         <when test='stkCategories != null and !stkCategories.isEmpty  '>
         AND SCM39V.STOCK_CTGRY IN (SELECT CODE FROM SYS0013M WHERE CODE_ID IN 
            <foreach item="item" collection="stkCategories" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </when>
      </choose>
				 
				GROUP BY SCM39V.PLAN_MASTER_ID, SCM01M.PLAN_YEAR,SCM01M.PLAN_MONTH, SCM01M.PLAN_WEEK, SCM39V.TEAM, SCM39V.STOCK_CTGRY  
				ORDER BY SCM39V.STOCK_CTGRY     
    </select>
    
    <select id="selectCalendarHeader" parameterType="Map" resultType="egovMap">
			SELECT 
             SCM_YEAR
            ,STOCK_PH1
            ,TEAM_H1
            ,PLAN_MASTER_ID_H
            ,CATEGORY_H1
            ,CODE_H1
            ,NAME_H1
            ,ISUUEORDER_H
            ,MONTHLY_PH2
            ,BEFORE_DAY_H2
            ,TODAY_H2
            ,M1_H2
            ,M2_H2
            ,M3_H3
            ,M4_H4
            ,SUPPLY_CORP_H_PSI
            ,SUPPLY_CORP_H_OVERDUE
            ,IS_SAVED
            ,DIV_ODD
            ,STK_TYPE_ID_H1
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W1_WEEK_SEQ ,1,5) ELSE SUBSTR(W1_WEEK_SEQ ,1,3) END) W1_WEEK_SEQ 
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W2_WEEK_SEQ ,1,5) ELSE SUBSTR(W2_WEEK_SEQ ,1,3) END) W2_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W3_WEEK_SEQ ,1,5) ELSE SUBSTR(W3_WEEK_SEQ ,1,3) END) W3_WEEK_SEQ 
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W4_WEEK_SEQ ,1,5) ELSE SUBSTR(W4_WEEK_SEQ ,1,3) END) W4_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W5_WEEK_SEQ ,1,5) ELSE SUBSTR(W5_WEEK_SEQ ,1,3) END) W5_WEEK_SEQ 
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W6_WEEK_SEQ ,1,5) ELSE SUBSTR(W6_WEEK_SEQ ,1,3) END) W6_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W7_WEEK_SEQ ,1,5) ELSE SUBSTR(W7_WEEK_SEQ ,1,3) END) W7_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W8_WEEK_SEQ ,1,5) ELSE SUBSTR(W8_WEEK_SEQ ,1,3) END) W8_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W9_WEEK_SEQ ,1,5) ELSE SUBSTR(W9_WEEK_SEQ ,1,3) END) W9_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W10_WEEK_SEQ,1,5) ELSE SUBSTR(W10_WEEK_SEQ,1,3) END) W10_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W11_WEEK_SEQ,1,5) ELSE SUBSTR(W11_WEEK_SEQ,1,3) END) W11_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W12_WEEK_SEQ,1,5) ELSE SUBSTR(W12_WEEK_SEQ,1,3) END) W12_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W13_WEEK_SEQ,1,5) ELSE SUBSTR(W13_WEEK_SEQ,1,3) END) W13_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W14_WEEK_SEQ,1,5) ELSE SUBSTR(W14_WEEK_SEQ,1,3) END) W14_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W15_WEEK_SEQ,1,5) ELSE SUBSTR(W15_WEEK_SEQ,1,3) END) W15_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W16_WEEK_SEQ,1,5) ELSE SUBSTR(W16_WEEK_SEQ,1,3) END) W16_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W17_WEEK_SEQ,1,5) ELSE SUBSTR(W17_WEEK_SEQ,1,3) END) W17_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W18_WEEK_SEQ,1,5) ELSE SUBSTR(W18_WEEK_SEQ,1,3) END) W18_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W19_WEEK_SEQ,1,5) ELSE SUBSTR(W19_WEEK_SEQ,1,3) END) W19_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W20_WEEK_SEQ,1,5) ELSE SUBSTR(W20_WEEK_SEQ,1,3) END) W20_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W21_WEEK_SEQ,1,5) ELSE SUBSTR(W21_WEEK_SEQ,1,3) END) W21_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W22_WEEK_SEQ,1,5) ELSE SUBSTR(W22_WEEK_SEQ,1,3) END) W22_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W23_WEEK_SEQ,1,5) ELSE SUBSTR(W23_WEEK_SEQ,1,3) END) W23_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W24_WEEK_SEQ,1,5) ELSE SUBSTR(W24_WEEK_SEQ,1,3) END) W24_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W25_WEEK_SEQ,1,5) ELSE SUBSTR(W25_WEEK_SEQ,1,3) END) W25_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W26_WEEK_SEQ,1,5) ELSE SUBSTR(W26_WEEK_SEQ,1,3) END) W26_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W27_WEEK_SEQ,1,5) ELSE SUBSTR(W27_WEEK_SEQ,1,3) END) W27_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W28_WEEK_SEQ,1,5) ELSE SUBSTR(W28_WEEK_SEQ,1,3) END) W28_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W29_WEEK_SEQ,1,5) ELSE SUBSTR(W29_WEEK_SEQ,1,3) END) W29_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W30_WEEK_SEQ,1,5) ELSE SUBSTR(W30_WEEK_SEQ,1,3) END) W30_WEEK_SEQ
      FROM
          (
            WITH HEAD_DATA
              AS (
                   SELECT  
                         SCM_YEAR
                        ,'STOCK' STOCK_PH1
                        ,'team' TEAM_H1
                        ,'planMasterId' PLAN_MASTER_ID_H
                        ,'category' CATEGORY_H1  
                        ,'code' CODE_H1
                        ,'name' NAME_H1
                        ,'m3AvgIssueOrder' ISUUEORDER_H  
                        ,'MONTHLY' MONTHLY_PH2
                        ,'m1IssueOrder' BEFORE_DAY_H2
                        ,'m0PlanOrder' TODAY_H2
                        ,'m1' M1_H2
                        ,'m2' M2_H2
                        ,'m3' M3_H3
                        ,'m4' M4_H4
                        ,'psi' SUPPLY_CORP_H_PSI
                        ,'overdue' SUPPLY_CORP_H_OVERDUE
                        ,'isSaved' IS_SAVED
                        ,'divOdd' DIV_ODD
                        ,'stkTypeId' STK_TYPE_ID_H1
                        , DECODE(LEAD(WEEK_TH_SN) OVER(ORDER BY 'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN)  
                                ,NULL
                                ,'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN ||'-'|| '9'
                                ,'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN ||'-'|| LEAD(WEEK_TH_SN) OVER(ORDER BY 'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN))
                          WEEK_SEQ
                        , ROWNUM RNO
                     FROM  SCM0018M
                    WHERE (SCM_YEAR = #{scmYearCbBox}) 
                      AND (WEEK_TH <![CDATA[ >= ]]> #{scmPeriodCbBox} ) 
                      AND (WEEK_TH <![CDATA[ <= ]]> (#{scmPeriodCbBox} + 16) )   
                      AND NVL(USE_YN,'Y')='Y'
              )
              SELECT *      
                FROM 
                    (
                      SELECT 
                            SCM_YEAR
                          , STOCK_PH1
                          , TEAM_H1
                          , PLAN_MASTER_ID_H
                          , CATEGORY_H1  
                          , CODE_H1
                          , NAME_H1
                          , ISUUEORDER_H  
                          , MONTHLY_PH2
                          , BEFORE_DAY_H2
                          , TODAY_H2
                          , M1_H2
                          , M2_H2
                          , M3_H3
                          , M4_H4
                          , SUPPLY_CORP_H_PSI
                          , SUPPLY_CORP_H_OVERDUE
                          , IS_SAVED
                          , DIV_ODD
                          , STK_TYPE_ID_H1
                          , WEEK_SEQ
                          , DECODE(RNO ,1 ,'1' ,2,'2',3,'3',4,'4' ,5,'5',6,'6',7,'7' ,8,'8',9,'9' ,10,'10',11,'11' ,12,'12',13,'13' ,14,'14',15,'15' ,16,'16' 
                                       ,17,'17',18,'18',19,'19',20,'20',21,'21',22,'22',23,'23' ,24,'24',25,'25' ,26,'26',27,'27' ,28,'28',29,'29' ,30,'30'
                                  ) RNO
                         FROM HEAD_DATA
                    )
                    PIVOT
                   (
                     MAX(WEEK_SEQ) WEEK_SEQ 
                         FOR RNO IN ( 1 AS W1,2 AS W2,3 AS W3,4 AS W4,5 AS W5,6 AS W6,7 AS W7,8 AS W8,9 AS W9,10 AS W10,11 AS W11,12 AS W12,13 AS W13,14 AS W14,15 AS W15,16 AS W16
                                     ,17 AS W17,18 AS W18,19 AS W19,20 AS W20, 21 AS W21,22 AS W22,23 AS W23, 24 AS W24, 25 AS W25 ,26 AS W26,27 AS W27,28 AS W28,29 AS W29,30 AS W30
                         )
                   )
        )  
              
    UNION ALL
              
       SELECT 
             SCM_YEAR
            ,STOCK_PH1
            ,TEAM_H1
            ,PLAN_MASTER_ID_H
            ,CATEGORY_H1
            ,CODE_H1
            ,NAME_H1
            ,ISUUEORDER_H
            ,MONTHLY_PH2
            ,BEFORE_DAY_H2
            ,TODAY_H2
            ,M1_H2
            ,M2_H2
            ,M3_H3
            ,M4_H4
            ,SUPPLY_CORP_H_PSI
            ,SUPPLY_CORP_H_OVERDUE
            ,IS_SAVED
            ,DIV_ODD
            ,STK_TYPE_ID_H1
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W1_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W1_WEEK_SEQ ,1,5) ELSE SUBSTR(W1_WEEK_SEQ ,1,3) END) W1_WEEK_SEQ 
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W2_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W2_WEEK_SEQ ,1,5) ELSE SUBSTR(W2_WEEK_SEQ ,1,3) END) W2_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W3_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W3_WEEK_SEQ ,1,5) ELSE SUBSTR(W3_WEEK_SEQ ,1,3) END) W3_WEEK_SEQ 
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W4_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W4_WEEK_SEQ ,1,5) ELSE SUBSTR(W4_WEEK_SEQ ,1,3) END) W4_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W5_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W5_WEEK_SEQ ,1,5) ELSE SUBSTR(W5_WEEK_SEQ ,1,3) END) W5_WEEK_SEQ 
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W6_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W6_WEEK_SEQ ,1,5) ELSE SUBSTR(W6_WEEK_SEQ ,1,3) END) W6_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W7_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W7_WEEK_SEQ ,1,5) ELSE SUBSTR(W7_WEEK_SEQ ,1,3) END) W7_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W8_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W8_WEEK_SEQ ,1,5) ELSE SUBSTR(W8_WEEK_SEQ ,1,3) END) W8_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W9_WEEK_SEQ ,'-',2) = 2) THEN SUBSTR(W9_WEEK_SEQ ,1,5) ELSE SUBSTR(W9_WEEK_SEQ ,1,3) END) W9_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W10_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W10_WEEK_SEQ,1,5) ELSE SUBSTR(W10_WEEK_SEQ,1,3) END) W10_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W11_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W11_WEEK_SEQ,1,5) ELSE SUBSTR(W11_WEEK_SEQ,1,3) END) W11_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W12_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W12_WEEK_SEQ,1,5) ELSE SUBSTR(W12_WEEK_SEQ,1,3) END) W12_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W13_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W13_WEEK_SEQ,1,5) ELSE SUBSTR(W13_WEEK_SEQ,1,3) END) W13_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W14_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W14_WEEK_SEQ,1,5) ELSE SUBSTR(W14_WEEK_SEQ,1,3) END) W14_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W15_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W15_WEEK_SEQ,1,5) ELSE SUBSTR(W15_WEEK_SEQ,1,3) END) W15_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W16_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W16_WEEK_SEQ,1,5) ELSE SUBSTR(W16_WEEK_SEQ,1,3) END) W16_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W17_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W17_WEEK_SEQ,1,5) ELSE SUBSTR(W17_WEEK_SEQ,1,3) END) W17_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W18_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W18_WEEK_SEQ,1,5) ELSE SUBSTR(W18_WEEK_SEQ,1,3) END) W18_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W19_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W19_WEEK_SEQ,1,5) ELSE SUBSTR(W19_WEEK_SEQ,1,3) END) W19_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W20_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W20_WEEK_SEQ,1,5) ELSE SUBSTR(W20_WEEK_SEQ,1,3) END) W20_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W21_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W21_WEEK_SEQ,1,5) ELSE SUBSTR(W21_WEEK_SEQ,1,3) END) W21_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W22_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W22_WEEK_SEQ,1,5) ELSE SUBSTR(W22_WEEK_SEQ,1,3) END) W22_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W23_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W23_WEEK_SEQ,1,5) ELSE SUBSTR(W23_WEEK_SEQ,1,3) END) W23_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W24_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W24_WEEK_SEQ,1,5) ELSE SUBSTR(W24_WEEK_SEQ,1,3) END) W24_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W25_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W25_WEEK_SEQ,1,5) ELSE SUBSTR(W25_WEEK_SEQ,1,3) END) W25_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W26_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W26_WEEK_SEQ,1,5) ELSE SUBSTR(W26_WEEK_SEQ,1,3) END) W26_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W27_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W27_WEEK_SEQ,1,5) ELSE SUBSTR(W27_WEEK_SEQ,1,3) END) W27_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W28_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W28_WEEK_SEQ,1,5) ELSE SUBSTR(W28_WEEK_SEQ,1,3) END) W28_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W29_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W29_WEEK_SEQ,1,5) ELSE SUBSTR(W29_WEEK_SEQ,1,3) END) W29_WEEK_SEQ
            ,(CASE WHEN (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 2 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 1) OR (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 1 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 2) OR (FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',3) = 9 AND FN_GET_SPLIT_DATA2(W30_WEEK_SEQ,'-',2) = 2) THEN SUBSTR(W30_WEEK_SEQ,1,5) ELSE SUBSTR(W30_WEEK_SEQ,1,3) END) W30_WEEK_SEQ
      FROM
          (
            WITH HEAD_DATA
              AS (
                   SELECT  
                         SCM_YEAR
                        ,'STOCK' STOCK_PH1
                        ,'team' TEAM_H1
                        ,'planMasterId' PLAN_MASTER_ID_H
                        ,'category' CATEGORY_H1  
                        ,'code' CODE_H1
                        ,'name' NAME_H1
                        ,'m3AvgIssueOrder' ISUUEORDER_H  
                        ,'MONTHLY' MONTHLY_PH2
                        ,'m1IssueOrder' BEFORE_DAY_H2
                        ,'m0PlanOrder' TODAY_H2
                        ,'m1' M1_H2
                        ,'m2' M2_H2
                        ,'m3' M3_H3
                        ,'m4' M4_H4
                        ,'psi' SUPPLY_CORP_H_PSI
                        ,'overdue' SUPPLY_CORP_H_OVERDUE
                        ,'isSaved' IS_SAVED
                        ,'divOdd' DIV_ODD
                        ,'stkTypeId' STK_TYPE_ID_H1
                        , DECODE(LEAD(WEEK_TH_SN) OVER(ORDER BY 'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN)  
                                ,NULL
                                ,'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN ||'-'|| '9'
                                ,'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN ||'-'|| LEAD(WEEK_TH_SN) OVER(ORDER BY 'W'|| LPAD(WEEK_TH,2,0)||'-'||WEEK_TH_SN))
                          WEEK_SEQ
                        , ROWNUM RNO
                     FROM  SCM0018M
                    WHERE (SCM_YEAR = (#{scmYearCbBox} +1) ) 
                          AND (WEEK_TH <![CDATA[ >= ]]> 1 ) 
                          AND (WEEK_TH <![CDATA[ <= ]]> (1 + 16) )
                          AND NVL(USE_YN,'Y')='Y'
              )
              SELECT *      
                FROM 
                    (
                      SELECT 
                            SCM_YEAR
                          , STOCK_PH1
                          , TEAM_H1
                          , PLAN_MASTER_ID_H
                          , CATEGORY_H1  
                          , CODE_H1
                          , NAME_H1
                          , ISUUEORDER_H  
                          , MONTHLY_PH2
                          , BEFORE_DAY_H2
                          , TODAY_H2
                          , M1_H2
                          , M2_H2
                          , M3_H3
                          , M4_H4
                          , SUPPLY_CORP_H_PSI
                          , SUPPLY_CORP_H_OVERDUE
                          , IS_SAVED
                          , DIV_ODD
                          , STK_TYPE_ID_H1
                          , WEEK_SEQ
                          , DECODE(RNO ,1 ,'1' ,2,'2',3,'3',4,'4' ,5,'5',6,'6',7,'7' ,8,'8',9,'9' ,10,'10',11,'11' ,12,'12',13,'13' ,14,'14',15,'15' ,16,'16' 
                                       ,17,'17',18,'18',19,'19',20,'20',21,'21',22,'22',23,'23' ,24,'24',25,'25' ,26,'26',27,'27' ,28,'28',29,'29' ,30,'30'
                                  ) RNO
                         FROM HEAD_DATA
                    )
                    PIVOT
                   (
                     MAX(WEEK_SEQ) WEEK_SEQ 
                         FOR RNO IN ( 1 AS W1,2 AS W2,3 AS W3,4 AS W4,5 AS W5,6 AS W6,7 AS W7,8 AS W8,9 AS W9,10 AS W10,11 AS W11,12 AS W12,13 AS W13,14 AS W14,15 AS W15,16 AS W16
                                     ,17 AS W17,18 AS W18,19 AS W19,20 AS W20, 21 AS W21,22 AS W22,23 AS W23, 24 AS W24, 25 AS W25 ,26 AS W26,27 AS W27,28 AS W28,29 AS W29,30 AS W30
                         )
                   )
        ) 
    </select>
    
    <select id="selectSalesCnt" parameterType="Map" resultType="egovMap">
		 SELECT  
		       SUM(ORD_CNT) SALE_CNT 
		  FROM SCM0030S 
		  WHERE SCM_YEAR= #{scmYearCbBox}
		    AND SCM_MONTH= #{selectPlanMonth}
		    AND SCM_WEEK_TH = #{weekTh}
		    AND TEAM=  #{scmTeamCbBox}   
		    AND STOCK_CODE  = #{stockCode}
		  GROUP BY SCM_YEAR, SCM_MONTH,SCM_WEEK_TH,TEAM
    </select>
    
    <select id="selectRemainWeekTh" parameterType="Map" resultType="egovMap">
		   SELECT SCM_YEAR
		         ,WEEK_TH
			  FROM SCM0018M 
			  WHERE SCM_YEAR =  #{scmYearCbBox}
			   AND SCM_MONTH =  #{selectPlanMonth}
			   AND WEEK_TH <![CDATA[ < ]]> #{scmPeriodCbBox}
			   AND NVL(USE_YN,'Y')='Y'
    </select>
    
    <select id="selectChildField" parameterType="Map" resultType="egovMap">
		   SELECT SCM_YEAR
		        ,SCM_MONTH
		        ,WEEK_TH
		        ,WEEK_TH_SN
		        ,IS_SRPTD
		        ,SCM_YYYYMM
		        ,ROWNUM ROW_SEQ
		  FROM SCM0018M 
		 WHERE SCM_YEAR =  #{scmYearCbBox}
		   AND SCM_MONTH = #{selectPlanMonth}
		   AND NVL(USE_YN,'Y')='Y'
		 ORDER BY WEEK_TH
    </select>
    
<select id="selectWeekThSn" parameterType="Map" resultType="egovMap">
  SELECT SCM_YEAR
        ,SCM_MONTH
        ,WEEK_TH
        ,WEEK_TH_SN
        ,IS_SRPTD
        ,SCM_YYYYMM
        ,ROWNUM ROW_SEQ
   FROM SCM0018M 
  WHERE SCM_YEAR =  #{scmYearCbBox}
    AND SCM_MONTH = #{selectPlanMonth}
    AND NVL(USE_YN,'Y')='Y'
    AND WEEK_TH_SN = 1
  ORDER BY WEEK_TH
</select>

  <!--  Accuracy -->
<select id="selectAccuracyMonthlyHeaderList" parameterType="Map" resultType="egovMap">
  SELECT W1_WEEK_TH W1
        ,W2_WEEK_TH W2
        ,W3_WEEK_TH W3
        ,W4_WEEK_TH W4
        ,W5_WEEK_TH W5
        ,W6_WEEK_TH W6
        ,W7_WEEK_TH W7
    FROM(
				  WITH HEAD_DATA
            AS 
            (
               SELECT  
                      WEEK_TH
                    , ROWNUM RNO
                 FROM SCM0018M
                WHERE SCM_YEAR  = #{scmYearCbBox}
                  AND SCM_MONTH = #{scmMonthCbBox}
                  AND NVL(USE_YN,'Y')='Y'
                  AND WEEK_TH_SN = 1
            )
            SELECT *      
              FROM HEAD_DATA
             PIVOT
                 (
                   MAX(WEEK_TH) WEEK_TH FOR RNO IN ( 1 AS W1,2 AS W2,3 AS W3,4 AS W4,5 AS W5,6 AS W6,7 AS W7)
                 )
        )
</select> 

<select id="selectSeperation" parameterType="Map" resultType="egovMap">
		 SELECT M0.SCM_YEAR
			    , M0.SCM_MONTH
			    , M0.REC_CNT M0_TOT_CNT
			    , M1.REC_CNT M1_TOT_CNT
			    , M2.REC_CNT M2_TOT_CNT
			    , M3.REC_CNT M3_TOT_CNT
			FROM
					(
					  SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					  FROM SCM0018M 
					 WHERE SCM_YEAR =  #{scmYearCbBox}
					   AND SCM_MONTH = #{selectPlanMonth}
					   AND NVL(USE_YN,'Y')='Y'
					   GROUP BY SCM_YEAR,SCM_MONTH
					  ) M0
					,
					(
					   SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					  FROM SCM0018M
      <choose>
        <when test=' selectPlanMonth != null and (selectPlanMonth +1) > 12 '>	
           WHERE SCM_YEAR =  (#{scmYearCbBox} +1)
             AND SCM_MONTH = 1				  
        </when>
        <otherwise>
           WHERE SCM_YEAR =  #{scmYearCbBox}
             AND SCM_MONTH = (#{selectPlanMonth} +1)
        </otherwise>
      </choose>					  
 			       AND NVL(USE_YN,'Y')='Y'
					 GROUP BY SCM_YEAR,SCM_MONTH
					) M1
					,
					(
					   SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					  FROM SCM0018M
      <choose>
        <when test=' selectPlanMonth != null and (selectPlanMonth +1) > 12 '> 
           WHERE SCM_YEAR =  (#{scmYearCbBox} +1)
             AND SCM_MONTH = 2          
        </when>
        <otherwise>
           WHERE SCM_YEAR =  #{scmYearCbBox}
             AND SCM_MONTH = (#{selectPlanMonth} +2)
        </otherwise>
      </choose>   					   
					   AND NVL(USE_YN,'Y')='Y'
					   GROUP BY SCM_YEAR,SCM_MONTH   
					) M2
					,
					(
					
					   SELECT SCM_YEAR
					        ,SCM_MONTH
					        ,COUNT(SCM_YEAR) REC_CNT
					  FROM SCM0018M 
      <choose>
        <when test=' selectPlanMonth != null and (selectPlanMonth +1) > 12 '> 
           WHERE SCM_YEAR =  (#{scmYearCbBox} +1)
             AND SCM_MONTH = 3          
        </when>
        <otherwise>
           WHERE SCM_YEAR =  #{scmYearCbBox}
             AND SCM_MONTH = (#{selectPlanMonth} +3)
        </otherwise>
      </choose>  					  
					   AND NVL(USE_YN,'Y')='Y'
					   GROUP BY SCM_YEAR,SCM_MONTH  
					) M3
			WHERE ROWNUM = 1
    </select>
    
    <select id="selectExcuteYear" parameterType="Map" resultType="egovMap">
			SELECT TO_CHAR((SYSDATE-365),'YYYY') YEAR FROM DUAL
			UNION
			SELECT TO_CHAR(SYSDATE,'YYYY') YEAR FROM DUAL
    </select>

    <select id="selectMonthCombo" parameterType="Map" resultType="egovMap">
      SELECT 
             SCM_MONTH  
        FROM SCM0018M 
       WHERE SCM_YEAR = #{scmYearCbBox}
         AND WEEK_TH  = #{scmPeriodCbBox} 
         AND WEEK_TH_SN = 1
         AND NVL(USE_YN,'Y')='Y'
    </select>

    <select id="selectPeriodByYear" parameterType="Map" resultType="egovMap">
			SELECT SCM_YEAR   
			     , WEEK_TH ||'-'|| WEEK_TH_SN ||decode(length(WEEK_TH),1,'  [','[')||TO_CHAR(WEEK_TH_SN_START,'YYYY-MM-DD') || ' ~ ' ||  WEEK_TH_SN_END ||']' SCM_PERIOD  
			     , SCM_MONTH  
			     , WEEK_TH  
			  FROM SCM0018M 
			 WHERE SCM_YEAR = #{year} 
			   AND WEEK_TH_SN = 1
			   AND NVL(USE_YN,'Y')='Y'
    </select>

    <select id="selectScmTeamCode" parameterType="Map" resultType="egovMap">
	     SELECT CODE
	           ,CODE_NAME
	      FROM SYS0013M
	     WHERE CODE_MASTER_ID = #{codeMasterId}
	     ORDER BY CODE_ID 
    </select>

    <select id="selectDefaultStockCode" parameterType="Map" resultType="egovMap">
			SELECT STOCK_CODE AS STK_CODE
			     , T1.STK_DESC AS STK_DESC  
        FROM SCM0008M T0 LEFT JOIN SYS0026M T1 ON T1.STK_CODE=T0.STOCK_CODE
    </select>

    <select id="selectStockCategoryCode" parameterType="Map" resultType="egovMap">
	     SELECT CODE_ID 
				    , CODE 
				    , CODE CODE_NAME
				  FROM
				     (
				       SELECT Extent1.STK_ID STK_ID  ,
				              Extent1.STK_CODE STK_CODE  ,
				              Extent2.CODE_ID CODE_ID  ,
				              Extent2.CODE CODE  ,
				              Extent1.STK_DESC STK_DESC  ,
				              Extent3.CODE_ID CODEID1  ,
				              Extent3.CODE CODE1  
				         FROM SYS0026M Extent1
				               JOIN SYS0013M Extent2   ON Extent1.STK_CTGRY_ID = Extent2.CODE_ID
				               JOIN SYS0013M Extent3   ON Extent1.STK_TYPE_ID = Extent3.CODE_ID
				               JOIN SCM0008M Extent4   ON Extent1.STK_ID = Extent4.STOCK_ID     
				    ) GROUP BY CODE_ID, CODE     
				      ORDER BY CODE_ID, CODE   
	  </select>
   
    <select id="selectStockCode" parameterType="Map" resultType="egovMap">
			SELECT SYS26M.STK_ID   
			     , SYS26M.STK_CODE 
			     , SYS26M.STK_DESC  
			     , Extent2.CODE_ID   
			     , Extent2.CODE CODE 
			     , Extent3.CODE_ID CODE_ID2  
			     , Extent3.CODE CODE2  
			  FROM SYS0026M SYS26M
			  JOIN SYS0013M Extent2   ON SYS26M.STK_CTGRY_ID = Extent2.CODE_ID
			  JOIN SYS0013M Extent3   ON SYS26M.STK_TYPE_ID = Extent3.CODE_ID
			<choose>
        <when test=' codeIds != null and codeIds != "" '>
        WHERE EXISTS ( SELECT 1 C1  
                         FROM SCM0008M Extent4
                        WHERE  Extent4.STOCK_ID = SYS26M.STK_ID 
                     ) 
		     AND ( 1 = SYS26M.STUS_CODE_ID )
		     AND ( 0 = TO_NUMBER(SYS26M.IS_NCV) )
         AND  Extent2.CODE_ID IN ( SELECT REGEXP_SUBSTR (#{codeIds}, '[^,]+', 1, LEVEL)
                                     FROM DUAL
                                  CONNECT BY REGEXP_SUBSTR (#{codeIds}, '[^,]+', 1, LEVEL) IS NOT NULL
                                 )
        </when>
        <otherwise>
          JOIN SCM0008M Extent4   ON SYS26M.STK_ID = Extent4.STOCK_ID
        </otherwise>
      </choose>
			 ORDER BY SYS26M.STK_DESC   ASC
    </select>
    
    <select id="selectPlanId" parameterType="Map" resultType="egovMap">
			SELECT 
			       PLAN_ID
			      ,PLAN_YEAR
			      ,PLAN_MONTH
			      ,PLAN_WEEK
			      ,TEAM
			      ,DECODE(PLAN_STUS_ID,1,'Active','Confirmed') PLAN_STUS_NM
			      ,TO_CHAR(CRT_DT,'YYYY/MM/DD HH24:MI:SS') CRT_DT
			      ,STUS_DT
			      ,CRT_USER_ID
			 FROM SCM0001M
			WHERE PLAN_YEAR = #{scmYearCbBox}
			  AND PLAN_WEEK = #{scmPeriodCbBox} 
     <if test="scmTeamCbBox != null and scmTeamCbBox !=''">
        AND TEAM      = #{scmTeamCbBox}   
     </if>
			  AND ROWNUM    = 1
    </select>
    
    <select id="selectSalesPlanMngmentList" parameterType="Map" resultType="egovMap">
      SELECT 
             (SELECT PLAN_STUS_ID
                FROM SCM0001M
               WHERE PLAN_ID = PLAN_MASTER_ID
             ) CHECK_FLAG
             , PLAN_MASTER_ID
             , team 
             , STK_TYPE_ID  
             , category 
             , code  
             , name       
             , M3_AVG_Issue_Order
             , M1_ISSUE_ORDER
             , M0_PLAN ||'/'|| M0_ORD M0_PLAN_ORDER 
             , M1
             , M2   
             , M3   
             , M4                 
                                        
             , BEF_4_WEEK_TH
             , BEF_3_WEEK_TH
             , BEF_2_WEEK_TH
             , BEF_1_WEEK_TH
             
             , W00  
             , W01  
             , W02  
             , W03  
             , W04  
             , W05  
             , W06  
             , W07  
             , W08  
             , W09  
             , W10  
             , W11  
             , W12  
             , W13  
             , W14  
             , W15  
             , W16  
             , W17  
             , W18  
             , W19  
             , W20  
             , W21  
             , W22  
             , W23  
             , W24  
             , W25  
             , W26  
             , W27  
             , W28  
             , W29  
             , W30  
             , WS1  
             , WS2  
             , WS3  
             , WS4  
             , WS5  
             , SCM39V.name  
             , SCM39V.category   
    FROM
    (
      SELECT PLAN_DTL_ID      
             , PLAN_MASTER_ID   
             , TEAM team
             , STK_TYPE_ID        
             , STOCK_CODE code  
             , PRE_M3_AVG_ORDED 
             , PRE_M3_AVG_ISSU  
             , ROUND(PRE_M3_AVG_ISSU)  ||'/'|| ROUND(PRE_M3_AVG_ORDED)  M3_AVG_Issue_Order
             , ROUND(M_1)  ||'/'|| ROUND(M1_ORD)  M1_ISSUE_ORDER
             , M1_ORD   
             , M2_ORD   
             , M3_ORD   
             , M_3   
             , M_2   
             , M_1   
             , ROUND(FN_GET_COMPNT_QTY_PLAN_SUM(#{scmYearCbBox},#{scmYearCbBox},STOCK_CODE)) M0_PLAN  
             , ROUND(FN_GET_COMPNT_QTY_ORD_SUM(#{scmYearCbBox},#{scmPeriodCbBox},STOCK_CODE)) M0_ORD  
              
             , FN_GET_ADD_MONTH_SUM( #{scmYearCbBox},#{selectPlanMonth}, STOCK_CODE, 1 ) M1
             , FN_GET_ADD_MONTH_SUM( #{scmYearCbBox},#{selectPlanMonth}, STOCK_CODE, 2 ) M2   
             , FN_GET_ADD_MONTH_SUM( #{scmYearCbBox},#{selectPlanMonth}, STOCK_CODE, 3 ) M3   
             , FN_GET_ADD_MONTH_SUM( #{scmYearCbBox},#{selectPlanMonth}, STOCK_CODE, 4 ) M4 
               
             , FN_GET_COUNT_SCM_WEEK_TH(STOCK_CODE,TEAM,#{scmYearCbBox},#{selectPlanMonth},(#{scmPeriodCbBox} -4) ) BEF_4_WEEK_TH
             , FN_GET_COUNT_SCM_WEEK_TH(STOCK_CODE,TEAM,#{scmYearCbBox},#{selectPlanMonth},(#{scmPeriodCbBox} -3) ) BEF_3_WEEK_TH
             , FN_GET_COUNT_SCM_WEEK_TH(STOCK_CODE,TEAM,#{scmYearCbBox},#{selectPlanMonth},(#{scmPeriodCbBox} -2) ) BEF_2_WEEK_TH
             , FN_GET_COUNT_SCM_WEEK_TH(STOCK_CODE,TEAM,#{scmYearCbBox},#{selectPlanMonth},(#{scmPeriodCbBox} -1) ) BEF_1_WEEK_TH  
             
             , W00  
             , W01  
             , W02  
             , W03  
             , W04  
             , W05  
             , W06  
             , W07  
             , W08  
             , W09  
             , W10  
             , W11  
             , W12  
             , W13  
             , W14  
             , W15  
             , W16  
             , W17  
             , W18  
             , W19  
             , W20  
             , W21  
             , W22  
             , W23  
             , W24  
             , W25  
             , W26  
             , W27  
             , W28  
             , W29  
             , W30  
             , WS1  
             , WS2  
             , WS3  
             , WS4  
             , WS5  
             , STOCK_NAME name  
             , STOCK_CTGRY category  
         FROM SCM0039V 
         WHERE  PLAN_MASTER_ID  IN ( SELECT PLAN_ID
                                       FROM SCM0001M
                                      WHERE PLAN_YEAR = #{scmYearCbBox}
                                        AND PLAN_WEEK = #{scmPeriodCbBox}
                                    <if test='scmTeamCbBox != null and scmTeamCbBox !="" '>
                                        AND TEAM      = #{scmTeamCbBox}   
                                    </if>
                                   )                                                         
      <choose>
        <when test='scmStockTypes != null and !scmStockTypes.isEmpty '>
         AND  STK_TYPE_ID IN
            <foreach item="item" collection="scmStockTypes" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>

        </when>
      </choose>
                                                                         
      <choose>
        <when test='stkCodes != null and !stkCodes.isEmpty '>
         AND  STOCK_CODE IN
            <foreach item="item" collection="stkCodes" index="index" open="(" separator="," close=")">
                #{item}
            </foreach>
        </when>
      </choose>
      
       ) SCM39V
    </select>

    <select id="selectSalesPlanMngmentPeriod" parameterType="Map" resultType="egovMap">
			SELECT SCM_YEAR   ,
			       WEEK_TH ||'-'|| WEEK_TH_SN ||'['||TO_CHAR(WEEK_TH_SN_START,'YYYY-MM-DD') || ' ~ ' ||  WEEK_TH_SN_END ||']' SCM_PERIOD  ,
			       SCM_MONTH  ,
			       WEEK_TH  
			  FROM SCM0018M 
			 WHERE SCM_YEAR = #{year} 
			   AND WEEK_TH_SN = 1
			   AND NVL(USE_YN,'Y')='Y'
    </select>
    
    <update id="updateScmPlanMaster" parameterType="Map">
      UPDATE SCM0002D
         SET PLAN_MASTER_ID = #{planMasterId} 
      
         <if test='w00 != null and w00 !="" '>
               , W00 = #{w00} 
         </if>
         <if test='w01 != null and w01 !="" '>
               , W01 = #{w01} 
         </if>
         <if test='w02 != null and w02 !="" '>
               , W02 = #{w02} 
         </if>
         <if test='w03 != null and w03 !="" '>
               , W03 = #{w03} 
         </if>
         <if test='w04 != null and w04 !="" '>
               , W04 = #{w04} 
         </if>
         <if test='w05 != null and w05 !="" '>
               , W05 = #{w05} 
         </if>
      
         <if test='w06 != null and w06 !="" '>
               , W06 = #{w06} 
         </if>
         <if test='w07 != null and w07 !="" '>
               , W07 = #{w07} 
         </if>
         <if test='w08 != null and w08 !="" '>
               , W08 = #{w08} 
         </if>
         <if test='w09 != null and w09 !="" '>
               , W09 = #{w09} 
         </if>
         <if test='w10 != null and w10 !="" '>
               , W10 = #{w10} 
         </if>
         
         <if test='w11 != null and w11 !="" '>
               , W11 = #{w11} 
         </if>         
         <if test='w12 != null and w12 !="" '>
               , W12 = #{w12} 
         </if>
         <if test='w13 != null and w13 !="" '>
               , W13 = #{w13} 
         </if>
         <if test='w14 != null and w14 !="" '>
               , W14 = #{w14} 
         </if>
         <if test='w15 != null and w15 !="" '>
               , W15 = #{w15} 
         </if>
         <if test='w16 != null and w16 !="" '>
               , W16 = #{w16} 
         </if>
         <if test='w17 != null and w17 !="" '>
               , W17 = #{w17} 
         </if>
         <if test='w18 != null and w18 !="" '>
               , W18 = #{w18} 
         </if>
         <if test='w19 != null and w19 !="" '>
               , W19 = #{w19} 
         </if>
         <if test='w20 != null and w20 !="" '>
               , W20 = #{w20} 
         </if>
         
         <if test='w21 != null and w21 !="" '>
               , W21 = #{w21} 
         </if>
         <if test='w22 != null and w22 !="" '>
               , W22 = #{w22} 
         </if>
         <if test='w23 != null and w23 !="" '>
               , W23 = #{w23} 
         </if>
         <if test='w24 != null and w24 !="" '>
               , W24 = #{w24} 
         </if>
         <if test='w25 != null and w25 !="" '>
               , W25 = #{w25} 
         </if>
         <if test='w26 != null and w26 !="" '>
               , W26 = #{w26} 
         </if>
         <if test='w27 != null and w27 !="" '>
               , W27 = #{w27} 
         </if>
         <if test='w28 != null and w28 !="" '>
               , W28 = #{w28} 
         </if>
         <if test='w29 != null and w29 !="" '>
               , W29 = #{w29} 
         </if>
         <if test='w30 != null and w30 !="" '>
               , W30 = #{w30} 
         </if>
       
       WHERE PLAN_MASTER_ID = #{planMasterId} 
         AND STOCK_CODE = #{code}  
         AND TEAM  = #{team} 
    </update>        

<select id="selectPlanDetailIdSeq" parameterType="Map" resultType="egovMap">
SELECT SCM0002D_PLAN_DTL_ID_SEQ.NEXTVAL SCM0002D_PLAN_DTL_ID_SEQ
  FROM DUAL
</select>

<select id="selectPlanMasterId" parameterType="Map" resultType="egovMap">
SELECT PLAN_ID PLAN_MASTER_ID
  FROM SCM0001M  
 WHERE PLAN_YEAR = #{scmYearCbBox}
   AND PLAN_WEEK = #{scmPeriodCbBox}
   AND TEAM      = #{scmTeamCbBox}   
</select>

<select id="selectStockIdByStCode" parameterType="Map" resultType="egovMap">
SELECT STK_ID  
  FROM SYS0026M  
 WHERE STK_CODE    = #{newStockCode}
   AND STK_TYPE_ID = #{newStockTypeId}
   AND ROWNUM = 1 
</select>

<insert id="insertSalesPlanDetail" parameterType="Map">
 <selectKey keyProperty="scm0002dPlanDtlIdSeq,getPlanMasterId" resultType="egovMap" order="BEFORE">
   SELECT SCM0002D_PLAN_DTL_ID_SEQ.NEXTVAL AS SCM0002D_PLAN_DTL_ID_SEQ
        ,(
           SELECT PLAN_ID 
						 FROM SCM0001M  
						WHERE PLAN_YEAR = #{scmGrYear}
						  AND PLAN_WEEK = #{scmGrWeek}
						  AND TEAM      = #{team}     
         ) GET_PLAN_MASTER_ID
  FROM DUAL
 </selectKey>
                
 INSERT INTO SCM0002D
           (
             PLAN_DTL_ID    
            ,PLAN_MASTER_ID 
            ,TEAM           
            ,STOCK_CODE     
            
            <if test='preM3AvgOrded != null and preM3AvgOrded !="" '>
            ,PRE_M3_AVG_ORDED 
            </if>                
            <if test='preM3AvgIssu != null and preM3AvgIssu !="" '>
            ,PRE_M3_AVG_ISSU  
            </if>   
            <if test='m1Ord != null and m1Ord !="" '>
            ,M1_ORD  
            </if>   
            <if test='m2Ord != null and m2Ord !="" '>
            ,M2_ORD
            </if>   
            <if test='m3Ord != null and m3Ord !="" '>
            ,M3_ORD
            </if>               
            <if test='m33 != null and m33 !="" '>
            ,M_3      /*m33*/
            </if>                 
            <if test='m22 != null and m22 !="" '>
            ,M_2      /*m22*/
            </if>                
            <if test='m11 != null and m11 !="" '>
            ,M_1      /*m11*/
            </if>                
            <if test='m0Plan != null and m0Plan !="" '>
            ,M0_PLAN 
            </if>                
            <if test='m0Ord != null and m0Ord !="" '>
            ,M0_ORD 
            </if>                
          
            <if test='m1 != null and m1 !="" '>
            ,M1     
            </if>              
            <if test='m2 != null and m2 !="" '>
            ,M2     
            </if>              
            <if test='m3 != null and m3 !="" '>
            ,M3     
            </if>              
            <if test='m4 != null and m4 !="" '>
            ,M4     
            </if>

            <if test='w00 != null and w00 !="" '>
            ,W00
            </if>              
            <if test='w01 != null and w01 !="" '>
            ,W01
            </if>              
            <if test='w02 != null and w02 !="" '>
            ,W02
            </if>              
            <if test='w03 != null and w03 !="" '>
            ,W03 
            </if>              
            <if test='w04 != null and w04 !="" '>
            ,W04
            </if>              
            <if test='w05 != null and w05 !="" '>
            ,W05 
            </if>              
            <if test='w06 != null and w06 !="" '>
            ,W06
            </if>              
            <if test='w07 != null and w07 !="" '>
            ,W07 
            </if>              
            <if test='w08 != null and w08 !="" '>
            ,W08
            </if>              
            <if test='w09 != null and w09 !="" '>
            ,W09
            </if>    

            <if test='w10 != null and w10 !="" '>
            ,W10 
            </if>            
            <if test='w11 != null and w11 !="" '>
            ,W11
            </if>            
            <if test='w12 != null and w12 !="" '>
            ,W12 
            </if>            
            <if test='w13 != null and w13 !="" '>
            ,W13 
            </if>            
            <if test='w14 != null and w14 !="" '>
            ,W14
            </if>            
            <if test='w15 != null and w15 !="" '>
            ,W15
            </if>            
            <if test='w16 != null and w16 !="" '>
            ,W16 
            </if>            
            <if test='w17 != null and w17 !="" '>
            ,W17 
            </if>            
            <if test='w18 != null and w18 !="" '>
            ,W18 
            </if>            
            <if test='w19 != null and w19 !="" '>
            ,W19 
            </if>  
            
            <if test='w20 != null and w20 !="" '>
            ,W20
            </if> 
            <if test='w21 != null and w21 !="" '>
            ,W21 
            </if>              
            <if test='w22 != null and w22 !="" '>
            ,W22 
            </if>              
            <if test='w23 != null and w23 !="" '>
            ,W23  
            </if>              
            <if test='w24 != null and w24 !="" '>
            ,W24  
            </if>              
            <if test='w25 != null and w25 !="" '>
            ,W25  
            </if>              
            <if test='w26 != null and w26 !="" '>
            ,W26 
            </if>              
            <if test='w27 != null and w27 !="" '>
            ,W27  
            </if>              
            <if test='w28 != null and w28 !="" '>
            ,W28  
            </if>              
            <if test='w29 != null and w29 !="" '>
            ,W29  
            </if>  
            <if test='w30 != null and w30 !="" '>
            ,W30
            </if>              

            <if test='ws1 != null and ws1 !="" '>
            ,WS1 
            </if>
            <if test='ws2 != null and ws2 !="" '>
            ,WS2 
            </if>
            <if test='ws3 != null and ws3 !="" '>
            ,WS3 
            </if>
            <if test='ws4 != null and ws4 !="" '>
            ,WS4 
            </if>
            <if test='ws5 != null and ws5 !="" '>
            ,WS5 
            </if>
            )
      VALUES
           (
             #{scm0002dPlanDtlIdSeq} 
            ,#{getPlanMasterId} 
            ,#{team}            
            ,#{newStockCode}    
            
            <if test='preM3AvgOrded != null and preM3AvgOrded !="" '>
            ,#{preM3AvgOrded}  
            </if>                
            <if test='preM3AvgIssu != null and preM3AvgIssu !="" '>
            ,#{preM3AvgIssu}  
            </if>                
            
            <if test='m1Ord != null and m1Ord !="" '>
            ,#{m1Ord}  
            </if>                
            <if test='m2Ord != null and m2Ord !="" '>
            ,#{m2Ord}  
            </if>                
            <if test='m3Ord != null and m3Ord !="" '>
            ,#{m3Ord}  
            </if>                
            
            <if test='m33 != null and m33 !="" '>
            ,#{m33}  
            </if>                
            <if test='m22 != null and m22 !="" '>
            ,#{m22}  
            </if>                
            <if test='m11 != null and m11 !="" '>
            ,#{m11}  
            </if>                
            
            <if test='m0Plan != null and m0Plan !="" '>
            ,#{m0Plan}  
            </if>                
            <if test='m0Ord != null and m0Ord !="" '>
            ,#{m0Ord}  
            </if>                
            
            <if test='m1 != null and m1 !="" '>
            ,#{m1}  
            </if>              
            <if test='m2 != null and m2 !="" '>
            ,#{m2} 
            </if>              
            <if test='m3 != null and m3 !="" '>
            ,#{m3} 
            </if>              
            <if test='m4 != null and m4 !="" '>
            ,#{m4} 
            </if>              
            
            <if test='w00 != null and w00 !="" '>
            ,#{w00} 
            </if>              
            <if test='w01 != null and w01 !="" '>
            ,#{w01} 
            </if>              
            <if test='w02 != null and w02 !="" '>
            ,#{w02} 
            </if>              
            <if test='w03 != null and w03 !="" '>
            ,#{w03} 
            </if>              
            <if test='w04 != null and w04 !="" '>
            ,#{w04} 
            </if>              
            <if test='w05 != null and w05 !="" '>
            ,#{w05} 
            </if>              
            <if test='w06 != null and w06 !="" '>
            ,#{w06} 
            </if>              
            <if test='w07 != null and w07 !="" '>
            ,#{w07} 
            </if>              
            <if test='w08 != null and w08 !="" '>
            ,#{w08} 
            </if>              
            <if test='w09 != null and w09 !="" '>
            ,#{w09} 
            </if>    
                      
            <if test='w10 != null and w10 !="" '>
            ,#{w10} 
            </if>            
            <if test='w11 != null and w11 !="" '>
            ,#{w11} 
            </if>            
            <if test='w12 != null and w12 !="" '>
            ,#{w12} 
            </if>            
            <if test='w13 != null and w13 !="" '>
            ,#{w13} 
            </if>            
            <if test='w14 != null and w14 !="" '>
            ,#{w14} 
            </if>            
            <if test='w15 != null and w15 !="" '>
            ,#{w15} 
            </if>            
            <if test='w16 != null and w16 !="" '>
            ,#{w16} 
            </if>            
            <if test='w17 != null and w17 !="" '>
            ,#{w17} 
            </if>            
            <if test='w18 != null and w18 !="" '>
            ,#{w18} 
            </if>            
            <if test='w19 != null and w19 !="" '>
            ,#{w19} 
            </if>            
            <if test='w20 != null and w20 !="" '>
            ,#{w20} 
            </if>            
            
            <if test='w21 != null and w21 !="" '>
            ,#{w21} 
            </if>              
            <if test='w22 != null and w22 !="" '>
            ,#{w22}  
            </if>              
            <if test='w23 != null and w23 !="" '>
            ,#{w23}  
            </if>              
            <if test='w24 != null and w24 !="" '>
            ,#{w24}  
            </if>              
            <if test='w25 != null and w25 !="" '>
            ,#{w25}  
            </if>              
            <if test='w26 != null and w26 !="" '>
            ,#{w26}  
            </if>              
            <if test='w27 != null and w27 !="" '>
            ,#{w27}  
            </if>              
            <if test='w28 != null and w28 !="" '>
            ,#{w28}  
            </if>              
            <if test='w29 != null and w29 !="" '>
            ,#{w29}  
            </if>              
            <if test='w30 != null and w30 !="" '>
            ,#{w30}  
            </if>              

            <if test='ws1 != null and ws1 !="" '>
            ,#{ws1}  
            </if>
            <if test='ws2 != null and ws2 !="" '>
            ,#{ws2} 
            </if>
            <if test='ws3 != null and ws3 !="" '>
           ,#{ws3} 
            </if>
            <if test='ws4 != null and ws4 !="" '>
            ,#{ws4}  
            </if>
            <if test='ws5 != null and ws5 !="" '>
            ,#{ws5} 
            </if>
           )

</insert>


<insert id="insertSalesPlanMaster" parameterType="Map">
        <selectKey keyProperty="salesPlanMstSeq" resultType="int" order="BEFORE">
            SELECT SCM0001M_PLAN_ID_SEQ.NEXTVAL FROM DUAL
        </selectKey>
         
            INSERT INTO SCM0001M
				           (
				             PLAN_ID
				           , TEAM
				           , PLAN_YEAR    
				           , PLAN_MONTH
				           , PLAN_WEEK
				           , PLAN_STUS_ID
				           , CRT_DT
				           , CRT_USER_ID
				           )
             VALUES
				          (
				             #{salesPlanMstSeq}
				           , #{scmTeamCbBox}
				           , #{scmYearCbBox}
				           , (SELECT SCM_MONTH FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND WEEK_TH = #{scmPeriodCbBox} AND WEEK_TH_SN = 1 )
				           , #{scmPeriodCbBox}
				           , 4
				           , SYSDATE
				           , #{crtUserId}
				          )
</insert> 

<delete id="deleteStockCode" parameterType="Map">
         
    DELETE 
      FROM SCM0002D 
     WHERE PLAN_MASTER_ID = #{planMasterId}  
       AND TEAM = #{team} 
       AND STOCK_CODE = #{code} 
       AND (SELECT PLAN_STUS_ID 
             FROM SCM0001M  
            WHERE PLAN_ID = #{planMasterId}
           ) <![CDATA[ <> ]]>  4 
           
</delete> 

<update id="updateSalesPlanUnConfirm" parameterType="Map">
  UPDATE SCM0001M 
     SET PLAN_STUS_ID = 1   
   WHERE PLAN_YEAR = #{scmYearCbBox}
     AND PLAN_WEEK = #{scmPeriodCbBox}
     AND TEAM      = #{scmTeamCbBox}
</update> 

<update id="updateSalesPlanConfirm" parameterType="Map">
  UPDATE SCM0001M 
     SET PLAN_STUS_ID = 4  
   WHERE PLAN_YEAR = #{scmYearCbBox}
     AND PLAN_WEEK = #{scmPeriodCbBox}
     AND TEAM      = #{scmTeamCbBox}
</update> 

<select id="selectAccuracyWeeklyDetail" parameterType="Map" resultType="egovMap">
  SELECT * 
    FROM(
         SELECT
               #{scmMonthCbBox} MONTH
             , 'W' || #{scmPeriodCbBox} WEEK
             , STOCK_CODE
             , STOCK_NAME
             , STOCK_CTGRY
             , STK_TYPE_ID
             
             ,TEAM
             ,SUM(W12_WEEK_00) W12
             ,SUM(W11_WEEK_00) W11 
             ,SUM(W10_WEEK_00) W10
             ,SUM(W9_WEEK_00)  W9  
             ,SUM(W8_WEEK_00)  W8  
             ,SUM(W7_WEEK_00)  W7 
             ,SUM(W6_WEEK_00)  W6   
             ,SUM(W5_WEEK_00)  W5    
             ,SUM(W4_WEEK_00)  W4  
             ,SUM(W3_WEEK_00)  W3 
             ,SUM(W2_WEEK_00)  W2  
             ,SUM(W1_WEEK_00)  W1      
             ,SUM(ORD_VALUE) SALES_ORDER
             ,ROUND(AVG(SHORT_TERM_AVG))||'%' SHORT_TERM_AVG
             ,ROUND(AVG(MID_TERM_AVG))||'%'  MID_TERM_AVG

          FROM (
                SELECT
                       TEAM,STOCK_CODE,STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID,ORD_VALUE
                      ,W1_WEEK_00 ,W2_WEEK_00  ,W3_WEEK_00  ,W4_WEEK_00  ,W5_WEEK_00  ,W6_WEEK_00  
                      ,W7_WEEK_00 ,W8_WEEK_00  ,W9_WEEK_00  ,W10_WEEK_00 ,W11_WEEK_00 ,W12_WEEK_00
                      ,DECODE(SHORT_TERM_CNT, 0 , 0,  ROUND(SHORT_TERM_SUM / SHORT_TERM_CNT) ) SHORT_TERM_AVG
                      ,DECODE(MID_TERM_CNT, 0, 0,  ROUND(MID_TERM_SUM / MID_TERM_CNT) ) MID_TERM_AVG 
                  FROM
                  (
                   SELECT STEP5_DATA.*
                        ,(W1_RATTING + W2_RATTING + W3_RATTING + W4_RATTING + W5_RATTING + W6_RATTING + W7_RATTING +W8_RATTING) SHORT_TERM_SUM
                        ,(W9_RATTING + W10_RATTING + W11_RATTING + W12_RATTING ) MID_TERM_SUM
                        ,( CASE WHEN W1_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W2_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W3_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W4_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         + CASE WHEN W5_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W6_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W7_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W8_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END 
                         ) SHORT_TERM_CNT 
                        ,( CASE WHEN W9_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W10_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W11_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W12_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END) MID_TERM_CNT
                    FROM
                        (
                           WITH STEP4_DATA
                             AS
                                (
                                  SELECT STEP3_DATA.*
                                       , CASE WHEN ( STEP3_DATA.ORD_VALUE <![CDATA[<]]> STEP3_DATA.WEEK_00  ) 
                                              THEN ROUND((STEP3_DATA.ORD_VALUE / STEP3_DATA.WEEK_00)*100) 
                                              WHEN ( STEP3_DATA.WEEK_00   <![CDATA[<]]> STEP3_DATA.ORD_VALUE  ) 
                                              THEN ROUND((STEP3_DATA.WEEK_00 / STEP3_DATA.ORD_VALUE)*100) 
                                         ELSE
                                            0
                                         END ACCURACY_RATTING
                                  FROM (
                                        SELECT STEP2_DATA.*
                                              ,(SELECT M0_ORD FROM SCM0052V SCM52V WHERE SCM52V.PLAN_YEAR = #{scmYearCbBox}  AND SCM52V.PLAN_MONTH = #{scmMonthCbBox} AND SCM52V.PLAN_WEEK = #{scmPeriodCbBox} AND SCM52V.TEAM = STEP2_DATA.TEAM AND SCM52V.STOCK_CODE = STEP2_DATA.STOCK_CODE) ORD_VALUE
                                          FROM 
                                              ( 
                                                SELECT STEP1_DATA.*  
                                                  FROM 
                                                      (
                                                        SELECT   1 SEQ
                                                               ,TEAM
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year1}
                                                            AND PLAN_WEEK = #{weekTh1}
                                                                
                                                        UNION ALL
                                                                
                                                        SELECT  2 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year2}
                                                            AND PLAN_WEEK = #{weekTh2} 
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  3 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year3}
                                                            AND PLAN_WEEK = #{weekTh3}  
                                                                        
                                                          UNION ALL
                                                                
                                                        SELECT  4 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year4}
                                                            AND PLAN_WEEK = #{weekTh4}  
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  5 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year5}  
                                                            AND PLAN_WEEK = #{weekTh5}  
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  6 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year6}   
                                                            AND PLAN_WEEK = #{weekTh6}
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  7 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year7}   
                                                            AND PLAN_WEEK = #{weekTh7} 
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  8 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year8}  
                                                            AND PLAN_WEEK = #{weekTh8}           
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  9 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year9}   
                                                            AND PLAN_WEEK = #{weekTh9} 
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  10 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year10}  
                                                            AND PLAN_WEEK = #{weekTh10}    
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  11 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year11}  
                                                            AND PLAN_WEEK = #{weekTh11} 
                                                                    
                                                          UNION ALL
                                                                
                                                        SELECT  12 SEQ
                                                               ,TEAM  
                                                               ,STOCK_CODE  
                                                               ,STOCK_NAME  
                                                               ,STOCK_CTGRY
                                                               ,STK_TYPE_ID  
                                                               ,W00 WEEK_00
                                                                       
                                                           FROM SCM0052V  
                                                          WHERE PLAN_YEAR = #{year12}  
                                                            AND PLAN_WEEK = #{weekTh12}   
                                                      )  STEP1_DATA
                                               
                                              )  STEP2_DATA
                                        ) STEP3_DATA
                                ) 
                                SELECT *
                                  FROM STEP4_DATA
                                    
                                  PIVOT
                                       (
                                         MAX(WEEK_00) WEEK_00 ,  MAX(ACCURACY_RATTING) RATTING
                                             FOR SEQ IN ( 1 AS W1  ,2 AS W2 ,3 AS W3 ,4 AS W4   ,5 AS W5   ,6 AS W6  
                                                         ,7 AS W7  ,8 AS W8 ,9 AS W9 ,10 AS W10 ,11 AS W11 ,12 AS W12
                                                        )
                                       )  
                                        
                        ) STEP5_DATA
                      
                  )STEP6_DATA

               ) STEP7_DATA
          GROUP BY  TEAM ,STOCK_CODE,STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID

        /******************************/

        UNION ALL

        /******************************/

        SELECT  #{scmMonthCbBox}  MONTH
               ,'W' || #{scmPeriodCbBox}  WEEK
               , STOCK_CODE
               , STOCK_NAME
               , STOCK_CTGRY
               , STK_TYPE_ID
            
               ,'ALL' TEAM
               ,ALL_W12_WEEK_00 W12
               ,ALL_W11_WEEK_00 W11
               ,ALL_W10_WEEK_00 W10 
               ,ALL_W9_WEEK_00  W9 
               ,ALL_W8_WEEK_00  W8 
               ,ALL_W7_WEEK_00  W7     
               ,ALL_W6_WEEK_00  W6        
               ,ALL_W5_WEEK_00  W5 
               ,ALL_W4_WEEK_00  W4                     
               ,ALL_W3_WEEK_00  W3 
               ,ALL_W2_WEEK_00  W2                     
               ,ALL_W1_WEEK_00  W1 
               ,ORD_VALUE SALES_ORDER
               , CASE WHEN ALL_SHORT_CNT <![CDATA[>]]> 0 THEN ROUND(( (ALL_W8_RATTING + ALL_W7_RATTING + ALL_W6_RATTING + ALL_W5_RATTING 
                                                        + ALL_W4_RATTING + ALL_W3_RATTING + ALL_W2_RATTING + ALL_W1_RATTING) / ALL_SHORT_CNT ))
                                            ELSE 0 END  ||'%'
                 SHORT_TERM_AVG 
               , CASE WHEN ALL_MID_CNT <![CDATA[>]]> 0 THEN ROUND(((ALL_W12_RATTING + ALL_W11_RATTING + ALL_W10_RATTING + ALL_W9_RATTING ) / ALL_MID_CNT )) 
                                           ELSE 0 END  ||'%'
                 MID_TERM_AVG

          FROM (
                  /* ALL_RATING_AVG */
                  SELECT SUM_TEMP2.*
                        
                        ,( CASE WHEN ALL_W1_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W2_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W3_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W4_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         + CASE WHEN ALL_W5_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W6_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W7_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W8_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         ) ALL_SHORT_CNT
                        ,( CASE WHEN ALL_W9_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W10_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W11_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN ALL_W12_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                         ) ALL_MID_CNT   

                   FROM (
                            SELECT TEAM, STOCK_CODE, STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID, ORD_VALUE 
                                  ,ALL_W1_WEEK_00  ,ALL_W2_WEEK_00 ,ALL_W3_WEEK_00 ,ALL_W4_WEEK_00 ,ALL_W5_WEEK_00 ,ALL_W6_WEEK_00 
                                  ,ALL_W7_WEEK_00  ,ALL_W8_WEEK_00 ,ALL_W9_WEEK_00 ,ALL_W10_WEEK_00 ,ALL_W11_WEEK_00 ,ALL_W12_WEEK_00
                                  ,CASE WHEN ALL_W12_WEEK_00   <![CDATA[<]]> ALL_W12_ORD_VALUE THEN ROUND((ALL_W12_WEEK_00 / ALL_W12_ORD_VALUE )*100) 
                                        WHEN ALL_W12_ORD_VALUE <![CDATA[<]]> ALL_W12_WEEK_00 THEN ROUND((ALL_W12_ORD_VALUE / ALL_W12_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W12_RATTING
                                  ,CASE WHEN ALL_W11_WEEK_00   <![CDATA[<]]> ALL_W11_ORD_VALUE THEN ROUND((ALL_W11_WEEK_00 / ALL_W11_ORD_VALUE )*100) 
                                        WHEN ALL_W11_ORD_VALUE <![CDATA[<]]> ALL_W11_WEEK_00 THEN ROUND((ALL_W11_ORD_VALUE / ALL_W11_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W11_RATTING
                                  ,CASE WHEN ALL_W10_WEEK_00   <![CDATA[<]]> ALL_W10_ORD_VALUE THEN ROUND((ALL_W10_WEEK_00 / ALL_W10_ORD_VALUE )*100) 
                                        WHEN ALL_W10_ORD_VALUE <![CDATA[<]]> ALL_W10_WEEK_00 THEN ROUND((ALL_W10_ORD_VALUE / ALL_W10_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W10_RATTING
                                  ,CASE WHEN ALL_W9_WEEK_00   <![CDATA[<]]> ALL_W9_ORD_VALUE THEN ROUND((ALL_W9_WEEK_00 / ALL_W9_ORD_VALUE )*100) 
                                        WHEN ALL_W9_ORD_VALUE <![CDATA[<]]> ALL_W9_WEEK_00 THEN ROUND((ALL_W9_ORD_VALUE / ALL_W9_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W9_RATTING
                                  ,CASE WHEN ALL_W8_WEEK_00   <![CDATA[<]]> ALL_W8_ORD_VALUE THEN ROUND((ALL_W8_WEEK_00 / ALL_W8_ORD_VALUE )*100) 
                                        WHEN ALL_W8_ORD_VALUE <![CDATA[<]]> ALL_W8_WEEK_00 THEN ROUND((ALL_W8_ORD_VALUE / ALL_W8_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W8_RATTING
                                  ,CASE WHEN ALL_W7_WEEK_00   <![CDATA[<]]> ALL_W7_ORD_VALUE THEN ROUND((ALL_W7_WEEK_00 / ALL_W7_ORD_VALUE )*100) 
                                        WHEN ALL_W7_ORD_VALUE <![CDATA[<]]> ALL_W7_WEEK_00 THEN ROUND((ALL_W7_ORD_VALUE / ALL_W7_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W7_RATTING                     
                                  ,CASE WHEN ALL_W6_WEEK_00   <![CDATA[<]]> ALL_W6_ORD_VALUE THEN ROUND((ALL_W6_WEEK_00 / ALL_W6_ORD_VALUE )*100) 
                                        WHEN ALL_W6_ORD_VALUE <![CDATA[<]]> ALL_W6_WEEK_00 THEN ROUND((ALL_W6_ORD_VALUE / ALL_W6_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W6_RATTING
                                  ,CASE WHEN ALL_W5_WEEK_00   <![CDATA[<]]> ALL_W5_ORD_VALUE THEN ROUND((ALL_W5_WEEK_00 / ALL_W5_ORD_VALUE )*100) 
                                        WHEN ALL_W5_ORD_VALUE <![CDATA[<]]> ALL_W5_WEEK_00 THEN ROUND((ALL_W5_ORD_VALUE / ALL_W5_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W5_RATTING
                                  ,CASE WHEN ALL_W4_WEEK_00   <![CDATA[<]]> ALL_W4_ORD_VALUE THEN ROUND((ALL_W4_WEEK_00 / ALL_W4_ORD_VALUE )*100) 
                                        WHEN ALL_W4_ORD_VALUE <![CDATA[<]]> ALL_W4_WEEK_00 THEN ROUND((ALL_W4_ORD_VALUE / ALL_W4_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W4_RATTING
                                  ,CASE WHEN ALL_W3_WEEK_00   <![CDATA[<]]> ALL_W3_ORD_VALUE THEN ROUND((ALL_W3_WEEK_00 / ALL_W3_ORD_VALUE )*100) 
                                        WHEN ALL_W3_ORD_VALUE <![CDATA[<]]> ALL_W3_WEEK_00 THEN ROUND((ALL_W3_ORD_VALUE / ALL_W3_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W3_RATTING                                  
                                  ,CASE WHEN ALL_W2_WEEK_00   <![CDATA[<]]> ALL_W2_ORD_VALUE THEN ROUND((ALL_W2_WEEK_00 / ALL_W2_ORD_VALUE )*100)
                                        WHEN ALL_W2_ORD_VALUE <![CDATA[<]]> ALL_W2_WEEK_00   THEN ROUND((ALL_W2_ORD_VALUE / ALL_W2_WEEK_00 )*100) 
                                        ELSE 0                     
                                   END ALL_W2_RATTING
                                  ,CASE WHEN ALL_W1_WEEK_00   <![CDATA[<]]> ALL_W1_ORD_VALUE THEN ROUND((ALL_W1_WEEK_00 / ALL_W1_ORD_VALUE )*100) 
                                        WHEN ALL_W1_ORD_VALUE <![CDATA[<]]> ALL_W1_WEEK_00   THEN ROUND((ALL_W1_ORD_VALUE / ALL_W1_WEEK_00 )*100) 
                                        ELSE 0
                                   END ALL_W1_RATTING      
                                              
                                  FROM
                                      (
                                        SELECT 'ALL' TEAM, STOCK_CODE, STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID 
				                                       ,SUM(ORD_VALUE) ORD_VALUE
				                                       ,SUM(W1_WEEK_00) ALL_W1_WEEK_00 ,SUM(ORD_VALUE) ALL_W1_ORD_VALUE
				                                       ,SUM(W2_WEEK_00) ALL_W2_WEEK_00 ,SUM(ORD_VALUE) ALL_W2_ORD_VALUE
				                                       ,SUM(W3_WEEK_00) ALL_W3_WEEK_00 ,SUM(ORD_VALUE) ALL_W3_ORD_VALUE
				                                       ,SUM(W4_WEEK_00) ALL_W4_WEEK_00 ,SUM(ORD_VALUE) ALL_W4_ORD_VALUE
				                                       ,SUM(W5_WEEK_00) ALL_W5_WEEK_00 ,SUM(ORD_VALUE) ALL_W5_ORD_VALUE
				                                       ,SUM(W6_WEEK_00) ALL_W6_WEEK_00 ,SUM(ORD_VALUE) ALL_W6_ORD_VALUE
				                                       ,SUM(W7_WEEK_00) ALL_W7_WEEK_00 ,SUM(ORD_VALUE) ALL_W7_ORD_VALUE
				                                       ,SUM(W8_WEEK_00) ALL_W8_WEEK_00 ,SUM(ORD_VALUE) ALL_W8_ORD_VALUE
				                                       ,SUM(W9_WEEK_00) ALL_W9_WEEK_00 ,SUM(ORD_VALUE) ALL_W9_ORD_VALUE
				                                       ,SUM(W10_WEEK_00) ALL_W10_WEEK_00 ,SUM(ORD_VALUE) ALL_W10_ORD_VALUE
				                                       ,SUM(W11_WEEK_00) ALL_W11_WEEK_00 ,SUM(ORD_VALUE) ALL_W11_ORD_VALUE
				                                       ,SUM(W12_WEEK_00) ALL_W12_WEEK_00 ,SUM(ORD_VALUE) ALL_W12_ORD_VALUE   
                                  FROM (
                                        SELECT  
                                             TEAM,STOCK_CODE, STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID,ORD_VALUE
                                              ,W1_WEEK_00 ,W1_RATTING  ,W2_WEEK_00 ,W2_RATTING  ,W3_WEEK_00,W3_RATTING  ,W4_WEEK_00,W4_RATTING   ,W5_WEEK_00,W5_RATTING   ,W6_WEEK_00  ,W6_RATTING  
                                              ,W7_WEEK_00 ,W7_RATTING  ,W8_WEEK_00,W8_RATTING   ,W9_WEEK_00,W9_RATTING  ,W10_WEEK_00,W10_RATTING ,W11_WEEK_00,W11_RATTING ,W12_WEEK_00 ,W12_RATTING  
                                              ,DECODE(SHORT_TERM_CNT, 0, 0,  ROUND(SHORT_TERM_SUM / SHORT_TERM_CNT) ) SHORT_TERM_AVG
                                              ,DECODE(MID_TERM_CNT  , 0, 0,  ROUND(MID_TERM_SUM   / MID_TERM_CNT) ) MID_TERM_AVG 
                                          FROM
                                          (
                                           SELECT STEP5_DATA.*
                                                ,(W1_RATTING + W2_RATTING + W3_RATTING + W4_RATTING + W5_RATTING + W6_RATTING + W7_RATTING +W8_RATTING) SHORT_TERM_SUM
                                                ,(W9_RATTING + W10_RATTING + W11_RATTING + W12_RATTING ) MID_TERM_SUM
                                                ,( CASE WHEN W1_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W2_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W3_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W4_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END
                                                 + CASE WHEN W5_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W6_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W7_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W8_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END 
                                                 ) SHORT_TERM_CNT 
                                                ,( CASE WHEN W9_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W10_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W11_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END + CASE WHEN W12_RATTING <![CDATA[>]]> 0 THEN 1 ELSE 0 END) MID_TERM_CNT
                                            FROM
                                                (
                                                   WITH STEP4_DATA
                                                     AS
                                                        (
                                                          SELECT STEP3_DATA.*
                                                               , CASE WHEN ( STEP3_DATA.ORD_VALUE <![CDATA[<]]> STEP3_DATA.WEEK_00  ) 
                                                                      THEN ROUND((STEP3_DATA.ORD_VALUE / STEP3_DATA.WEEK_00)*100) 
                                                                      WHEN ( STEP3_DATA.WEEK_00   <![CDATA[<]]> STEP3_DATA.ORD_VALUE  ) 
                                                                      THEN ROUND((STEP3_DATA.WEEK_00 / STEP3_DATA.ORD_VALUE)*100) 
                                                                 ELSE
                                                                    0
                                                                 END ACCURACY_RATTING
                                                          FROM (
                                                                SELECT STEP2_DATA.*
                                                                      ,(SELECT M0_ORD FROM SCM0052V SCM52V WHERE SCM52V.PLAN_YEAR = #{scmYearCbBox}  AND SCM52V.PLAN_MONTH = #{scmMonthCbBox} AND SCM52V.PLAN_WEEK = #{scmPeriodCbBox} AND SCM52V.TEAM = STEP2_DATA.TEAM AND SCM52V.STOCK_CODE = STEP2_DATA.STOCK_CODE) ORD_VALUE
                                                                  FROM 
                                                                      ( 
                                                                        SELECT STEP1_DATA.*  
                                                                          FROM 
                                                                              (
                                                                                SELECT   1 SEQ
                                                                                       ,TEAM
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year1}  
                                                                                    AND PLAN_WEEK = #{weekTh1}
                                                                                          
                                                                                UNION ALL
                                                                                          
                                                                                SELECT  2 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year2}  
                                                                                    AND PLAN_WEEK = #{weekTh2} 
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  3 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year3}  
                                                                                    AND PLAN_WEEK = #{weekTh3} 
                                                                                                  
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  4 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year4}  
                                                                                    AND PLAN_WEEK = #{weekTh4} 
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  5 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year5}  
                                                                                    AND PLAN_WEEK = #{weekTh5}  
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  6 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year6}   
                                                                                    AND PLAN_WEEK = #{weekTh6} 
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  7 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year7}   
                                                                                    AND PLAN_WEEK = #{weekTh7} 
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  8 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year8}  
                                                                                    AND PLAN_WEEK = #{weekTh8}           
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  9 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year9}   
                                                                                    AND PLAN_WEEK = #{weekTh9} 
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  10 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year10}  
                                                                                    AND PLAN_WEEK = #{weekTh10}    
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  11 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year11}  
                                                                                    AND PLAN_WEEK = #{weekTh11} 
                                                                                              
                                                                                  UNION ALL
                                                                                          
                                                                                SELECT  12 SEQ
                                                                                       ,TEAM  
                                                                                       ,STOCK_CODE  
                                                                                       ,STOCK_NAME  
                                                                                       ,STOCK_CTGRY
                                                                                       ,STK_TYPE_ID  
                                                                                       ,W00 WEEK_00
                                                                                                 
                                                                                   FROM SCM0052V  
                                                                                  WHERE PLAN_YEAR = #{year12}  
                                                                                    AND PLAN_WEEK = #{weekTh12}   
                                                                              )  STEP1_DATA
                                                                      )  STEP2_DATA
                                                                ) STEP3_DATA
                                                        ) 
                                                        SELECT *
                                                          FROM STEP4_DATA
                                                              
                                                          PIVOT
                                                               (
                                                                 MAX(WEEK_00) WEEK_00 ,  MAX(ACCURACY_RATTING) RATTING
                                                                     FOR SEQ IN ( 1 AS W1  ,2 AS W2 ,3 AS W3 ,4 AS W4   ,5 AS W5   ,6 AS W6  
                                                                                 ,7 AS W7  ,8 AS W8 ,9 AS W9 ,10 AS W10 ,11 AS W11 ,12 AS W12
                                                                                )
                                                               )  
                                                                  
                                                ) STEP5_DATA
                                                
                                          )STEP6_DATA

                                       ) STEP7_DATA
                                       GROUP BY STOCK_CODE,STOCK_NAME,STOCK_CTGRY,STK_TYPE_ID
                                      ) SUM_TEMP1
                       
                         ) SUM_TEMP2
          
           ) SUM_TEMP3
           
      ) WEEKLY_DETAIL
 
  ORDER BY STOCK_CODE, DECODE(TEAM,'CODY',1,'DST',2 ,3)   
  
</select> 

<select id="selectAccuracyMonthlyReport" parameterType="Map" resultType="egovMap">
  WITH HEAD_MONTHLY1
  AS 
    (
	     SELECT AB.*
	       FROM (
	             SELECT *
	               FROM (
	                     SELECT GBN||'_TERM' GBN, TEAM,WEEK,ROUND(TERM_AVG/TERM_AVG_CNT) ACCRU_RAT
	                       FROM (
		                            SELECT 'MID' GBN, TEAM,WEEK, SUM(MID_TERM_AVG) TERM_AVG, COUNT(*) TERM_AVG_CNT
		                              FROM GBL_TEMP_ACCURACY
		                             WHERE (MID_TERM_AVG > 0 ) 
		                             GROUP BY TEAM,WEEK
		                              
		                            UNION ALL
		                              
		                            SELECT 'SHORT' GBN,  TEAM,WEEK, SUM(SHORT_TERM_AVG) TERM_AVG, COUNT(*) TERM_AVG_CNT
		                              FROM GBL_TEMP_ACCURACY
		                             WHERE (SHORT_TERM_AVG > 0 ) 
		                             GROUP BY TEAM,WEEK
	                           )
	                    )
	                        
	                      PIVOT
	                            (
	                              MAX(ACCRU_RAT) 
	                                 FOR WEEK IN (   1 AS W1  , 2 AS W2   ,3 AS W3   ,4 AS W4   ,5 AS W5   ,6 AS W6   ,7 AS W7   ,8 AS W8   ,9 AS W9   ,10 AS W10
	                                               ,11 AS W11 ,12 AS W12 ,13 AS W13 ,14 AS W14 ,15 AS W15 ,16 AS W16 ,17 AS W17 ,18 AS W18 ,19 AS W19 ,20 AS W20
	                                               ,21 AS W21 ,22 AS W22 ,23 AS W23 ,24 AS W24 ,25 AS W25 ,26 AS W26 ,27 AS W27 ,28 AS W28 ,29 AS W29 ,30 AS W30 
	                                               ,31 AS W31 ,32 AS W32 ,33 AS W33 ,34 AS W34 ,35 AS W35 ,36 AS W36 ,37 AS W37 ,38 AS W38 ,39 AS W39 ,40 AS W40 
	                                               ,41 AS W41 ,42 AS W42 ,43 AS W43 ,44 AS W44 ,45 AS W45 ,46 AS W46 ,47 AS W47 ,48 AS W48 ,49 AS W49 ,50 AS W50 
	                                               ,51 AS W51 ,52 AS W52)
	                            )
	            )  AB
    )
    
  , HEAD_MONTHLY2
    AS
    (
      SELECT 
             TEAM
            ,GBN||'_TERM' GBN
            ,ROUND(SUM(ACCRU_RAT) / ( SELECT COUNT(1) CNT FROM SCM0018M WHERE SCM_YEAR = #{scmYearCbBox} AND SCM_MONTH = #{scmMonthCbBox} AND WEEK_TH_SN = 1) ) MONTHLY_ACCRURAY 
        FROM(
	             SELECT GBN, TEAM,WEEK, ROUND((SUM_TERM_AVG/TERM_AVG_CNT)) ACCRU_RAT
	               FROM (
		                     SELECT 'MID' GBN, TEAM,WEEK, SUM(MID_TERM_AVG) SUM_TERM_AVG, COUNT(*) TERM_AVG_CNT
		                      FROM GBL_TEMP_ACCURACY
		                     WHERE (MID_TERM_AVG > 0 ) 
		                     GROUP BY TEAM,WEEK
		                    
		                    UNION ALL
		                    
		                    SELECT 'SHORT' GBN, TEAM,WEEK, SUM(SHORT_TERM_AVG) SUM_TERM_AVG, COUNT(*) TERM_AVG_CNT
		                      FROM GBL_TEMP_ACCURACY
		                     WHERE (SHORT_TERM_AVG > 0 ) 
		                     GROUP BY TEAM,WEEK
	                   )
            ) 
      GROUP BY ROLLUP ( GBN ,TEAM )
      HAVING  TEAM IS NOT NULL
    )    
     SELECT  H1.TEAM
            ,H1.GBN TERM 
            ,H2.MONTHLY_ACCRURAY
            ,H1.*
       FROM HEAD_MONTHLY1 H1
           ,HEAD_MONTHLY2 H2
      WHERE H1.GBN  = H2.GBN  
        AND H1.TEAM = H2.TEAM
      ORDER BY DECODE(H1.TEAM,'ALL',1,'DST',2,3), DECODE(TERM,'SHORT_TERM',1,2)  
  
</select> 

<resultMap id="salePlanDetailInsertMap" type="egovMap"></resultMap>
<select id="callSpCreateSalesPlanDetail" statementType="CALLABLE" parameterType="Map">
    { call SP_CREATE_SALES_PLAN_DETAIL(
		                                    #{salesPlanMstSeq}
		                                  , #{scmYearCbBox}
		                                  , #{scmPeriodCbBox}
		                                  , #{scmTeamCbBox}
		                                  , #{p1, mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=salePlanDetailInsertMap})
    }
</select>

<resultMap id="salePlanAccuracyInsertMap" type="egovMap"></resultMap>
<select id="callSpCreateMonthlyAccuracy" statementType="CALLABLE" parameterType="Map">
    { call SP_INS_SCM_ACCURACY(
                                  #{scmYearCbBox}
                                , #{scmMonthCbBox}
                                , #{scmPeriodCbBox}
                                , #{rtnVal,  mode=OUT, jdbcType=VARCHAR, javaType=STRING, resultMap=salePlanAccuracyInsertMap})
    }
</select>

  
</mapper>