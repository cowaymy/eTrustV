<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.incentive.goldPoints.impl.GoldPointsMapper">

    <select id="selectNextBatchId" resultType="int">
        SELECT ICR0001M_SEQ.NEXTVAL FROM DUAL
    </select>

    <insert id="insertGoldPointsMst" parameterType="Map">
        INSERT INTO ICR0001M (
            GP_BATCH_ID,
            STUS_ID,
            REM,
            CRT_DT,
            CRT_USER_ID,
            UPD_DT,
            UPD_USER_ID
        ) VALUES (
            #{goldPtsBatchId},
            1,
            null,
            SYSDATE,
            #{crtUserId},
            SYSDATE,
            #{updUserId}
        )
    </insert>

    <insert id="insertGoldPointsDtl" parameterType="Map">
        INSERT INTO ICR0002D (
            GP_BATCH_DTL_ID,
            GP_BATCH_ID,
            MEM_CODE,
            MEM_NAME,
            GP_DESC,
            GP_UPL_PTS,
            GP_START_DT,
            GP_END_DT,
            STUS_ID,
            REM,
            CRT_DT,
            CRT_USER_ID,
            UPD_DT,
            UPD_USER_ID
        ) SELECT
                ICR0002D_SEQ.NEXTVAL,
                goldPtsBatchId,
                memCode,
                memName,
                gpDesc,
                gpUplPts,
                gpStartDt,
                gpEndDt,
                stusId,
                rem,
                crtDt,
                crtUserId,
                updDt,
                updUserId
            FROM (
            <foreach collection="list" item="item" index="index" separator=" UNION ALL ">
                SELECT
                    #{goldPtsBatchId} goldPtsBatchId,
                    #{item.memCode} memCode,
                    #{item.memName} memName,
                    #{item.ptsDesc} gpDesc,
                    #{item.ptsEarned} gpUplPts,
                    TO_DATE(#{item.startDate},'DD/MM/YYYY') gpStartDt,
                    TO_DATE(#{item.endDate},'DD/MM/YYYY') gpEndDt,
                    1 stusId,
                    NULL rem,
                    SYSDATE crtDt,
                    #{item.crtUserId} crtUserId,
                    SYSDATE updDt,
                    #{item.updUserId} updUserId
                FROM DUAL
            </foreach>
        )
    </insert>

    <update id="callGoldPointsConfirm" statementType="CALLABLE" parameterType="Map">
        {call SP_GOLD_PTS_CONFIRM(#{goldPtsBatchId})}
    </update>

    <select id="selectNextRedemptionItemsBatchId" resultType="int">
        SELECT ICR0004M_SEQ.NEXTVAL FROM DUAL
    </select>

    <insert id="insertRedemptionItemsMst" parameterType="Map">
        INSERT INTO ICR0004M (
            RI_BATCH_ID,
            STUS_ID,
            REM,
            CRT_DT,
            CRT_USER_ID,
            UPD_DT,
            UPD_USER_ID
        ) VALUES (
            #{riBatchId},
            1,
            null,
            SYSDATE,
            #{crtUserId},
            SYSDATE,
            #{updUserId}
        )
    </insert>

    <insert id="insertRedemptionItemsDtl" parameterType="Map">
        INSERT INTO ICR0005D (
            RI_BATCH_DTL_ID,
            RI_BATCH_ID,
            ITM_CODE,
            ITM_CAT,
            ITM_DESC,
            GP_PER_UNIT,
            RI_START_DT,
            RI_END_DT,
            STUS_ID,
            REM,
            CRT_DT,
            CRT_USER_ID,
            UPD_DT,
            UPD_USER_ID
        ) SELECT
                ICR0005D_SEQ.NEXTVAL,
                riBatchId,
                itmCode,
                itmCat,
                itmDesc,
                gpPerUnit,
                riStartDt,
                riEndDt,
                stusId,
                rem,
                crtDt,
                crtUserId,
                updDt,
                updUserId
            FROM (
            <foreach collection="list" item="item" index="index" separator=" UNION ALL ">
                SELECT
                    #{riBatchId} riBatchId,
                    #{item.itmCode} itmCode,
                    #{item.itmCat} itmCat,
                    #{item.itmDesc} itmDesc,
                    #{item.gpPerUnit} gpPerUnit,
                    TO_DATE(#{item.startDt},'DD/MM/YYYY') riStartDt,
                    TO_DATE(#{item.endDt},'DD/MM/YYYY') riEndDt,
                    1 stusId,
                    NULL rem,
                    SYSDATE crtDt,
                    #{item.crtUserId} crtUserId,
                    SYSDATE updDt,
                    #{item.updUserId} updUserId
                FROM DUAL
            </foreach>
        )
    </insert>

    <update id="callRedemptionItemsConfirm" statementType="CALLABLE" parameterType="Map">
        {call SP_REDEMPTN_ITEMS_CONFIRM(#{riBatchId})}
    </update>

    <select id="selectPointsSummaryList" parameterType="Map" resultType="egovMap">
        SELECT * FROM (
            SELECT
                I.MEM_CODE,
                I.MEM_NAME,
                T.NAME STATUS,
                S.CODE_NAME POSITION_DESC,
                SUM(I.GP_BAL_PTS) TOT_BAL_PTS
            FROM ICR0003D I
            JOIN ORG0001D O ON O.MEM_CODE = I.MEM_CODE
            JOIN SYS0013M S ON S.CODE_ID = O.MEM_TYPE
            JOIN SYS0038M T ON T.STUS_CODE_ID =  O.STUS
            WHERE 1=1
            AND I.GP_BAL_PTS > 0
            AND (SYSDATE BETWEEN I.GP_START_DT AND I.GP_END_DT)

            <if test=" null != memCode and '' != memCode">
                AND I.MEM_CODE = #{memCode}
            </if>

            AND S.CODE_MASTER_ID = 1
            GROUP BY I.MEM_CODE, I.MEM_NAME, T.NAME, S.CODE_NAME
        )
    </select>

    <select id="selectTransactionHistory" parameterType="Map" resultType="egovMap">
        SELECT * FROM (
            SELECT
                I.MEM_CODE,
                I.MEM_NAME,
                T.NAME STATUS,
                S.CODE_NAME POSITION_DESC,
                SUM(I.GP_BAL_PTS) TOT_BAL_PTS
            FROM ICR0003D I
            JOIN ORG0001D O ON O.MEM_CODE = I.MEM_CODE
            JOIN SYS0013M S ON S.CODE_ID = O.MEM_TYPE
            JOIN SYS0038M T ON T.STUS_CODE_ID =  O.STUS
            WHERE S.CODE_MASTER_ID = 1
            AND I.MEM_CODE = #{memCode}
            GROUP BY I.MEM_CODE, I.MEM_NAME, T.NAME, S.CODE_NAME
        )
    </select>

    <select id="selectPointsExpiryList" parameterType="Map" resultType="egovMap">
        SELECT
            GP_DESC,
            GP_UPL_PTS,
            TO_CHAR(GP_END_DT, 'DD-MM-YYYY') GP_END_DT
        FROM ICR0003D
        WHERE MEM_CODE = #{memCode}
        ORDER BY GP_ITM_ID
    </select>

    <select id="selectRedemptionBasicInfo" parameterType="Map" resultType="egovMap">
        SELECT * FROM (
            SELECT
                O.MEM_CODE,
                O.NAME MEM_NAME,
                O.TEL_MOBILE,
                O.EMAIL,
                SUM(I.GP_BAL_PTS) TOT_BAL_PTS
            FROM SYS0047M S
            JOIN ORG0001D O ON O.MEM_CODE = S.HR_CODE
            JOIN ICR0003D I ON I.MEM_CODE = O.MEM_CODE
            WHERE S.USER_ID = #{userId}
            AND I.GP_BAL_PTS > 0
            AND (SYSDATE BETWEEN I.GP_START_DT AND I.GP_END_DT)
            GROUP BY O.MEM_CODE, O.NAME, O.TEL_MOBILE, O.EMAIL
        )
    </select>

    <select id="getOrgDtls" parameterType="Map" resultType="String">
        SELECT
            B.MEM_CODE
        FROM SYS0047M A
        JOIN ORG0001D B
            ON A.HR_CODE = B.MEM_CODE
        WHERE A.USER_ID = #{userId}
    </select>

    <select id="searchItemCategoryList" parameterType="Map" resultType="egovMap">
        SELECT DISTINCT UPPER(ITM_CAT) ITM_CAT FROM ICR0006D WHERE SYSDATE BETWEEN RI_START_DT AND RI_END_DT
    </select>

    <select id="searchRedemptionItemList" parameterType="Map" resultType="egovMap">
        SELECT
            RI_ITM_ID,
            UPPER(ITM_CODE) || ' - ' || UPPER(ITM_DESC) AS ITM_DISPLAY_NAME,
            GP_PER_UNIT
        FROM ICR0006D
        WHERE SYSDATE BETWEEN RI_START_DT AND RI_END_DT
        <if test=" null != category and '' != category">
            AND UPPER(ITM_CAT) = #{category}
        </if>
    </select>

    <select id="selectNextRedemptionId" resultType="int">
            SELECT ICR0007M_SEQ.NEXTVAL FROM DUAL
    </select>

    <select id="getNextRedemptionNo" resultType="String">
            SELECT FN_GET_DOCNO('178') FROM DUAL
    </select>

    <insert id="insertNewRedemption" parameterType="Map">
        INSERT INTO ICR0007M (
            RDM_ID,
            RDM_NO,
            RDM_ITM_ID,
            QTY,
            COLLECT_BRNCH_ID,
            MEM_CODE,
            CRT_DT,
            CRT_USER_ID,
            STUS_ID
        ) VALUES (
            #{redemptionId},
            #{redemptionNo},
            #{rdmItm},
            #{rdmQty},
            #{rdmColBrnch},
            #{rdmMemCode},
            SYSDATE,
            #{userId},
            1
        )
    </insert>

    <resultMap id="processRdmptnResultStus" type="egovMap"></resultMap>
    <resultMap id="processRdmptnResultMsg" type="egovMap"></resultMap>

    <update id="processRedemption" statementType="CALLABLE" parameterType="Map">
        {call SP_GOLD_PTS_REDEEM(#{redemptionId}, #{userId},
                                        #{p1, mode=OUT, jdbcType=INTEGER, javaType=int, resultMap=processRdmptnResultStus},
                                        #{p2, mode=OUT, jdbcType=VARCHAR, javaType=String, resultMap=processRdmptnResultMsg})}
    </update>

</mapper>