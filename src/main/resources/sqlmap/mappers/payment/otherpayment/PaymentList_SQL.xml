<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.otherpayment.service.impl.PaymentListMapper">
    
    <select id="selectGroupPaymentList" parameterType="Map" resultType="egovMap">
        SELECT
            A.GROUP_SEQ, 
            (SELECT APP_TYPE FROM PAY0241T WHERE SEQ = A.GROUP_SEQ AND PRCSS_SEQ = A.PRCSS_SEQ AND ROWNUM <![CDATA[ <= ]]> 1) AS APP_TYPE,         
            D.PAY_ITM_MODE_ID,
            F.CODE_NAME AS PAY_ITM_MODE_NM,
            E.CUST_ID,
            (CASE WHEN E.SALES_ORD_NO IS NOT NULL THEN E.SALES_ORD_NO ELSE I.SALES_ORD_NO END) AS SALES_ORD_NO,
            D.PAY_ITM_REF_DT,
            C.OR_NO,
            C.BRNCH_ID,
            A.CRC_STATE_MAPPING_ID,        
            A.CRC_STATE_MAPPING_DT,
            A.BANK_STATE_MAPPING_ID,
            A.BANK_STATE_MAPPING_DT,
            A.REV_STUS_ID,
            G.NAME AS REV_STUS_NM,
            A.REV_DT
        FROM 
            PAY0252T A
            JOIN PAY0064D C ON A.PAY_ID = C.PAY_ID
            JOIN PAY0065D D ON A.PAY_ITM_ID = D.PAY_ITM_ID
            LEFT JOIN SAL0001D E ON C.SALES_ORD_ID = E.SALES_ORD_ID    
            JOIN SYS0013M F ON D.PAY_ITM_MODE_ID = F.CODE_ID
            LEFT JOIN SYS0038M G ON A.REV_STUS_ID = G.STUS_CODE_ID
            LEFT JOIN PAY0007D H ON C.BILL_ID = H.BILL_ID
            LEFT JOIN SAL0001D I ON H.BILL_SO_ID = I.SALES_ORD_ID         
        WHERE 
            A.GROUP_SEQ IN (
                SELECT 
                    DISTINCT A.GROUP_SEQ
                FROM 
                    PAY0252T A
                    JOIN PAY0064D B ON A.PAY_ID = B.PAY_ID                    
                    JOIN PAY0065D C ON A.PAY_ITM_ID = C.PAY_ITM_ID
                    JOIN SAL0001D D ON B.SALES_ORD_ID = D.SALES_ORD_ID    
                WHERE 
                    D.SALES_ORD_NO = #{ordNo}    
                    AND C.PAY_ITM_REF_DT BETWEEN TO_DATE(#{tranDateFr},'DD/MM/YYYY') AND TO_DATE(#{tranDateTo},'DD/MM/YYYY')
            )      
        ORDER BY A.RSLT_SEQ DESC
        
    </select>
    
    <select id="selectPaymentListByGroupSeq" parameterType="Map" resultType="egovMap">
        SELECT
            A.GROUP_SEQ, 
            (SELECT APP_TYPE FROM PAY0241T WHERE SEQ = A.GROUP_SEQ AND PRCSS_SEQ = A.PRCSS_SEQ AND ROWNUM <![CDATA[ <= ]]> 1) AS APP_TYPE,         
            D.PAY_ITM_MODE_ID,
            F.CODE_NAME AS PAY_ITM_MODE_NM,
            E.CUST_ID,
            (CASE WHEN E.SALES_ORD_NO IS NOT NULL THEN E.SALES_ORD_NO ELSE I.SALES_ORD_NO END) AS SALES_ORD_NO,
            D.PAY_ITM_REF_DT,
            C.OR_NO,
            C.BRNCH_ID,
            A.PAY_ITM_AMT,
            A.CRC_STATE_MAPPING_ID,        
            A.CRC_STATE_MAPPING_DT,
            A.BANK_STATE_MAPPING_ID,
            A.BANK_STATE_MAPPING_DT,
            A.REV_STUS_ID,
            G.NAME AS REV_STUS_NM,
            A.REV_DT
        FROM 
            PAY0252T A
            JOIN PAY0064D C ON A.PAY_ID = C.PAY_ID
            JOIN PAY0065D D ON A.PAY_ITM_ID = D.PAY_ITM_ID
            LEFT JOIN SAL0001D E ON C.SALES_ORD_ID = E.SALES_ORD_ID
            JOIN SYS0013M F ON D.PAY_ITM_MODE_ID = F.CODE_ID
            LEFT JOIN SYS0038M G ON A.REV_STUS_ID = G.STUS_CODE_ID
            LEFT JOIN PAY0007D H ON C.BILL_ID = H.BILL_ID
            LEFT JOIN SAL0001D I ON H.BILL_SO_ID = I.SALES_ORD_ID                 
        WHERE 
            A.GROUP_SEQ = #{groupSeq}
        ORDER BY A.RSLT_SEQ DESC
        
    </select>
    
     <insert id="requestDCF" parameterType="Map">
        <selectKey keyProperty="dcfReqId" resultType="int" order="BEFORE">
            SELECT PAY0258D_SEQ.NEXTVAL FROM DUAL
        </selectKey>  
            INSERT INTO PAY0258D (
                DCF_REQ_ID,
				GRP_SEQ,
				DCF_RESN,
				DCF_AMT,
				DCF_REM,
				DCF_STUS_ID,
				DCF_CRT_USER_ID,
				DCF_CRT_DT
            ) VALUES (
                #{dcfReqId},
                #{groupSeq},
                #{reason},
                TO_NUMBER(#{totalAmt}),
                #{remark},
                1,
                #{userId},
                SYSDATE
            )
    </insert>
    
    <update id="updateGroupPaymentRevStatus" parameterType="Map">
        UPDATE PAY0252T SET REV_STUS_ID = #{revStusId} WHERE GROUP_SEQ = #{groupSeq}
    </update> 
    
    <select id="selectRequestDCFList" parameterType="Map" resultType="egovMap">
        SELECT  
            A.DCF_REQ_ID,
		    A.GRP_SEQ,
		    A.DCF_RESN,
		    C.CODE_NAME AS DCF_RESN_NM,    
		    A.DCF_STUS_ID,
		    B.NAME AS DCF_STUS_NM,
		    A.DCF_CRT_USER_ID,
		    D.USER_NAME AS DCF_CRT_USER_NM,
		    A.DCF_CRT_DT    
        FROM 
            PAY0258D A
            LEFT JOIN SYS0038M B ON A.DCF_STUS_ID = B.STUS_CODE_ID
            LEFT JOIN SYS0013M C ON A.DCF_RESN = C.CODE_ID
            LEFT JOIN SYS0047M D ON A.DCF_CRT_USER_ID = D.USER_ID
        WHERE
            1=1
            <if test="reqDateFr != null and reqDateTo != null and reqDateFr != '' and reqDateTo != '' ">
                AND DCF_CRT_DT <![CDATA[   >= ]]> TO_DATE(#{reqDateFr},'DD/MM/YYYY')
                AND DCF_CRT_DT <![CDATA[   < ]]> TO_DATE(#{reqDateTo},'DD/MM/YYYY') + 1
            </if>
            <if test="status != null and status != '' ">
            AND DCF_STUS_ID = #{status}
            </if>
            <if test="reason != null and reason != '' ">
            AND DCF_RESN = #{reason}
            </if>
            <if test="reqNo != null and reqNo != '' ">
            AND DCF_REQ_ID = #{reqNo}
            </if>  
        ORDER BY A.DCF_REQ_ID    
        
    </select>  
    
    
    <update id="updateStatusDCF" parameterType="Map">
        UPDATE PAY0258D SET
            DCF_APPV_DT = SYSDATE,
            DCF_APPV_USER_ID = #{userId},
            DCF_APPV_REM = #{remark},
            DCF_STUS_ID = #{dcfStusId}
        WHERE 
            DCF_REQ_ID = #{reqNo}
    </update>  
    
    <update id="approvalDCF" statementType="CALLABLE" parameterType="Map">
        {call SP_INST_PAYMENT_REVRS(#{reqNo},#{groupSeq},#{remark}, #{userId} )}
    </update>
    
    
</mapper>