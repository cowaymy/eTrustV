<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.autodebit.service.impl.AutoDebitMapper">

  <select id="orderNumberSearchMobile" parameterType="Map" resultType="egovMap">
		SELECT s0001d.SALES_ORD_ID,s0001d.SALES_ORD_NO, s0001d.CUST_ID,s0029d.NAME AS CUST_NAME,
		s0029d.NRIC AS CUST_NRIC, s0013m.CODE_NAME AS STATUS_DESC,s0013m1.CODE_NAME AS USER_TYPE,
		NVL(p0053s.ACC_DEBT_SUB_TOT_OTSTND,0) AS TOTAL_OUTSTANDING, TO_CHAR(s0001d.CRT_DT,'DD/MM/YYYY') AS CREATED_DATE,
		s0001d.MTH_RENT_AMT AS MONTHLY_RENTAL_AMOUNT, s0029d.EMAIL as CUST_EMAIL, s0027d.TEL_M1 AS CUST_MOBILE
		FROM SAL0001D s0001d
		LEFT JOIN SAL0029D s0029d
		ON s0001d.CUST_ID = s0029d.CUST_ID
		LEFT JOIN SYS0013M s0013m
		ON s0013m.CODE_ID = s0001d.APP_TYPE_ID
		LEFT JOIN SYS0013M s0013m1
		ON s0013m1.CODE_ID = s0029d.TYPE_ID
		LEFT JOIN PAY0053S p0053s
		ON p0053s.ACC_DEBT_ORD_ID = s0001d.SALES_ORD_ID
		LEFT JOIN SAL0027D s0027d
		ON s0001d.CUST_CNT_ID = s0027d.CUST_CNTC_ID
		WHERE s0001d.APP_TYPE_ID = 66
		AND s0001d.STUS_CODE_ID = 4
		AND s0001d.SALES_ORD_NO = #{salesOrdNo}
  </select>

  <select id="autoDebitHistoryMobileList" parameterType="Map" resultType="egovMap">
		SELECT p0333m.PAD_ID,p0333m.PAD_NO,p0333m.SALES_ORD_NO,TO_CHAR(p0333m.CRT_DT,'DD/MM/YYYY') AS CREATED_DATE,
		TO_CHAR(p0333m.UPT_DT,'DD/MM/YYYY') AS UPDATED_DATE,p0333m.REMARKS,
		s0038M.NAME AS STATUS_DESC,s0029d.NAME AS CUST_NAME
		FROM PAY0333M p0333m
		INNER JOIN SYS0038M s0038m
		ON s0038m.STUS_CODE_ID = p0333m.STUS_CODE_ID
		INNER JOIN SAL0029D s0029d
		ON s0029d.CUST_ID = p0333m.CUST_ID
		WHERE 1=1
		<if test='fromDate != null and toDate != null'>
			<if test='fromDate != "" and toDate != ""'>
				<![CDATA[
					AND p0333m.CRT_DT => #{fromDate} AND p0333m.CRT_DT < #{toDate}
				]]>
			</if>
		</if>
		<if test='salesOrderNo != null and salesOrderNo != ""'>
		AND p0333m.SALES_ORD_NO = #{salesOrdNo}
		</if>
		<if test='statusCodeID != null and statusCodeID != ""'>
		AND p0333.STUS_CODE_ID = #{statusCodeID}
		</if>
  </select>

  <select  id="selectAutoDebitEnrollmentList" parameterType="Map" resultType="egovMap">
		SELECT p0333m.PAD_ID, p0333m.PAD_NO, TO_CHAR(p0333m.CRT_DT,'DD/MM/YYYY') AS KEY_IN_DATE, TO_CHAR(p0333m.CRT_DT,'HH12:MI:SS AM') AS KEY_IN_TIMESTAMP,
		s0038m.NAME AS STATUS_DESC, p0333m.SALES_ORD_NO, s0029d.NAME AS CUST_NAME, s0032m.RESN_DESC, p0333m.REMARKS,
		s0047m1.USER_NAME AS CREATOR, s0005m.CODE ||' '|| s0005m.NAME AS USER_BRANCH, p0333m.UPT_DT ||','|| (s0047m2.USER_NAME) AS LAST_UPDATED_DATE, p0333m.CUST_CRC_ID,
		TO_CHAR(s0028d.CUST_CRC_CRT_DT,'DD/MM/YYYY') AS CRC_APPLY_DATE
		FROM PAY0333M p0333m
		LEFT JOIN SAL0029D s0029d
		ON p0333m.CUST_ID = s0029d.CUST_ID
		LEFT JOIN SYS0038M s0038m
		ON p0333m.STUS_CODE_ID = s0038m.STUS_CODE_ID
		LEFT JOIN SYS0047M s0047m1
		ON p0333m.CRT_BY = s0047m1.USER_ID
		LEFT JOIN SYS0047M s0047m2
		ON p0333m.UPT_BY = s0047m2.USER_ID
		LEFT JOIN SYS0005M s0005m
		ON p0333m.USER_BRANCH = s0005m.BRNCH_ID
		LEFT JOIN ORG0001D o0001d
		ON s0047m1.USER_NAME = o0001d.MEM_CODE
		LEFT JOIN ORG0005D o0005d
		ON o0005d.MEM_ID = o0001d.MEM_ID
		LEFT JOIN SYS0032M s0032m
		ON s0032m.RESN_ID = p0333m.FAIL_REASON_CODE
		LEFT JOIN SAL0028D s0028d
		ON s0028d.CUST_CRC_ID = p0333m.CUST_CRC_ID
		WHERE 1=1
		<if test='padNo != null and padNo != ""'>
			AND p0333m.PAD_NO = #{padNo}
		</if>
		<if test='orderNo != null and orderNo != ""'>
			AND p0333m.SALES_ORD_NO = #{orderNo}
		</if>
		<if test='requestDateFrom != null and requestDateFrom != "" and requestDateTo != null and requestDateTo != ""'>
			AND p0333m.CRT_DT BETWEEN TO_DATE(#{requestDateFrom},'DD/MM/YYYY') AND TO_DATE(#{requestDateTo},'DD/MM/YYYY')
		</if>
		<if test='requestDateFrom != null and requestDateFrom != "" and requestDateTo != null and requestDateTo != "" and requestTimeFrom != null and requestTimeFrom != "" and requestTimeTo != null and requestTimeTo != ""'>
			AND p0333m.CRT_DT BETWEEN TO_DATE(#{requestDateFrom} || #{requestTimeFrom}, 'dd/mm/yyyy hh24:mi')  AND TO_DATE(#{requestDateTo} || #{requestTimeTo}, 'dd/mm/yyyy hh24:mi')
		</if>
		<if test='crcRequestDateFrom != null and crcRequestDateFrom != "" and crcRequestDateTo != null and crcRequestDateTo != ""'>
			AND s0028d.CUST_CRC_CRT_DT BETWEEN TO_DATE(#{crcRequestDateFrom},'DD/MM/YYYY') AND TO_DATE(#{crcRequestDateTo},'DD/MM/YYYY')
		</if>
		<if test='custName != null and custName != ""'>
			AND s0029d.NAME = #{custName}
		</if>
		<if test='nricCompanyNo != null and nricCompanyNo != ""'>
			AND s0029d.NRIC = #{nricCompanyNo}
		</if>
		<if test='orgCode != null and orgCode != ""'>
			AND o0005d.LAST_ORG_CODE = #{orgCode}
		</if>
		<if test='grpCode != null and grpCode != ""'>
			AND o0005d.LAST_GRP_CODE = #{grpCode}
		</if>
		<if test='deptCode != null and deptCode != ""'>
			AND o0005d.LAST_DEPT_CODE = #{deptCode}
		</if>
		<if test="statusIdList != null and statusIdList != ''">
		      AND p0333m.STUS_CODE_ID in
		      <foreach item="item" collection="statusIdList" index="index"
		        open="(" separator="," close=")">
		        #{item}
		      </foreach>
		</if>
		<if test="branchIdList != null and branchIdList != ''">
		      AND s0005m.BRNCH_ID in
		      <foreach item="item" collection="branchIdList" index="index"
		        open="(" separator="," close=")">
		        #{item}
		      </foreach>
		</if>
		<if test="regionIdList != null and regionIdList != ''">
		      AND p0333m.REGN_ID in
		      <foreach item="item" collection="regionIdList" index="index"
		        open="(" separator="," close=")">
		        #{item}
		      </foreach>
		</if>
		<if test="cardTypeIdList != null and cardTypeIdList != ''">
		     	AND s0028d.CARD_TYPE_ID in
		      <foreach item="item" collection="cardTypeIdList" index="index"
		        open="(" separator="," close=")">
		        #{item}
		      </foreach>
		</if>
		<if test='memId != null and memId != ""'>
			AND o0001d.MEM_ID = #{memId}
		</if>
		<if test='memCode != null and memCode != ""'>
			AND o0001d.MEM_CODE = #{memCode}
		</if>
		ORDER BY p0333m.CRT_DT DESC
  </select>

	<select id="selectAutoDebitDetailInfo" parameterType="Map" resultType="egovMap">
		SELECT p0333m.PAD_ID, p0333m.PAD_NO, p0333m.SALES_ORD_NO, custtype.CODE_NAME AS CUST_TYPE, s0029d.NAME, s0029d.NRIC, p0333m.CRT_DT,
		s0001d.SALES_DT, s0026m.STK_DESC, s0001d.MTH_RENT_AMT, rentalstatus.CODE_NAME AS RENTAL_STATUS,
		p0333m.FAIL_REASON_CODE, p0333m.REMARKS, p0333m.STUS_CODE_ID, p0333m.IS_THIRD_PARTY_PAYMENT, s0001d.SALES_ORD_ID,
		p0333m.ATCH_FILE_GROUP_ID
		FROM PAY0333M p0333m
		INNER JOIN SAL0029D s0029d
		ON s0029d.CUST_ID = p0333m.CUST_ID
		INNER JOIN SYS0013M custtype
		ON custtype.CODE_ID = s0029d.TYPE_ID
		INNER JOIN SAL0001D s0001d
		ON s0001d.SALES_ORD_NO = p0333m.SALES_ORD_NO
		INNER JOIN SYS0013M rentalstatus
		ON rentalstatus.CODE_ID = s0001d.APP_TYPE_ID
		INNER JOIN SAL0002D s0002d
		ON s0002d.SALES_ORD_ID = s0001d.SALES_ORD_ID
		INNER JOIN SYS0026M s0026m
		ON s0026m.STK_ID = s0002d.ITM_STK_ID
		WHERE 1=1
		AND p0333m.PAD_ID = #{padId}
	</select>

	<select id="selectCustomerCreditCardInfo" parameterType="Map" resultType="egovMap">
		SELECT s0028d.CUST_ORI_CRC_NO, s0013m1.CODE_NAME AS CARD_PROVIDER, s0028d.CUST_CRC_OWNER, s0028d.CUST_CRC_EXPR, s0004m.CODE || '-' || s0004m.NAME AS ISSUE_BANK,s0013m2.CODE_NAME AS CARD_TYPE
		FROM SAL0028D s0028d
		INNER JOIN SYS0013M s0013m1
		ON s0028d.CUST_CRC_TYPE_ID = s0013m1.CODE_ID
		INNER JOIN SYS0013M s0013m2
		ON s0028d.CARD_TYPE_ID = s0013m2.CODE_ID
		INNER JOIN SYS0004M s0004m
		ON s0004m.BANK_ID = s0028d.CUST_CRC_BANK_ID
		WHERE 1=1
		AND s0028d.CUST_CRC_ID = #{custCrcId}
	</select>

	<select id="selectAttachmentInfo" parameterType="Map" resultType="egovMap">
		SELECT s0071d.ATCH_FILE_ID AS CI_ATCH_FILE_ID, s0071d.ATCH_FILE_NAME AS CI_ATCH_FILE_NAME,
		s0071d.FILE_SUB_PATH AS CI_FILE_SUB_PATH, s0071d.PHYSICL_FILE_NAME AS CI_PHYSICL_FILE_NAME,
		s0071d.FILE_EXTSN AS CI_FILE_EXTSN, s0071d.FILE_SIZE AS CI_FILE_SIZE
		FROM PAY0333M p0333m
		LEFT JOIN SYS0070M s0070m
		ON s0070m.ATCH_FILE_GRP_ID =  p0333m.ATCH_FILE_GROUP_ID
		LEFT JOIN SYS0071D s0071d
		ON s0071d.ATCH_FILE_ID = s0070m.ATCH_FILE_ID
		WHERE 1=1
		AND p0333m.PAD_ID = #{padId}
	</select>

	<select id="selectRejectReasonCode" parameterType="Map" resultType="egovMap">
        SELECT RESN_ID CODE, CODE || '-' || RESN_DESC AS CODE_NAME
        FROM SYS0032M
        WHERE 1=1
        AND RESN_TYPE_ID = 6852
        ORDER BY RESN_ID ASC
    </select>

	  <select id="selectNextFileGroupId" resultType="int">
	    SELECT SYS0070M_ATCH_FILE_GRP_ID_SEQ.NEXTVAL
	    FROM DUAL
	  </select>

    <select id="selectNextFileId" resultType="int">
        SELECT SYS0071D_ATCH_FILE_ID_SEQ.NEXTVAL atchFileId FROM DUAL
    </select>

    <select id="selectNextPadId" resultType="int">
        SELECT PAY0333M_PAD_ID_SEQ.NEXTVAL padId FROM DUAL
    </select>

	<insert id="insertFileGroup" parameterType="Map">
	  INSERT INTO SYS0070M (ATCH_FILE_GRP_ID
	                                   , ATCH_FILE_ID
	                                   , CHENAL_TYPE
	                                   , CRT_USER_ID
	                                   , CRT_DT
	                                   , UPD_USER_ID
	                                   , UPD_DT
	  ) VALUES ( #{atchFileGrpId}
	                , #{atchFileId}
	                , #{chenalType}
	                , #{crtUserId}
	                , SYSDATE
	                , #{updUserId}
	                , SYSDATE
	  )
	</insert>

	<insert id="insertFileDetail" parameterType="Map">
		INSERT INTO SYS0071D (
		ATCH_FILE_ID
		, ATCH_FILE_NAME
		, FILE_SUB_PATH
		, PHYSICL_FILE_NAME
		, FILE_EXTSN
		, FILE_SIZE
		, FILE_PASSWORD
		, FILE_UNQ_KEY
		, FILE_KEY_SEQ
		)VALUES (
		#{atchFileId}
		,#{atchFileName}
		,#{fileSubPath}
		,#{physiclFileName}
		,#{fileExtsn}
		,#{fileSize}
		,#{filePassword}
		,#{fileUnqKey}
		,#{fileKeySeq}
		)
	</insert>

	<update id="updateAction" parameterType="Map">
	      UPDATE PAY0333M
	      SET STUS_CODE_ID = #{statusCodeId},
	      REMARKS = #{remarks},
	      FAIL_REASON_CODE = #{rejectReasonCode},
	      UPT_BY = #{userId},
	      UPT_DT = SYSDATE
	      WHERE PAD_ID = #{padId}
    </update>

    <select id="selectCreatorInfo" parameterType="String" resultType="egovMap">
       	SELECT s0047m.USER_ID, s0005m.NAME AS USER_BRANCH
       	FROM SYS0047M s0047m
       	LEFT JOIN ORG0001D o0001d
       	ON o0001d.MEM_ID = s0047m.USER_ID
       	LEFT JOIN SYS0005M s0005m
       	ON s0005m.BRNCH_ID = o0001d.BRNCH
       	WHERE USER_NAME = #{memCode}
    </select>

    <insert id="3w" parameterType="Map">
		INSERT INTO PAY0333M (PAD_ID,PAD_NO,CRT_DT,STUS_CODE_ID,SALES_ORD_NO,CUST_ID,
		CRT_BY,USER_BRANCH,IS_THIRD_PARTY_PAYMENT,CUST_CRC_ID,SIGN_IMG,
		ATCH_FILE_GROUP_ID)
		VALUES
		(#{padId}, #{padNo}, SYSDATE, 1, #{salesOrdNo}, #{custId},#{creatorId},#{userBranch},
		#{isThirdPartyPaymentCheck},#{newCustCreditCardId},UTL_RAW.CAST_TO_RAW(#{signImg}),
		#{atchFileGrpId})
	</insert>

	<select id="getSmsTemplate" parameterType="Map" resultType="String">
		SELECT REPLACE(REPLACE(REPLACE(REPLACE(REPLACE((SELECT MESSAGE FROM SYS0052M WHERE ID = 'pay.msg.smsAutoDebit'),'{1}', #{salesOrdNo}), '{2}', #{monthlyRentalAmount}), '{3}', #{link}), '{4}', #{bankIssuer}),{5}, #{cardEnding})
		FROM DUAL
	</select>

	<select id="selectCustCardBankInformation" parameterType="Map" resultType="egovMap">
       	SELECT s0028d.CUST_ORI_CRC_NO, s0004m.CODE AS BANK_ISSUER
       	FROM SAL0028D s0028d
       	INNER JOIN SYS0004M s0004m
       	ON s0004m.BANK_ID = s0028d.CUST_CRC_BANK_ID
       	WHERE s0028d.CUST_CRC_ID = #{newCustCreditCardId}
    </select>

	<select id="getEmailTitle" parameterType="Map" resultType="String">
		SELECT REPLACE((SELECT MSG_EMAIL_TITLE FROM SYS0043D WHERE MSG_ID = 11 AND MSG_TYPE_ID = 2001),'{1}', #{salesOrdNo})
		FROM DUAL
	</select>

		<select id="getEmailDescription" parameterType="Map" resultType="egovMap">
	</select>
</mapper>