<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.common.service.impl.CommonPaymentMapper">

    <select id="selectOrderInfoRental" parameterType="Map" resultType="egovMap">
        SELECT 
            Extent1.SALES_ORD_ID,
            Extent1.CUST_BILL_ID,
            Extent1.SALES_ORD_NO,
            Extent1.CUST_ID,
            Extent4.NAME CUST_NM,
            Extent1.APP_TYPE_ID,
            Extent2.CODE_NAME APP_TYPE_NM,
            Extent1.PV_YEAR,
            Extent1.PV_MONTH,
            Extent1.STUS_CODE_ID STUS_CODE_ID,
            Extent3.STUS_CODE_ID STUS_CODE_NM,
            Extent1.MTH_RENT_AMT,
            Extent1.TOT_AMT,
            0 AS BALANCE,
            '' AS LAST_PAYMENT,       
            Extent1.MEM_ID MEM_ID,
            NVL(Extent5.RPF_CNT,0) AS RPF_CNT,
            NVL(Extent5.RPF_CHARGE,0) AS RPF_CHARGE
        FROM 
            SAL0001D Extent1
            JOIN SYS0013M Extent2 ON Extent2.CODE_ID = Extent1.APP_TYPE_ID
            JOIN SAL0071D Extent3 ON Extent3.SALES_ORD_ID = Extent1.SALES_ORD_ID       
            JOIN SAL0029D Extent4 ON Extent4.CUST_ID = Extent1.CUST_ID
            LEFT JOIN (
                            SELECT 
                                RENT_SO_ID,
                                COUNT(1) AS RPF_CNT,
                                NVL(SUM(RENT_AMT),0) AS RPF_CHARGE
                            FROM 
                                PAY0022D 
                            WHERE  
                                RENT_DOC_TYPE_ID = 161 AND RENT_AMT  <![CDATA[ >= ]]>0
                            GROUP BY RENT_SO_ID ) Extent5 ON Extent5.RENT_SO_ID = Extent1.SALES_ORD_ID   
        WHERE
            Extent1.APP_TYPE_ID = 66
            AND Extent1.SALES_ORD_ID = #{orderId}
	</select>
	
	<select id="selectRPFCN" parameterType="Map" resultType="egovMap">
        SELECT
            NVL(SUM(RENT_AMT),0) AS CN_AMT     
        FROM 
            ( 
            SELECT 
                DISTINCT
                UnionAll1.RENT_RUN_ID,
                UnionAll1.RENT_AMT  
            FROM 
                ( 
                SELECT 
                    Extent1.RENT_RUN_ID RENT_RUN_ID  ,
                    Extent1.RENT_AMT RENT_AMT  
                FROM 
                    PAY0022D Extent1
                    JOIN PAY0002D Extent2   ON (Extent2.ADJ_ENTRY_NOTE_NO = Extent1.RENT_DOC_NO  OR (Extent2.ADJ_ENTRY_SO_ID = #{orderId}  AND  Extent1.RENT_DOC_NO LIKE 'INS%'  ) )
                                    AND 171 = Extent2.ADJ_ENTRY_DR_ACC_ID 
                                    AND 43 = Extent2.ADJ_ENTRY_CR_ACC_ID 
                                    AND 155 = Extent2.ADJ_ENTRY_NOTE_TYPE_ID 
                WHERE  
                    Extent1.RENT_SO_ID = #{orderId}
                    AND 155 = Extent1.RENT_DOC_TYPE_ID
                    AND Extent1.RENT_AMT <![CDATA[ < ]]> 0
                UNION ALL
                SELECT 
                    Extent3.RENT_RUN_ID RENT_RUN_ID  ,
                    Extent4.MEMO_ADJ_TOT_AMT * -1.00 C2
                FROM 
                    PAY0022D Extent3
                    JOIN PAY0011D Extent4   ON Extent4.MEMO_ADJ_INVC_NO = Extent3.RENT_DOC_NO
                                                    AND 1293 = Extent4.MEMO_ADJ_TYPE_ID
                                                    AND 4 = Extent4.MEMO_ADJ_STUS_ID 
                WHERE  
                    Extent3.RENT_SO_ID = #{orderId}
                    AND 161 = Extent3.RENT_DOC_TYPE_ID
                    AND Extent3.RENT_AMT <![CDATA[ > ]]> 0 
                ) UnionAll1 
            ) Distinct1
    </select>
    
    <select id="selectRPFDN" parameterType="Map"  resultType="egovMap">
        SELECT 
            NVL(SUM(Extent2.MEMO_ADJ_TOT_AMT),0) AS DN_AMT  
        FROM 
            PAY0022D Extent1
            JOIN PAY0011D Extent2  ON Extent2.MEMO_ADJ_INVC_NO = Extent1.RENT_DOC_NO
                                                AND 1294 = Extent2.MEMO_ADJ_TYPE_ID 
                                                AND 4 = Extent2.MEMO_ADJ_STUS_ID
        WHERE  
            Extent1.RENT_SO_ID = #{orderId}
            AND 161 = Extent1.RENT_DOC_TYPE_ID
            AND Extent1.RENT_AMT <![CDATA[>]]>  0
    </select>
    
    <select id="selectRpfCnAmount" parameterType="Map"  resultType="egovMap">
        SELECT
            NVL(SUM(Extent2.ADJ_ENTRY_AMT),0) AS CN_AMT
        FROM 
            PAY0022D Extent1
            JOIN PAY0002D Extent2   ON ( Extent2.ADJ_ENTRY_NOTE_NO = Extent1.RENT_DOC_NO OR ( Extent2.ADJ_ENTRY_SO_ID = #{orderId} AND  Extent1.RENT_DOC_NO LIKE 'INS%'  ))
                                                AND Extent2.ADJ_ENTRY_DR_ACC_ID = 171
                                                AND Extent2.ADJ_ENTRY_CR_ACC_ID = 43
                                                AND Extent2.ADJ_ENTRY_NOTE_TYPE_ID = 155
        WHERE  
            Extent1.RENT_SO_ID = #{orderId}
            AND 155 = Extent1.RENT_DOC_TYPE_ID
            AND Extent1.RENT_AMT <![CDATA[ < ]]> 0
    </select>
    
    <select id="selectRpfCnNewAmount" parameterType="Map"  resultType="egovMap">
        SELECT 
            NVL(SUM(Extent5.MEMO_ITM_AMT),0) AS CN_NEW_AMT
        FROM 
            PAY0022D Extent1
            CROSS JOIN SAL0001D Extent2
            JOIN PAY0030D Extent3   ON Extent3.INVC_ITM_ORD_NO = Extent2.SALES_ORD_NO
            JOIN PAY0011D Extent4   ON Extent4.MEMO_ADJ_INVC_NO = Extent1.RENT_DOC_NO
                                                    AND Extent4.MEMO_ADJ_TYPE_ID = 1293
                                                    AND Extent4.MEMO_ADJ_STUS_ID = 4
            JOIN PAY0012D Extent5   ON Extent5.MEMO_ADJ_ID = Extent4.MEMO_ADJ_ID 
                                                    AND Extent5.MEMO_ITM_INVC_ITM_ID = Extent3.INVC_ITM_ID 
        WHERE  
            Extent1.RENT_SO_ID = #{orderId} 
            AND Extent1.RENT_DOC_TYPE_ID = 161
            AND Extent1.RENT_AMT <![CDATA[ > ]]> 0 
            AND Extent2.SALES_ORD_ID = #{orderId}
    </select>          
    
    <select id="selectPayTotalAmount" parameterType="Map"  resultType="egovMap">
        SELECT NVL(SUM(RENT_AMT),0) AS PAY_TOTAL FROM PAY0022D WHERE RENT_SO_ID = #{orderId}  AND RENT_AMT <![CDATA[ < ]]> 0
    </select>  
    
    <select id="selectRpfTotBillAmount" parameterType="Map"  resultType="egovMap">
        SELECT NVL(SUM(RENT_AMT),0) AS RPF_TOT_BILL FROM PAY0022D WHERE RENT_SO_ID = #{orderId} AND RENT_DOC_TYPE_ID = 161 AND RENT_AMT <![CDATA[ >= ]]> 0 
    </select>  
    <select id="selectReversedAmount" parameterType="Map"  resultType="egovMap">
        SELECT 
            NVL(SUM(B.REV_AMT),0) AS REV_AMT 
        FROM 
            PAY0022D A 
            JOIN PAY1004V B ON A.RENT_SO_ID = B.SALES_ORD_ID 
                                    AND A.RENT_DOC_NO = B.REV_WOR
            WHERE A.RENT_SO_ID = #{orderId}
            AND A.RENT_DOC_TYPE_ID = 161
            AND A.RENT_AMT <![CDATA[ < ]]> 0
    </select>  
    
    <select id="selectRevPaymentAmount" parameterType="Map"  resultType="egovMap">
        SELECT NVL(SUM(RENT_AMT),0) AS REV_PAYMENT_AMT FROM PAY0022D WHERE RENT_SO_ID = #{orderId} AND RENT_DOC_TYPE_ID = 160
    </select>
    
    <select id="selectBills" parameterType="Map"  resultType="egovMap">
        SELECT 
            RENT_RUN_ID,
            RENT_ID,
            RENT_SO_ID,
            RENT_DOC_NO,
            RENT_DOC_TYPE_ID,
            RENT_DT_TM,
            RENT_AMT,
            RENT_BATCH_NO,
            RENT_INST_NO,
            RENT_UPD_USER_ID,
            RENT_UPD_DT,
            RENT_IS_SYNC,
            RENT_BILL_RUNNG_TOT
         FROM 
            PAY0022D 
        WHERE 
            RENT_SO_ID = #{orderId} 
            AND RENT_DOC_TYPE_ID != 160 
            AND RENT_AMT <![CDATA[ > ]]> 0
    </select>
    
    <select id="selectOrderInfoForBills" parameterType="Map"  resultType="egovMap">
        SELECT STUS_CODE_ID,TOT_AMT,MTH_RENT_AMT FROM SAL0001D WHERE SALES_ORD_ID = #{orderId} 
    </select>
   
   <select id="selectRpfPaidAmount" parameterType="Map"  resultType="egovMap">
        SELECT NVL(SUM(RENT_AMT),0) AS RPF_PAID FROM PAY0022D WHERE RENT_SO_ID = #{orderId} AND RENT_AMT <![CDATA[ < ]]> 0 AND RENT_DOC_TYPE_ID = 161
   </select>
   
   <select id="selectLastPaymentDt" parameterType="Map"  resultType="egovMap">
        SELECT TO_CHAR(MAX(RENT_DT_TM),'YYYY-MM-DD') AS RENT_DT_TM FROM PAY0022D WHERE RENT_SO_ID = #{orderId} AND RENT_AMT <![CDATA[ < ]]> 0
   </select>
   
   <select id="selectRentInstNo" parameterType="Map"  resultType="egovMap">
        SELECT 
            RENT_INST_NO 
        FROM 
            SAL0070D 
        WHERE 
            SALES_ORD_ID = #{orderId}
            AND EXTRACT(MONTH FROM RENT_INST_DT) = EXTRACT(MONTH FROM SYSDATE)
            AND EXTRACT(YEAR FROM RENT_INST_DT) = EXTRACT(YEAR FROM SYSDATE)
    </select>         
    
     <select id="selectLastBilledInstNo" parameterType="Map"  resultType="egovMap">
        SELECT 
            NVL(MAX(RENT_INST_NO),0) AS LAST_RENT_INST_NO,
            NVL(SUM(RENT_AMT),0) AS TOT_BILL_AMT             
        FROM 
            PAY0022D 
        WHERE 
            RENT_SO_ID = #{orderId} 
            AND RENT_AMT <![CDATA[ > ]]> 0 
            AND RENT_DOC_TYPE_ID != 160
    </select>      
    
    <select id="selectBillInfoRental" parameterType="Map" resultType="egovMap">
        SELECT
            BILL_ID  ,
            0 AS TASK_ID  ,
            ORD_ID  ,
            ORD_NO  ,
            BILL_AMT  ,
            BILL_DT,
            BILL_NO  ,
            BILL_GRP_ID  ,
            CUST_NM  ,
            INSTALLMENT,
            BILL_TYPE_ID,
            BILL_TYPE_NM  ,
            0 AS REV_AMT,
            0 AS BTN_CHECK
        FROM
            (
            SELECT
                Extent1.RENT_ID BILL_ID  ,                
                Extent1.RENT_SO_ID ORD_ID  ,
                Extent3.SALES_ORD_NO ORD_NO  ,
                Extent1.RENT_AMT BILL_AMT  ,
                Extent1.RENT_DT_TM AS BILL_DT,
                Extent1.RENT_DOC_NO BILL_NO  ,       
                CASE WHEN ( Extent3.CUST_BILL_ID IS NULL ) THEN 0 ELSE Extent3.CUST_BILL_ID END BILL_GRP_ID  ,
                Extent4.NAME CUST_NM  ,
                Extent1.RENT_INST_NO AS INSTALLMENT,              
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID,
                Extent2.CODE_NAME BILL_TYPE_NM  
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            )
        WHERE 
            BILL_AMT <![CDATA[ > ]]> 0
            AND BILL_TYPE_ID <![CDATA[ <> ]]> 160
            <if test='excludeRPF != null and excludeRPF == "ADD" '>
            AND BILL_TYPE_ID <![CDATA[ <> ]]> 161
            </if>
    </select>
    <select id="selectBillRpfPaid" parameterType="Map" resultType="egovMap">
        SELECT
            NVL(SUM(BILL_AMT),0) * -1 AS RPF_PAID
        FROM
            (
            SELECT
                Extent1.RENT_AMT BILL_AMT  ,           
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID                        
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            )
        WHERE 
            BILL_AMT <![CDATA[ < ]]> 0
            AND BILL_TYPE_ID = 161
    </select>
    
    <select id="selectBillRpfRev" parameterType="Map" resultType="egovMap">    
        SELECT 
            NVL(SUM(Filter1.RPF_REV),0)  RPF_REV  
        FROM 
            ( 
            SELECT 
                Extent2.PAY_ITM_AMT * -1 AS RPF_REV
            FROM 
                PAY0064D Extent1
                JOIN PAY0065D Extent2   ON Extent2.PAY_ID = Extent1.PAY_ID
                JOIN PAY0065D Extent3   ON Extent3.PAY_ITM_ID = Extent2.PAY_ITM_REF_ITM_ID
                JOIN PAY0064D Extent4   ON Extent4.PAY_ID = Extent3.PAY_ID AND Extent4.TYPE_ID = 98
            WHERE  
                Extent1.TYPE_ID = 101
                AND Extent1.SALES_ORD_ID = #{orderId}  
            ) Filter1
    </select>
    
    <select id="selectBillAdjAmount" parameterType="Map" resultType="egovMap">
        SELECT  
            NVL(SUM(MEMO_ADJ_TOT_AMT),0) AS MEMO_ADJ_TOT_AMT  
        FROM
            (
            SELECT
                Extent1.RENT_ID BILL_ID  ,                
                Extent1.RENT_SO_ID ORD_ID  ,
                Extent3.SALES_ORD_NO ORD_NO  ,
                Extent1.RENT_AMT BILL_AMT  ,
                Extent1.RENT_DT_TM AS BILL_DT,
                Extent1.RENT_DOC_NO BILL_NO  ,       
                CASE WHEN ( Extent3.CUST_BILL_ID IS NULL ) THEN 0 ELSE Extent3.CUST_BILL_ID END BILL_GRP_ID  ,
                Extent4.NAME CUST_NM  ,
                Extent1.RENT_INST_NO AS INSTALLMENT,              
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID,
                Extent2.CODE_NAME BILL_TYPE_NM  
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            ) LED
            JOIN PAY0011D ADJ2 ON LED.BILL_NO = ADJ2.MEMO_ADJ_INVC_NO AND ADJ2.MEMO_ADJ_STUS_ID = 4  
            AND MEMO_ADJ_REF_NO LIKE #{adjType}  || '%'
        WHERE
            LED.BILL_AMT <![CDATA[ > ]]> 0
            AND LED.BILL_TYPE_ID = 161       
    </select>            
    
    <select id="selectBillRentalPaidAmount" parameterType="Map" resultType="egovMap">
        SELECT
            NVL(SUM(BILL_AMT),0) * -1 AS RENT_PAID
        FROM
            (
            SELECT
                Extent1.RENT_ID BILL_ID  ,                
                Extent1.RENT_SO_ID ORD_ID  ,
                Extent3.SALES_ORD_NO ORD_NO  ,
                Extent1.RENT_AMT BILL_AMT  ,
                Extent1.RENT_DT_TM AS BILL_DT,
                Extent1.RENT_DOC_NO BILL_NO  ,       
                CASE WHEN ( Extent3.CUST_BILL_ID IS NULL ) THEN 0 ELSE Extent3.CUST_BILL_ID END BILL_GRP_ID  ,
                Extent4.NAME CUST_NM  ,
                Extent1.RENT_INST_NO AS INSTALLMENT,              
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID,
                Extent2.CODE_NAME BILL_TYPE_NM  
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            ) LED
        WHERE
            BILL_AMT <![CDATA[ < ]]> 0
            AND BILL_TYPE_ID NOT IN (1059,162,161)
    </select>
    
    <select id="selectBillRentalRevAmount" parameterType="Map" resultType="egovMap">    
        SELECT 
            NVL(SUM(Filter1.RENTAL_REV),0)  RENTAL_REV  
        FROM 
            ( 
            SELECT 
                Extent2.PAY_ITM_AMT * -1 AS RENTAL_REV
            FROM 
                PAY0064D Extent1
                JOIN PAY0065D Extent2   ON Extent2.PAY_ID = Extent1.PAY_ID
                JOIN PAY0065D Extent3   ON Extent3.PAY_ITM_ID = Extent2.PAY_ITM_REF_ITM_ID
                JOIN PAY0064D Extent4   ON Extent4.PAY_ID = Extent3.PAY_ID AND 99 <![CDATA[ <> ]]> Extent4.TYPE_ID AND 1059 <![CDATA[ <> ]]> Extent4.TYPE_ID AND 98 <![CDATA[ <> ]]> Extent4.TYPE_ID
            WHERE  
                Extent1.TYPE_ID = 101
                AND Extent1.SALES_ORD_ID = #{orderId}  
            ) Filter1
    </select>       
    
    <select id="selectBillPenaltyPaidAmount" parameterType="Map" resultType="egovMap">
        SELECT
            NVL(SUM(BILL_AMT),0) * -1 AS PENALTY_PAID
        FROM
            (
            SELECT
                Extent1.RENT_ID BILL_ID  ,                
                Extent1.RENT_SO_ID ORD_ID  ,
                Extent3.SALES_ORD_NO ORD_NO  ,
                Extent1.RENT_AMT BILL_AMT  ,
                Extent1.RENT_DT_TM AS BILL_DT,
                Extent1.RENT_DOC_NO BILL_NO  ,       
                CASE WHEN ( Extent3.CUST_BILL_ID IS NULL ) THEN 0 ELSE Extent3.CUST_BILL_ID END BILL_GRP_ID  ,
                Extent4.NAME CUST_NM  ,
                Extent1.RENT_INST_NO AS INSTALLMENT,              
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID,
                Extent2.CODE_NAME BILL_TYPE_NM  
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            ) LED
        WHERE
            BILL_AMT <![CDATA[ < ]]> 0
            AND BILL_TYPE_ID = 162
    </select>
    
    <select id="selectBillPenaltyRevAmount" parameterType="Map" resultType="egovMap">    
        SELECT 
            NVL(SUM(Filter1.PENALTY_REV),0)  PENALTY_REV  
        FROM 
            ( 
            SELECT 
                Extent2.PAY_ITM_AMT * -1 AS PENALTY_REV
            FROM 
                PAY0064D Extent1
                JOIN PAY0065D Extent2   ON Extent2.PAY_ID = Extent1.PAY_ID
                JOIN PAY0065D Extent3   ON Extent3.PAY_ITM_ID = Extent2.PAY_ITM_REF_ITM_ID
                JOIN PAY0064D Extent4   ON Extent4.PAY_ID = Extent3.PAY_ID AND 99 = Extent4.TYPE_ID
            WHERE  
                Extent1.TYPE_ID = 101
                AND Extent1.SALES_ORD_ID = #{orderId}  
            ) Filter1
    </select>    
    
    <select id="selectBillRhfPaidAmount" parameterType="Map" resultType="egovMap">
        SELECT
            NVL(SUM(BILL_AMT),0) * -1 AS RHF_PAID
        FROM
            (
            SELECT
                Extent1.RENT_ID BILL_ID  ,                
                Extent1.RENT_SO_ID ORD_ID  ,
                Extent3.SALES_ORD_NO ORD_NO  ,
                Extent1.RENT_AMT BILL_AMT  ,
                Extent1.RENT_DT_TM AS BILL_DT,
                Extent1.RENT_DOC_NO BILL_NO  ,       
                CASE WHEN ( Extent3.CUST_BILL_ID IS NULL ) THEN 0 ELSE Extent3.CUST_BILL_ID END BILL_GRP_ID  ,
                Extent4.NAME CUST_NM  ,
                Extent1.RENT_INST_NO AS INSTALLMENT,              
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID,
                Extent2.CODE_NAME BILL_TYPE_NM 
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            ) LED
        WHERE
            BILL_AMT <![CDATA[ < ]]> 0
            AND BILL_TYPE_ID = 1059
    </select>
    
    <select id="selectBillRfhRevAmount" parameterType="Map" resultType="egovMap">    
        SELECT 
            NVL(SUM(Filter1.RHF_REV),0)  RHF_REV  
        FROM 
            ( 
            SELECT 
                Extent2.PAY_ITM_AMT * -1 AS RHF_REV
            FROM 
                PAY0064D Extent1
                JOIN PAY0065D Extent2   ON Extent2.PAY_ID = Extent1.PAY_ID
                JOIN PAY0065D Extent3   ON Extent3.PAY_ITM_ID = Extent2.PAY_ITM_REF_ITM_ID
                JOIN PAY0064D Extent4   ON Extent4.PAY_ID = Extent3.PAY_ID AND 1059 = Extent4.TYPE_ID
            WHERE  
                Extent1.TYPE_ID = 101
                AND Extent1.SALES_ORD_ID = #{orderId}  
            ) Filter1
    </select>  
    
    <select id="selectBillRhfCNAmount" parameterType="Map" resultType="egovMap">
        SELECT  
            NVL(SUM(MEMO_ADJ_TOT_AMT),0) AS MEMO_ADJ_TOT_AMT  
        FROM
            (
            SELECT
                Extent1.RENT_ID BILL_ID  ,                
                Extent1.RENT_SO_ID ORD_ID  ,
                Extent3.SALES_ORD_NO ORD_NO  ,
                Extent1.RENT_AMT BILL_AMT  ,
                Extent1.RENT_DT_TM AS BILL_DT,
                Extent1.RENT_DOC_NO BILL_NO  ,       
                CASE WHEN ( Extent3.CUST_BILL_ID IS NULL ) THEN 0 ELSE Extent3.CUST_BILL_ID END BILL_GRP_ID  ,
                Extent4.NAME CUST_NM  ,
                Extent1.RENT_INST_NO AS INSTALLMENT,              
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID,
                Extent2.CODE_NAME BILL_TYPE_NM  
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            ) LED
            JOIN PAY0011D ADJ2 ON LED.BILL_NO = ADJ2.MEMO_ADJ_INVC_NO AND ADJ2.MEMO_ADJ_STUS_ID = 4 AND ADJ2.MEMO_ADJ_TYPE_ID  = 1293              
        WHERE
            LED.BILL_AMT <![CDATA[ > ]]> 0
            AND LED.BILL_TYPE_ID = 1059       
    </select>  
    
    <select id="selectBillRhfCNOldAmount" parameterType="Map" resultType="egovMap">
        SELECT  
            NVL(SUM(BILL_AMT),0) AS ADJ_OLD_CN_AMT  
        FROM
            (
            SELECT
                Extent1.RENT_ID BILL_ID  ,                
                Extent1.RENT_SO_ID ORD_ID  ,
                Extent3.SALES_ORD_NO ORD_NO  ,
                Extent1.RENT_AMT BILL_AMT  ,
                Extent1.RENT_DT_TM AS BILL_DT,
                Extent1.RENT_DOC_NO BILL_NO  ,       
                CASE WHEN ( Extent3.CUST_BILL_ID IS NULL ) THEN 0 ELSE Extent3.CUST_BILL_ID END BILL_GRP_ID  ,
                Extent4.NAME CUST_NM  ,
                Extent1.RENT_INST_NO AS INSTALLMENT,              
                (CASE 
                    WHEN Extent1.RENT_DOC_TYPE_ID = 155 THEN
                        (CASE 
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'CNR' THEN
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,2) = 'CN' THEN              
                                (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ADJS.MEMO_ITM_DEBT_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                            WHEN Extent1.RENT_DOC_TYPE_ID = 155 AND SUBSTR(Extent1.RENT_DOC_NO,0,3) = 'ACN' THEN
                                159    
                            ELSE             
                                (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 171 THEN 161 ELSE (CASE WHEN ENT.ADJ_ENTRY_DR_ACC_ID = 170 THEN 159 ELSE 0 END) END)
                        END )       
                    ELSE Extent1.RENT_DOC_TYPE_ID END ) AS BILL_TYPE_ID,
                Extent2.CODE_NAME BILL_TYPE_NM  
            FROM 
                PAY0022D Extent1
                JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.RENT_DOC_TYPE_ID
                JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.RENT_SO_ID
                JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
                LEFT JOIN PAY0002D ENT ON Extent1.RENT_DOC_NO = ENT.ADJ_ENTRY_NOTE_NO
                LEFT JOIN PAY0011D ADJ ON Extent1.RENT_DOC_NO = ADJ.MEMO_ADJ_REF_NO
                LEFT JOIN PAY0012D ADJS ON ADJ.MEMO_ADJ_ID = ADJS.MEMO_ADJ_ID
            WHERE 
                Extent1.RENT_SO_ID = #{orderId} 
            ) LED
            JOIN PAY0002D ADJ2 ON LED.BILL_NO = ADJ2.ADJ_ENTRY_NOTE_NO
                                               AND ADJ2.ADJ_ENTRY_DR_ACC_ID  = 203 
                                               AND ADJ2.ADJ_ENTRY_NOTE_TYPE_ID  = 155
        WHERE
            LED.BILL_AMT <![CDATA[ < ]]> 0
            AND LED.BILL_TYPE_ID = 155       
    </select>   
    
    <select id="selectOrderInfoNonRental" parameterType="Map" resultType="egovMap">
        SELECT 
            Extent1.SALES_ORD_ID,
            Extent1.CUST_BILL_ID,
            Extent1.SALES_ORD_NO,
            Extent1.CUST_ID,
            Extent7.NAME CUST_NM  ,
            Extent1.APP_TYPE_ID,
            Extent2.CODE_NAME APP_TYPE_NM  ,
            Extent1.PV_YEAR,
            Extent1.PV_MONTH,
            Extent1.STUS_CODE_ID STUS_CODE_ID  ,
            Extent4.NAME STUS_CODE_NM  ,
            Extent1.MTH_RENT_AMT ,
            Extent1.TOT_AMT,
            0 AS BALANCE,
            '' AS LAST_PAYMENT,      
            Extent1.MEM_ID MEM_ID  ,
            Extent3.NAME MEM_NM  ,
            Extent5.NAME BRNCH_NM  ,
            Extent6.USER_ID USER_ID  ,
            '' CREATOR_CODE,
            Extent6.USER_NAME USER_NAME  
        FROM 
            SAL0001D Extent1
            JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.APP_TYPE_ID
            JOIN ORG0001D Extent3   ON Extent3.MEM_ID = Extent1.MEM_ID
            JOIN SYS0038M Extent4   ON Extent4.STUS_CODE_ID = Extent1.STUS_CODE_ID
            LEFT JOIN SYS0005M Extent5   ON Extent5.BRNCH_ID = UTILS.CONVERT_TO_NUMBER(Extent3.BRNCH,10,0)
            LEFT JOIN SYS0047M Extent6   ON Extent6.USER_ID = Extent1.CRT_USER_ID
            JOIN SAL0029D Extent7   ON Extent7.CUST_ID = Extent1.CUST_ID
        WHERE  
            Extent1.APP_TYPE_ID IN ( 67,68,1412 )
            AND  Extent1.SALES_ORD_ID = #{orderId} 
    </select>            
    
    <select id="selectBillInfoLedgerCnt" parameterType="Map" resultType="egovMap">
        SELECT COUNT(1) AS CNT FROM PAY0035D WHERE TRADE_SO_ID = #{orderId} 
    </select>
    
    <select id="selectLedgerInfo" parameterType="Map" resultType="egovMap">
        SELECT 
            MAX(CASE WHEN TRADE_AMT <![CDATA[ < ]]> 0 THEN TO_CHAR(TRADE_DT_TM,'YYYY-MM-DD') ELSE '1900-01-01' END) AS LAST_PAY_DT,
            MAX(TRADE_INST_NO) AS TRADE_INST_NO,
            MAX(CASE WHEN TRADE_AMT <![CDATA[ > ]]> 0 THEN TO_CHAR(TRADE_DT_TM,'YYYY-MM-DD') ELSE '1900-01-01' END) AS LAST_BILL_DT,
            SUM(CASE WHEN TRADE_AMT <![CDATA[ < ]]> 0 AND TRADE_DOC_TYPE_ID <![CDATA[ <> ]]> 155  THEN TRADE_AMT * -1 ELSE 0 END) AS PAID_TOTAL,
            SUM(CASE WHEN TRADE_AMT <![CDATA[ > ]]> 0 AND TRADE_DOC_TYPE_ID <![CDATA[ <> ]]> 160  THEN TRADE_AMT ELSE 0 END) AS BILL_TOTAL,
            SUM(CASE WHEN TRADE_AMT <![CDATA[ < ]]> 0 AND TRADE_DOC_TYPE_ID = 155  THEN TRADE_AMT ELSE 0 END) AS CN_TOTAL,
            SUM(CASE WHEN TRADE_AMT <![CDATA[ > ]]> 0 AND TRADE_DOC_TYPE_ID = 160  THEN TRADE_AMT ELSE 0 END) AS REV_TOTAL        
        FROM 
            PAY0035D 
        WHERE 
            TRADE_SO_ID = #{orderId}
    </select>        
    
    <resultMap id="resultMembershipMap" type="egovMap" />
    <select id="selectOrderInfoSVM" statementType="CALLABLE" parameterType="Map">
        {
            call SP_GET_OTSTND_MBRSH_BY_ORD_ID(#{orderId} , #{resultMemSvm, mode=OUT, jdbcType=CURSOR, javaType=ResultSet, resultMap=resultMembershipMap})            
        }
    </select>
    
    
</mapper>