<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.cardpayment.service.impl.CrcReconCRCStateMapper">
    
    <select id="selectCrcStatementMappingList" parameterType="Map" resultType="egovMap">
        SELECT 
			GROUP_SEQ, 
			PAY_ITM_CC_NO, 
			PAY_ITM_REF_DT, 
			PAY_ITM_APPV_NO, 
			PAY_ITM_CARD_MODE_ID, 
			CARD_MODE_NAME,
			AMOUNT, 
			CRC_TRNSC_ID, 
			CRC_TRNSC_DT, 
			CRC_TRNSC_NO, 
			CRC_TRNSC_APPV, 
			CRDIT_CARD, 
			CRC_STATE_ACC_ID, 
			GROS_AMT,
			CRC_MC_NAME
			FROM 
			    (
			    SELECT
			        A.GROUP_SEQ,
			        B.PAY_ITM_CC_NO,
			        B.PAY_ITM_REF_DT,
			        B.PAY_ITM_APPV_NO,
			        B.PAY_ITM_CARD_MODE_ID,
			        C.CODE_NAME CARD_MODE_NAME,
			        NVL(SUM(A.PAY_ITM_AMT),0) + NVL(MAX(A.BANK_CHG_AMT),0) AS AMOUNT,
			        E.ACC_DESC CRC_MC_NAME
			    FROM 
			        PAY0252T A
			        JOIN PAY0065D B ON A.PAY_ITM_ID = B.PAY_ITM_ID
			        JOIN SYS0013M C ON B.PAY_ITM_CARD_MODE_ID = C.CODE_ID AND C.DISAB = 0 AND C.CODE_MASTER_ID = '130'
			        JOIN PAY0240T D ON A.GROUP_SEQ = D.SEQ
                    JOIN SYS0001M E ON D.BANK_ACC_ID = E.ACC_ID AND E.ACC_STUS_ID = 1 AND E.IS_PAY_CRC = 1
			    WHERE 
			        A.PAY_ITM_MODE_ID = 107
			        AND A.CRC_STATE_MAPPING_STUS_ID = 1
			        <if test="transDateFr != null and transDateTo != null and transDateFr != '' and transDateTo != ''" > 
			        AND B.PAY_ITM_REF_DT BETWEEN TO_DATE(#{transDateFr},'DD/MM/YYYY') AND TO_DATE(#{transDateTo},'DD/MM/YYYY')
			        </if>
			        <if test="bankAcc != null and bankAcc != ''">
			        AND B.PAY_ITM_BANK_ACC_ID = #{bankAcc}
			        </if>
			    GROUP BY 
			        A.GROUP_SEQ,
			        B.PAY_ITM_CC_NO,
			        B.PAY_ITM_REF_DT,
			        B.PAY_ITM_APPV_NO,
			        B.PAY_ITM_CARD_MODE_ID,
			        C.CODE_NAME,
			        E.ACC_DESC ) TB1
			    JOIN 
			    (
			    SELECT  
			        B.CRC_TRNSC_ID,
			        B.CRC_TRNSC_DT,
			        B.CRC_TRNSC_NO,
			        B.CRC_TRNSC_APPV,
			        B.CRDIT_CARD,
			        A.CRC_STATE_ACC_ID,
			        NVL(SUM(B.CRC_GROS_AMT),0) AS GROS_AMT
			    FROM 
			        PAY0075D A 
			        JOIN PAY0076D B ON A.CRC_STATE_ID = B.CRC_STATE_ID 
			    WHERE
			        B.KEYIN_STUS_ID = 1
			        <if test="transDateFr != null and transDateTo != null and transDateFr != '' and transDateTo != ''" > 
			        AND B.CRC_TRNSC_DT BETWEEN TO_DATE(#{transDateFr},'DD/MM/YYYY') AND TO_DATE(#{transDateTo},'DD/MM/YYYY')
			        </if>
			        <if test="bankAcc != null and bankAcc != ''">
			        AND A.CRC_STATE_ACC_ID = #{bankAcc}
			        </if>
			    GROUP BY 
			        B.CRC_TRNSC_ID,
			        B.CRC_TRNSC_DT,
			        B.CRC_TRNSC_NO,
			        B.CRC_TRNSC_APPV,
			        B.CRDIT_CARD,
			        A.CRC_STATE_ACC_ID ) TB2 ON   TB1.PAY_ITM_CC_NO = TB2.CRC_TRNSC_NO
			                                    AND TB1.PAY_ITM_REF_DT = TB2.CRC_TRNSC_DT
			                                    AND TB1.PAY_ITM_APPV_NO = TB2.CRC_TRNSC_APPV
			                                    AND TB1.AMOUNT = TB2.GROS_AMT
    </select>
    
    <select id="selectCrcKeyInList" parameterType="Map" resultType="egovMap">
        SELECT 
			GROUP_SEQ, 
			PAY_ITM_CC_NO, 
			PAY_ITM_REF_DT, 
			PAY_ITM_APPV_NO, 
			PAY_ITM_CARD_MODE_ID, 
			CARD_MODE_NAME,
			AMOUNT,
			CRC_MC_NAME
			FROM 
			    (
			    SELECT
			        A.GROUP_SEQ GROUP_SEQ,
			        B.PAY_ITM_CC_NO PAY_ITM_CC_NO,
			        B.PAY_ITM_REF_DT PAY_ITM_REF_DT,
			        B.PAY_ITM_APPV_NO PAY_ITM_APPV_NO,
			        B.PAY_ITM_CARD_MODE_ID PAY_ITM_CARD_MODE_ID,
			        C.CODE_NAME CARD_MODE_NAME,
			        NVL(SUM(A.PAY_ITM_AMT),0) + NVL(MAX(A.BANK_CHG_AMT),0) AS AMOUNT,
			        E.ACC_DESC CRC_MC_NAME
			    FROM 
			        PAY0252T A
			        JOIN PAY0065D B ON A.PAY_ITM_ID = B.PAY_ITM_ID
			        JOIN SYS0013M C ON B.PAY_ITM_CARD_MODE_ID = C.CODE_ID AND C.DISAB = 0 AND C.CODE_MASTER_ID = '130'
			        JOIN PAY0240T D ON A.GROUP_SEQ = D.SEQ
                    JOIN SYS0001M E ON D.BANK_ACC_ID = E.ACC_ID AND E.ACC_STUS_ID = 1 AND E.IS_PAY_CRC = 1
			    WHERE 
			        A.PAY_ITM_MODE_ID = 107
			        AND A.CRC_STATE_MAPPING_STUS_ID = 1
			        <if test="transDateFr != null and transDateTo != null and transDateFr != '' and transDateTo != ''" > 
                    AND B.PAY_ITM_REF_DT BETWEEN TO_DATE(#{transDateFr},'DD/MM/YYYY') AND TO_DATE(#{transDateTo},'DD/MM/YYYY')
                    </if>
                    <if test="bankAcc != null and bankAcc != ''">
                    AND B.PAY_ITM_BANK_ACC_ID = #{bankAcc}
                    </if>
			    GROUP BY 
			        A.GROUP_SEQ,
			        B.PAY_ITM_CC_NO,
			        B.PAY_ITM_REF_DT,
			        B.PAY_ITM_APPV_NO,
			        B.PAY_ITM_CARD_MODE_ID,
			        C.CODE_NAME,
			        E.ACC_DESC) TB1
			    
				    WHERE 1=1
				    AND (TB1.PAY_ITM_CC_NO,
				    TB1.PAY_ITM_REF_DT, 
				    TB1.PAY_ITM_APPV_NO, 
				    TB1.AMOUNT ) 
				    NOT IN (
					    SELECT  
					        B.CRC_TRNSC_NO,
					        B.CRC_TRNSC_DT,
					        B.CRC_TRNSC_APPV,
					        NVL(SUM(B.CRC_GROS_AMT),0) AS GROS_AMT
					    FROM 
					        PAY0075D A 
					        JOIN PAY0076D B ON A.CRC_STATE_ID = B.CRC_STATE_ID 
					        LEFT JOIN SYS0001M C ON A.CRC_STATE_ACC_ID = C.ACC_ID AND C.IS_PAY_CRC = 1
					    WHERE
					        B.KEYIN_STUS_ID = 1
					        <if test="transDateFr != null and transDateTo != null and transDateFr != '' and transDateTo != ''" > 
		                    AND B.CRC_TRNSC_DT BETWEEN TO_DATE(#{transDateFr},'DD/MM/YYYY') AND TO_DATE(#{transDateTo},'DD/MM/YYYY')
		                    </if>
		                    <if test="bankAcc != null and bankAcc != ''">
		                    AND A.CRC_STATE_ACC_ID = #{bankAcc}
		                    </if>
					    GROUP BY 
					        B.CRC_TRNSC_ID,
					        B.CRC_TRNSC_DT,
					        B.CRC_TRNSC_NO,
					        B.CRC_TRNSC_APPV
					        )
				        ORDER BY PAY_ITM_REF_DT DESC
    </select>
    
    <select id="selectCrcStateList" parameterType="Map" resultType="egovMap">
        SELECT 
			CRC_TRNSC_ID, 
			CRC_TRNSC_NO, 
			CRC_TRNSC_DT, 
			CRC_TRNSC_APPV, 
			CRDIT_CARD, 
			CRC_STATE_ACC_ID, 
			BANK_ACC_NAME, 
			GROS_AMT
			FROM 
			    (
				    SELECT  
				        B.CRC_TRNSC_ID,
				        B.CRC_TRNSC_NO,
				        B.CRC_TRNSC_DT,
				        B.CRC_TRNSC_APPV,
				        B.CRDIT_CARD,
				        A.CRC_STATE_ACC_ID,
				        C.ACC_DESC BANK_ACC_NAME,
				        NVL(SUM(B.CRC_GROS_AMT),0) AS GROS_AMT,
				        C.ACC_DESC
				    FROM 
				        PAY0075D A 
				        JOIN PAY0076D B ON A.CRC_STATE_ID = B.CRC_STATE_ID 
				        LEFT JOIN SYS0001M C ON A.CRC_STATE_ACC_ID = C.ACC_ID AND C.IS_PAY_CRC = 1
				    WHERE
				        B.KEYIN_STUS_ID = 1
				        <if test="transDateFr != null and transDateTo != null and transDateFr != '' and transDateTo != ''" > 
	                    AND B.CRC_TRNSC_DT BETWEEN TO_DATE(#{transDateFr},'DD/MM/YYYY') AND TO_DATE(#{transDateTo},'DD/MM/YYYY')
	                    </if>
	                    <if test="bankAcc != null and bankAcc != ''">
	                    AND A.CRC_STATE_ACC_ID = #{bankAcc}
	                    </if>
				    GROUP BY 
				        B.CRC_TRNSC_ID,
				        B.CRC_TRNSC_DT,
				        B.CRC_TRNSC_NO,
				        B.CRC_TRNSC_APPV,
				        B.CRDIT_CARD,
				        A.CRC_STATE_ACC_ID,
				        C.ACC_DESC
			        ) TB1
			    WHERE 1=1
			    AND (TB1.CRC_TRNSC_NO,
			        TB1.CRC_TRNSC_DT,
			        TB1.CRC_TRNSC_APPV,
			        TB1.GROS_AMT) 
			    NOT IN (
					    SELECT
					        B.PAY_ITM_CC_NO,
					        B.PAY_ITM_REF_DT,
					        B.PAY_ITM_APPV_NO,
					        NVL(SUM(A.PAY_ITM_AMT),0) + NVL(MAX(A.BANK_CHG_AMT),0) AS AMOUNT
					    FROM 
					        PAY0252T A
					        JOIN PAY0065D B ON A.PAY_ITM_ID = B.PAY_ITM_ID
					    WHERE 
					        A.PAY_ITM_MODE_ID = 107
					        AND A.CRC_STATE_MAPPING_STUS_ID = 1
					        <if test="transDateFr != null and transDateTo != null and transDateFr != '' and transDateTo != ''" > 
		                    AND B.PAY_ITM_REF_DT BETWEEN TO_DATE(#{transDateFr},'DD/MM/YYYY') AND TO_DATE(#{transDateTo},'DD/MM/YYYY')
		                    </if>
		                    <if test="bankAcc != null and bankAcc != ''">
		                    AND B.PAY_ITM_BANK_ACC_ID = #{bankAcc}
		                    </if>
					    GROUP BY 
					        A.GROUP_SEQ,
					        B.PAY_ITM_CC_NO,
					        B.PAY_ITM_REF_DT,
					        B.PAY_ITM_APPV_NO,
					        B.PAY_ITM_CARD_MODE_ID
			    )
			    ORDER BY CRC_TRNSC_DT DESC
    </select>
    
    <update id="updCrcStatement" parameterType="Map" >
        UPDATE PAY0076D SET 
            KEYIN_STUS_ID = 4
            , KEYIN_MAPPING_DT = SYSDATE
            , KEYIN_MAPPING_USER_ID = #{userId}
        WHERE
            CRC_TRNSC_ID = #{crcTrnscId}
    </update>
    
    <update id="updCrcKeyIn" parameterType="Map" >
        UPDATE PAY0252T SET 
            CRC_STATE_MAPPING_STUS_ID = 4
            , CRC_STATE_MAPPING_DT = SYSDATE
            , CRC_STATE_MAPPING_USER_ID = #{userId}
            , CRC_STATE_MAPPING_ID = #{crcTrnscId}
        WHERE
            GROUP_SEQ = #{groupSeq}
    </update>
    
</mapper>