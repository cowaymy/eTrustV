<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.billinggroup.service.impl.BillingTaxInvoiceMapper">

    <select id="selectTaxInvoiceRentalList" parameterType="Map" resultType="egovMap">
	   SELECT
	       Filter1.TAXINVOICEID1 TAX_INVC_ID  ,
	       Filter1.TAX_INVC_REF_NO TAX_INVC_REF_NO  ,
	       Filter1.TAX_INVC_REF_DT TAX_INVC_REF_DT  ,
	       Filter1.TAX_INVC_CUST_NAME TAX_INVC_CUST_NAME  ,
	       Filter1.TAX_INVC_CUST_ID TAX_INVC_CUST_ID  , <!-- Added By keyi 20211013 -->
	       Filter1.TAX_INVC_TYPE TAX_INVC_TYPE  ,
	       Filter1.INVC_ITM_ORD_NO INVC_ITM_ORD_NO  ,
	       Filter1.INVC_ITM_RENTAL_FEE INVC_ITM_RENTAL_FEE  ,
	       Filter1.INVC_ITM_INSTLMT_NO INVC_ITM_INSTLMT_NO  ,
	       Filter1.TAX_INVC_MONTH MONTH,
	       Filter1.TAX_INVC_YEAR YEAR,
	       Filter1.GEN_E_INV <!-- Added for e-Invoice -->
	    FROM
	            (
	            SELECT
	                Extent1.TAX_INVC_ID TAXINVOICEID1  ,
	                Extent1.TAX_INVC_REF_NO TAX_INVC_REF_NO  ,
	                Extent1.TAX_INVC_REF_DT TAX_INVC_REF_DT  ,
	                Extent1.TAX_INVC_CUST_NAME TAX_INVC_CUST_NAME  ,
	                Extent1.TAX_INVC_MONTH TAX_INVC_MONTH  ,
	                Extent1.TAX_INVC_YEAR TAX_INVC_YEAR  ,
	                Extent1.TAX_INVC_TYPE TAX_INVC_TYPE  ,
	                Extent2.INVC_ITM_ORD_NO INVC_ITM_ORD_NO  ,
	                Extent2.INVC_ITM_RENTAL_FEE INVC_ITM_RENTAL_FEE  ,
	                Extent2.INVC_ITM_INSTLMT_NO INVC_ITM_INSTLMT_NO ,
	                Extent4.CUST_ID TAX_INVC_CUST_ID,
                    CASE WHEN Extent8.QR_CODE IS NOT NULL THEN 'Y'
                        ELSE 'N'
                    END AS GEN_E_INV
	            FROM
	                PAY0029D Extent1
	                JOIN PAY0030D Extent2   ON Extent1.TAX_INVC_ID = Extent2.TAX_INVC_ID
	                LEFT JOIN SAL0001D Extent4 ON Extent4.SALES_ORD_NO = Extent2.INVC_ITM_ORD_NO
	                LEFT JOIN EIV0004D Extent8 ON Extent8.INV_REF_NO = Extent1.TAX_INVC_REF_NO AND Extent8.STATUS = 4
	            WHERE
	                Extent1.TAX_INVC_BILL_TYPE = 133) Filter1
	            LEFT JOIN PAY0017D Extent3   ON Filter1.TAX_INVC_REF_NO = Extent3.ACC_INV_VOID_INVC_NO
	    WHERE
	        Extent3.ACC_INV_VOID_ID IS NULL
	        <if test="brNo != null and brNo != '' ">
	        AND  Filter1.TAX_INVC_REF_NO = #{brNo}
	        </if>
	        <if test="invoiceType != null and invoiceType != '' ">
	        AND  Filter1.TAX_INVC_TYPE = #{invoiceType}
	        </if>
	        <if test="orderNo != null and orderNo != '' ">
	        AND  Filter1.INVC_ITM_ORD_NO = #{orderNo}
	        </if>
			<if test="month != null and month != '' ">
			AND  Filter1.TAX_INVC_MONTH = #{month}
			</if>
			<if test="year != null and year != '' ">
			AND  Filter1.TAX_INVC_YEAR = #{year}
			</if>
			<if test="custName != null and custName != '' ">
			AND Filter1.TAX_INVC_CUST_NAME LIKE '%' || #{custName} || '%'
			</if>
			<if test="custID != null and custID != '' ">
            AND Filter1.TAX_INVC_CUST_ID = #{custID}
            </if>
        --ORDER BY Filter1.INVC_ITM_ORD_NO DESC

	</select>

	<select id="selectTaxInvoiceOutrightList" parameterType="Map" resultType="egovMap">
       SELECT
            txm.TAX_INVC_ID,
            txm.TAX_INVC_REF_NO,
            txm.TAX_INVC_REF_DT,
            txm.TAX_INVC_CUST_NAME,
            orm.APP_TYPE_ID,
            cd.CODE_NAME,
            txs.INVC_ITM_ORD_NO,
            txs.INVC_ITM_PRODUCT_MODEL,
            txs.INVC_ITM_AMT_DUE,
            TO_NUMBER(TO_CHAR(txm.TAX_INVC_REF_DT,'MM')) AS month,
            TO_NUMBER(TO_CHAR(txm.TAX_INVC_REF_DT,'YYYY')) AS year,
            orm.CUST_ID TAX_INVC_CUST_ID,  <!--Added by Keyi 20211013-->
            CASE WHEN eiv.QR_CODE IS NOT NULL THEN 'Y'
                    ELSE 'N'
            END AS GEN_E_INV
        FROM
            PAY0033D txm
            LEFT JOIN PAY0034D txs ON txm.TAX_INVC_ID = txs.TAX_INVC_ID
            LEFT JOIN SAL0001D orm ON txs.INVC_ITM_ORD_NO = orm.SALES_ORD_NO
            LEFT JOIN SYS0013M cd ON orm.APP_TYPE_ID = cd.CODE_ID
            LEFT JOIN EIV0004D eiv ON eiv.INV_REF_NO = txm.TAX_INVC_REF_NO AND eiv.STATUS = 4
        WHERE
            1=1
            <if test="invoiceNo != null and invoiceNo != '' ">
            AND txm.TAX_INVC_REF_NO = #{invoiceNo}
            </if>
            <if test="orderNo != null and orderNo != '' ">
            AND txs.INVC_ITM_ORD_NO = #{orderNo}
            </if>
            <if test="appType != null">
                AND orm.APP_TYPE_ID IN
                <foreach collection="appType" item="item" open="(" close=")" separator="," >
                    #{item}
                </foreach>
            </if>
            <if test="custName != null and custName != '' ">
            AND txm.TAX_INVC_CUST_NAME LIKE '%' || #{custName} || '%'
            </if>
            <if test="invoicePeriod != null and invoicePeriod != '' ">
            AND txm.TAX_INVC_REF_DT  <![CDATA[   >= ]]> TO_DATE(#{invoicePeriod},'MM/YYYY')
            AND txm.TAX_INVC_REF_DT  <![CDATA[  < ]]>  LAST_DAY(TO_DATE(#{invoicePeriod},'MM/YYYY')) + 1
            </if>
            <if test="custID != null and custID != '' ">
            AND orm.CUST_ID = #{custID}
            </if>
        ORDER BY txs.INVC_ITM_ORD_NO DESC
    </select>

    <select id="selectTaxInvoiceMembershipList" parameterType="Map" resultType="egovMap">
        SELECT
	        Extent1.TAX_INVC_ID AS TAX_INVC_ID,
	        Extent1.TAX_INVC_REF_NO AS TAX_INVC_REF_NO,
	        Extent1.TAX_INVC_REF_DT AS TAX_INVC_REF_DT,
	        Extent1.TAX_INVC_SVC_NO AS TAX_INVC_SVC_NO,
	        Extent1.TAX_INVC_TYPE AS TAX_INVC_TYPE,
	        Extent1.TAX_INVC_CUST_NAME AS TAX_INVC_CUST_NAME,
	        Extent2.INVC_ITM_AMT_DUE AS INVC_ITM_AMT_DUE,
	        TO_NUMBER(TO_CHAR(Extent1.TAX_INVC_REF_DT,'MM')) AS month,
	        TO_NUMBER(TO_CHAR(Extent1.TAX_INVC_REF_DT,'YYYY')) AS year,
	        (CASE WHEN Extent2.INVC_ITM_ORD_NO IS NOT NULL THEN Extent2.INVC_ITM_ORD_NO ELSE INVC_ITM_ORD_NO END) AS INVC_ITM_ORD_NO,
	        Extent3.SALES_ORD_NO,
 	        Extent3.CUST_ID TAX_INVC_CUST_ID,  <!--Added by keyi 20211013-->
            CASE WHEN Extent8.QR_CODE IS NOT NULL THEN 'Y'
                ELSE 'N'
            END AS GEN_E_INV
        FROM
            PAY0031D Extent1
            INNER JOIN PAY0032D Extent2 ON Extent2.TAX_INVC_ID = Extent1.TAX_INVC_ID
            INNER JOIN SAL0001D Extent3 ON Extent2.INVC_ITM_ORD_NO = Extent3.SALES_ORD_NO
            LEFT JOIN EIV0004D Extent8 ON Extent8.INV_REF_NO = Extent1.TAX_INVC_REF_NO AND Extent8.STATUS = 4
        WHERE
            1=1
             <if test="invoiceNo != null and invoiceNo != '' ">
            AND Extent1.TAX_INVC_TYPE = #{invoiceType}
             </if>
            <if test="invoiceNo != null and invoiceNo != '' ">
            AND Extent1.TAX_INVC_REF_NO = #{invoiceNo}
            </if>
            <if test="serviceNo != null and serviceNo != '' ">
            AND Extent1.TAX_INVC_SVC_NO = #{serviceNo}
            </if>
            <if test="orderNo != null and orderNo != '' ">
            AND Extent3.SALES_ORD_NO = #{orderNo}
            </if>
            <if test="invoicePeriod != null and invoicePeriod != '' ">
            AND Extent1.TAX_INVC_REF_DT  <![CDATA[   >= ]]> TO_DATE(#{invoicePeriod},'MM/YYYY')
            AND Extent1.TAX_INVC_REF_DT  <![CDATA[  < ]]>  LAST_DAY(TO_DATE(#{invoicePeriod},'MM/YYYY')) + 1
            </if>
            <if test="custName != null and custName != '' ">
            AND Extent1.TAX_INVC_CUST_NAME LIKE '%' || #{custName} || '%'
            </if>
            <if test="custID != null and custID != '' ">
            AND Extent3.CUST_ID = #{custID}
            </if>

        ORDER BY Extent1.TAX_INVC_SVC_NO DESC
    </select>

	<select id="selectTaxInvoiceRenMembershipList" parameterType="Map" resultType="egovMap">
            SELECT
                Filter1.TAXINVOICEID1 TAX_INVC_ID  ,
				Filter1.TAX_INVC_REF_NO TAX_INVC_REF_NO  ,
				Filter1.TAX_INVC_REF_DT TAX_INVC_REF_DT  ,
				Filter1.TAX_INVC_CUST_NAME TAX_INVC_CUST_NAME  ,
				Filter1.TAX_INVC_TYPE TAX_INVC_TYPE  ,
				Filter1.INVC_ITM_ORD_NO INVC_ITM_ORD_NO  ,
				Filter1.INVC_ITM_RENTAL_FEE INVC_ITM_RENTAL_FEE  ,
				Filter1.INVC_ITM_INSTLMT_NO INVC_ITM_INSTLMT_NO  ,
				Filter1.INVC_ITM_DESC2 INVC_ITM_DESC2  ,
				Filter1.TAX_INVC_MONTH MONTH  ,
				Filter1.TAX_INVC_YEAR YEAR
            FROM
                (
                SELECT
                    Extent1.TAX_INVC_ID TAXINVOICEID1  ,
	                Extent1.TAX_INVC_REF_NO TAX_INVC_REF_NO  ,
	                Extent1.TAX_INVC_REF_DT TAX_INVC_REF_DT  ,
	                Extent1.TAX_INVC_CUST_NAME TAX_INVC_CUST_NAME  ,
	                Extent1.TAX_INVC_MONTH TAX_INVC_MONTH  ,
	                Extent1.TAX_INVC_YEAR TAX_INVC_YEAR  ,
	                Extent1.TAX_INVC_TYPE TAX_INVC_TYPE  ,
	                Extent2.INVC_ITM_ORD_NO INVC_ITM_ORD_NO  ,
	                Extent2.INVC_ITM_RENTAL_FEE INVC_ITM_RENTAL_FEE  ,
	                Extent2.INVC_ITM_INSTLMT_NO INVC_ITM_INSTLMT_NO  ,
	                Extent2.INVC_ITM_DESC2 INVC_ITM_DESC2
                FROM
                    PAY0029D Extent1
                    JOIN PAY0030D Extent2   ON Extent1.TAX_INVC_ID = Extent2.TAX_INVC_ID
                WHERE
                    Extent1.TAX_INVC_BILL_TYPE = 134) Filter1
                LEFT JOIN PAY0017D Extent3   ON Filter1.TAX_INVC_REF_NO = Extent3.ACC_INV_VOID_INVC_NO
        WHERE
            Extent3.ACC_INV_VOID_ID IS NULL
            <if test="brNo != null and brNo != '' ">
            AND Filter1.TAX_INVC_REF_NO = #{brNo}
            </if>
            <if test="orderNo != null and orderNo != '' ">
            AND Filter1.INVC_ITM_ORD_NO = #{orderNo}
            </if>
            <if test="month != null and month != '' ">
            AND  Filter1.TAX_INVC_MONTH = #{month}
            </if>
            <if test="year != null and year != '' ">
            AND  Filter1.TAX_INVC_YEAR = #{year}
            </if>
            <if test="custName != null and custName != '' ">
            AND Filter1.TAX_INVC_CUST_NAME LIKE '%' || #{custName} || '%'
            </if>
            <if test="rentalMembershipNo != null and rentalMembershipNo != '' ">
            AND Filter1.INVC_ITM_DESC2 = #{rentalMembershipNo}
            </if>
        ORDER BY Filter1.INVC_ITM_ORD_NO DESC
        </select>

        <select id="selectTaxInvoiceMiscellaneousList" parameterType="Map" resultType="egovMap">
            SELECT
                Extent1.TAX_INVC_ID AS TAX_INVC_ID,
                Extent1.TAX_INVC_REF_NO AS TAX_INVC_REF_NO,
                Extent1.TAX_INVC_REF_DT AS TAX_INVC_REF_DT,
				Extent1.TAX_INVC_SVC_NO AS TAX_INVC_SVC_NO,
				Extent1.TAX_INVC_TYPE AS TAX_INVC_TYPE,
				Extent1.TAX_INVC_CUST_NAME AS TAX_INVC_CUST_NAME,
				Extent1.TAX_INVC_AMT_DUE AS TAX_INVC_AMT_DUE,
				TO_NUMBER(TO_CHAR(Extent1.TAX_INVC_REF_DT,'MM')) AS month,
				TO_NUMBER(TO_CHAR(Extent1.TAX_INVC_REF_DT,'YYYY')) AS year,
                CASE WHEN Extent8.QR_CODE IS NOT NULL THEN 'Y'
                    ELSE 'N'
                END AS GEN_E_INV
            FROM
                PAY0031D Extent1
                LEFT JOIN EIV0004D Extent8 ON Extent8.INV_REF_NO = Extent1.TAX_INVC_REF_NO AND Extent8.STATUS = 4
            WHERE
                Extent1.TAX_INVC_TYPE = #{invoiceType}
                <if test="invoiceNo != null and invoiceNo != '' ">
                AND Extent1.TAX_INVC_REF_NO = #{invoiceNo}
                </if>
                <if test="serviceNo != null and serviceNo != '' ">
                AND Extent1.TAX_INVC_SVC_NO = #{serviceNo}
                </if>
                <if test="invoicePeriod != null and invoicePeriod != '' ">
                AND Extent1.TAX_INVC_REF_DT  <![CDATA[   >= ]]> TO_DATE(#{invoicePeriod},'MM/YYYY')
                AND Extent1.TAX_INVC_REF_DT  <![CDATA[  < ]]>  LAST_DAY(TO_DATE(#{invoicePeriod},'MM/YYYY')) + 1
                </if>
                <if test="custName != null and custName != '' ">
                AND Extent1.TAX_INVC_CUST_NAME LIKE '%' ||#{custName} || '%'
                </if>
            ORDER BY Extent1.TAX_INVC_SVC_NO DESC
        </select>

        <select id="selectStatementCompanyRental" parameterType="Map" resultType="egovMap">
            SELECT
                Extent1.STATE_ID AS STATE_ID,
                Extent1.STATE_REF_NO AS STATE_REF_NO,
                Extent1.STATE_CUST_NAME AS STATE_CUST_NAME,
                Extent2.STATE_ITM_ORD_NO AS STATE_ITM_ORD_NO,
                Extent2.STATE_ITM_TYPE AS STATE_ITM_TYPE,
                Extent2.STATE_ITM_REF_NO AS STATE_ITM_REF_NO,
                Extent1.STATE_MONTH AS MONTH,
                Extent1.STATE_YEAR AS YEAR,
                Extent3.CUST_ID AS STATE_CUST_ID   <!-- Added by Keyi 20211013-->
            FROM
                PAY0025D Extent1
                INNER JOIN PAY0026D Extent2 ON Extent2.STATE_ID = Extent1.STATE_ID
                LEFT JOIN SAL0001D Extent3 ON Extent3.SALES_ORD_NO = Extent2.STATE_ITM_ORD_NO
            WHERE
                1=1
                <if test="billingNo != null and billingNo != '' ">
                AND Extent2.STATE_ITM_REF_NO = #{billingNo}
                </if>
                <if test="orderNo != null and orderNo != '' ">
                AND Extent2.STATE_ITM_ORD_NO = #{orderNo}
                </if>
                <if test="month != null and month != '' ">
                    AND  Extent1.STATE_MONTH = #{month}
                </if>
                <if test="year != null and year != '' ">
                    AND  Extent1.STATE_YEAR = #{year}
                </if>
                <if test="custName != null and custName != '' ">
                AND Extent1.STATE_CUST_NAME LIKE '%' || #{custName}  || '%'
                </if>
                <if test="custID != null and custID != '' ">
                AND Extent3.CUST_ID = #{custID}
                </if>
            ORDER BY Extent2.STATE_ITM_ORD_NO DESC
    </select>
</mapper>