<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.billinggroup.service.impl.BillingInvoiceMapper">

    <sql id="pagingStart">
        SELECT *
        FROM (SELECT ROWNUM AS RNUM
                                ,Z.*
                    FROM (
    </sql>
    <sql id="pagingEnd">
         ) Z
                    WHERE ROWNUM <![CDATA[<=]]> ( #{pageNo} * #{rowCount}) )
        WHERE RNUM > ((#{pageNo} - 1) * #{rowCount})
    </sql>

    <!-- Reconciliation 리스트 조회 -->
    <select id="selectCompanyInvoiceList" parameterType="Map" resultType="egovMap">
       <![CDATA[
            SELECT DISTINCT Filter1.NAME1 NAME  ,
                                        Filter1.NRIC1 NRIC  ,
                                        Filter1.EMAIL EMAIL  ,
                                        Filter1.SALES_ORD_ID SALES_ORD_ID  ,
                                        Filter1.SALES_ORD_NO SALES_ORD_NO  ,
                                        Filter1.SALES_DT SALES_DT  ,
                                        Filter1.RENT_DOC_NO RENT_DOC_NO  ,
                                        Filter1.RENT_AMT RENT_AMT  ,
                                        Filter1.RENT_INST_NO RENT_INST_NO  ,
                                        1 C1  ,
                                        CASE WHEN ( Filter1.TASK_ID IS NULL ) THEN 0 ELSE Filter1.TASK_ID END TASK_ID  ,
                                        CASE WHEN ( 66 = Filter1.APP_TYPE_ID ) THEN Filter1.NAME2 ELSE Filter1.NAME3 END APP_TYPE_NAME  ,
                                        TO_CHAR(Filter1.RENT_DT_TM, 'DD-MM-YYYY') REN_DATE_TIME ,
                                        CASE WHEN TO_NUMBER(TO_CHAR(Filter1.RENT_DT_TM, 'MM')) < 9 THEN SUBSTR(TO_CHAR(Filter1.RENT_DT_TM, 'MM'), 2,1 ) ELSE TO_CHAR(Filter1.RENT_DT_TM, 'MM') END  REN_DATE_TIME_MONTH,
                                        TO_CHAR(Filter1.RENT_DT_TM, 'YYYY') REN_DATE_TIME_YEAR
                        FROM ( SELECT Extent1.NAME NAME1  ,
                                              Extent1.NRIC NRIC1  ,
                                              Extent1.EMAIL EMAIL  ,
                                              Extent2.SALES_ORD_ID SALES_ORD_ID  ,
                                              Extent2.SALES_ORD_NO SALES_ORD_NO  ,
                                              Extent2.SALES_DT SALES_DT  ,
                                              Extent2.APP_TYPE_ID APP_TYPE_ID  ,
                                              Extent3.RENT_DOC_NO RENT_DOC_NO  ,
                                              Extent3.RENT_DT_TM RENT_DT_TM  ,
                                              Extent3.RENT_AMT RENT_AMT  ,
                                              Extent3.RENT_INST_NO RENT_INST_NO  ,
                                              CASE WHEN (Extent4.TASK_ID IS NULL) THEN Extent10.TAX_INVC_TASK_ID ELSE Extent4.TASK_ID END TASK_ID  ,
                                              Extent6.NAME NAME2  ,
                                              Extent7.NAME NAME3
                                 FROM SAL0029D Extent1
                                        JOIN SAL0001D Extent2   ON ( Extent2.CUST_ID = Extent1.CUST_ID )
                                        AND ( 8 <> Extent2.STUS_CODE_ID )
                                        JOIN PAY0022D Extent3   ON ( Extent3.RENT_SO_ID = Extent2.SALES_ORD_ID )
                                        AND ( Extent3.RENT_DOC_TYPE_ID IN ( 158,159,161 )
                                   )
                                  AND ( Extent3.RENT_DOC_NO LIKE 'BR%' )
                                  LEFT JOIN PAY0062S Extent4   ON ( Extent4.BR_NO = Extent3.RENT_DOC_NO )
                                  AND ( 1 = TO_NUMBER(Extent4.STUS_CODE_ID) )
                                  LEFT JOIN SAL0024D Extent5   ON ( Extent5.CUST_BILL_ID = Extent2.CUST_BILL_ID )
                                  AND ( 66 = Extent2.APP_TYPE_ID )
                                  LEFT JOIN SAL0027D Extent6   ON ( Extent6.CUST_CNTC_ID = Extent5.CUST_BILL_CNT_ID )
                                  AND ( 66 = Extent2.APP_TYPE_ID )
                                  LEFT JOIN SAL0027D Extent7   ON ( Extent7.CUST_CNTC_ID = Extent2.CUST_CNT_ID )
                                  AND ( 66 <> Extent2.APP_TYPE_ID )
                                  LEFT JOIN PAY0029D Extent10  ON (Extent10.TAX_INVC_REF_NO = Extent3.RENT_DOC_NO)
                        WHERE  ( 965 = Extent1.TYPE_ID )
                                 AND ( 8 <> TO_NUMBER(Extent1.STUS_CODE_ID) ) ) Filter1
                       LEFT JOIN PAY0017D Extent8   ON Extent8.ACC_INV_VOID_INVC_NO = Filter1.RENT_DOC_NO
                 WHERE  ( Extent8.ACC_INV_VOID_REF_NO IS NULL)]]>
                         <if test="billNo != '' ">
                                AND  (Filter1.RENT_DOC_NO = #{billNo})
                          </if>
                          <if test="orderNo != '' ">
                                AND ( Filter1.SALES_ORD_NO = #{orderNo} )
                          </if>
                          <if test="custName != '' ">
                                AND ( Filter1.NAME1 LIKE '%' || #{custName} || '%' ESCAPE '~' )
                          </if>
                          <if test="custNRIC != '' ">
                                AND ( Filter1.NAME1 LIKE '%' || #{custNRIC} || '%' ESCAPE '~' )
                          </if>
                          <if test="sMonth != '' ">
                                AND ( (utils.datepart('MONTH', Filter1.RENT_DT_TM)) = #{sMonth} )
                          </if>
                          <if test="sYear != '' ">
                                AND ( (utils.datepart('YEAR', Filter1.RENT_DT_TM)) = #{sYear} )
                          </if>
        ORDER BY Filter1.SALES_ORD_ID DESC
    </select>

    <select id="selectRentalStatementList" parameterType="Map" resultType="egovMap">
     <![CDATA[
       SELECT DISTINCT Filter1.RENT_DOC_NO RENT_DOC_NO  ,
                       Filter1.RENT_AMT RENT_AMT  ,
                       Filter1.RENT_INST_NO RENT_INST_NO  ,
                       1 C1  ,
                       CASE WHEN ( Filter1.TASK_ID IS NULL ) THEN 0 ELSE Filter1.TASK_ID END TASK_ID  ,
                       TO_CHAR(TO_DATE(Filter1.RENT_DT_TM, 'YYYY-MM-DD'), 'YY/MM') RENT_DT_TM ,
                       CASE WHEN TO_NUMBER(TO_CHAR(Filter1.RENT_DT_TM, 'MM')) < 9 THEN SUBSTR(TO_CHAR(Filter1.RENT_DT_TM, 'MM'), 2,1 ) ELSE TO_CHAR(Filter1.RENT_DT_TM, 'MM') END  RDTMONTH,
                       TO_CHAR(Filter1.RENT_DT_TM, 'YYYY') RDTYEAR,
                       Filter1.SALES_ORD_ID SALES_ORD_ID  ,
                       Filter1.SALES_ORD_NO SALES_ORD_NO  ,
                       TO_CHAR(Filter1.SALES_DT, 'DD-MM-YYYY') SALES_DT  ,
                       Filter1.NAME2 NAME  ,
                       Filter1.NRIC1 NRIC  ,
                       Filter1.NAME3 NAME1  ,
                       Filter1.EMAIL EMAIL
       FROM ( SELECT Extent1.RENT_DOC_NO RENT_DOC_NO  ,
                     Extent1.RENT_DT_TM RENT_DT_TM  ,
                     Extent1.RENT_AMT RENT_AMT  ,
                     Extent1.RENT_INST_NO RENT_INST_NO  ,
                     Extent2.TASK_ID TASK_ID  ,
                     Extent3.SALES_ORD_ID SALES_ORD_ID  ,
                     Extent3.SALES_ORD_NO SALES_ORD_NO  ,
                     Extent3.SALES_DT SALES_DT  ,
                     Extent4.NAME NAME2  ,
                     Extent4.NRIC NRIC1  ,
                     Extent5.NAME NAME3 ,
                     Extent4.EMAIL EMAIL
              FROM PAY0022D Extent1
                     LEFT JOIN PAY0084D Extent2   ON Extent1.RENT_DOC_NO = Extent2.BR_NO
                     LEFT JOIN SAL0001D Extent3   ON Extent1.RENT_SO_ID = Extent3.SALES_ORD_ID
                     LEFT JOIN SAL0029D Extent4   ON Extent3.CUST_ID = Extent4.CUST_ID
                     LEFT JOIN SAL0027D Extent5   ON Extent3.CUST_CNT_ID = Extent5.CUST_CNTC_ID
               WHERE  Extent1.RENT_DOC_TYPE_ID IN ( 158,159,161 )
             ) Filter1
              LEFT JOIN SAL0074D Extent6   ON Filter1.SALES_ORD_ID = Extent6.SALES_ORD_ID
        WHERE 1=1
                        ]]>
       <if test="billNo != '' ">
        AND ( Filter1.RENT_DOC_NO =  #{billNo}  )
        </if>
        <if test="orderNo != '' ">
        AND ( Filter1.SALES_ORD_NO =  #{orderNo}  )
        </if>
        <if test="custName != '' " >
        AND ( Filter1.NAME2 LIKE '%' || #{custName} || '%' ESCAPE '~' )
        </if>
        <if test="custNRIC != '' ">
        AND ( Filter1.NAME2 LIKE '%' || #{custNRIC} || '%' ESCAPE '~' )
        </if>
        <if test="sMonth != '' ">
        AND ( (utils.datepart('MONTH', Filter1.RENT_DT_TM)) = #{sMonth} )
        </if>
        <if test="sYear != '' ">
        AND ( (utils.datepart('YEAR', Filter1.RENT_DT_TM)) = #{sYear} )
        </if>
  ORDER BY Filter1.SALES_ORD_ID DESC

    </select>

    <select id="selectMembershipInvoiceList" parameterType="Map" resultType="egovMap">
<![CDATA[
    SELECT DISTINCT Extent1.INVC_REF_NO INVC_REF_NO  ,
               Extent1.TASK_ID TASK_ID  ,
               1 C1  ,
               TO_CHAR(Extent1.INVC_REF_DT, 'DD-MM-YYYY') INVC_REF_DT  ,
               TO_NUMBER(Extent2.INVC_SUB_MEM_PAC_AMT)  INVC_SUB_MEM_PAC_AMT,
               TO_NUMBER(Extent2.INVC_SUB_MEM_BS_AMT) INVC_SUB_MEM_BS_AMT  ,
               Extent3.SRV_MEM_QUOT_NO SRV_MEM_QUOT_NO  ,
               Extent4.SALES_ORD_ID SALES_ORD_ID  ,
               Extent4.SALES_ORD_NO SALES_ORD_NO  ,
               Extent4.SALES_DT SALES_DT  ,
               Extent5.NAME NAME  ,
               Extent5.NRIC NRIC  ,
               Extent6.TEL_M1 TEL_M1,
               Extent5.EMAIL EMAIL
       FROM PAY0013D Extent1
              LEFT JOIN PAY0014D Extent2   ON Extent1.INVC_ID = Extent2.INVC_ID
              LEFT JOIN SAL0093D Extent3   ON Extent2.INVC_SUB_MEM_QOTAT_ID = Extent3.SRV_MEM_QUOT_ID
              LEFT JOIN SAL0001D Extent4   ON Extent3.SRV_SALES_ORD_ID = Extent4.SALES_ORD_ID
              LEFT JOIN SAL0029D Extent5   ON Extent4.CUST_ID = Extent5.CUST_ID
              LEFT JOIN SAL0027D Extent6   ON Extent4.CUST_CNT_ID = Extent6.CUST_CNTC_ID
        WHERE  1=1 ]]>
                        <if test="invoiceNo != '' ">
                            AND( Extent1.INVC_REF_NO = #{invoiceNo} )
                         </if>
                         <if test="orderNo != '' ">
                            AND ( Extent4.SALES_ORD_NO = #{orderNo} )
                        </if>
                        <if test="custName != '' ">
                            AND ( Extent5.NAME LIKE '%' || #{custName} || '%'ESCAPE '~' )
                        </if>
                        <if test="custNRIC != '' ">
                            AND ( Extent5.NAME LIKE '%' || #{custNRIC} || '%'ESCAPE '~' )
                         </if>
                         <if test="quotationNo != '' ">
                            AND ( Extent3.SRV_MEM_QUOT_NO LIKE '%' || #{quotationNo} || '%'ESCAPE '~' )
                         </if>
        ORDER BY Extent4.SALES_ORD_ID DESC
    </select>

    <select id="selectOutrightInvoiceList" parameterType="Map" resultType="egovMap">
    <include refid="pagingStart" />
      SELECT
            DISTINCT Filter1.SALES_ORD_ID SALES_ORD_ID ,
            Filter1.SALES_ORD_NO SALES_ORD_NO ,
            TO_CHAR(Filter1.SALES_DT,'DD/MM/YYYY') SALES_DT ,
            Filter1.APP_TYPE_ID APP_TYPE_ID ,
            Filter1.NAME1 NAME ,
            Filter1.NRIC1 NRIC ,
            Filter1.EMAIL EMAIL ,
            1 C1 ,
            CASE WHEN ( Filter1.ORGCODE1 IS NOT NULL ) THEN Filter1.ORGCODE1 ELSE '' END OrgCode1 ,
            CASE WHEN ( Filter1.GRPCODE1 IS NOT NULL ) THEN Filter1.GRPCODE1 ELSE '' END GrpCode1 ,
            CASE WHEN ( Filter1.DEPTCODE1 IS NOT NULL ) THEN Filter1.DEPTCODE1 ELSE '' END DeptCode1 ,
            Filter1.MEMBERID1 MEM_ID ,
            Filter1.MEMBERCODE1 MEM_CODE ,
            Filter1.MEM_TYPE MEM_TYPE ,
            Extent5.CODE_NAME CODE_NAME
        FROM
            (
            SELECT
                Extent1.SALES_ORD_ID SALES_ORD_ID ,
                Extent1.SALES_ORD_NO SALES_ORD_NO ,
                Extent1.SALES_DT SALES_DT ,
                Extent1.APP_TYPE_ID APP_TYPE_ID ,
                Extent2.NAME NAME1 ,
                Extent2.NRIC NRIC1 ,
                Extent2.EMAIL EMAIL ,
                Extent3.MEM_ID MEMBERID1 ,
                Extent3.MEM_CODE MEMBERCODE1 ,
                Extent3.MEM_TYPE MEM_TYPE ,
                Extent4.DEPT_CODE DEPTCODE1 ,
                Extent4.GRP_CODE GRPCODE1 ,
                Extent4.ORG_CODE ORGCODE1
            FROM
                SAL0001D Extent1
                JOIN SAL0029D Extent2 ON Extent1.CUST_ID = Extent2.CUST_ID
                LEFT JOIN ORG0001D Extent3 ON Extent1.MEM_ID = Extent3.MEM_ID
                LEFT JOIN
                      (SELECT vMemberOrg.MEM_ID MEM_ID ,
                             vMemberOrg.MEM_CODE MEM_CODE ,
                             vMemberOrg.MEM_LVL MEM_LVL ,
                             vMemberOrg.DEPT_CODE DEPT_CODE ,
                             vMemberOrg.GRP_CODE GRP_CODE ,
                             vMemberOrg.ORG_CODE ORG_CODE ,
                             vMemberOrg.TOP_ORG_CODE TOP_ORG_CODE ,
                             vMemberOrg.MEM_UP_ID MEM_UP_ID ,
                             vMemberOrg.LVL3_UP_ID LVL3_UP_ID ,
                             vMemberOrg.LVL2_UP_ID LVL2_UP_ID ,
                             vMemberOrg.LVL1_UP_ID LVL1_UP_ID ,
                             vMemberOrg.LVL0_UP_ID LVL0_UP_ID
                        FROM ORG1001V vMemberOrg ) Extent4 ON Extent3.MEM_ID = Extent4.MEM_ID
                WHERE
                    Extent1.APP_TYPE_ID IN (67,68)
                    AND  Extent1.STUS_CODE_ID = 4
               ) Filter1
           LEFT JOIN SYS0013M Extent5 ON Filter1.APP_TYPE_ID = Extent5.CODE_ID
        WHERE
            1=1
            <if test="orderNo != '' and orderNo != null" >
            AND Filter1.SALES_ORD_NO = #{orderNo}
            </if>
            <if test="custName != '' and custName != null">
            AND Filter1.NAME1 LIKE '%' || #{custName} || '%' ESCAPE '~'
            </if>
            <if test="appType != '' and appType != null">
            AND Filter1.APP_TYPE_ID IN (
                <foreach collection="appType" index="index" separator=",">
                    '${appType[index]}'
                </foreach>
                )
            </if>
        ORDER BY Filter1.SALES_ORD_ID DESC
        <include refid="pagingEnd" />
    </select>

    <select id="selectOutrightInvoiceListCount" parameterType="Map" resultType="int">
        SELECT
            COUNT(*)
            FROM
                SAL0001D Extent1
                JOIN SAL0029D Extent2 ON Extent1.CUST_ID = Extent2.CUST_ID
                LEFT JOIN ORG0001D Extent3 ON Extent1.MEM_ID = Extent3.MEM_ID
                LEFT JOIN ORG1001V  Extent4 ON Extent3.MEM_ID = Extent4.MEM_ID
                        LEFT JOIN SYS0013M Extent5 ON Extent1.APP_TYPE_ID = Extent5.CODE_ID
                WHERE
                    Extent1.APP_TYPE_ID IN (67,68)
                    AND  Extent1.STUS_CODE_ID = 4
                    <if test="orderNo != '' " >
		              AND Extent1.SALES_ORD_NO = #{orderNo}
		            </if>
		            <if test="custName != '' ">
		              AND Extent2.NAME LIKE '%' || #{custName} || '%' ESCAPE '~'
		            </if>
		            <if test="appType != '' and appType != null">
		              AND Extent1.APP_TYPE_ID IN (
		                <foreach collection="appType" index="index" separator=",">
		                    '${appType[index]}'
		                </foreach>
		                )
		            </if>
    </select>

    <select id="selectCompanyStatementList" parameterType="Map" resultType="egovMap">
        <![CDATA[
            SELECT DISTINCT Extent1.BILL_ID BILL_ID  ,
                       Extent1.CUST_NAME CUST_NAME  ,
                       Extent2.SO_NO SO_NO  ,
                       Extent3.CUST_BILL_GRP_NO CUST_BILL_GRP_NO  ,
                       1 C1  ,
                       TO_NUMBER(Extent1.PV_YEAR) YEAR  ,
                       TO_NUMBER(Extent1.PV_MONTH) MONTH  ,
                       Extent7.EMAIL EMAIL
              FROM PAY0082D Extent1
              JOIN PAY0083D Extent2   ON ( Extent2.BILL_ID = Extent1.BILL_ID )
              AND ( TO_NUMBER(Extent2.PV_MONTH) = TO_NUMBER(Extent1.PV_MONTH) )
              AND ( TO_NUMBER(Extent2.PV_YEAR) = TO_NUMBER(Extent1.PV_YEAR) )
              JOIN SAL0024D Extent3   ON Extent1.BILL_ID = Extent3.CUST_BILL_ID
              LEFT JOIN ( SELECT StatementCompanyRelatedOrder.PV_MONTH PV_MONTH  ,
                                         StatementCompanyRelatedOrder.PV_YEAR PV_YEAR  ,
                                         StatementCompanyRelatedOrder.BILL_ID BILL_ID  ,
                                         StatementCompanyRelatedOrder.SO_ID SO_ID  ,
                                         StatementCompanyRelatedOrder.CRT_DT CRT_DT
                               FROM PAY0101M StatementCompanyRelatedOrder ) Extent4   ON Extent1.BILL_ID = Extent4.BILL_ID
                          LEFT JOIN SAL0001D Extent5   ON Extent4.SO_ID = Extent5.SALES_ORD_ID
                          LEFT JOIN SAL0029D Extent7   ON Extent7.CUST_ID = Extent5.CUST_ID
                          LEFT JOIN PAY0022D Extent6   ON ( Extent5.SALES_ORD_ID = Extent6.RENT_SO_ID )
                                  AND ( Extent6.RENT_AMT > 0 )
               WHERE  1=1]]>
                <if test="billNo != '' ">
                   AND Extent3.CUST_BILL_GRP_NO =  #{billNo}
                </if>
                <if test="orderNo != '' ">
                   AND Extent2.SO_NO = #{orderNo}
                </if>
                <if test="custName != '' ">
                   AND ( Extent1.CUST_NAME LIKE '%' || #{custName} || '%' ESCAPE '~' )
                </if>
                <if test="sMonth != '' ">
                   AND Extent1.PV_MONTH = #{sMonth}
                </if>
                <if test="sYear != '' ">
                   AND Extent1.PV_YEAR = #{sYear}
                 </if>
                  ORDER BY Extent1.BILL_ID DESC
    </select>

    <select id="selectProformaInvoiceList" parameterType="Map" resultType="egovMap">
     SELECT DISTINCT Filter1.AppTypeCode AppTypeCode  ,
             Filter1.AppTypeName AppTypeName  ,
             Filter1.Creator Creator  ,
             Filter1.CustomerIC CustomerIC  ,
             Filter1.VANo VANo  ,
             Filter1.CustomerName CustomerName  ,
             Filter1.OrderID1 OrderID  ,
             Filter1.OrderNo OrderNo  ,
             Filter1.OrderStatusCode OrderStatusCode  ,
             Filter1.OrderStatusID OrderStatusID  ,
             Filter1.OrderPONo OrderPONo  ,
             Filter1.StockCode StockCode  ,
             Filter1.StockDesc StockDesc  ,
             Filter1.StockID StockID  ,
             Filter1.OrderRefNo OrderRefNo  ,
             Filter1.RentalStatus RentalStatus  ,
             Filter1.OrderMemID OrderMemID  ,
             Filter1.OrderMemCode OrderMemCode  ,
             Filter1.OrderMemTypeID OrderMemTypeID  ,
             Filter1.OrderCustBillID OrderCustBillID  ,
             Filter1.OrderMailTelM OrderMailTelM  ,
             Filter1.OrderMailTelO OrderMailTelO  ,
             Filter1.OrderMailTelR OrderMailTelR  ,
             Filter1.OrderMailTelF OrderMailTelF  ,
             Filter1.OrderInstTelM OrderInstTelM  ,
             Filter1.OrderInstTelO OrderInstTelO  ,
             Filter1.OrderInstTelR OrderInstTelR  ,
             Filter1.OrderInstTelF OrderInstTelF  ,
             Filter1.LastInstallSirimNo LastInstallSirimNo  ,
             Filter1.LastInstallSerialNo LastInstallSerialNo  ,
             1 C1  ,
             CASE WHEN ( Filter1.AppTypeID IS NOT NULL ) THEN Filter1.AppTypeID ELSE 0 END AppTypeId  ,
             CASE WHEN ( Filter1.CustomerID IS NOT NULL ) THEN Filter1.CustomerID ELSE 0 END CustomerId  ,
             CASE WHEN ( Filter1.DSCBranchID IS NOT NULL ) THEN Filter1.DSCBranchID ELSE 0 END DSCBranchId  ,
             CASE WHEN ( Filter1.KeyInBranchID IS NOT NULL ) THEN Filter1.KeyInBranchID ELSE 0 END KeyInBranchID  ,
             CASE WHEN ( Filter1.OrderDate IS NOT NULL ) THEN TO_CHAR(Filter1.OrderDate, 'YYYY-MM-DD HH24:MI:SS') ELSE '1900-01-01 00:00:00' END OrderDate  ,
             CASE WHEN ( Extent3.ORG_CODE IS NOT NULL ) THEN Extent3.ORG_CODE ELSE ' ' END OrgCode  ,
             CASE WHEN ( Extent3.GRP_CODE IS NOT NULL ) THEN Extent3.GRP_CODE ELSE ' ' END GrpCode  ,
             CASE WHEN ( Extent3.DEPT_CODE IS NOT NULL ) THEN Extent3.DEPT_CODE ELSE ' ' END DeptCode  ,
             Extent6.EMAIL EMAIL,
             TO_NUMBER(TO_CHAR(Filter1.OrderDate,'MM')) AS month,
             TO_NUMBER(TO_CHAR(Filter1.OrderDate,'YYYY')) AS year
    FROM ( SELECT Extent1.APP_TYPE_CODE AppTypeCode ,
                          Extent1.APP_TYPE_ID AppTypeID  ,
                          Extent1.APP_TYPE_NAME AppTypeName  ,
                          Extent1.CRT_USER_ID Creator  ,
                          Extent1.CUST_IC CustomerIC  ,
                          Extent1.VA_NO VANo  ,
                          Extent1.CUST_ID CustomerID  ,
                          Extent1.CUST_NAME CustomerName  ,
                          Extent1.DSC_BRNCH_ID DSCBranchID  ,
                          Extent1.KEYIN_BRNCH_ID KeyInBranchID  ,
                          Extent1.ORD_DT OrderDate  ,
                          Extent1.ORD_ID OrderID1  ,
                          Extent1.ORD_NO OrderNo  ,
                          Extent1.ORD_STUS_CODE OrderStatusCode  ,
                          Extent1.ORD_STUS_ID OrderStatusID  ,
                          Extent1.ORD_PO_NO OrderPONo  ,
                          Extent1.STOCK_CODE StockCode  ,
                          Extent1.STOCK_DESC StockDesc  ,
                          Extent1.STOCK_ID StockID  ,
                          Extent1.ORD_REF_NO OrderRefNo  ,
                          Extent1.RENTAL_STUS RentalStatus  ,
                          Extent1.ORD_MEM_ID OrderMemID  ,
                          Extent1.ORD_MEM_CODE OrderMemCode  ,
                          Extent1.ORD_MEM_TYPE_ID OrderMemTypeID  ,
                          Extent1.ORD_CUST_BILL_ID OrderCustBillID  ,
                          Extent1.ORD_MAIL_TEL_M OrderMailTelM  ,
                          Extent1.ORD_MAIL_TEL_O OrderMailTelO  ,
                          Extent1.ORD_MAIL_TEL_R OrderMailTelR  ,
                          Extent1.ORD_MAIL_TEL_F OrderMailTelF  ,
                          Extent1.ORD_INST_TEL_M OrderInstTelM  ,
                          Extent1.ORD_INST_TEL_O OrderInstTelO  ,
                          Extent1.ORD_INST_TEL_R OrderInstTelR  ,
                          Extent1.ORD_INST_TEL_F OrderInstTelF  ,
                          Extent2.LAST_INSTALL_SIRIM_NO LastInstallSirimNo  ,
                          Extent2.LAST_INSTALL_SERIAL_NO LastInstallSerialNo
                 FROM (SELECT vOrderView.APP_TYPE_CODE APP_TYPE_CODE  ,
                               vOrderView.APP_TYPE_ID APP_TYPE_ID  ,
                               vOrderView.APP_TYPE_NAME APP_TYPE_NAME  ,
                               vOrderView.CRT_USER_ID CRT_USER_ID  ,
                               vOrderView.CUST_IC CUST_IC  ,
                               vOrderView.VA_NO VA_NO  ,
                               vOrderView.CUST_ID CUST_ID  ,
                               vOrderView.CUST_NAME CUST_NAME  ,
                               vOrderView.DSC_BRNCH_ID DSC_BRNCH_ID  ,
                               vOrderView.KEYIN_BRNCH_ID KEYIN_BRNCH_ID  ,
                               vOrderView.ORD_DT ORD_DT  ,
                               vOrderView.ORD_ID ORD_ID  ,
                               vOrderView.ORD_NO ORD_NO  ,
                               vOrderView.ORD_STUS_CODE ORD_STUS_CODE  ,
                               vOrderView.ORD_STUS_ID ORD_STUS_ID  ,
                               vOrderView.ORD_PO_NO ORD_PO_NO  ,
                               vOrderView.STOCK_CODE STOCK_CODE  ,
                               vOrderView.STOCK_DESC STOCK_DESC  ,
                               vOrderView.STOCK_ID STOCK_ID  ,
                               vOrderView.ORD_REF_NO ORD_REF_NO  ,
                               vOrderView.RENTAL_STUS RENTAL_STUS  ,
                               vOrderView.ORD_MEM_ID ORD_MEM_ID  ,
                               vOrderView.ORD_MEM_CODE ORD_MEM_CODE  ,
                               vOrderView.ORD_MEM_TYPE_ID ORD_MEM_TYPE_ID  ,
                               vOrderView.ORD_CUST_BILL_ID ORD_CUST_BILL_ID  ,
                               vOrderView.ORD_MAIL_TEL_M ORD_MAIL_TEL_M  ,
                               vOrderView.ORD_MAIL_TEL_O ORD_MAIL_TEL_O  ,
                               vOrderView.ORD_MAIL_TEL_R ORD_MAIL_TEL_R  ,
                               vOrderView.ORD_MAIL_TEL_F ORD_MAIL_TEL_F  ,
                               vOrderView.ORD_INST_TEL_M ORD_INST_TEL_M  ,
                               vOrderView.ORD_INST_TEL_O ORD_INST_TEL_O  ,
                               vOrderView.ORD_INST_TEL_R ORD_INST_TEL_R  ,
                               vOrderView.ORD_INST_TEL_F ORD_INST_TEL_F
                        FROM SAL1015V vOrderView ) Extent1
                          JOIN ( SELECT vOrderInstallationInfo.ORD_ID ORD_ID  ,
                                        /*
                                        vOrderInstallationInfo.INST_ADDR1 INST_ADDR1  ,
                                        vOrderInstallationInfo.INST_ADDR2 INST_ADDR2  ,
                                        vOrderInstallationInfo.INST_ADDR3 INST_ADDR3  ,
                                        vOrderInstallationInfo.INST_CNTY INST_CNTY  ,
                                        */
                                        vOrderInstallationInfo.INST_STATE INST_STATE  ,
                                        vOrderInstallationInfo.INST_AREA INST_AREA  ,
                                        /*
                                        vOrderInstallationInfo.INST_POST_CODE INST_POST_CODE  ,
                                        */
                                        vOrderInstallationInfo.INST_CNT_NAME INST_CNT_NAME  ,
                                        vOrderInstallationInfo.INST_CNT_NRIC INST_CNT_NRIC  ,
                                        vOrderInstallationInfo.INST_CNT_EMAIL INST_CNT_EMAIL  ,
                                        vOrderInstallationInfo.INST_CNT_TEL_M INST_CNT_TEL_M  ,
                                        vOrderInstallationInfo.INST_CNT_TEL_O INST_CNT_TEL_O  ,
                                        vOrderInstallationInfo.INST_CNT_TEL_R INST_CNT_TEL_R  ,
                                        vOrderInstallationInfo.INST_CNT_TEL_F INST_CNT_TEL_F  ,
                                        vOrderInstallationInfo.INST_CNT_GENDER INST_CNT_GENDER  ,
                                        vOrderInstallationInfo.FIRST_INSTALL_NO FIRST_INSTALL_NO  ,
                                        vOrderInstallationInfo.FIRST_INSTALL_CT_CODE FIRST_INSTALL_CT_CODE  ,
                                        vOrderInstallationInfo.FIRST_INSTALL_CT_NAME FIRST_INSTALL_CT_NAME  ,
                                        vOrderInstallationInfo.FIRST_INSTALL_DT FIRST_INSTALL_DT  ,
                                        vOrderInstallationInfo.FIRST_INSTALL_REM FIRST_INSTALL_REM  ,
                                        vOrderInstallationInfo.FIRST_INSTALL_SIRIM_NO FIRST_INSTALL_SIRIM_NO  ,
                                        vOrderInstallationInfo.FIRST_INSTALL_SERIAL_NO FIRST_INSTALL_SERIAL_NO  ,
                                        vOrderInstallationInfo.LAST_INSTALL_NO LAST_INSTALL_NO  ,
                                        vOrderInstallationInfo.LAST_INSTALL_CT_CODE LAST_INSTALL_CT_CODE  ,
                                        vOrderInstallationInfo.LAST_INSTALL_CT_NAME LAST_INSTALL_CT_NAME  ,
                                        vOrderInstallationInfo.LAST_INSTALL_DT LAST_INSTALL_DT  ,
                                        vOrderInstallationInfo.LAST_INSTALL_REM LAST_INSTALL_REM  ,
                                        vOrderInstallationInfo.LAST_INSTALL_SIRIM_NO LAST_INSTALL_SIRIM_NO  ,
                                        vOrderInstallationInfo.LAST_INSTALL_SERIAL_NO LAST_INSTALL_SERIAL_NO  ,
                                        vOrderInstallationInfo.DSC_ID DSC_ID  ,
                                        vOrderInstallationInfo.DSC_CODE DSC_CODE  ,
                                        vOrderInstallationInfo.DSC_NAME DSC_NAME  ,
                                        vOrderInstallationInfo.INSTCT INSTCT  ,
                                        vOrderInstallationInfo.PREFER_INST_DT PREFER_INST_DT  ,
                                        vOrderInstallationInfo.PREFER_INST_TM PREFER_INST_TM  ,
                                        vOrderInstallationInfo.INSTALL_ADDR_ID INSTALL_ADDR_ID  ,
                                        vOrderInstallationInfo.INSTALL_CNTC_ID INSTALL_CNTC_ID  ,
                                        vOrderInstallationInfo.INST_CNT_DEPT INST_CNT_DEPT  ,
                                        vOrderInstallationInfo.INST_CNT_POST INST_CNT_POST  ,
                                        vOrderInstallationInfo.VRIFY_REM VRIFY_REM
                                 FROM SAL1010V vOrderInstallationInfo ) Extent2   ON Extent2.ORD_ID = Extent1.ORD_ID
                               WHERE  1=1
                                        <if test="appTypeList != '' and appTypeList != null">
                                        AND ( (CASE WHEN ( Extent1.APP_TYPE_ID IS NOT NULL ) THEN Extent1.APP_TYPE_ID ELSE 0 END) IN (
                                            <foreach collection="appTypeList" index="index" separator=",">
                                                '${appTypeList[index]}'
                                            </foreach>
                                         ))
                                        </if>
                                        AND ( 1 = Extent1.ORD_STUS_ID )
                                        <if test="keyInBranchList != '' and keyInBranchList != null">
                                        AND ( (CASE WHEN ( Extent1.KEYIN_BRNCH_ID IS NOT NULL ) THEN Extent1.KEYIN_BRNCH_ID ELSE 0 END) IN (
                                            <foreach collection="keyInBranchList" index="index" separator=",">
                                                '${keyInBranchList[index]}'
                                            </foreach>
                                        ))
                                        </if>
                                        <if test="dscBranchList != '' and dscBranchList != null">
                                        AND ( (CASE WHEN ( Extent1.DSC_BRNCH_ID IS NOT NULL ) THEN Extent1.DSC_BRNCH_ID ELSE 0 END) IN (
                                            <foreach collection="dscBranchList" index="index" separator=",">
                                                '${dscBranchList[index]}'
                                            </foreach>
                                        ) )
                                        </if>
                             ) Filter1
                              LEFT JOIN ( SELECT vMemberOrg.MEM_ID MEM_ID  ,
                                                 vMemberOrg.MEM_CODE MEM_CODE  ,
                                                 vMemberOrg.MEM_LVL MEM_LVL  ,
                                                 vMemberOrg.DEPT_CODE DEPT_CODE  ,
                                                 vMemberOrg.GRP_CODE GRP_CODE  ,
                                                 vMemberOrg.ORG_CODE ORG_CODE  ,
                                                 vMemberOrg.TOP_ORG_CODE TOP_ORG_CODE  ,
                                                 vMemberOrg.MEM_UP_ID MEM_UP_ID  ,
                                                 vMemberOrg.LVL3_UP_ID LVL3_UP_ID  ,
                                                 vMemberOrg.LVL2_UP_ID LVL2_UP_ID  ,
                                                 vMemberOrg.LVL1_UP_ID LVL1_UP_ID  ,
                                                 vMemberOrg.LVL0_UP_ID LVL0_UP_ID
                                          FROM ORG1001V vMemberOrg ) Extent3   ON Extent3.MEM_ID = Filter1.OrderMemID
                                LEFT JOIN ( SELECT Extent4.NAME NAME1  ,
                                              Extent4.NRIC NRIC1  ,
                                              Extent4.EMAIL EMAIL  ,
                                              Extent5.SALES_ORD_ID SALES_ORD_ID  ,
                                              Extent5.SALES_ORD_NO SALES_ORD_NO  ,
                                              Extent5.SALES_DT SALES_DT  ,
                                              Extent5.APP_TYPE_ID APP_TYPE_ID
                                 FROM SAL0029D Extent4
                                        JOIN SAL0001D Extent5   ON ( Extent5.CUST_ID = Extent4.CUST_ID )) Extent6 ON Extent6.SALES_ORD_ID = Filter1.OrderID1
                        WHERE  1=1
                                 <if test="orderNo != '' ">
                                 AND ( Filter1.OrderNo = #{orderNo} )
                                 </if>
                                 <if test="orderDateFrom != '' ">
                                 AND ( (CASE WHEN ( Filter1.OrderDate IS NOT NULL ) THEN TO_DATE(Filter1.OrderDate, 'YYYY-MM-DD HH24:MI:SS') ELSE TO_DATE('1900-01-01 00:00:00','YYYY-MM-DD HH24:MI:SS') END)  <![CDATA[>=]]> TO_DATE(#{orderDateFrom}, 'YYYY-MM-DD HH24:MI:SS') )
                                 </if>
                                 <if test="orderDateTo != '' ">
                                 AND ( (CASE WHEN ( Filter1.OrderDate IS NOT NULL ) THEN TO_DATE(Filter1.OrderDate, 'YYYY-MM-DD HH24:MI:SS') ELSE TO_DATE('1900-01-01 00:00:00','YYYY-MM-DD HH24:MI:SS') END)  <![CDATA[<=]]> TO_DATE(#{orderDateTo}, 'YYYY-MM-DD HH24:MI:SS') )
                                 </if>
                                 <if test="custId != '' ">
                                 AND ( (CASE WHEN ( Filter1.CustomerID IS NOT NULL ) THEN Filter1.CustomerID ELSE 0 END) = #{custId} )
                                 </if>
                                 <if test="custName != '' ">
                                 AND ( Filter1.CustomerName LIKE '%' || #{custName} ||' %' ESCAPE '~' )
                                 </if>
                                 <if test="custIC != '' " >
                                 AND ( Filter1.CustomerIC LIKE '%' || #{custIC} || '%' ESCAPE '~' )
                                 </if>
                                 <if test="productId != '' ">
                                 AND ( Filter1.StockID = #{productId} )
                                 </if>
                                 <if test="memberCode != '' ">
                                 AND ( Filter1.OrderMemCode = #{memberCode} )
                                 </if>
                                 <if test="refNo != '' ">
                                 AND ( Filter1.OrderRefNo = #{refNo} )
                                 </if>
                                 <if test="poNo != '' ">
                                 AND ( Filter1.OrderPONo = #{poNo} )
                                 </if>
                                 <if test="contactNo != '' ">
                                 AND ( ( Filter1.OrderMailTelF LIKE '%' || #{contactNo} || '%' ESCAPE '~' )
                                         OR ( Filter1.OrderMailTelM LIKE '%' || #{contactNo} || '%' ESCAPE '~' )
                                         OR ( Filter1.OrderMailTelO LIKE '%' || #{contactNo} || '%' ESCAPE '~' )
                                         OR ( Filter1.OrderMailTelR LIKE '%' || #{contactNo} || '%' ESCAPE '~' )
                                         OR ( Filter1.OrderInstTelF LIKE '%' || #{contactNo} || '%' ESCAPE '~' )
                                         OR ( Filter1.OrderInstTelM LIKE '%' || #{contactNo} || '%' ESCAPE '~' )
                                         OR ( Filter1.OrderInstTelO LIKE '%' || #{contactNo} || '%' ESCAPE '~' )
                                         OR ( Filter1.OrderInstTelR LIKE '%' || #{contactNo} || '%' ESCAPE '~' ) )
                                 </if>
                                ORDER BY Filter1.OrderNo ASC
    </select>

    <select id="selectPenaltyBillDate" parameterType="Map" resultType="egovMap">
       SELECT
            Extent1.SALES_ORD_ID   ,
            Extent1.SALES_ORD_NO   ,
            Extent2.STK_RETN_ID ,
            Extent2.RETN_NO ,
            NVL(TO_NUMBER(TO_CHAR(Extent2.UPD_DT,'YYYY')),1900) AS BILL_DT_YEAR,
            NVL(TO_NUMBER(TO_CHAR(Extent2.UPD_DT,'MM')),1) AS BILL_DT_MONTH,
            NVL(Extent2.UPD_DT,TO_DATE('1900-01-01','YYYY-MM-DD')) AS BILL_DT
        FROM
            SAL0001D Extent1
            JOIN LOG0038D Extent2   ON Extent2.SALES_ORD_ID = Extent1.SALES_ORD_ID
            AND Extent2.STUS_CODE_ID = 4
            AND Extent2.TYPE_ID = 296
        WHERE
            1=1
            <if test="orderNo != null and orderNo != '' ">
            AND Extent1.SALES_ORD_NO = #{orderNo}
            </if>
            <if test="billNo != null and billNo != '' ">
            AND  Extent2.RETN_NO = #{billNo}
            </if>
        ORDER BY Extent2.STK_RETN_ID DESC

    </select>
</mapper>