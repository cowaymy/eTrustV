<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.ecash.service.impl.ECashRefundMapper">

    <!--E-Cash - eCash List -->
    <select id="selectECashRefundList" parameterType="Map" resultType="egovMap">
		SELECT
			EXTENT1.FILE_BATCH_ID,
			EXTENT1.FILE_BATCH_NAME,
			EXTENT1.FILE_BATCH_TOT_RCORD,
			EXTENT1.FILE_BATCH_TOT_AMT,
			EXTENT1.FILE_BATCH_REJCT_RCORD,
			EXTENT1.FILE_BATCH_APPV_RCORD,
			EXTENT1.FILE_BATCH_APPV_AMT,
			EXTENT1.FILE_BATCH_STUS_ID,
			EXTENT2.CODE as STUS_CODE,
			EXTENT2.NAME,
			EXTENT1.FILE_BATCH_REM,
			EXTENT1.FILE_BATCH_CRT_USER_ID,
			EXTENT3.USER_NAME as CRT_USER_NAME,
			NVL(TO_CHAR(EXTENT1.FILE_BATCH_CRT,'DD/MM/YYYY hh:mi:ss A.M.'),'01-01-1900 AM 00:00:00') AS FILE_BATCH_CRT,
			(CASE WHEN Extent1.FILE_BATCH_UPD IS NOT NULL
                THEN NVL(TO_CHAR(Extent1.FILE_BATCH_UPD,'DD/MM/YYYY hh:mi:ss A.M.'),'01-01-1900 AM 00:00:00')
                ELSE NULL END) AS FILE_BATCH_UPD,
			EXTENT4.USER_NAME,
			EXTENT1.FILE_BATCH_UPD_USER_ID,
			(CASE WHEN Extent1.FILE_BATCH_CHRG_BACK_DT IS NOT NULL
                THEN NVL(TO_CHAR(Extent1.FILE_BATCH_CHRG_BACK_DT,'DD/MM/YYYY hh:mi:ss A.M.'),'01-01-1900 AM 00:00:00')
                ELSE NULL END) AS FILE_BATCH_CHRG_BACK_DT
		FROM PAY0242M EXTENT1
			JOIN SYS0038M EXTENT2 on EXTENT2.STUS_CODE_ID = EXTENT1.FILE_BATCH_STUS_ID
			LEFT JOIN SYS0047M EXTENT3 on EXTENT3.USER_ID =
			EXTENT1.FILE_BATCH_CRT_USER_ID
			LEFT JOIN SYS0047M EXTENT4 on EXTENT4.USER_ID =
			EXTENT1.FILE_BATCH_UPD_USER_ID
		WHERE
		1=1
            <if test="batchId != null and batchId != ''">
            AND Extent1.FILE_BATCH_ID = #{batchId}
            </if>
            <if test="creator != null and creator != ''">
            AND EXTENT4.USER_NAME =#{creator}
            </if>
            <if test="createDt1 != null and createDt2 != null and createDt1 != '' and createDt2 != '' ">
                AND Extent1.FILE_BATCH_CRT <![CDATA[   >= ]]>  TO_DATE(TO_CHAR(TO_DATE(#{createDt1},'DD/MM/YYYY'),'YYYYMMDD') || '000000','yyyymmddhh24miss')
                AND Extent1.FILE_BATCH_CRT <![CDATA[   <   ]]>  TO_DATE(TO_CHAR(TO_DATE(#{createDt2},'DD/MM/YYYY'),'YYYYMMDD') || '000000','yyyymmddhh24miss') + 1
            </if>
            <if test="status != null and status != ''">
                AND Extent1.FILE_BATCH_STUS_ID = #{status}
            </if>
            <if test="refundDt1 != null and refundDt2 != null and refundDt1 != '' and refundDt2 != '' ">
                AND Extent1.FILE_BATCH_CHRG_BACK_DT <![CDATA[   >= ]]>  TO_DATE(TO_CHAR(TO_DATE(#{refundDt1},'DD/MM/YYYY'),'YYYYMMDD') || '000000','yyyymmddhh24miss')
                AND Extent1.FILE_BATCH_CHRG_BACK_DT <![CDATA[   < ]]>  TO_DATE(TO_CHAR(TO_DATE(#{refundDt2},'DD/MM/YYYY'),'YYYYMMDD') || '000000','yyyymmddhh24miss') + 1
            </if>
            <if test="batchName != null and batchName != ''">
                AND Extent1.FILE_BATCH_NAME = #{batchName}
            </if>
         ORDER BY Extent1.FILE_BATCH_ID
    </select>

    <!-- E-Cash - Deactivate e-AutoDebitDecution -->
    <update id="deactivateEAutoDebitRefund" parameterType="Map" >
        UPDATE PAY0242M SET
              FILE_BATCH_STUS_ID = 8
            , FILE_BATCH_UPD_DT = SYSDATE
            , FILE_BATCH_UPD_USER_ID = #{userId}
        WHERE
            FILE_BATCH_ID = #{fileBatchId}
    </update>

    <!-- E-Cash - Deactivate e-AutoDebitDecution_Sub -->
    <update id="deactivateEAutoDebitRefundSub" parameterType="Map" >
        UPDATE SAL0152M SET
              FILE_ITM_STUS_ID = 8
            , FILE_ITM_UPD = SYSDATE
            , FILE_ITM_UPD_USER_ID = #{userId}
        WHERE
            FILE_BATCH_ID = #{fileBatchId}
    </update>

<!--     <resultMap id="resultECashMap" type="egovMap" />
    <select id="createECashDeduction" statementType="CALLABLE" parameterType="Map">
        {
            call SP_INST_ECASH_GENDEDUCTION( #{new_issueBank},#{userId},#{eCash, mode=OUT, jdbcType=CURSOR, javaType=ResultSet, resultMap=resultECashMap})
        }
    </select>

    <delete id="deleteECashResultItem" parameterType="Map" >
        DELETE FROM SAL0211T WHERE ITM_ID = #{fileBatchId}
    </delete>

    <insert id="insertECashResultItem" parameterType="Map" >
        INSERT INTO SAL0211T (ITM_CNT,ITM_ID,APPV_CODE,RESPNS_CODE) VALUES (#{itmCnt},#{itmId},#{appvCode},#{respnsCode});
    </insert>

    <update id="updateECashResult" statementType="CALLABLE" parameterType="Map">
        {
            call SP_UPD_ECASH_DEDUCTIONRESULT(#{fileBatchId},#{fileBatchBankId},#{userId},#{fileName},#{settleDate})
        }
    </update>-->
</mapper>