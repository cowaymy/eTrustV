<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.billing.service.impl.BillingMgmtMapper">

    <!-- Reconciliation 리스트 조회 -->
	<select id="selectBillingMgnt" parameterType="Map" resultType="egovMap">
	   SELECT Extent1.TASK_ID TASK_ID  ,
       Extent1.TASK_TYPE TASK_TYPE  ,
       Extent1.BILLING_YEAR BILLING_YEAR  ,
       Extent1.BILLING_MONTH BILLING_MONTH  ,
       Extent1.TOT_CNT TOT_CNT  ,
       Extent1.TOT_AMT TOT_AMT  ,
       Extent1.START_DT START_DT  ,
       Extent1.STUS STUS  ,
       Extent1.END_DT END_DT  ,
       Extent1.IS_CNFM IS_CNFM  ,
       Extent1.IS_INVC_GENRT IS_INVC_GENRT  ,
       Extent1.CRT_DT CRT_DT  ,
       Extent1.CRT_USER_ID CRT_USER_ID  ,
       Extent1.UPD_DT UPD_DT  ,
       Extent1.UPD_USER_ID UPD_USER_ID  ,
       Extent1.TASK_REM TASK_REM  
  FROM PAY0047D Extent1
 WHERE  'ADV BILL'   <![CDATA[<>]]> Extent1.TASK_TYPE
 <if test="year != null and year != '' ">
    AND BILLING_YEAR = #{year}
 </if>
 <if test="month != null and month != '' ">
    AND BILLING_MONTH = #{month}
 </if>
  ORDER BY Extent1.TASK_ID DESC
	</select>
	
	<select id="selectBillingMaster" parameterType="Map" resultType="egovMap">
	   SELECT Extent1.TASK_ID TASK_ID  ,
	       Extent1.TASK_TYPE TASK_TYPE  ,
	       Extent1.BILLING_YEAR BILLING_YEAR  ,
	       Extent1.BILLING_MONTH BILLING_MONTH  ,
	       Extent1.TOT_CNT TOT_CNT  ,
	       Extent1.TOT_AMT TOT_AMT  ,
	       Extent1.START_DT START_DT  ,
	       Extent1.STUS STUS  ,
	       Extent1.END_DT END_DT  ,
	       Extent1.IS_CNFM IS_CNFM  ,
	       Extent1.CRT_DT CRT_DT  ,
	       Extent1.CRT_USER_ID CRT_USER_ID  ,
	       Extent1.UPD_DT UPD_DT  ,
	       Extent1.UPD_USER_ID UPD_USER_ID  ,
	       Extent1.IS_INVC_GENRT IS_INVC_GENRT  ,
	       Extent1.TASK_REM TASK_REM  
	   FROM PAY0047D Extent1
	   WHERE  Extent1.TASK_ID = #{taskId}
	               AND ROWNUM = 1 
	</select>
	
	<select id="selectBillingDetail" parameterType="Map" resultType="egovMap">
	   SELECT Extent1.TASK_ID TASK_ID  ,
	       Extent1.TASK_BILL_SO_ID TASK_BILL_SO_ID  ,
	       Extent1.TASK_REF_NO TASK_REF_NO  ,
	       Extent1.TASK_BILL_TYPE_ID TASK_BILL_TYPE_ID  ,
	       Extent2.CODE_NAME CODE_NAME  ,
	       Extent3.SALES_ORD_NO SALES_ORD_NO  ,
	       Extent4.NAME NAME  ,
	       0 C1  ,
	       TO_NUMBER(Extent1.TASK_BILL_AMT) TASK_BILL_AMT  ,
	       TO_DATE(Extent1.TASK_REF_DT_TM) TASK_REF_DT_TM  ,
	       CASE 
	            WHEN ( Extent1.TASK_BILL_GRP_ID IS NULL ) THEN 0
	       ELSE Extent1.TASK_BILL_GRP_ID
	          END TASK_BILL_GRP_ID  ,
	       TO_NUMBER(Extent1.TASK_BILL_INST_NO) TASK_BILL_INST_NO  
	  FROM PAY0048D Extent1
	         JOIN SYS0013M Extent2   ON Extent2.CODE_ID = Extent1.TASK_BILL_TYPE_ID
	         JOIN SAL0001D Extent3   ON Extent3.SALES_ORD_ID = Extent1.TASK_BILL_SO_ID
	         JOIN SAL0029D Extent4   ON Extent4.CUST_ID = Extent3.CUST_ID
	  WHERE  Extent1.TASK_ID = #{taskId}
	  <if test="orderNo != 'null' and orderNo != '' ">
	               AND Extent3.SALES_ORD_NO = #{orderNo}
	  </if>  
	  <if test="billNo != null and billNo != '' ">
	               AND Extent1.TASK_REF_NO = #{billNo}
	  </if> 
	  <if test="custName != null and custName != '' ">
	               AND Extent4.NAME = #{custName}
	  </if>
	   <if test="group != null and group != '' ">
	               AND (CASE WHEN (Extent1.TASK_BILL_GRP_ID IS NULL) THEN 0 ELSE Extent1.TASK_BILL_GRP_ID END) = #{group}
	   </if>
	  ORDER BY Extent1.TASK_BILL_SO_ID ASC
	</select>
	
	<resultMap id="earyBillMap" type="egovMap"></resultMap>
	<select id="callEaryBillProcedure" statementType="CALLABLE" parameterType="Map">
        {call SP_INITIIZE_BILL_GST_EARY_RENT(#{year}, #{month}, #{userId}), #{p1, mode=OUT, jdbcType=INTEGER, javaType=int, resultMap=earyBillillMap}}
    </select>
    
    <resultMap id="billMap" type="egovMap"></resultMap>
    <select id="callBillProcedure" statementType="CALLABLE" parameterType="Map">
        {call SP_INITIIZE_BILL_GST_RENT(#{year}, #{month}, #{userId}, #{p1, mode=OUT, jdbcType=INTEGER, javaType=int, resultMap=billMap})}
    </select>
    
    <select id="getExistBill" parameterType="Map" resultType ="java.lang.Integer">
        SELECT count(*) cnt
		FROM PAY0047D Extent1
		WHERE  ( 1 = Extent1.IS_CNFM ) 
                  AND ( Extent1.TASK_ID = #{taskId} )
		<if test="month != '' and month != null">
		          AND ( Extent1.BILLING_MONTH = #{month} )
		</if>
		<if test="year != '' and year != null">
		          AND ( Extent1.BILLING_YEAR = #{year} )
		</if>
		          AND ROWNUM <![CDATA[<=]]> 1
    </select>
    
    <resultMap id="cEarlyBills" type="egovMap"></resultMap>
    <select id="confirmEarlyBills" statementType="CALLABLE" parameterType="Map">
        {call SP_GEN_BILL_GST_EARLY_RENTAL(#{taskId}, #{userId}, #{p1, mode=OUT, jdbcType=INTEGER, javaType=int, resultMap=cEarlyBills})}
    </select>
    
    <resultMap id="cBills" type="egovMap"></resultMap>
    <select id="confirmBills" statementType="CALLABLE" parameterType="Map">
        {call SP_GEN_BILL_GST_RENTAL(#{taskId}, #{userId}, #{p1, mode=OUT, jdbcType=INTEGER, javaType=int, resultMap=cBills})}
    </select>
</mapper>