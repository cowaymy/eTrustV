<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.payment.payment.service.impl.SearchPaymentMapper">
    
    <resultMap id="paymentListResultMap" type="EgovMap">
        <result property="payItmCcNo" column="PAY_ITM_CC_NO" jdbcType="CLOB" javaType="java.lang.String"/>
        <result property="c1" column="C1" jdbcType="CLOB" javaType="java.lang.String"/>
        <result property="payItmEncryptCcNo" column="PAY_ITM_ENCRYPT_CC_NO" jdbcType="BLOB" javaType="java.lang.String"/>
        <result property="payItmRem" column="PAY_ITM_REM" jdbcType="CLOB" javaType="java.lang.String"/>
    </resultMap>
      
    <!--Search Payment Order List(Master Grid) 리스트 조회  -->
    <select id="selectOrderList" parameterType="Map" resultType="egovMap">
        SELECT
            TRX_ID,
			TRX_DT,
			TRX_AMT,
			PAY_ID,
			OR_NO,
			TR_NO,
			PAY_DT,
			LAST_UPD_DT,
			PAY_TYPE_ID,
			PAY_TYPE_NAME,
			LAST_UPD_USER_ID,
			LAST_UPD_USER_NAME,
			SALES_ORD_ID,
			SALES_ORD_NO,
			OR_AMT,
			PO_NO,
			CLCTR_BRNCH_ID,
			CLCTR_BRNCH_CODE,
			CLCTR_BRNCH_NAME,
			CUST_ID,
			CUST_NAME,
			CUST_IC,
			CUST_TYPE_ID,
			CUST_TYPE_NAME,
			PRODUCT_CTGRY_ID,
			PRODUCT_CTGRY_NAME,
			PRODUCT_ID,
			PRODUCT_CODE,
			PRODUCT_DESC,
			KEYIN_USER_ID,
			KEYIN_USER_NAME,
			APP_TYPE_ID,
			APP_TYPE_NAME,
			CLCTR_NAME,
			CLCTR_CODE,
			KEYIN_BRNCH_ID,
			KEYIN_BRNCH_CODE,
			KEYIN_BRNCH_NAME,
			DEBTOR_ACC_ID,
			DEBTOR_ACC_CODE,
			DEBTOR_ACC_DESC,
			SALES_MEM_ID,
			SALES_MEM_CODE,
			SALES_MEM_NAME,
			VIRTL_ACC_NO,
			HP_CODE,
			HP_NAME,
			HP_ID,
			CLCTR_ID,
			ALLOW_COMM,
			ADV_MONTH,
			TR_ISSU_DT,
			BATCH_PAY_ID
	    FROM           
	        PAY1001V 
	    WHERE
	        1=1
	        <if test="orderNo != ''">
			  AND SALES_ORD_NO = #{orderNo}
	        </if>
	        <if test="payDate1 != '' and payDate2 != '' "> 
				AND PAY_DT  <![CDATA[   >= ]]> TO_DATE(TO_CHAR(TO_DATE(#{payDate1},'DD/MM/YYYY'),'YYYYMMDD') || '000000','yyyymmddhh24miss')
		        AND PAY_DT  <![CDATA[  < ]]>  TO_DATE(TO_CHAR(TO_DATE(#{payDate2},'DD/MM/YYYY'),'YYYYMMDD') || '000000','yyyymmddhh24miss') + 1
			</if>
	        <if test="applicationType != ''"> 
			AND APP_TYPE_ID = #{applicationType}
			</if>
	        <if test="orNo != ''"> 
			AND OR_NO = #{orNo} 
			</if>
	        <if test="poNo != ''">
			AND PO_NO = #{poNo} 
			</if>
	        <if test="paymentType != ''">
			AND PAY_TYPE_ID = #{paymentType}
			</if>
	        <if test="customerId != ''"> 
			AND CUST_ID = #{customerId}
			</if>
	        <if test="branchId != ''"> 
			AND KEYIN_BRNCH_ID = #{branchId}
			</if>
	        <if test="userId != ''"> 
			AND KEYIN_USER_ID = #{userId}
			</if>
	        <if test="customerName != ''"> 
			AND CUST_NAME LIKE '%' || #{customerName} || '%'
			</if>
	        <if test="customerIC != ''">
			AND CUST_IC = #{customerIC}
			</if>
	        <if test="trNo != ''"> 
			AND TR_NO = #{trNo}
			</if>
	        <if test="chequeNo != ''"> 
			AND PAY_ID IN (SELECT PAY_ID from PAY0065D WHERE PAY_ITM_CHQ_NO = #{chequeNo})
			</if>
	        <if test="crcNo != ''">
			AND PAY_ID IN (SELECT PAY_ID from PAY0065D WHERE PAY_ITM_ORI_CC_NO = #{crcNo})
			</if>
	        <if test="bankAccount != ''">
			AND PAY_ID IN (SELECT PAY_ID from PAY0065D WHERE PAY_ITM_ISSU_BANK_ID = #{bankAccount})
			</if>
	        <if test="batchPaymentId != '' ">
			AND BATCH_PAY_ID = #{batchPaymentId}
			</if>
	    ORDER BY PAY_ID             
    </select>
    
    <!--Search Payment : PaymentList (Slave Grid) 리스트 조회  -->
    <select id="selectPaymentList" parameterType="Map" resultMap="paymentListResultMap">
        SELECT 
            Extent1.PAY_ITM_ID, 
            Extent1.PAY_ID, 
            Extent1.PAY_ITM_MODE_ID, 
            Extent2.CODE_NAME, 
            Extent1.PAY_ITM_REF_NO, 
            Extent1.PAY_ITM_CC_NO, 
            CASE WHEN Extent1.PAY_ITM_ORI_CC_NO IS NOT NULL THEN Extent1.PAY_ITM_ORI_CC_NO ELSE empty_clob() END AS C1, 
		    Extent1.PAY_ITM_ENCRYPT_CC_NO,
		    Extent1.PAY_ITM_CC_TYPE_ID, 
		    Extent3.CODE_NAME AS CODE_NAME1, 
		    Extent1.PAY_ITM_CC_HOLDER_NAME, 
		    Extent1.PAY_ITM_CC_EXPR_DT, 
		    Extent1.PAY_ITM_CHQ_NO, 
		    Extent1.PAY_ITM_ISSU_BANK_ID, 
		    CASE WHEN Extent4.BANK_ID IS NOT NULL THEN Extent4.CODE ELSE '' END AS C2, 
		    Extent4.NAME, 
		    Extent1.PAY_ITM_AMT, 
		    Extent1.PAY_ITM_IS_ONLINE, 
		    Extent1.PAY_ITM_BANK_ACC_ID AS PayItemBankAccID, 
		    CASE WHEN Extent5.ACC_ID IS NOT NULL THEN Extent5.ACC_CODE ELSE '' END AS C3, 
		    Extent5.ACC_DESC, 
		    Extent1.PAY_ITM_REF_DT, 
		    Extent1.PAY_ITM_APPV_NO, 
		    Extent1.PAY_ITM_REM, 
		    Extent1.PAY_ITM_STUS_ID, 
		    Extent6.NAME AS NAME1, 
		    Extent1.PAY_ITM_IS_LOK, 
		    Extent1.PAY_ITM_BANK_CHRG_AMT, 
		    Extent1.PAY_ITM_IS_THRD_PARTY, 
		    Extent1.PAY_ITM_THRD_PARTY_IC, 
		    Extent1.PAY_ITM_MID, 
		    Extent1.PAY_ITM_GRP_ID, 
		    Extent1.PAY_ITM_REF_ITM_ID, 
		    Extent1.ETC3, 
		    CASE WHEN Extent1.PAY_ITM_EFT_NO IS NOT NULL THEN Extent1.PAY_ITM_EFT_NO ELSE '' END AS C4, 
		    CASE WHEN Extent1.PAY_ITM_RUNNG_NO IS NOT NULL THEN Extent1.PAY_ITM_RUNNG_NO ELSE '' END AS C5, 
		    CASE WHEN Extent1.PAY_ITM_CARD_TYPE_ID IS NOT NULL THEN Extent1.PAY_ITM_CARD_TYPE_ID ELSE 0 END AS C6, 
		    CASE WHEN Extent7.CODE_ID IS NOT NULL THEN Extent7.CODE_NAME ELSE '' END AS C7, 
		    CASE WHEN Extent1.PAY_ITM_CARD_MODE_ID IS NOT NULL THEN 
		                                                            CASE WHEN 1298 = Extent1.PAY_ITM_CARD_MODE_ID THEN 'On' 
		                                                                 WHEN 1299 = Extent1.PAY_ITM_CARD_MODE_ID THEN 'Off' 
		                                                                 WHEN 1300 = Extent1.PAY_ITM_CARD_MODE_ID THEN 'PNP' 
		                                                                 ELSE '-' END 
		         WHEN 1 = Extent1.PAY_ITM_IS_ONLINE THEN 'On' 
		         WHEN 0 = Extent1.PAY_ITM_IS_ONLINE THEN 'Off' ELSE '-' END AS C8
        FROM       
		    PAY0065D Extent1
		    LEFT OUTER JOIN SYS0013M Extent2 ON Extent2.CODE_ID = Extent1.PAY_ITM_MODE_ID
		    LEFT OUTER JOIN SYS0013M Extent3 ON Extent3.CODE_ID = Extent1.PAY_ITM_CC_TYPE_ID
		    LEFT OUTER JOIN SYS0004M Extent4 ON Extent4.BANK_ID = Extent1.PAY_ITM_ISSU_BANK_ID
		    LEFT OUTER JOIN SYS0001M Extent5 ON Extent5.ACC_ID = Extent1.PAY_ITM_BANK_ACC_ID
		    LEFT OUTER JOIN SYS0038M Extent6 ON Extent6.STUS_CODE_ID = Extent1.PAY_ITM_STUS_ID
		    LEFT OUTER JOIN SYS0013M Extent7 ON Extent7.CODE_ID = Extent1.PAY_ITM_CARD_TYPE_ID
		WHERE 
		    Extent1.PAY_ITM_STUS_ID = 1
		    AND Extent1.PAY_ID = #{payId}
                      
    </select>
     
         <select id="selectSalesList" parameterType="Map" resultType="egovMap">
     SELECT V.ORG_CODE tOrgCode  ,
       V.GRP_CODE tGrpCode  ,
       V.DEPT_CODE tDeptCode  ,
       V.ORG_CODE OrgCode ,
       V.GRP_CODE GrpCode,
       V.DEPT_CODE DeptCode,
       R1.MEM_CODE MemberCode,
       COUNT(ACC.ACC_DEBT_ORD_ID)  sUnit  ,
       SUM(CASE 
                WHEN Sub.ACC_DEBT_SUB_OPNG_OTSTND <![CDATA[< ]]> 0 THEN 0
           ELSE Sub.ACC_DEBT_SUB_OPNG_OTSTND
              END)  sLMOS  ,
       SUM(Sub.ACC_DEBT_SUB_CURR_CHRG)  sCMCHG  ,
       SUM(Sub.ACC_DEBT_SUB_OPNG_COLCT_TRGET)  sCLCTG  ,
       SUM(Sub.ACC_DEBT_SUB_CURR_COLCT)  sCOL  ,
       SUM(Sub.ACC_DEBT_SUB_CURR_ADJ)  sADJ  ,
       (SUM(Sub.ACC_DEBT_SUB_OPNG_COLCT_TRGET)  + (SUM(Sub.ACC_DEBT_SUB_CURR_COLCT)  + SUM(Sub.ACC_DEBT_SUB_CURR_ADJ) )) sOUT  ,
       /*SUM(Sub.AccDebtSubTotalOutstanding)CUROUTSTD,*/
       (CASE 
             WHEN (SUM(Sub.ACC_DEBT_SUB_OPNG_COLCT_TRGET) ) = 0 THEN 0
       ELSE round(((SUM(Sub.ACC_DEBT_SUB_OPNG_COLCT_TRGET)  + (SUM(Sub.ACC_DEBT_SUB_CURR_COLCT)  + SUM(Sub.ACC_DEBT_SUB_CURR_ADJ) )) / (SUM(Sub.ACC_DEBT_SUB_OPNG_COLCT_TRGET) ) * 100), 2)
          END) sRate  
  FROM PAY0052S ACC
         JOIN PAY0053S Sub   ON Sub.ACC_DEBT_ORD_ID = ACC.ACC_DEBT_ORD_ID
         JOIN SAL0001D SOM   ON SOM.SALES_ORD_ID = ACC.ACC_DEBT_ORD_ID
         LEFT JOIN SAL0071D SCH   ON SCH.SALES_ORD_ID = SOM.SALES_ORD_ID
         JOIN ORG0001D R1   ON SOM.MEM_ID = R1.MEM_ID
         AND R1.MEM_TYPE = 2
         JOIN ORG1001V V   ON V.MEM_ID = R1.MEM_ID
 WHERE  R1.STUS = 1
          AND SOM.APP_TYPE_ID = 66
          
          --AND SOM.DeptCode like '%CCS%'
          AND Sub.ACC_DEBT_SUB_OPNG_COLCT_TRGET > 0
          AND SOM.STUS_CODE_ID = 4
          AND V.DEPT_CODE <![CDATA[ <> ]]> ' '
          AND ( SCH.STUS_CODE_ID = 'INV'
          OR SCH.STUS_CODE_ID = 'REG' )
      <if test = "orgCode != ''">
               AND V.ORG_CODE = #{orgCode}
      </if>
      <if test = "grpCode != ''">
               AND V.GRP_CODE = #{grpCode}
      </if>
      <if test = "deptCode != ''">
               AND V.DEPT_CODE = #{deptCode}
      </if>
      <if test = "memberCode != ''">
               AND R1.MEM_CODE = #{memberCode}
      </if>
      GROUP BY V.ORG_CODE,V.GRP_CODE,V.DEPT_CODE,R1.MEM_CODE
      
     </select>

</mapper>