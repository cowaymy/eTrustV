<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.services.bs.impl.HsManualMapper">


    <!-- 
        CLOB 컬럼을 사용하기 위해서는 아래와 같이 resultMap을 선언 후
         <select id="selectClobData" parameterType="Map"  resultMap="clobMap"> 와 같이
          resultMap="clobMap" 을 사용해야 함.
    -->
    <resultMap id="clobMap" type="EgovMap">
        <result property="typeDesc" column="type_Desc" jdbcType="CLOB" javaType="java.lang.String"/>
    </resultMap>   
    
    


			



    <select id="selectBranchList" parameterType="Map" resultType="egovMap">

	    SELECT s005m.brnch_id AS CODE_ID
                , s005m.code || '-' || s005m.name AS CODE_NAME
			from SYS0005M s005m
			        ,SYS0013M s0013m
			where s005m.type_id = s0013m.code_id
			and s005m.type_id in (41, 40, 42, 1160, 43, 46, 44, 45, 47)
			order by s005m.CODE ASC           
  
          </select>
  
  
  
  
      <select id="getCdUpMemList" parameterType="Map" resultType="egovMap">
            SELECT A.MEM_ID AS CODE_ID
                    ,A.DEPT_CODE || '-' || B.NAME AS CODE_NAME
            FROM ORG0005D A
                    ,ORG0001D B
                    ,SYS0005M C
            WHERE A.MEM_ID = B.MEM_ID
                AND A.BRNCH_ID = C.BRNCH_ID
                AND A.DEPT_CODE IS NOT NULL
                AND B.STUS IN (1,8)
                AND B.MEM_TYPE = 2                
            <if test="memLvl == '3'.toString()">
                AND A.MEM_LVL = #{memLvl}
                AND A.BRNCH_ID = #{groupCode}
            </if>
            <if test="memLvl == '4'.toString()">
                AND A.MEM_LVL = #{memLvl}
                AND A.MEM_UP_ID = #{groupCode}
            </if>
            ORDER BY DEPT_CODE
       </select>
  
  
  
           <select id="getCdList_1" parameterType="Map" resultType="egovMap">
          
                select b.mem_code as CODY_ID 
                        ,B.MEM_ID  AS MEM_ID
                        ,b.name as CODY_NAME
                        ,b.STUS,EXTENT2.CODE
                from ORG1001V a
                        ,ORG0001D b
                        ,SYS0038M EXTENT2
                where a.MEM_ID = b.MEM_ID
                AND b.STUS = EXTENT2.STUS_CODE_ID
                and b.MEM_TYPE = 2
                and b.stus = '1' 
                and b.BRNCH = #{BrnchCdList}
                order by b.mem_code
                                              
          </select>
       
  
		   <select id="getCdList" parameterType="Map" resultType="egovMap">
		  
				select b.mem_code as CODE_ID 
				        ,b.name as CODE_NAME
				from ORG1001V a
				        ,ORG0001D b
				where a.MEM_ID = b.MEM_ID
				and b.MEM_TYPE = 2
				<if test="groupCode != null and groupCode != ''">
				    and brnch = #{groupCode}
				</if>
				order by b.mem_code
                                              
		  </select>
		  
		  
		  
          <select id="selectHsManualList" parameterType="Map" resultType="egovMap">
              
                            SELECT   rownum as rnum,C.CUST_ID CUST_ID
                                        , C.NAME Name
                                         ,SOM.SALES_ORD_NO SALES_ORD_NO
                                         ,HSM.MONTH
                                         ,HSM.YEAR YEAR
                                         ,HSM.MONTH || '/' || HSM.YEAR HS_DATE
                                         ,HSM.NO
                                         ,HSM.CODY_ID
                                         ,HSM.STUS_CODE_ID STUS_CODE_ID
                                         ,EXTENT2.CODE CODE
                                         ,SOM.BRNCH_ID  AS BRNCH_ID
                                FROM SAL0001D SOM
                                        ,SAL0029D C
                                        ,SYS0013M CORPTYPE 
                                        ,SAL0002D SOD
                                        ,SVC0008D HSM
                                        ,SYS0038M EXTENT2
                                WHERE 1=1
                                AND SOM.CUST_ID = C.CUST_ID
                                AND   C.CORP_TYPE_ID = CORPTYPE.CODE_ID(+)
                                AND   SOM.SALES_ORD_ID = SOD.SALES_ORD_ID 
                                AND SOM.SALES_ORD_ID = HSM.SALES_ORD_ID(+)
                                AND HSM.STUS_CODE_ID = EXTENT2.STUS_CODE_ID(+)
                 <![CDATA[ AND SOM.STUS_CODE_ID <> 8    ]]>   
			                 <if test="ManuaMyBSMonth != null and ManuaMyBSMonth != ''">
		                              AND  hsm.YEAR(+) = #{myBSYear} 
                                      AND  hsm.MONTH(+) = #{myBSMonth} 
			                 </if>                                   
                               <if test="ManuaSalesOrder != null and ManuaSalesOrder != ''">
                                      AND SOM.SALES_ORD_NO = #{ManuaSalesOrder}
                               </if>
                               <if test="ManualCustomer != null and ManualCustomer != ''">
                                      AND c.CUST_ID = #{ManualCustomer}
                               </if>
		                        <if test="saleOrdListSp != null and saleOrdListSp != '' ">
		                            AND SOM.SALES_ORD_NO IN
                                   <foreach item="item" collection="saleOrdListSp" index="index" open="(" separator="," close=")">
		                            #{item}
		                            </foreach>
		                        </if>
                         

          </select>

          
          
          
          
          
          
                    <select id="selectHsManualListPop" parameterType="Map" resultType="egovMap">
              
                            SELECT   rownum as rnum,C.CUST_ID CUST_ID
                                        , C.NAME Name
                                         ,SOM.SALES_ORD_NO SALES_ORD_NO
                                         ,HSM.MONTH
                                         ,HSM.YEAR YEAR
                                         ,HSM.MONTH || '/' || HSM.YEAR HS_DATE
                                         ,HSM.NO
                                         ,HSM.CODY_ID
                                         ,HSM.STUS_CODE_ID STUS_CODE_ID
                                         ,EXTENT2.CODE CODE
                                         ,SOM.BRNCH_ID  AS BRNCH_ID
                                FROM SAL0001D SOM
                                        ,SAL0029D C
                                        ,SYS0013M CORPTYPE 
                                        ,SAL0002D SOD
                                        ,SVC0008D HSM
                                        ,SYS0038M EXTENT2
                                WHERE 1=1
                                AND SOM.CUST_ID = C.CUST_ID
                                AND   C.CORP_TYPE_ID = CORPTYPE.CODE_ID(+)
                                AND   SOM.SALES_ORD_ID = SOD.SALES_ORD_ID 
                                AND SOM.SALES_ORD_ID = HSM.SALES_ORD_ID(+)
                                AND HSM.STUS_CODE_ID = EXTENT2.STUS_CODE_ID(+)
                 <![CDATA[ AND SOM.STUS_CODE_ID <> 8    ]]>   
                             <if test="ManuaMyBSMonth != null and ManuaMyBSMonth != ''">
                                      AND  hsm.YEAR(+) = #{myBSYear} 
                                      AND  hsm.MONTH(+) = #{myBSMonth} 
                             </if>                                   
                               <if test="ManuaSalesOrder != null and ManuaSalesOrder != ''">
                                      AND SOM.SALES_ORD_NO = #{ManuaSalesOrder}
                               </if>
                               <if test="ManualCustomer != null and ManualCustomer != ''">
                                      AND c.CUST_ID = #{ManualCustomer}
                               </if>
                                <if test="saleOrdListSp != null and saleOrdListSp != ''">
                                    AND SOM.SALES_ORD_NO IN
                                   <foreach item="item" collection="saleOrdListSp" index="index" open="(" separator="," close=")">
                                    #{item}
                                    </foreach>
                                </if>
                         

          </select>
          
          
          
          
                  <select id="selectHsAssiinlList" parameterType="Map" resultType="egovMap">
              

                         SELECT Project2.C1 C1  ,
                                    Project2.SCHDUL_ID SCHDUL_ID  ,
                                    Project2.No No  ,
                                    Project2.HS_DATE HS_DATE  ,
                                    Project2.CODY_ID CODY_ID,                                    
                                    Project2.STUS_CODE_ID STUS_CODE_ID  ,
                                    Project2.Code Code  ,
                                    Project2.SALES_ORD_ID SALES_ORD_ID  ,
                                    Project2.SALES_ORD_NO SALES_ORD_NO  ,
                                    Project2.Code1 Code1  ,
                                    Project2.C2 C2  ,
                                    Project2.C3 C3  ,
                                    Project2.C4 C4  ,
                                    Project2.CODY_ID CODY_ID  ,
                                    Project2.C5 C5  ,
                                    Project2.C6 C6  ,
                                    Project2.C7 C7  ,
                                    Project2.INST_STATE INST_STATE  ,
                                    Project2.INST_AREA INST_AREA  ,
                                    Project2.C8 C8  ,
                                    Project2.Name Name  ,
                                    Project2.NRIC NRIC  ,
                                    Project2.CODY_STATUS,
                                    Project2.BRNCH_ID,
                                    Project2.cust_id
                      FROM ( SELECT Project2.SCHDUL_ID SCHDUL_ID  ,
                                    Project2.No No  ,
                                    Project2.HS_DATE HS_DATE   ,
                                    Project2.CODY_ID CODY_ID  ,
                                    Project2.STUS_CODE_ID STUS_CODE_ID  ,
                                    Project2.Code Code  ,
                                    Project2.SALES_ORD_ID SALES_ORD_ID  ,
                                    Project2.SALES_ORD_NO SALES_ORD_NO  ,
                                    Project2.Name Name  ,
                                    Project2.NRIC NRIC  ,
                                    Project2.Code1 Code1  ,
                                    Project2.INST_STATE INST_STATE  ,
                                    Project2.INST_AREA INST_AREA  ,
                                    Project2.C1 C1  ,
                                    Project2.C2 C2  ,
                                    Project2.C3 C3  ,
                                    Project2.C4 C4  ,
                                    Project2.C5 C5  ,
                                    Project2.C6 C6  ,
                                    Project2.C7 C7  ,
                                    Project2.C8 C8  ,
                                    Project2.CODY_STATUS as CODY_STATUS,
                                    Project2.BRNCH_ID as BRNCH_ID,
                                    Project2.cust_id as cust_id,
                                    ROW_NUMBER() OVER ( ORDER BY Project2.SCHDUL_ID ASC  ) row_number  
                             FROM ( SELECT Distinct1.SCHDUL_ID SCHDUL_ID  ,
                                           Distinct1.No No  ,
                                           Distinct1.HS_DATE HS_DATE  ,
                                           Distinct1.CODY_ID CODY_ID  ,
                                           Distinct1.STUS_CODE_ID STUS_CODE_ID  ,
                                           Distinct1.Code Code  ,
                                           Distinct1.SALES_ORD_ID SALES_ORD_ID  ,
                                           Distinct1.SALES_ORD_NO SALES_ORD_NO  ,
                                           Distinct1.Name Name  ,
                                           Distinct1.NRIC NRIC  ,
                                           Distinct1.Code1 Code1  ,
                                           Distinct1.INST_STATE INST_STATE  ,
                                           Distinct1.INST_AREA INST_AREA  ,
                                           Distinct1.C1 C1  ,
                                           Distinct1.C2 C2  ,
                                           Distinct1.C3 C3  ,
                                           Distinct1.C4 C4  ,
                                           Distinct1.C5 C5  ,
                                           Distinct1.C6 C6  ,
                                           Distinct1.C7 C7  ,
                                           Distinct1.C8 C8  ,
                                           Distinct1.CODY_STATUS as CODY_STATUS,
                                           Distinct1.BRNCH_ID as BRNCH_ID,
                                           Distinct1.cust_id cust_id
                                    FROM (    
                                                    SELECT DISTINCT
                                                                 Extent1.SCHDUL_ID SCHDUL_ID,
                                                                 Extent1.NO NO,
                                                                 Extent1.MONTH  || '/' ||   Extent1.YEAR HS_DATE,
                                                                 Extent1.CODY_ID CODY_ID,
                                                                 Extent1.STUS_CODE_ID STUS_CODE_ID,
                                                                 Extent2.CODE CODE,
                                                                 Extent3.SALES_ORD_ID SALES_ORD_ID,
                                                                 Extent3.SALES_ORD_NO SALES_ORD_NO,
                                                                 Extent4.NAME NAME,
                                                                 Extent4.NRIC NRIC,
                                                                 Extent5.CODE CODE1,
                                                                 Extent6.INST_STATE INST_STATE,
                                                                 Extent6.INST_AREA INST_AREA,
                                                                 1 C1,
                                                                 CASE
                                                                    WHEN (Extent7.RESULT_ID IS NOT NULL)
                                                                    THEN Extent7.RESULT_ID
                                                                    ELSE 0
                                                                 END C2,
                                                                 CASE
                                                                    WHEN (Extent7.RESULT_ID IS NOT NULL)
                                                                    THEN  Extent7.NO
                                                                    ELSE ''
                                                                 END C3,
                                                                 CASE
                                                                    WHEN (Extent8.MEM_ID IS NOT NULL)
                                                                    THEN Extent8.MEM_TYPE
                                                                    ELSE  0
                                                                 END C4,
                                                                 CASE
                                                                    WHEN (Extent8.MEM_ID IS NOT NULL)
                                                                    THEN Extent8.MEM_CODE
                                                                    ELSE ''
                                                                 END C5,
                                                                 CASE
                                                                    WHEN (Extent8.MEM_ID IS NOT NULL)
                                                                    THEN  Extent8.STUS
                                                                    ELSE 0
                                                                 END C6,
                                                                 CASE
                                                                    WHEN (Extent6.FIRST_INSTALL_DT  IS NOT NULL)
                                                                    THEN (Extent6.FIRST_INSTALL_DT)
                                                                    ELSE  ('1900-01-01 00:00:00')
                                                                 END  C7,
                                                                 CASE
                                                                    WHEN (Extent9.MEM_ID IS NOT NULL)
                                                                    THEN Extent9.MEM_CODE
                                                                    ELSE   ''
                                                                 END C8,
                                                                 Extent4.STUS_CODE_ID as CODY_STATUS,
                                                                 Extent3.BRNCH_ID as BRNCH_ID,
                                                                 Extent3.cust_id cust_id
                                                    from SVC0008D Extent1
                                                            ,SYS0038M Extent2
                                                            ,SAL0001D Extent3
                                                            ,SAL0029D Extent4
                                                            ,SYS0013M Extent5
                                                            , (SELECT vOrderInstallationInfo. ORD_ID ORD_ID,
                                                                          vOrderInstallationInfo. INST_STATE INST_STATE,
                                                                          vOrderInstallationInfo. INST_AREA INST_AREA,
                                                                          vOrderInstallationInfo.  INST_CNT_NAME INST_CNT_NAME,
                                                                          vOrderInstallationInfo.INST_CNT_NRIC INST_CNT_NRIC,
                                                                          vOrderInstallationInfo.INST_CNT_EMAIL INST_CNT_EMAIL,
                                                                          vOrderInstallationInfo.INST_CNT_TEL_M INST_CNT_TEL_M,
                                                                          vOrderInstallationInfo.INST_CNT_TEL_O INST_CNT_TEL_O,
                                                                          vOrderInstallationInfo.INST_CNT_TEL_R INST_CNT_TEL_R,
                                                                          vOrderInstallationInfo.INST_CNT_TEL_F INST_CNT_TEL_F,
                                                                          vOrderInstallationInfo.INST_CNT_GENDER INST_CNT_GENDER,
                                                                          vOrderInstallationInfo.FIRST_INSTALL_NO FIRST_INSTALL_NO,
                                                                          vOrderInstallationInfo.FIRST_INSTALL_CT_CODE FIRST_INSTALL_CT_CODE,
                                                                          vOrderInstallationInfo.FIRST_INSTALL_CT_NAME FIRST_INSTALL_CT_NAME,
                                                                          vOrderInstallationInfo.FIRST_INSTALL_DT FIRST_INSTALL_DT,
                                                                          vOrderInstallationInfo.FIRST_INSTALL_REM FIRST_INSTALL_REM,
                                                                          vOrderInstallationInfo.FIRST_INSTALL_SIRIM_NO FIRST_INSTALL_SIRIM_NO,
                                                                          vOrderInstallationInfo.FIRST_INSTALL_SERIAL_NO FIRST_INSTALL_SERIAL_NO,
                                                                          vOrderInstallationInfo.LAST_INSTALL_NO LAST_INSTALL_NO,
                                                                          vOrderInstallationInfo.LAST_INSTALL_CT_CODE LAST_INSTALL_CT_CODE,
                                                                          vOrderInstallationInfo.LAST_INSTALL_CT_NAME LAST_INSTALL_CT_NAME,
                                                                          vOrderInstallationInfo.LAST_INSTALL_DT LAST_INSTALL_DT,
                                                                          vOrderInstallationInfo.LAST_INSTALL_REM  LAST_INSTALL_REM,
                                                                          vOrderInstallationInfo.LAST_INSTALL_SIRIM_NO LAST_INSTALL_SIRIM_NO,
                                                                          vOrderInstallationInfo.LAST_INSTALL_SERIAL_NO LAST_INSTALL_SERIAL_NO,
                                                                          vOrderInstallationInfo.DSC_ID DSC_ID,
                                                                          vOrderInstallationInfo.DSC_CODE DSC_CODE,
                                                                          vOrderInstallationInfo.DSC_NAME DSC_NAME,
                                                                          vOrderInstallationInfo.INSTCT INSTCT,
                                                                          vOrderInstallationInfo.PREFER_INST_DT PREFER_INST_DT,
                                                                          vOrderInstallationInfo.PREFER_INST_TM PREFER_INST_TM,
                                                                          vOrderInstallationInfo.INSTALL_ADDR_ID INSTALL_ADDR_ID,
                                                                          vOrderInstallationInfo.INSTALL_CNTC_ID INSTALL_CNTC_ID,
                                                                          vOrderInstallationInfo.INST_CNT_DEPT  INST_CNT_DEPT,
                                                                          vOrderInstallationInfo.INST_CNT_POST  INST_CNT_POST,
                                                                          vOrderInstallationInfo.VRIFY_REM VRIFY_REM
                                                                     FROM SAL1010V vOrderInstallationInfo
                                                                     ) Extent6
                                                                    ,SVC0006D Extent7
                                                                    ,ORG0001D Extent8
                                                                    ,ORG0001D Extent9
                                                    where Extent2.STUS_CODE_ID =  Extent1.STUS_CODE_ID
                                                        and Extent3.SALES_ORD_ID = Extent1.SALES_ORD_ID
                                                        and Extent4.CUST_ID = Extent3.CUST_ID
                                                        and Extent5.CODE_ID =  Extent3.APP_TYPE_ID
                                                        and Extent6.ORD_ID =  Extent1.SALES_ORD_ID
                                                        and Extent7.SCHDUL_ID(+) =  Extent1.SCHDUL_ID
                                                        and  Extent8.MEM_ID(+) = Extent1.CODY_ID 
                                                        and  Extent9.MEM_ID(+) = Extent7.CODY_ID          
                                                        AND 306 = Extent7.TYPE_ID(+)
                                                        and  1 = Extent7.RESULT_IS_CURR(+)
                                                        and 1 = Extent1.STUS_CODE_ID
                                                        AND  Extent1.YEAR = #{myBSYear} 
                                                        AND  Extent1.MONTH = #{myBSMonth} 
                                                      <if test="txtSalesOrder != null and txtSalesOrder != ''">
                                                             AND ( Extent3.SALES_ORD_NO = #{txtSalesOrder})
                                                      </if>
                                                      <if test="txtHsOrderNo != null and txtHsOrderNo != ''">
                                                             AND ( Extent1.No = #{txtHsOrderNo})
                                                      </if>
                                                      <if test="cmdBranchCode != null and cmdBranchCode != ''">
                                                             AND ( Extent3.BRNCH_ID = #{cmdBranchCode})
                                                      </if>
                                                      ) Distinct1 ) Project2 ) Project2
                     WHERE  Project2.row_number > 0
                      ORDER BY Project2.SCHDUL_ID ASC 
          </select>
          
          
 	          <insert id="insertHsResult" parameterType="Map">
              insert into SVC0008D (
	                   SCHDUL_ID
					    ,NO
						,SALES_ORD_ID
						,MONTH
						,YEAR
                        ,STUS_CODE_ID
                        ,LAST_SVC
                        ,LOK
						,TYPE_ID
						,CODY_ID
						,CRT_USER_ID
						,CRT_DT
						)
	             values (
	                  GBSLCVD.SVC0008D_SCHDUL_ID_SEQ.nextval
	                , '111111'
			        , #{salesOrdNo}
			        , #{month}
			        , #{year}
                    , #{stus}
                    , #{lastSvc}
                    , #{lok}
			        , #{typeId}
			        , #{codyId}
     			    , #{creator}   
			        , SYSDATE
	        )
	        </insert> 

</mapper>      		  