<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.services.as.impl.CompensationMapper">


 <select id="selCompensationList" parameterType="Map" resultType="egovMap">
			<!-- SELECT COMP_NO /* COMPENSATION CASE NO */, 
				       CUST_ID /* CUSTOMER ID */,
				       SVC.SALES_ORD_NO /* SALES ORDER */, 
				       AS_NO /* AS NUMBER */,
				       AS_REQSTER_TYPE_ID /* COMPENSATION REQUEST ROUTE */,
				       STUS_CODE_ID /* STATUS */, TO_CHAR(COMP_DT, 'DD/MM/YYYY')  COMP_DT /* COMPLETE DATE */,
				       MAIN_DEPT /* IN CHARGE DEPARTMENT */, CODE /* DSC CODE */,
				       COMP_TOT_AMT /* COMPENSATION AMOUNT */, TO_CHAR(ISSUE_DT, 'DD/MM/YYYY') ISSUE_DT/* ISSUED DATE */,
				       AS_DEFECT_TYPE_ID /* DEFECT TYPE */,
				       AS_MALFUNC_RESN_ID /* DEFECT REASON */,
				       ASR_ITM_PART_ID /* DEFECT PARTS */,
				       ASR_ITM_PART_DESC /* DEFECT DESCRIPTION */,
				       AS_SLUTN_RESN_ID /* SOLUTION CODE */,
				       COMP_ITEM_1 /* COMPENSATION ITEM 1 */,
				       COMP_ITEM_2 /* COMPENSATION ITEM 2 */,
				       COMP_ITEM_3 /* COMPENSATION ITEM 3 */
				       ,ORD_INFO.STK_DESC
				       ,ORD_INFO.INSTALL_DT
				       ,ORD_INFO.SERIAL_NO
				  FROM SVC0053M SVC,
				  (SELECT E.STK_DESC, C.INSTALL_DT, C.SERIAL_NO, A.SALES_ORD_NO
				  FROM SAL0001D A,
				       SAL0046D B,
				       SAL0047D C,
				       SAL0002D D,
				       SYS0026M E,
				       SVC0053M F
				 WHERE A.SALES_ORD_ID = B.SALES_ORD_ID
				   AND A.SALES_ORD_ID = D.SALES_ORD_ID
				   AND B.INSTALL_ENTRY_ID = C.ENTRY_ID
				   AND D.ITM_STK_ID = E.STK_ID
				   AND F.SALES_ORD_NO = A.SALES_ORD_NO(+)
				   AND C.SERIAL_NO IS NOT NULL
				   AND ROWNUM = '1'
				) ORD_INFO
				 WHERE 1 = 1 
				 AND SVC.SALES_ORD_NO = ORD_INFO.SALES_ORD_NO(+) -->
			SELECT A.CUST_ID,                                                    /* CUSTOMER CODE    */
				       A.SALES_ORD_NO,                                               /* ORDER NUMBER     */
				       A.AS_NO,                                                           /* AS ORDER NUMBER */
				       TO_CHAR(COMP_DT, 'DD/MM/YYYY')  COMP_DT,        /* COMPLETE DATA  */
				       TO_CHAR(ISSUE_DT, 'DD/MM/YYYY') ISSUE_DT,        /* APPLICATION DATE */
				       (SELECT DISTINCT CODE || '-' || NAME  CODE_NAME  FROM SYS0005M CODE WHERE 1=1 AND CODE.TYPE_ID= 43 AND CODE.CODE = A.CODE)   AS CODE, /* DSC BRANCH */
				       COMP_TOT_AMT, 
				       B.NAME, 
				       A.COMP_NO,
				       (SELECT E.STK_DESC
			            FROM SAL0001D A1,
			                 SAL0046D B,
			                 SAL0047D C,
			                 SAL0002D D,
			                 SYS0026M E
			           WHERE A1.SALES_ORD_ID = B.SALES_ORD_ID
			             AND A1.SALES_ORD_ID = D.SALES_ORD_ID
			             AND B.INSTALL_ENTRY_ID = C.ENTRY_ID
			             AND D.ITM_STK_ID = E.STK_ID
			             AND A.SALES_ORD_NO = A1.SALES_ORD_NO(+)
			             AND C.SERIAL_NO IS NOT NULL
			             AND ROWNUM = '1')  AS STK_DESC,
				       CASE 
					        WHEN A.STUS_CODE_ID ='1' THEN 'Active'
					        WHEN A.STUS_CODE_ID ='34' THEN 'Solved'
					        WHEN A.STUS_CODE_ID ='35' THEN 'Unsolved'
					        WHEN A.STUS_CODE_ID ='36' THEN 'Closed'
					        WHEN A.STUS_CODE_ID ='44' THEN 'Pending'
					   END STUS_CODE_ID
			  FROM SVC0053M A, SYS0038M B
			 WHERE A.STUS_CODE_ID = B.STUS_CODE_ID
             <if test="customerCode != null and customerCode  != '' " >    
                     AND A.CUST_ID =  #{customerCode}
             </if>			 
             <if test="orderNum != null and orderNum  != '' " >    
                     AND A.SALES_ORD_NO =  #{orderNum}
             </if>        
             <if test="dscBranch != null and dscBranch  != '' " >    
                     AND A.CODE =  #{dscBranch}
             </if>                            
             <if test="applicationStrDate != null and applicationStrDate  != '' " >    
                     AND A.ISSUE_DT >=  TO_DATE(#{applicationStrDate}, 'DD/MM/YYYY')
             </if>   
             <if test="applicationEndDate != null and applicationEndDate  != '' " >    
                     AND A.ISSUE_DT <![CDATA[<]]>   TO_DATE(#{applicationEndDate}, 'DD/MM/YYYY')
             </if>   
             <if test="status != null and status  != '' " >    
                     AND A.STUS_CODE_ID in ( #{status} )
             </if>
             <if test="code != null and code  != '' " >    
                     AND A.CODE in ( #{code} )
             </if>
            ORDER BY   A.COMP_NO DESC               
 </select>
              
              
 <select id="selectSalesOrdNoInfo" parameterType="Map" resultType="egovMap">
			SELECT E.STK_DESC, TO_CHAR(C.INSTALL_DT, 'dd/mm/yyyy') INSTALL_DT, C.SERIAL_NO, A.CUST_ID
			  FROM SAL0001D A,
			       SAL0046D B,
			       SAL0047D C,
			       SAL0002D D,
			       SYS0026M E
			 WHERE A.SALES_ORD_ID = B.SALES_ORD_ID
			   AND A.SALES_ORD_ID = D.SALES_ORD_ID
			   AND B.INSTALL_ENTRY_ID = C.ENTRY_ID
			   AND D.ITM_STK_ID = E.STK_ID
			   AND A.SALES_ORD_NO = #{salesOrdNo}
			   AND C.SERIAL_NO IS NOT NULL
			   AND ROWNUM = '1'
 </select>              
              
    <select id ="selectCompenSationView" parameterType="Map" resultType="egovMap">
			SELECT
			         COMP_NO                         /*  Compensation Case No        */    
			        ,CUST_ID                         /*  Customer ID                 */    
			        ,svc.SALES_ORD_NO                /*  Sales Order                 */    
			        ,AS_NO                           /*  AS Number                   */                
			        ,AS_REQSTER_TYPE_ID      /*  Compensation Request Route  */    
			        ,STUS_CODE_ID                /*  Status                      */    
			        ,TO_CHAR(COMP_DT, 'DD/MM/YYYY') COMP_DT                         /*  Complete Date               */    
			        ,MAIN_DEPT              /*  In Charge Department        */    
			        ,CODE                   /*  DSC Code                    */    
			        ,COMP_TOT_AMT           /*  Compensation Amount         */    
			        ,TO_CHAR(ISSUE_DT, 'DD/MM/YYYY') ISSUE_DT               /*  Issued Date                 */    
			        ,AS_DEFECT_TYPE_ID      /*  Defect Type                 */    
			        ,AS_MALFUNC_RESN_ID     /*  Defect Reason               */    
			        ,ASR_ITM_PART_ID        /*  Defect  Parts               */    
			        ,ASR_ITM_PART_DESC      /*  Defect  Description         */  
			        ,AS_SLUTN_RESN_ID       /*  Solution Code               */  
			        ,COMP_ITEM_1            /*  Compensation Item 1         */  
			        ,COMP_ITEM_2            /*  Compensation Item 2         */  
			        ,COMP_ITEM_3            /*  Compensation Item 3         */
			        ,ATCH_FILE_GRP_ID 
			        ,CRT_USER_ID
			        ,ORD_INFO.STK_DESC
                    ,ORD_INFO.INSTALL_DT
                    ,ORD_INFO.SERIAL_NO  
			 FROM SVC0053M svc,
					    (SELECT E.STK_DESC, C.INSTALL_DT, C.SERIAL_NO, A.SALES_ORD_NO
						  FROM SAL0001D A,
						       SAL0046D B,
						       SAL0047D C,
						       SAL0002D D,
						       SYS0026M E
						 WHERE A.SALES_ORD_ID = B.SALES_ORD_ID
						   AND A.SALES_ORD_ID = D.SALES_ORD_ID
						   AND B.INSTALL_ENTRY_ID = C.ENTRY_ID
						   AND D.ITM_STK_ID = E.STK_ID
						   AND A.SALES_ORD_NO = ( SELECT SALES_ORD_NO FROM  SVC0053M WHERE 1=1 AND COMP_NO  = #{compNo} )
						   AND C.SERIAL_NO IS NOT NULL
						   AND ROWNUM = '1'
						) ORD_INFO
			 WHERE 1 = 1 AND comp_no = #{compNo}    
			 and svc.sales_ord_no = ord_info.SALES_ORD_NO(+)
    
    </select>              
    
    
    <insert id="insertCompensation" parameterType="Map" >
    INSERT INTO SVC0053M
				(
				COMP_NO, CUST_ID, SALES_ORD_NO, AS_NO, AS_REQSTER_TYPE_ID, 
				STUS_CODE_ID, COMP_DT, MAIN_DEPT, CODE, COMP_TOT_AMT, 
				ISSUE_DT, AS_DEFECT_TYPE_ID, AS_MALFUNC_RESN_ID, ASR_ITM_PART_ID, ASR_ITM_PART_DESC, 
				AS_SLUTN_RESN_ID, COMP_ITEM_1, COMP_ITEM_2, COMP_ITEM_3, ATCH_FILE_GRP_ID, 
				CRT_USER_ID, CRT_DT, UPD_USER_ID, UPD_DT
				)
		values
				(
				SVC0053M_COMP_NO_SEQ.NEXTVAL , #{custId}, #{salesOrdNo}, #{asNo}, #{asReqsterTypeId}, 
				#{stusCodeId}, to_date(#{compDt}, 'yyyymmdd'), #{searchdepartment}, #{code}, #{compTotAmt}, 
				to_date(#{issueDt}, 'yyyymmdd'), #{asDefectTypeId}, #{asMalfuncResnId}, #{asrItmPart_id}, #{asrItmPartDesc}, 
				#{asSlutnResn_id}, #{compItem1}, #{compItem2}, #{compItem3}, #{atchFileGrpId},
				#{updator}, SYSDATE, #{updator}, SYSDATE
				)
    </insert>
    
    <insert id="updateCompensation" parameterType="Map" >
    update SVC0053M
         set  CUST_ID                     = #{custId}
              ,SALES_ORD_NO            = #{salesOrdNo}
              ,AS_NO                        = #{asNo}
              ,AS_REQSTER_TYPE_ID   = #{asReqsterTypeId}
              ,COMP_DT                    = to_date(#{compDt}, 'yyyymmdd')
              ,MAIN_DEPT                  = #{searchdepartment}
              ,CODE                          = #{code}
              ,COMP_TOT_AMT           = #{compTotAmt}
              ,ISSUE_DT                    = to_date(#{issueDt}, 'yyyymmdd')
              ,STUS_CODE_ID             = #{stusCodeId}
              ,AS_DEFECT_TYPE_ID     = #{asDefectTypeId}
              ,AS_MALFUNC_RESN_ID   = #{asMalfuncResnId}
              ,ASR_ITM_PART_ID         = #{asrItmPart_id}
              ,ASR_ITM_PART_DESC     = #{asrItmPartDesc}
              ,AS_SLUTN_RESN_ID       = #{asSlutnResn_id}
              ,COMP_ITEM_1               = #{compItem1}
              ,COMP_ITEM_2               = #{compItem2}
              ,COMP_ITEM_3               = #{compItem3}
              ,ATCH_FILE_GRP_ID         = nvl(#{atchFileGrpId}, ATCH_FILE_GRP_ID)
              ,UPD_USER_ID                = #{updator}
              ,UPD_DT                        = SYSDATE
     where COMP_NO =  #{compNo}    
    </insert>    
    
    
    <select id="selectAttachmentFileInfo" parameterType="Map" resultType="egovMap">
            SELECT T1.ATCH_FILE_GRP_ID
                   ,T1.ATCH_FILE_ID
                   ,T2.ATCH_FILE_NAME
                   ,T2.FILE_SUB_PATH
                   ,T2.PHYSICL_FILE_NAME
                   ,T2.FILE_EXTSN
                   ,T2.FILE_SIZE
          FROM SYS0070M T1
          LEFT JOIN SYS0071D T2
          ON T1.ATCH_FILE_ID = T2.ATCH_FILE_ID
          WHERE T1.ATCH_FILE_GRP_ID = #{atchFileGrpId}
    </select>
    
</mapper>