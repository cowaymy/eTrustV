<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.services.tagMgmt.impl.TagMgmtMapper">
    

  
  
  <select id="selectTagStatus" parameterType="Map" resultType="egovMap">
			 
	SELECT      Z.Counseling_No , Z.Customer_No , Z.classify_mem 
                     , Z.Customer_name, Z.Main_inquiry, Z.Sub_inquiry 
                     , Z.Feedback_code, Z.MAIN_DEPT, Z.SUB_DEPT
                     , Z.DEPT_CODE, Z.SUB_DEPT_CDE  , Z.Status
                     ,TO_CHAR (Z.Reg_date, 'YYYY-MM-DD') Reg_date
                     ,z.ord_no,z.hc_mem_id  , z.CNSL_LRGCLAS_CD,  z.CNSL_MEDCLAS_CD
        
        FROM      (
             SELECT A.CUR_SEQNO   Counseling_No 
                , A.CUST_NO as Customer_No   
                , DECODE(FN_GET_COMMCD(1, TGT_DVCD), '', FN_GET_COMMCD(8, TGT_DVCD), FN_GET_COMMCD(1, TGT_DVCD)) AS classify_mem  
                , A.CUST_NM Customer_name 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_LRGCLAS_CD, 'ms-MY') AS Main_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_MEDCLAS_CD, 'ms-MY') AS Sub_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_SMLCLAS_CD, 'ms-MY') AS Feedback_code
                , DECODE(B.MAIN_DEPT,'',CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', A.DEPT_CODE) , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', B.MAIN_DEPT )) AS MAIN_DEPT    
                , DECODE(B.SUB_DEPT,'',CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', A.SUB_DEPT_CDE) , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', B.SUB_DEPT)) AS SUB_DEPT   
                , A.DEPT_CODE
                , A.SUB_DEPT_CDE  
                , A.Ord_no
                , DECODE(B.STUS_CODE_ID, '', 'Active', CALLCENTERUSER.FN_ERP_GET_STUS_NM(B.STUS_CODE_ID)) as Status
                , to_date(Substr(a.REG_DTM, 1, 8 ),'YYYY/MM/DD') Reg_date
                , a.hc_mem_id , A.CNSL_LRGCLAS_CD,  A.CNSL_MEDCLAS_CD
                FROM CALLCENTERUSER.T_CUR_HIST A   
				LEFT OUTER JOIN GBSLCVD.CCR0006D B    
				ON A.CUR_SEQNO = B.CUR_SEQ_NO
				WHERE A.TR_DVCD         = 'T'
        ) Z
        WHERE 1=1
	   <if test="customer != null and customer != '' ">
            AND Z.Customer_name = upper(#{customer})
        </if>
        <if test="main_inquiry != null and main_inquiry != '' ">
           AND Z.CNSL_LRGCLAS_CD IN (#{main_inquiry})
        </if>
        <if test="sub_inquiry != null and sub_inquiry != '' ">
          AND Z.CNSL_MEDCLAS_CD IN (#{sub_inquiry})
        </if>
        <if test="counseling_no != null and counseling_no != '' ">
           AND  LOWER(Z.Counseling_No)= LOWER(#{counseling_no})
        </if>
         <if test="main_department != null and main_department != '' ">
           AND  Z.DEPT_CODE IN (#{main_department})
        </if>
         <if test="sub_department != null and sub_department != '' ">
           AND  Z.SUB_DEPT_CDE IN (#{sub_department})
        </if>
          <if test="feedback_code != null and feedback_code != '' ">
           AND  LOWER(Z.Feedback_code) = LOWER(#{feedback_code})
        </if>
        <if test="regDt != null and regDt != '' ">
            and TO_CHAR (Z.Reg_date, 'YYYY-MM-DD') = TO_CHAR(TO_DATE (#{regDt},   'DD/MM/YYYY'),'YYYY-MM-DD')
        </if>
        
        <if test="listStatus != null and listStatus != '' ">
              AND Z.Status IN
              <foreach item="item" collection="listStatus" index="index" open="(" separator="," close=")">
              CALLCENTERUSER.FN_ERP_GET_STUS_NM( #{item} )
              </foreach>
           </if>
           
	      ORDER BY  Reg_date
  </select>
  
  
    <select id="selectDetailTagStatus" parameterType="Map" resultType="egovMap">
             
    SELECT      Z.Counseling_No , Z.Customer_No , Z.classify_mem 
                     , Z.Customer_name, Z.Main_inquiry, Z.Sub_inquiry 
                     , Z.Feedback_code, Z.MAIN_DEPT, Z.SUB_DEPT
                     , Z.DEPT_CODE, Z.SUB_DEPT_CDE  , Z.Status
                     ,TO_CHAR (Z.Reg_date, 'YYYY-MM-DD') Reg_date
                     ,z.ord_no,  z.hc_mem_id, z.ORD_ID, z.hc_id 
                     ,z.LATEST_MAIN_DEPT,LATEST_SUB_DEPT 
        
        FROM      (
             SELECT A.CUR_SEQNO   Counseling_No 
                , A.CUST_NO as Customer_No   
                , DECODE(FN_GET_COMMCD(1, TGT_DVCD), '', FN_GET_COMMCD(8, TGT_DVCD), FN_GET_COMMCD(1, TGT_DVCD)) AS classify_mem  
                , A.CUST_NM Customer_name 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_LRGCLAS_CD, 'ms-MY') AS Main_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_MEDCLAS_CD, 'ms-MY') AS Sub_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_SMLCLAS_CD, 'ms-MY') AS Feedback_code
                , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', A.DEPT_CODE) AS MAIN_DEPT    
                , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', A.SUB_DEPT_CDE) AS SUB_DEPT 
                , DECODE(B.MAIN_DEPT,'',CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', A.DEPT_CODE) , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', B.MAIN_DEPT )) AS LATEST_MAIN_DEPT  
                , DECODE(B.SUB_DEPT,'',CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', A.SUB_DEPT_CDE) , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', B.SUB_DEPT)) AS LATEST_SUB_DEPT          
                , A.DEPT_CODE
                , A.SUB_DEPT_CDE  
                , A.Ord_no
                , DECODE(B.STUS_CODE_ID, '', 'Active', CALLCENTERUSER.FN_ERP_GET_STUS_NM(B.STUS_CODE_ID)) as Status
                , to_date(Substr(a.REG_DTM, 1, 8 ),'YYYY/MM/DD') Reg_date
                ,  a.hc_mem_id ,  a.ORD_ID, a.hc_id
                FROM CALLCENTERUSER.T_CUR_HIST A   
                LEFT OUTER JOIN GBSLCVD.CCR0006D B    
                ON A.CUR_SEQNO = B.CUR_SEQ_NO
                WHERE A.TR_DVCD         = 'T'
        ) Z
        WHERE 1=1
        and z.Counseling_No = #{counselingId}
        </select>
        
         <insert id="insertCcr0006d" parameterType="Map" >
          INSERT INTO Ccr0006d(
          CALL_ENTRY_ID , SALES_ORD_ID ,TYPE_ID , STUS_CODE_ID
          , RESULT_ID , DOC_ID , CRT_USER_ID , CRT_DT
          , CALL_DT, IS_WAIT_FOR_CANCL, HAPY_CALLER_ID, UPD_DT
          , UPD_USER_ID, ORI_CALL_DT, CUR_SEQ_NO
          , MAIN_DEPT, SUB_DEPT
          )
          VALUES(
          CCR0006D_CALL_ENTRY_ID_SEQ.NEXTVAL, #{orderId}, 260, #{status}
          ,0 ,0 , #{userId}, SYSDATE
          ,TO_date(#{regDate},'YY/MM/DD') ,0 ,#{hcId} , SYSDATE
          ,#{userId} , SYSDATE, #{counselingNo}   
          <choose>
                      <when test="inputMainDept != null and inputMainDept != ''">  
                       , #{inputMainDept}
                      </when>
                      <otherwise>
                         , #{mainDept}
                      </otherwise>
            </choose>
              <choose>
                      <when test="inputSubDept != null and inputSubDept != ''">  
                       ,#{inputSubDept}
                      </when>
                      <otherwise>
                       ,#{subDept}
                      </otherwise>
            </choose>
            
          )
          
          
         
         
         
         </insert>
         
         
             <select id="selectCallEntryId" parameterType="Map" resultType="egovMap">
	             SELECT CALL_ENTRY_ID
	             FROM CCR0006D
	             WHERE  CUR_SEQ_NO = #{counselingNo}
	             <![CDATA[ and ROWNUM < = 1    ]]>
             </select>
             
              <insert id="insertCcr0007d" parameterType="Map" >
			          INSERT INTO Ccr0007d(
			        CALL_RESULT_ID, CALL_ENTRY_ID, CALL_STUS_ID, CALL_DT
					, CALL_ACTN_DT, CALL_FDBCK_ID, CALL_CT_ID, CALL_REM
				    , CALL_CRT_USER_ID, CALL_CRT_DT, CALL_CRT_USER_ID_DEPT, CALL_HC_ID
					, CALL_ROS_AMT, CALL_SMS, CALL_SMS_REM
					, MAIN_DEPT, SUB_DEPT
			          )
			          VALUES(
			          CCR0007D_CALL_RESULT_ID_SEQ.NEXTVAL, #{callEntryId}, #{status}, TO_date(#{regDate},'YY/MM/DD')
			          ,SYSDATE , 0 , #{userId}, #{remark}
			          ,#{userId} ,SYSDATE ,0 , #{hcId}
			          ,0 , 0, 0 
			          <choose>
				          <when test="inputMainDept != null and inputMainDept != ''">  
				          , #{inputMainDept}
				          </when>
				          <otherwise>
				          , #{mainDept}
				          </otherwise>
			          </choose>
			           <choose>
                      <when test="inputSubDept != null and inputSubDept != ''">  
                       ,#{inputSubDept}
                      </when>
                      <otherwise>
                       ,#{subDept}
                      </otherwise>
            </choose>
			          )
			  </insert>
			  
			    <update id="updateCcr0006d" parameterType="Map" >
				     update Ccr0006d
				     set UPD_USER_ID = #{userId},
				     UPD_DT = SYSDATE,
				     STUS_CODE_ID = #{status}
				    <choose>
                      <when test="inputMainDept != null and inputMainDept != ''">  
                         , MAIN_DEPT = #{inputMainDept}
                      </when>
                     </choose>
                      <choose>
                      <when test="inputSubDept != null and inputSubDept != ''">  
                         , SUB_DEPT = #{inputSubDept}
				      </when>
                     </choose>
				     WHERE  CUR_SEQ_NO = #{counselingNo}
			    </update>
			    
			    
			      <select id="selectTagRemarks" parameterType="Map" resultType="egovMap">                
       SELECT 
        CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', T1.DEPT_CODE) AS main_department    
           , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', T1.SUB_DEPT_CDE) AS sub_department
          , TO_CHAR(T2.MEMO) AS remark_cont
           , to_char('Active') as status_Nm   
          , TO_CHAR( to_date(Substr(T2.REG_DTM, 1, 8 ),'YYYY/MM/DD'), 'YYYY-MM-DD' )AS crt_Date
           , TO_CHAR(T2.REG_NM) AS REG_NM
           
         FROM CALLCENTERUSER.T_CUR_HIST T1
         LEFT JOIN CALLCENTERUSER.T_RMK_HIST T2 
           ON T1.CUR_SEQNO = T2.CUR_SEQNO
        WHERE T1.CUR_SEQNO = #{counselingNo}
        
        union all
        
        SELECT CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', T1.MAIN_DEPT ) main_department,  CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', T1.SUB_DEPT) sub_department, TO_CHAR( T1.CALL_REM )  remark_cont
         ,  to_char(CALLCENTERUSER.FN_ERP_GET_STUS_NM(T1.CALL_STUS_ID)) status_Nm    ,TO_CHAR(T1.CALL_CRT_DT,'YYYY-MM-DD') crt_Date
         , T2.USER_FULL_NAME AS REG_NM
        FROM  GBSLCVD.CCR0007D T1
        LEFT OUTER JOIN GBSLCVD.SYS0047M T2   
         ON T1.CALL_CRT_USER_ID = T2.USER_ID
         where Call_stus_id in (1,10,34,35,36,44)
          and  CALL_ENTRY_ID = #{callEntryId}
                       
			      </select>
			      
			        <select id="selectMainDept"  resultType="egovMap">
					        
						 SELECT CODE CODE_ID
						     , CODE_DESC CODE_NAME
						  FROM GBSLCVD.SYS0013M 
						 WHERE CODE_MASTER_ID = 359
						 ORDER BY CODE
			        </select>
			        
			        
			             <select id="selectSubDept"  parameterType="Map" resultType="egovMap">
                            
                         SELECT CODE CODE_ID
					     , CODE_DESC CODE_NAME
					  FROM GBSLCVD.SYS0013M
					 WHERE CODE_MASTER_ID = 360
					
                          <if test = "groupCode != null and groupCode != '' ">
						           AND CODE IN (SELECT SUB_DEPT_CODE FROM SVC0063C WHERE MAIN_DEPT_CODE = #{groupCode})
				         </if>
				         
				          ORDER BY CODE
						  
                    </select>
			        
			       
			        
			         <select id="selectMainInquiryList"  resultType="egovMap">
                            
                        SELECT T1.CNSL_CD CODE_ID
				             , T2.CD_NM CODE_NAME
				          FROM CALLCENTERUSER.T_CNSL_CD T1
				          LEFT OUTER JOIN CALLCENTERUSER.T_CNSL_CD_POLYGLOT T2
				            ON T1.CNSL_CD = T2.CNSL_CD
				         WHERE T2.LANG_CD = 'ms-MY'
				           AND T1.USE_YN = 'Y'
				           AND T1.CNSL_CD_LVL = '1'
				      GROUP BY T1.CNSL_CD
				             , T2.CD_NM
				             , T1.SEQ
				      ORDER BY T1.SEQ
                    </select>
		
	
		<select id="selectSubInquiryList" parameterType="Map"  resultType="egovMap">
			
			
		   SELECT T1.CNSL_CD CODE_ID
			     , T2.CD_NM CODE_NAME
			     , T1.HGRK_CNSL_CD
			     , T1.SEQ
			  FROM CALLCENTERUSER.T_CNSL_CD T1
			  LEFT OUTER JOIN CALLCENTERUSER.T_CNSL_CD_POLYGLOT T2
			    ON T1.CNSL_CD = T2.CNSL_CD
			 WHERE T2.LANG_CD = 'ms-MY'
			   AND T1.CNSL_CD_LVL = '2'
			   AND T1.USE_YN = 'Y'
			 <if test = "groupCode != null and groupCode != '' ">
			   AND T1.HGRK_CNSL_CD = #{groupCode} 
		  </if>
			ORDER BY T1.SEQ
		   
		
		</select>
		
		<select id="getOrderInfo" parameterType="Map"  resultType="egovMap">
		      SELECT C.NAME, C.NRIC, D.STK_DESC, F.CODE_DESC,A.SALES_ORD_ID FROM 
				SAL0001D A, 
				SAL0002D B,
				SAL0029D C,
				SYS0026M D,
				SYS0013M F
				WHERE A.SALES_ORD_ID = B.SALES_ORD_ID
				AND   A.CUST_ID = C.CUST_ID
				AND   B.ITM_STK_ID = D.STK_ID
				AND   A.APP_TYPE_ID = F.CODE_ID
				AND   A.SALES_ORD_NO = #{ordNo}
		</select>
		
		<select id="getCallerInfo" parameterType="Map"  resultType="egovMap">
              SELECT B.NAME, B.NRIC, B.TEL_M1, B.TEL_R, B.EMAIL FROM 
				SAL0001D A,
				SAL0027D B
				WHERE A.CUST_CNT_ID = B.CUST_CNTC_ID
				AND   A.SALES_ORD_NO = #{ordNo}
        </select>
        
        <select id="selectOrderSalesmanViewByOrderID" parameterType="Map" resultType="egovMap">
        SELECT T1.SALES_ORD_ID SALES_ORD_ID
             , T1.DEPT_CODE DEPT_CODE
             , T1.GRP_CODE GRP_CODE
             , T1.ORG_CODE ORG_CODE
             , T2.MEM_ID MEM_ID
             , T2.MEM_CODE MEM_CODE
             , T2.MEM_TYPE MEM_TYPE
             , T2.NAME NAME
             , T2.NRIC NRIC
             , T2.TEL_OFFICE TEL_OFFICE
             , T2.TEL_HUSE TEL_HUSE
             , T2.TEL_MOBILE TEL_MOBILE
             , T3.MEM_ID MEM_ID1
             , T3.MEM_CODE MEM_CODE1
             , T3.NAME NAME1
             , T3.TEL_MOBILE TEL_MOBILE1
             , T4.MEM_ID MEM_ID2
             , T4.MEM_CODE MEM_CODE2
             , T4.NAME NAME2
             , T4.TEL_MOBILE TEL_MOBILE2
             , T5.MEM_ID MEM_ID3
             , T5.MEM_CODE MEM_CODE3
             , T5.NAME NAME3
             , T5.TEL_MOBILE TEL_MOBILE3
          FROM SAL0001D T1
          LEFT
          JOIN ORG0001D T2
            ON T2.MEM_ID = T1.MEM_ID
          LEFT
          JOIN ORG0001D T3
            ON T3.MEM_ID = T1.SALES_GM_ID
          LEFT
          JOIN ORG0001D T4
            ON T4.MEM_ID = T1.SALES_SM_ID
          LEFT
          JOIN ORG0001D T5
            ON T5.MEM_ID = T1.SALES_HM_ID
         WHERE  T1.SALES_ORD_ID = #{salesOrdId}
    </select>
    
    <select id="selectOrderServiceMemberViewByOrderID" parameterType="Map" resultType="egovMap">
    <![CDATA[
        SELECT T1.SALES_ORD_ID SALES_ORD_ID
             , T3.MEM_CODE MEM_CODE
             , T3.NAME NAME
             , T3.NRIC NRIC
             , T3.TEL_OFFICE TEL_OFFICE
             , T3.TEL_HUSE TEL_HUSE
             , T3.TEL_MOBILE TEL_MOBILE
             , T4.DEPT_CODE DEPT_CODE
             , T4.GRP_CODE GRP_CODE
             , T4.ORG_CODE ORG_CODE
             , T5.MEM_ID MEM_ID1
             , T5.MEM_CODE MEM_CODE1
             , T5.NAME NAME1
             , T5.TEL_MOBILE TEL_MOBILE1
             , T7.MEM_ID MEM_ID2
             , T7.MEM_CODE MEM_CODE2
             , T7.NAME NAME2
             , T7.TEL_MOBILE TEL_MOBILE2
             , T9.MEM_ID MEM_ID3
             , T9.MEM_CODE MEM_CODE3
             , T9.NAME NAME3
             , T9.TEL_MOBILE TEL_MOBILE3
          FROM SAL0001D T1
          JOIN SAL0090D T2
            ON T2.SRV_SO_ID = T1.SALES_ORD_ID
           AND 1 = T2.SRV_STUS_ID
          JOIN ORG0001D T3
            ON T3.MEM_ID = T2.SRV_CODY_ID
          JOIN
             ( SELECT V1.MEM_ID MEM_ID
                    , V1.MEM_CODE MEM_CODE
                    , V1.MEM_LVL MEM_LVL
                    , V1.DEPT_CODE DEPT_CODE
                    , V1.GRP_CODE GRP_CODE
                    , V1.ORG_CODE ORG_CODE
                    , V1.TOP_ORG_CODE TOP_ORG_CODE
                    , V1.MEM_UP_ID MEM_UP_ID
                    , V1.LVL3_UP_ID LVL3_UP_ID
                    , V1.LVL2_UP_ID LVL2_UP_ID
                    , V1.LVL1_UP_ID LVL1_UP_ID
                    , V1.LVL0_UP_ID LVL0_UP_ID
                 FROM ORG1001V V1 ) T4
            ON T4.MEM_ID = T3.MEM_ID
          LEFT
          JOIN ORG0001D T5
            ON T5.MEM_ID = T4.MEM_UP_ID
          LEFT
          JOIN
             ( SELECT V1.MEM_ID MEM_ID
                    , V1.MEM_CODE MEM_CODE
                    , V1.MEM_LVL MEM_LVL
                    , V1.DEPT_CODE DEPT_CODE
                    , V1.GRP_CODE GRP_CODE
                    , V1.ORG_CODE ORG_CODE
                    , V1.TOP_ORG_CODE TOP_ORG_CODE
                    , V1.MEM_UP_ID MEM_UP_ID
                    , V1.LVL3_UP_ID LVL3_UP_ID
                    , V1.LVL2_UP_ID LVL2_UP_ID
                    , V1.LVL1_UP_ID LVL1_UP_ID
                    , V1.LVL0_UP_ID LVL0_UP_ID
                 FROM ORG1001V V1 ) T6
            ON T6.MEM_ID = T4.MEM_UP_ID
          LEFT
          JOIN ORG0001D T7
            ON T7.MEM_ID = T6.MEM_UP_ID
          LEFT
          JOIN
             ( SELECT V1.MEM_ID MEM_ID
                    , V1.MEM_CODE MEM_CODE
                    , V1.MEM_LVL MEM_LVL
                    , V1.DEPT_CODE DEPT_CODE
                    , V1.GRP_CODE GRP_CODE
                    , V1.ORG_CODE ORG_CODE
                    , V1.TOP_ORG_CODE TOP_ORG_CODE
                    , V1.MEM_UP_ID MEM_UP_ID
                    , V1.LVL3_UP_ID LVL3_UP_ID
                    , V1.LVL2_UP_ID LVL2_UP_ID
                    , V1.LVL1_UP_ID LVL1_UP_ID
                    , V1.LVL0_UP_ID LVL0_UP_ID
                 FROM ORG1001V V1 ) T8
            ON T8.MEM_ID = T6.MEM_UP_ID
          LEFT JOIN ORG0001D T9
            ON T9.MEM_ID = T8.MEM_UP_ID
         WHERE T1.SALES_ORD_ID = #{salesOrdId} AND ROWNUM <= 1
    ]]>
    </select>
		
    
</mapper>