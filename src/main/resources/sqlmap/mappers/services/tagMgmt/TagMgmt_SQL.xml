<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.services.tagMgmt.impl.TagMgmtMapper">
    
  
  <select id="selectTagStatus" parameterType="Map" resultType="egovMap">
			 
	SELECT      Z.Counseling_No , Z.Customer_No , Z.classify_mem 
                     , Z.Customer_name, Z.Main_inquiry, Z.Sub_inquiry 
                     , Z.Feedback_code, Z.MAIN_DEPT, Z.SUB_DEPT
                     , Z.DEPT_CODE, Z.SUB_DEPT_CDE  , Z.Status
                     ,TO_CHAR (Z.Reg_date, 'YYYY-MM-DD') Reg_date
                     ,z.ord_no,z.hc_mem_id
        
        FROM      (
             SELECT A.CUR_SEQNO   Counseling_No 
                , A.CUST_NO as Customer_No   
                , DECODE(FN_GET_COMMCD(1, TGT_DVCD), '', FN_GET_COMMCD(8, TGT_DVCD), FN_GET_COMMCD(1, TGT_DVCD)) AS classify_mem  
                , A.CUST_NM Customer_name 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_LRGCLAS_CD, 'ms-MY') AS Main_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_MEDCLAS_CD, 'ms-MY') AS Sub_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_SMLCLAS_CD, 'ms-MY') AS Feedback_code
                , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', A.DEPT_CODE) AS MAIN_DEPT    
                , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', A.SUB_DEPT_CDE) AS SUB_DEPT   
                , A.DEPT_CODE
                , A.SUB_DEPT_CDE  
                , A.Ord_no
                , DECODE(B.STUS_CODE_ID, '', 'Active', CALLCENTERUSER.FN_ERP_GET_STUS_NM(B.STUS_CODE_ID)) as Status
                , to_date(Substr(a.REG_DTM, 1, 8 ),'YYYY/MM/DD') Reg_date
                , a.hc_mem_id
                FROM CALLCENTERUSER.T_CUR_HIST A   
				LEFT OUTER JOIN GBSLCVD.CCR0006D B    
				ON A.CUR_SEQNO = B.CUR_SEQ_NO
				WHERE A.TR_DVCD         = 'T'
				AND CUR_SEQNO NOT IN (
				SELECT CUR_SEQ_NO
				FROM GBSLCVD.CCR0006D
				WHERE CUR_SEQ_NO IS NOT NULL 
				AND STUS_CODE_ID NOT IN (1, 35, 44)
                )
        ) Z
        WHERE 1=1
	   <if test="customer != null and customer != '' ">
            AND Z.Customer_name = upper(#{customer})
        </if>
        <if test="main_inquiry != null and main_inquiry != '' ">
           AND LOWER(Z.main_inquiry) = LOWER(#{main_inquiry})
        </if>
        <if test="sub_inquiry != null and sub_inquiry != '' ">
          AND LOWER(Z.sub_inquiry) = LOWER(#{sub_inquiry})
        </if>
        <if test="counseling_no != null and counseling_no != '' ">
           AND  LOWER(Z.Counseling_No)= LOWER(#{counseling_no})
        </if>
         <if test="main_department != null and main_department != '' ">
           AND  LOWER(Z.MAIN_DEPT) = LOWER(#{main_department})
        </if>
         <if test="sub_department != null and sub_department != '' ">
           AND  LOWER(Z.sub_dept) = LOWER(#{sub_department})
        </if>
          <if test="feedback_code != null and feedback_code != '' ">
           AND  LOWER(Z.Feedback_code) = LOWER(#{feedback_code})
        </if>
        <if test="regDt != null and regDt != '' ">
            and TO_CHAR (Z.Reg_date, 'YYYY-MM-DD') = TO_CHAR(TO_DATE (#{regDt},   'DD/MM/YYYY'),'YYYY-MM-DD')
        </if>
           
	
  </select>
  
  
    <select id="selectDetailTagStatus" parameterType="Map" resultType="egovMap">
             
    SELECT      Z.Counseling_No , Z.Customer_No , Z.classify_mem 
                     , Z.Customer_name, Z.Main_inquiry, Z.Sub_inquiry 
                     , Z.Feedback_code, Z.MAIN_DEPT, Z.SUB_DEPT
                     , Z.DEPT_CODE, Z.SUB_DEPT_CDE  , Z.Status
                     ,TO_CHAR (Z.Reg_date, 'YYYY-MM-DD') Reg_date
                     ,z.ord_no,  z.hc_mem_id, z.ORD_ID, z.hc_id 
        
        FROM      (
             SELECT A.CUR_SEQNO   Counseling_No 
                , A.CUST_NO as Customer_No   
                , DECODE(FN_GET_COMMCD(1, TGT_DVCD), '', FN_GET_COMMCD(8, TGT_DVCD), FN_GET_COMMCD(1, TGT_DVCD)) AS classify_mem  
                , A.CUST_NM Customer_name 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_LRGCLAS_CD, 'ms-MY') AS Main_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_MEDCLAS_CD, 'ms-MY') AS Sub_inquiry 
                , CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_SMLCLAS_CD, 'ms-MY') AS Feedback_code
                , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', A.DEPT_CODE) AS MAIN_DEPT    
                , CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', A.SUB_DEPT_CDE) AS SUB_DEPT   
                , A.DEPT_CODE
                , A.SUB_DEPT_CDE  
                , A.Ord_no
                , DECODE(B.STUS_CODE_ID, '', 'Active', CALLCENTERUSER.FN_ERP_GET_STUS_NM(B.STUS_CODE_ID)) as Status
                , to_date(Substr(a.REG_DTM, 1, 8 ),'YYYY/MM/DD') Reg_date
                ,  a.hc_mem_id ,  a.ORD_ID, a.hc_id
                FROM CALLCENTERUSER.T_CUR_HIST A   
                LEFT OUTER JOIN GBSLCVD.CCR0006D B    
                ON A.CUR_SEQNO = B.CUR_SEQ_NO
                WHERE A.TR_DVCD         = 'T'
                AND CUR_SEQNO NOT IN (
                SELECT CUR_SEQ_NO
                FROM GBSLCVD.CCR0006D
                WHERE CUR_SEQ_NO IS NOT NULL 
                AND STUS_CODE_ID NOT IN (1, 35, 44)
                )
        ) Z
        WHERE 1=1
        and z.Counseling_No = #{counselingId}
        </select>
        
         <insert id="insertCcr0006d" parameterType="Map" >
          INSERT INTO Ccr0006d(
          CALL_ENTRY_ID , SALES_ORD_ID ,TYPE_ID , STUS_CODE_ID
          , RESULT_ID , DOC_ID , CRT_USER_ID , CRT_DT
          , CALL_DT, IS_WAIT_FOR_CANCL, HAPY_CALLER_ID, UPD_DT
          , UPD_USER_ID, ORI_CALL_DT, CUR_SEQ_NO, MAIN_DEPT
          , SUB_DEPT
          )
          VALUES(
          CCR0006D_CALL_ENTRY_ID_SEQ.NEXTVAL, #{orderId}, 260, 1
          ,0 ,0 , #{userId}, SYSDATE
          ,TO_date(#{regDate},'YY/MM/DD') ,0 ,#{hcId} , SYSDATE
          ,#{userId} , SYSDATE, #{counselingNo}, #{mainDept}
          ,#{subDept}
          )
          
          
         
         
         
         </insert>
         
         
             <select id="selectCallEntryId" parameterType="Map" resultType="egovMap">
	             SELECT CALL_ENTRY_ID
	             FROM CCR0006D
	             WHERE  CUR_SEQ_NO = #{counselingNo}
	             <![CDATA[ and ROWNUM < = 1    ]]>
             </select>
             
              <insert id="insertCcr0007d" parameterType="Map" >
			          INSERT INTO Ccr0007d(
			        CALL_RESULT_ID, CALL_ENTRY_ID, CALL_STUS_ID, CALL_DT
					, CALL_ACTN_DT, CALL_FDBCK_ID, CALL_CT_ID, CALL_REM
				    , CALL_CRT_USER_ID, CALL_CRT_DT, CALL_CRT_USER_ID_DEPT, CALL_HC_ID
					, CALL_ROS_AMT, CALL_SMS, CALL_SMS_REM, MAIN_DEPT
					, SUB_DEPT
			          )
			          VALUES(
			          CCR0007D_CALL_RESULT_ID_SEQ.NEXTVAL, #{callEntryId}, 1, TO_date(#{regDate},'YY/MM/DD')
			          ,SYSDATE , 0 , #{userId}, #{remark}
			          ,#{userId} ,SYSDATE ,0 , #{hcId}
			          ,0 , 0, 0 , #{mainDept}
			          ,#{subDept}
			          )
			  </insert>
  
    
</mapper>