<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.services.servicePlanning.impl.HolidayMapper">

    <insert id="insertHoliday" parameterType="Map">
        INSERT INTO SYS0081M(
          HOLIDAY
        , HOLIDAY_TYPE
        , HOLIDAY_SEQ
        , STATE
        , HOLIDAY_DESC
        , CRT_USER_ID
        , CRT_DT
        , UPD_USER_ID
        , UPD_DT
        )
        VALUES(
          TO_DATE(#{holiday},'YYYY-MM-DD')
        , #{holidayType}
        , SYS0081M_HOLIDAY_SEQ.NEXTVAL
        , #{state}
        , #{holidayDesc}
        , #{userId}
        , SYSDATE
        , #{userId}
        , SYSDATE 
         )
    </insert>
    
    <update id="updateHoliday" parameterType="Map">
       UPDATE SYS0081M SET
             HOLIDAY =  TO_DATE(#{holiday},'YYYY-MM-DD'),
             HOLIDAY_TYPE = #{holidayType},
             STATE = #{state},
             HOLIDAY_DESC = #{holidayDesc},
              UPD_USER_ID = #{userId},
              UPD_DT = SYSDATE 
          WHERE HOLIDAY_SEQ = #{holidaySeq}
    </update>
    <select id="selectHolidayList"  parameterType="Map" resultType="egovMap">
        SELECT HOLIDAY_SEQ,
		       TO_CHAR (HOLIDAY, 'YYYY-MM-DD') HOLIDAY,
		       HOLIDAY_TYPE,
		       STATE,
		       HOLIDAY_DESC
		  FROM SYS0081M
		  WHERE 1=1
		  <if test="type != null and type != ''">
            AND HOLIDAY_TYPE =  #{type}
          </if>
          <if test="holidayDt != null and holidayDt != ''">
            AND HOLIDAY =  TO_DATE(#{holidayDt},'DD/MM/YYYY')
          </if>
    </select>
    <select id="selectCTList"  parameterType="Map" resultType="egovMap">
        SELECT B.MEM_CODE, B.NAME,count(C.ct_mem_id) as total_assign_date, B.MEM_ID
         FROM SYS0005M A 
         INNER JOIN ORG0001D B ON A.BRNCH_ID = B.BRNCH
         LEFT OUTER  JOIN ORG0020D C ON B.MEM_ID = C.CT_MEM_ID
        WHERE A.CODE = #{branchName} AND MEM_TYPE = 3
        group by b.mem_code, b.name,B.MEM_ID
    </select>
    <select id="selectCTAssignList"  parameterType="Map" resultType="egovMap">
           select * from (SELECT 
             C.HOLIDAY_TYPE,
             C.STATE,
             TO_CHAR (C.HOLIDAY,'YYYY-MM-DD') HOLIDAY, 
             C.HOLIDAY_DESC,
             C.HOLIDAY_SEQ,
             A.CODE,
             A.BRNCH_ID,
             COUNT(D.CT_MEM_ID) AS Replacement_CT_Pax,
             CASE WHEN COUNT(D.CT_MEM_ID) = 0 THEN 'Active' 
                      WHEN  COUNT(D.CT_MEM_ID) > 0 THEN 'Complete' 
             END ASSIGN_STATUS
             FROM SYS0005M A 
             LEFT OUTER JOIN SYS0064M B ON A.AREA_ID = B.AREA_ID 
             LEFT OUTER JOIN SYS0081M C ON C.STATE = B.STATE
             LEFT OUTER JOIN ORG0020D D ON D.HOLIDAY = C.HOLIDAY AND D.HOLIDAY_TYPE = C.HOLIDAY_TYPE AND D.HOLIDAY_SEQ = C.HOLIDAY_SEQ
             LEFT OUTER JOIN ORG0001D E ON E.MEM_ID = D.CT_MEM_ID AND E.BRNCH = D.BRNCH_ID AND E.BRNCH = A.BRNCH_ID
             group by 
             C.HOLIDAY_TYPE,
             C.STATE,
             C.HOLIDAY, 
             C.HOLIDAY_DESC,
             A.CODE,
             A.BRNCH_ID,
             C.HOLIDAY_SEQ
             ) WHERE 1=1
              <if test="stateTypeList != null and stateTypeList != '' ">
                  AND ASSIGN_STATUS IN 
                  <foreach item="item" collection="stateTypeList" index="index" open="(" separator="," close=")">
                  #{item}
                  </foreach>
               </if>
              <if test="type != null and type != ''">
	            AND HOLIDAY_TYPE =  #{type}
	          </if>
	          <if test="holidayDt != null and holidayDt != ''">
	            AND HOLIDAY =  TO_DATE(#{holidayDt},'DD/MM/YYYY')
	          </if>
	          <if test="branchId != null and branchId != ''">
                AND CODE =  #{branchId}
              </if>
    </select>
    <insert id="insertCTAssign" parameterType="Map">
        INSERT INTO ORG0020D(
          HOLIDAY
        , HOLIDAY_TYPE
        , HOLIDAY_SEQ
        , ASIGN_SEQ
        , STATE
        , BRNCH_ID
        , CT_MEM_ID
        )
        VALUES(
          TO_DATE(#{holiday},'YYYY-MM-DD')
          , #{holidayType}
          , #{holidaySeq}
          , ORG0020D_ASIGN_SEQ.NEXTVAL
          , #{state}
          , #{branchId}
          , TO_NUMBER(#{memId})
          )
    </insert>
    <select id="selectAssignCTList"  parameterType="Map" resultType="egovMap">
        SELECT B.MEM_CODE, B.NAME, B.MEM_ID,COUNT(A.CT_MEM_ID) AS total_assign_date
        FROM ORG0020D A INNER JOIN ORG0001D B ON A.CT_MEM_ID = B.MEM_ID
        WHERE HOLIDAY = TO_DATE (#{holiday}, 'YYYY-MM-DD') AND HOLIDAY_TYPE = #{holidayType} AND B.BRNCH = #{branchId}
        GROUP BY B.MEM_CODE, B.NAME, B.MEM_ID
    </select>
    <delete id="deleteCTAssign" parameterType="Map">
        DELETE FROM ORG0020D
        WHERE HOLIDAY = TO_DATE (#{holiday}, 'YYYY-MM-DD') AND HOLIDAY_TYPE = #{holidayType} AND BRNCH_ID = #{branchId} AND CT_MEM_ID=#{memId}
    </delete>
    <select id="selectCTInfo"  parameterType="Map" resultType="egovMap">
        SELECT * FROM ORG0020D WHERE HOLIDAY = TO_DATE (#{holiday}, 'YYYY-MM-DD') AND HOLIDAY_TYPE = #{holidayType} AND BRNCH_ID = #{branchId} AND CT_MEM_ID=#{memId}
    </select>
    <select id="selectState" resultType="egovMap">
    SELECT STATE CODE_ID, STATE CODE_NAME FROM SYS0064M GROUP BY STATE
    </select>
    <delete id="deleteHoliday" parameterType="Map">
        DELETE FROM SYS0081M 
        WHERE HOLIDAY =  TO_DATE(#{holiday},'YYYY-MM-DD')
                   AND HOLIDAY_TYPE = #{holidayType}
                   AND HOLIDAY_SEQ = #{holidaySeq}
                   
    </delete>
    
</mapper>