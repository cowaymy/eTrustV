<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.services.servicePlanning.impl.MileageCalculationMapper">

<insert id="insertDCPMaster" parameterType="Map">
    INSERT INTO SVC0034M(
      MEM_TYPE
    , BRNCH_CODE
    , DCP_FROM
    , DCP_TO
    , DISTANCE
    , CRT_USER_ID
    , CRT_DT
    , UPD_USER_ID
    , UPD_DT
    )
    VALUES(
       #{memType}
     , #{brnchCode}
     , #{dcpFrom}
     , #{dcpTo}
     , #{distance}
     , #{userId}
     , SYSDATE
     , #{userId}
     , SYSDATE
     )
</insert>

<update id="updatetDCPMaster" parameterType="Map">
    UPDATE SVC0034M SET
	    MEM_TYPE = #{memType},
	    BRNCH_CODE = #{brnchCode},
	    DCP_FROM = #{dcpFrom},
	    DCP_TO = #{dcpTo},
	    DISTANCE = #{distance},
	    UPD_USER_ID = #{userId},
	    UPD_DT = SYSDATE
    WHERE MEM_TYPE = #{memType1}
	    AND BRNCH_CODE = #{brnchCode1}
	    AND DCP_FROM = #{dcpFrom1}
	    AND DCP_TO = #{dcpTo1}
</update>
<delete id="deleteDCPMaster" parameterType="Map">
         DELETE FROM SVC0034M
         WHERE  MEM_TYPE = #{memType1} AND BRNCH_CODE = #{brnchCode1}  AND DCP_FROM = #{dcpFrom1} AND DCP_TO = #{dcpTo1}
</delete>
<select id="selectDCPMaster"  parameterType="Map" resultType="egovMap">
        SELECT
            CASE WHEN MEM_TYPE = 2 THEN 'CODY'
             ELSE 'CT'  END MEM_TYPE,
            BRNCH_CODE BRNCH_CODE,
            DCP_FROM DCP_FROM,
            DCP_TO DCP_TO,
            DISTANCE DISTANCE,
            MEM_TYPE MEM_TYPE1,
            BRNCH_CODE BRNCH_CODE1,
            DCP_FROM DCP_FROM1,
            DCP_TO DCP_TO1,
            DISTANCE DISTANCE1
         FROM SVC0034M
         WHERE 1=1
         <if test="memTypeList != null and memTypeList != '' ">
	          AND MEM_TYPE IN
	          <foreach item="item" collection="memTypeList" index="index" open="(" separator="," close=")">
	          #{item}
	          </foreach>
           </if>
           <if test="mcpFromList != null and mcpFromList != '' ">
              AND DCP_FROM  IN
              <foreach item="item" collection="mcpFromList" index="index" open="(" separator="," close=")">
              #{item}
              </foreach>
           </if>
           <if test="mcpToList != null and mcpToList != '' ">
              AND DCP_TO  IN
              <foreach item="item" collection="mcpToList" index="index" open="(" separator="," close=")">
              #{item}
              </foreach>
           </if>
           <if test="branchCodeList != null and branchCodeList != '' ">
              AND BRNCH_CODE  IN
              <foreach item="item" collection="branchCodeList" index="index" open="(" separator="," close=")">
              #{item}
              </foreach>
           </if>
</select>

<select id="selectArea"  parameterType="Map" resultType="egovMap">
	            SELECT DISTINCT AREA CODE_ID,
                   AREA CODE_NAME
        FROM SYS0064M
</select>

<insert id="insertSchemaMgmt" parameterType="Map">
    INSERT INTO SVC0033M(
      SCHEM_ID
    , MEM_TYPE
    , RANGE_FROM
    , RANGE_TO
    , MILEAGE_AMT
    , DEDUCT_FLAG
    , MULTI_RATE
    , PERIOD_FROM
    , PERIOD_TO
    , CRT_USER_ID
    , CRT_DT
    , UPD_USER_ID
    , UPD_DT
    )
    VALUES(
       SVC0033M_SCHEM_ID_SEQ.NEXTVAL
     , #{memType}
     , TO_NUMBER(#{rangeFrom})
     , TO_NUMBER(#{rangeTo})
     , TO_NUMBER(#{mileageAmt})
     , TO_NUMBER(#{deductFlag})
     , TO_NUMBER(#{multiRate})
     , TO_DATE(#{applyFrom},'YYYY-MM-DD')
     , TO_DATE(#{applyTo},'YYYY-MM-DD')
     , #{userId}
     , SYSDATE
     , #{userId}
     , SYSDATE
     )
</insert>
<update id="updateSchemaMgmt" parameterType="Map">
    UPDATE SVC0033M SET
        MEM_TYPE = #{memType},
        RANGE_FROM = TO_NUMBER(#{rangeFrom}),
	    RANGE_TO = TO_NUMBER(#{rangeTo}),
	    MILEAGE_AMT = TO_NUMBER(#{mileageAmt}),
	    DEDUCT_FLAG = TO_NUMBER(#{deductFlag}),
	    MULTI_RATE = TO_NUMBER(#{multiRate}),
	    PERIOD_FROM = TO_DATE(#{applyFrom},'YYYY-MM-DD'),
	    PERIOD_TO = TO_DATE(#{applyTo},'YYYY-MM-DD'),
        UPD_USER_ID = #{userId},
        UPD_DT = SYSDATE
    WHERE SCHEM_ID = #{schemId}
</update>
<delete id="deleteSchemaMgmt" parameterType="Map">
         DELETE FROM SVC0033M
         WHERE SCHEM_ID = #{schemId}
</delete>
<select id="selectSchemaMgmt"  parameterType="Map" resultType="egovMap">
        SELECT
			SCHEM_ID SCHEM_ID,
			CASE WHEN MEM_TYPE = 2 THEN 'CODY'
			ELSE 'CT' END  MEM_TYPE,
			RANGE_FROM RANGE_FROM,
			RANGE_TO RANGE_TO,
			MILEAGE_AMT MILEAGE_AMT,
			DEDUCT_FLAG DEDUCT_FLAG,
			MULTI_RATE MULTI_RATE,
			TO_CHAR(PERIOD_FROM,'YYYY-MM-DD')  APPLY_FROM,
			TO_CHAR(PERIOD_TO, 'YYYY-MM-DD')  APPLY_TO
		FROM SVC0033M
		WHERE 1=1
		<if test="memTypeList != null and memTypeList != '' ">
           AND MEM_TYPE IN
           <foreach item="item" collection="memTypeList" index="index" open="(" separator="," close=")">
           #{item}
           </foreach>
        </if>
        <if test="applyFrom != '' and applyFrom != null ">
           <![CDATA[ AND  PERIOD_FROM  >= TO_DATE(#{applyFrom}, 'DD/MM/YYYY') ]]>
        </if>
         <if test="applyTo !='' and applyTo != null ">
           <![CDATA[  AND PERIOD_TO <=  TO_DATE(#{applyTo}, 'DD/MM/YYYY') ]]>
        </if>
</select>

<select id="selectSchemaResultMgmt"  parameterType="Map" resultType="egovMap">

SELECT
MEM_TYPE,
CODE AS BRANCH_ID,
MEM_CODE,
SERVICE_DATE,
DISTANCE as TOTAL_DISTANCE,
<![CDATA[
(SELECT MILEAGE_AMT
  FROM SVC0033M
  WHERE mem_type = z.mem_Type
  AND PERIOD_FROM <= UPD_DT
  AND PERIOD_TO     >= UPD_DT
  AND RANGE_FROM  <= DISTANCE
  AND RANGE_TO       > DISTANCE
  ) AS MILEAGE
                  ]]>
FROM
  (SELECT MEM_TYPE,
  CODE,
  MEM_CODE,
  SERVICE_DATE,
  SUM(DISTANCE) AS DISTANCE
  FROM
    (SELECT B.MEM_TYPE,
     C.CODE,
    B.MEM_CODE,
    TO_CHAR(A.CRT_DT, 'YYYY/MM/DD') AS SERVICE_DATE,
    A.DISTANCE
    FROM SVC0008D A,
      ORG0001D B,
      SYS0005M C
    WHERE A.CODY_ID                 = B.MEM_ID
    AND B.BRNCH                        = C.BRNCH_ID

                <if test="memTypeList != null and memTypeList != '' ">
                   AND MEM_TYPE IN
                   <foreach item="item" collection="memTypeList" index="index" open="(" separator="," close=")">
                   #{item}
                   </foreach>
                </if>
                <if test="memCodeList != null and memCodeList != '' ">
                   AND B.MEM_CODE IN
                   <foreach item="item" collection="memCodeList" index="index" open="(" separator="," close=")">
                   #{item}
                   </foreach>
                </if>
                <if test="branchList != null and branchList != '' ">
                   AND  C.CODE IN
                   <foreach item="item" collection="branchList" index="index" open="(" separator="," close=")">
                   #{item}
                   </foreach>
                </if>
/*     AND B.MEM_CODE                  = {memCode} */                                         /*'CD102098'*/
/*    AND C.code                          = {branch}    */                                          /*'CDB-21'*/
    AND A.YEAR                          = REGEXP_SUBSTR(#{month}, '[^/]+', 1, 2)    /* 2017 SUBSTR(:month,0,2)*/
    AND A.MONTH                       = REGEXP_SUBSTR(#{month}, '[^/]+', 1, 1)    /*  11 SUBSTR(:month,3,4) */
    /*AND TO_CHAR(A.CRT_DT, 'YYYYMMDD') = '20171123' FOR DAILY MILEAGE CLAIM */
    ) A
  GROUP BY MEM_TYPE,
  CODE,
  MEM_CODE,
    SERVICE_DATE
  ) z





</select>
    <select id="selectBranch"  parameterType="Map" resultType="egovMap">
        SELECT CODE CODE_ID,
                     CODE CODE_NAME
        FROM SYS0005M
        WHERE 1=1
         <if test="groupCode != null and groupCode != ''">
           AND TYPE_ID=#{groupCode}
         </if>
        GROUP BY CODE
        ORDER BY CODE
    </select>
    <select id="selectMemberCode"  parameterType="Map" resultType="egovMap">
         SELECT A.MEM_CODE CODE_ID, A.MEM_CODE ||' - '|| A.NAME CODE_NAME, B.CODE
		FROM ORG0001D A INNER JOIN SYS0005M B ON A.BRNCH = B.BRNCH_ID
		WHERE 1=1
		 <if test="groupCode != null and groupCode != ''">
              AND A.MEM_TYPE  = #{groupCode}
         </if>
		  AND A.STUS = '1'
    </select>
</mapper>