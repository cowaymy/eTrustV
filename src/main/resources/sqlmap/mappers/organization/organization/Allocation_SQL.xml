<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.organization.organization.impl.AllocationMapper">

    <select id="selectList" parameterType="Map" resultType="egovMap">
              <![CDATA[ 
                select   ct ,
                        (select MEM_CODE  from org0001d a  where   ct =a.MEM_ID )  MEM_CODE,
                        C_DATE ,  
                        to_char (to_date(C_DATE,'yyyy-mm-dd'),'dd/mm/yyyy') D_DATE, 
                        ASCNT||'-'||SUMSESION_CNT ascnt,
                        INSCNT||'-'||SUMSESION_CNT inscnt,
                        0||'-'||SUMSESION_CNT rtncnt
                from (                        
                        SELECT  MEM_ID  ct  ,  
                                INS_DATE  C_DATE,
                                (SELECT COUNT (*) CNT  FROM  SAL0046D  AA
                                 WHERE  1=1
                                 AND  AA.CT_ID =MEM_ID
                                 AND  AA.STUS_CODE_ID =4
                                 AND  TO_CHAR (AA.INSTALL_DT,'YYYY-MM-DD'  ) = TO_CHAR( ( to_date(INS_DATE,'yyyy-mm-dd') ) ,'yyyy-mm-dd')  )INSCNT ,
                                (SELECT COUNT (*) CNT  FROM  SVC0001D  AA
                                 WHERE  1=1
                                 AND  AA.AS_MEM_ID =MEM_ID
                                 AND  AA.AS_STUS_ID =4
                                 AND  TO_CHAR (AA.AS_APPNT_DT,'YYYYMMDD'  )  = TO_CHAR( ( to_date(INS_DATE,'yyyy-mm-dd') ) ,'yyyy-mm-dd')   ) ASCNT,
                                NVL(( SELECT  SUM(NVL(MORNG_SESION_INS,0) + NVL(AFTNON_SESION_INS,0) + NVL(EVNG_SESION_INS,0) ) SUMSESION_CNT  FROM ORG0015M S WHERE  S.CT_ID = MEM_ID ),0)SUMSESION_CNT 
                 FROM     ( 
                          select  
                                distinct MEM_ID  
                          from  ORG0005D t 
                          where  CT_SUB_GRP in(
                                SELECT
                                     F.CT_SUB_GRP
                                FROM SAL0001D  A , 
                                     SAL0045D B ,
                                     SAL0023D E , 
                                     SYS0064M F
                                WHERE 1=1
                                    AND A.SALES_ORD_ID =#{ORD_ID}
                                    AND A.SALES_ORD_ID = B.SALES_ORD_ID
                                    AND B.ADD_ID = E.CUST_ADD_ID
                                    AND E.AREA_ID = F.AREA_ID
                           )
                      )C ,(  SELECT   TO_CHAR( (SYSDATE -1) +level ,'yyyy-mm-dd') INS_DATE    FROM DUAL connect by level <= 5) TB  
                ORDER BY MEM_ID  ,INS_DATE ASC
                )                                           
                
        ]]>
        
    </select>
    
    
    <select id="selectDetailList" parameterType="Map" resultType="egovMap">
   
            SELECT  CT ,
        (SELECT OD.MEM_CODE  FROM ORG0001D OD  WHERE  CT =OD.MEM_ID  AND ROWNUM =1) MEM_CODE,
        (SELECT OD.CT_SUB_GRP  FROM ORG0005D OD  WHERE CT =OD.MEM_ID  AND ROWNUM =1) CT_SUB_GRP,
         SUM_INS_RE,
         SUM_RNS_RE,
         SUM_AS_CNT,
         SUM_INS_CNT,
         SUM_RTN_CNT,    /*Morning */
         AMOR,
         IMOR,
         RMOR,
         MOR_AS_CNT,
         MOR_INS_CNT,
         MOR_RTN_CNT,              /* After*/
         AAFT,
         IAFT,
         RAFT,
         AFT_AS_CNT,
         AFT_INS_CNT,
         AFT_RTN_CNT,           /* Evening */
         AEVN,
         IEVN,
         REVN,
         EVN_AS_CNT,
         EVN_INS_CNT,
         EVN_RTN_CNT,
         AOUT,
         IOUT,
         ROUT,
         OTH_AS_CNT,
         OTH_INS_CNT,
         OTH_RTN_CNT
FROM (                          
                                        
                    SELECT 
                            MEM_ID CT,
                             /*Summary*/
                            SUM_AS_RE, SUM_INS_RE,SUM_RNS_RE,
                            nvl(SUM_AS_RE,0)||'-'||SESION_CNT  SUM_AS_CNT, nvl(SUM_INS_RE,0)||'-'||SESION_CNT  SUM_INS_CNT ,nvl(SUM_RNS_RE,0)||'-'||SESION_CNT SUM_RTN_CNT,
                            /*Morning */
                            AMOR, IMOR , RMOR,
                            nvl(AMOR,0)||'-'||M_SESION MOR_AS_CNT   , nvl(IMOR,0)||'-'||M_SESION MOR_INS_CNT  ,  nvl(RMOR,0)||'-'||M_SESION MOR_RTN_CNT,
                            /* After*/
                           AAFT,IAFT ,RAFT,
                            nvl(AAFT,0)||'-'||A_SESION AFT_AS_CNT   , nvl(IAFT,0)||'-'||A_SESION AFT_INS_CNT  , nvl(RAFT,0)||'-'||A_SESION AFT_RTN_CNT,
                           /* Evening */
                            AEVN,IEVN,REVN,
                            nvl(AEVN,0)||'-'||E_SESION  EVN_AS_CNT   , nvl(IEVN,0)||'-'||E_SESION EVN_INS_CNT  , nvl(REVN,0)||'-'||E_SESION EVN_RTN_CNT ,
                            AOUT,IOUT,ROUT,
                            nvl(AOUT,0)||'-'||E_SESION  OTH_AS_CNT   , nvl(IEVN,0)||'-'||E_SESION OTH_INS_CNT  , nvl(REVN,0)||'-'||E_SESION  OTH_RTN_CNT 
                    FROM (    
                    SELECT 
                         MEM_ID, 
                         AMOR,AAFT,AEVN, AOUT,
                         (AMOR+AAFT+AEVN + AOUT)SUM_AS_RE ,
                         IMOR,IAFT,IEVN, IOUT,
                         (IMOR+IAFT+IEVN+IOUT) SUM_INS_RE,
                         RMOR, RAFT,REVN,ROUT,
                         (RMOR+ RAFT+REVN+ROUT)SUM_RNS_RE,
                         NVL(MORNG_SESION_INS,0) + NVL(AFTNON_SESION_INS,0) + NVL(EVNG_SESION_INS,0)  SESION_CNT,
                         NVL(MORNG_SESION_INS,0)  M_SESION,
                         NVL(AFTNON_SESION_INS,0) A_SESION,
                         NVL(EVNG_SESION_INS,0)   E_SESION
                    FROM (
                            SELECT 
                                MAX(AS_MEM_ID) MEM_ID, 
                                MAX(A01)  AMOR, MAX(A02)  AAFT, MAX(A03)  AEVN, MAX(A04)  AOUT,
                                MAX(I01)  IMOR, MAX(I02)  IAFT, MAX(I03)  IEVN, MAX(I04)  IOUT,
                                MAX(R01)  RMOR, MAX(R02)  RAFT, MAX(R03)  REVN, MAX(R04)  ROUT
                            FROM( 
                            select 
                                 B.AS_MEM_ID ,
                                 SUM(DECODE(B.AS_SESION_CODE,'A',1,0))   A01 ,
                                 SUM(DECODE(B.AS_SESION_CODE,'M',1,0))   A02 ,
                                 SUM(DECODE(B.AS_SESION_CODE,'E',1,0))   A03 ,
                                 SUM(DECODE(B.AS_SESION_CODE,'O',1,0))   A04 ,
                                 0  I01 , 0  I02 ,0  I03 , 0  I04 ,
                                 0  R01 , 0  R02 ,0  R03 , 0  R04 
                            FROM
                                ORG0005D A  ,SVC0001D  B ,  ORG0015M P
                            WHERE A.MEM_ID  = B.AS_MEM_ID
                            AND A.MEM_ID = P.CT_ID
                            /*AND B.AS_STUS_ID =4 */
                           /* AND AS_APPNT_DT =TO_DATE(SYSDATE ,'yyyy-mm-dd')*/
                            AND  to_char(AS_APPNT_DT,'YYYYMMDD')  BETWEEN  TO_CHAR(sysdate,'YYYYMMDD') AND  TO_CHAR(sysdate+10,'YYYYMMDD')
                            AND  A.MEM_ID = #{CT_ID}
                            GROUP BY B.AS_MEM_ID, B.AS_SESION_CODE 
                            UNION 
                            select     
                                 B.CT_ID ,
                                 0  A01 ,  0  A02 , 0   A03 , 0   A04 ,
                                 SUM(DECODE(B.SESION_CODE,'A',1,0))   I01 ,
                                 SUM(DECODE(B.SESION_CODE,'M',1,0))   I02 ,
                                 SUM(DECODE(B.SESION_CODE,'E',1,0))   I03 ,
                                 SUM(DECODE(B.SESION_CODE,'O',1,0))   I04 ,
                                 0  R01 ,
                                 0  R02 ,
                                 0  R03 ,
                                 0  R04 
                            FROM
                                ORG0005D A  ,SAL0046D  B ,  ORG0015M P
                            WHERE A.MEM_ID  = B.CT_ID
                            AND A.MEM_ID = P.CT_ID
                              AND  A.MEM_ID = #{CT_ID}
                            /*AND B.STUS_CODE_ID =4 */
                            /* AND INSTALL_DT =TO_DATE(SYSDATE ,'yyyy-mm-dd') */
                            AND  to_char(INSTALL_DT,'YYYYMMDD')  BETWEEN  TO_CHAR(sysdate,'YYYYMMDD') AND  TO_CHAR(sysdate+10,'YYYYMMDD')
                            GROUP BY B.CT_ID, B.SESION_CODE 
                            UNION 
                            select 
                                 B.CT_ID ,
                                 0  A01 , 0  A02 , 0  A03 , 0  A04 ,
                                 0  I01 , 0  I02 , 0  I03 , 0  I04,
                                 0  R01 , 0  R02 , 0  R03 , 0  R04 
                            FROM
                                ORG0005D A  ,SAL0046D  B ,  ORG0015M P
                            WHERE A.MEM_ID  = B.CT_ID
                            AND A.MEM_ID = P.CT_ID
                              AND  A.MEM_ID = #{CT_ID}
                            /* AND B.STUS_CODE_ID =4  */
                            /*AND INSTALL_DT =TO_DATE(SYSDATE,'yyyy-mm-dd') */
                            AND  to_char(INSTALL_DT,'YYYYMMDD')  BETWEEN  TO_CHAR(sysdate,'YYYYMMDD') AND  TO_CHAR(sysdate+10,'YYYYMMDD')
                            GROUP BY B.CT_ID, B.SESION_CODE 
                        )
                    ) S  , ORG0015M P 
                    WHERE 1=1 
                    AND S.MEM_ID = P.CT_ID(+)
                    )       
)
    </select>
    
    
    
</mapper>