<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.eAccounting.pettyCash.impl.PettyCashMapper">

<select id="selectCustodianList" parameterType="Map" resultType="egovMap">
/* pettyCashMapper.selectCustodianList */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.COST_CENTR
      ,T2.COST_CENTER_TEXT AS COST_CENTR_NAME
      ,T1.CUSTDN AS MEM_ACC_ID
      ,T3.MEM_ACC_NAME
      ,T1.HEAD_DEPT_FLAG
      ,T4.ATCH_FILE_GRP_ID
      ,T4.ATCH_FILE_ID
      ,T4.ATCH_FILE_NAME
      ,T4.FILE_EXTSN
      ,T4.FILE_CNT
      ,T1.CRT_DT
      ,T1.UPD_DT
      ,T1.CRT_USER_ID
      ,T5.USER_NAME
  FROM FCM0011M T1 LEFT JOIN FCM0008M T2 ON T1.COST_CENTR = T2.COST_CENTER
       LEFT JOIN FCM0006M T3 ON T1.CUSTDN = T3.MEM_ACC_ID
       LEFT JOIN
       (SELECT *
          FROM (SELECT ROW_NUMBER () OVER (PARTITION BY F1.ATCH_FILE_GRP_ID ORDER BY F1.ATCH_FILE_GRP_ID
                       ,F2.ATCH_FILE_ID) AS RNUM
                      ,F1.ATCH_FILE_GRP_ID
                      ,F2.ATCH_FILE_ID
                      ,F2.ATCH_FILE_NAME
                      ,F2.FILE_EXTSN
                      ,COUNT (F1.ATCH_FILE_ID) OVER (PARTITION BY F1.ATCH_FILE_GRP_ID) FILE_CNT
                  FROM SYS0070M F1 LEFT JOIN SYS0071D F2 ON F1.ATCH_FILE_ID = F2.ATCH_FILE_ID
                       ) F
         WHERE F.RNUM = 1) T4 ON T1.ATCH_FILE_GRP_ID = T4.ATCH_FILE_GRP_ID
       LEFT JOIN SYS0047M T5 ON T1.CRT_USER_ID = T5.USER_ID
       WHERE 1=1
        <if test="startDt != null and startDt != ''">
        <![CDATA[ 
             AND T1.UPD_DT >= TO_DATE(#{startDt}, 'DD/MM/YYYY')
        ]]>
        </if>          
        <if test="endDt != null and endDt != ''">
        <![CDATA[ 
             AND T1.UPD_DT < TO_DATE(#{endDt}, 'DD/MM/YYYY') + 1
        ]]>
        </if>          
        <if test="memAccID != null and memAccID != ''">
             AND T1.CUSTDN LIKE '%' || #{memAccID} || '%'
        </if>          
        <if test="costCenter != null and costCenter != ''">
             AND T1.COST_CENTR LIKE '%' || #{costCenter} || '%'
        </if>     
        <if test="crtUserId != null and crtUserId != ''">
             AND T5.USER_NAME LIKE '%' || #{crtUserId} || '%'
        </if>   
        ORDER BY T1.CRT_DT, T1.UPD_DT         
</select>

<select id="selectUserNric" parameterType="int" resultType="String">
/* pettyCashMapper.selectUserNric */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT USER_NRIC FROM SYS0047M WHERE USER_ID = #{userId}
</select>

<insert id="insertCustodian" parameterType="Map">
/* pettyCashMapper.insertCustodian */
   INSERT INTO FCM0011M
   (
        COST_CENTR
       ,CUSTDN
       ,HEAD_DEPT_FLAG
       ,BANK_CODE
       ,BANK_ACC_NO
       ,CUSTDN_NRIC
       ,APPV_CASH_AMT
       ,ATCH_FILE_GRP_ID
       ,CUSTDN_REM
       ,CRT_DT
       ,CRT_USER_ID
       ,UPD_DT
       ,UPD_USER_ID
    )
    values
    (
        #{costCentr}
       ,#{memAccId}
       ,#{headDeptFlag}
       ,#{bankCode}
       ,#{bankAccNo}
       ,#{userNric}
       ,#{appvCashAmt}
       ,#{fileGroupKey}
       ,#{custdnRem}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<select id="selectCustodianInfo" parameterType="Map" resultType="egovMap">
/* pettyCashMapper.selectCustodianInfo */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.COST_CENTR
      ,T2.COST_CENTER_TEXT AS COST_CENTR_NAME
      ,T1.CUSTDN AS MEM_ACC_ID
      ,T3.MEM_ACC_NAME
      ,T1.HEAD_DEPT_FLAG
      ,T4.ATCH_FILE_GRP_ID
      ,T4.ATCH_FILE_ID
      ,T4.ATCH_FILE_NAME
      ,T4.FILE_EXTSN
      ,T4.FILE_CNT
      ,T1.CRT_DT
      ,T1.UPD_DT
      ,T1.CRT_USER_ID
      ,T5.USER_NAME
  FROM FCM0011M T1 LEFT JOIN FCM0008M T2 ON T1.COST_CENTR = T2.COST_CENTER
       LEFT JOIN FCM0006M T3 ON T1.CUSTDN = T3.MEM_ACC_ID
       LEFT JOIN
       (SELECT *
          FROM (SELECT ROW_NUMBER () OVER (PARTITION BY F1.ATCH_FILE_GRP_ID ORDER BY F1.ATCH_FILE_GRP_ID
                       ,F2.ATCH_FILE_ID) AS RNUM
                      ,F1.ATCH_FILE_GRP_ID
                      ,F2.ATCH_FILE_ID
                      ,F2.ATCH_FILE_NAME
                      ,F2.FILE_EXTSN
                      ,COUNT (F1.ATCH_FILE_ID) OVER (PARTITION BY F1.ATCH_FILE_GRP_ID) FILE_CNT
                  FROM SYS0070M F1 LEFT JOIN SYS0071D F2 ON F1.ATCH_FILE_ID = F2.ATCH_FILE_ID
                       ) F
         WHERE F.RNUM = 1) T4 ON T1.ATCH_FILE_GRP_ID = T4.ATCH_FILE_GRP_ID
       LEFT JOIN SYS0047M T5 ON T1.CRT_USER_ID = T5.USER_ID         
</select>

</mapper>