<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.eAccounting.creditCard.impl.CreditCardMapper">

<select id="selectCrditCardMgmtList" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectCrditCardMgmtList */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T.CRDIT_CARD_SEQ, 
       T.CRDIT_CARD_USER_ID, 
       T.CRDIT_CARD_USER_NAME, 
       T.CRDIT_CARD_NO, 
       T.CHRG_USER_ID, 
       T.CHRG_USER_NAME, 
       T.COST_CENTR, 
       T.COST_CENTR_NAME, 
       T.ATCH_FILE_GRP_ID, 
       T.ATCH_FILE_ID, 
       T.ATCH_FILE_NAME, 
       T.FILE_EXTSN, 
       T.FILE_CNT, 
       T.CRDIT_CARD_STUS_CODE, 
       T.CRDIT_CARD_STUS, 
       T.CRT_DT, 
       T.UPD_DT 
FROM   (SELECT T1.CRDIT_CARD_SEQ, 
               T1.CRDIT_CARD_USER_ID, 
               T1.CRDIT_CARD_USER_NAME, 
               ( SUBSTR(T1.CRDIT_CARD_NO, 1, 4) 
                 || '********' 
                 || SUBSTR(T1.CRDIT_CARD_NO, -4) ) AS CRDIT_CARD_NO, 
               T1.CHRG_USER_ID, 
               T2.NAME                             AS CHRG_USER_NAME, 
               T1.COST_CENTR, 
               T1.COST_CENTR_NAME, 
               T1.ATCH_FILE_GRP_ID, 
               T3.ATCH_FILE_ID, 
               T3.ATCH_FILE_NAME, 
               T3.FILE_EXTSN, 
               T3.FILE_CNT, 
               T1.CRDIT_CARD_STUS                  AS CRDIT_CARD_STUS_CODE, 
               ( CASE T1.CRDIT_CARD_STUS 
                   WHEN 'A' THEN 'Active' 
                   WHEN 'R' THEN 'Removed' 
                 END )                             AS CRDIT_CARD_STUS, 
               T1.CRT_DT, 
               T1.UPD_DT 
        FROM   FCM0016M T1 
               LEFT JOIN ORG0001D T2 
                      ON T1.CHRG_USER_ID = T2.MEM_CODE 
               LEFT JOIN (SELECT * 
                          FROM   (SELECT Row_number () 
                                           OVER ( 
                                             PARTITION BY F1.ATCH_FILE_GRP_ID 
                                             ORDER BY F1.ATCH_FILE_GRP_ID, 
                                           F2.ATCH_FILE_ID) AS 
                                         RNUM, 
                                         F1.ATCH_FILE_GRP_ID, 
                                         F2.ATCH_FILE_ID, 
                                         F2.ATCH_FILE_NAME, 
                                         F2.FILE_EXTSN, 
                                         Count (F1.ATCH_FILE_ID) 
                                           OVER ( 
                                             PARTITION BY F1.ATCH_FILE_GRP_ID) 
                                         FILE_CNT 
                                  FROM   SYS0070M F1 
                                         LEFT JOIN SYS0071D F2 
                                                ON F1.ATCH_FILE_ID = 
                                                   F2.ATCH_FILE_ID) F 
                          WHERE  F.RNUM = 1) T3 
                      ON T1.ATCH_FILE_GRP_ID = T3.ATCH_FILE_GRP_ID) T 
       WHERE 1=1
        <if test="startDt != null and startDt != ''">
        <![CDATA[ 
             AND T.UPD_DT >= TO_DATE(#{startDt}, 'DD/MM/YYYY')
        ]]>
        </if>          
        <if test="endDt != null and endDt != ''">
        <![CDATA[ 
             AND T.UPD_DT < TO_DATE(#{endDt}, 'DD/MM/YYYY') + 1
        ]]>
        </if>          
        <if test="crditCardUserId != null and crditCardUserId != ''">
             AND T.CRDIT_CARD_USER_ID LIKE '%' || #{crditCardUserId} || '%'
        </if>          
        <if test="costCenter != null and costCenter != ''">
             AND UPPER(T.COST_CENTR) = UPPER(#{costCenter})
        </if>     
        <if test="chrgUserId != null and chrgUserId != ''">
             AND T.CHRG_USER_ID LIKE '%' || #{chrgUserId} || '%'
        </if>   
        <if test="crditCardNo != null and crditCardNo != ''">
             AND T.CRDIT_CARD_NO LIKE '%' || #{crditCardNo} || '%'
        </if>
        <if test="crditCardStus != null and crditCardStus != ''">
             AND T.CRDIT_CARD_STUS_CODE IN
         <foreach item="item" collection="crditCardStus" index="index" open="(" separator="," close=")">
             #{item}
         </foreach>
        </if>   
        ORDER BY T.CRT_DT, T.UPD_DT         
</select>

<select id="selectBankCode" resultType="egovMap">
/* creditCardMapper.selectBankCode */
    SELECT CODE , NAME FROM SYS0004M
</select>

<select id="selectNextCrditCardSeq" resultType="int">
/* creditCardMapper.selectNextCrditCardSeq */
    SELECT NVL(MAX(CRDIT_CARD_SEQ) + 1, 1) AS CRDIT_CARD_SEQ FROM FCM0016M
</select>

<insert id="insertCreditCard" parameterType="Map">
/* creditCardMapper.insertCreditCard */
   INSERT INTO FCM0016M
   (
        CRDIT_CARD_SEQ
        ,CRDIT_CARD_USER_ID
        ,CRDIT_CARD_USER_NAME
        ,CRDIT_CARD_NO
        ,CHRG_USER_ID
        ,COST_CENTR
        ,COST_CENTR_NAME
        ,BANK_CODE
        ,BANK_NAME
        ,CRDIT_CARD_TYPE
        ,APPV_CRDIT_LIMIT
        ,CRDIT_CARD_EXPR_DT
        ,ATCH_FILE_GRP_ID
        ,CRDIT_CARD_REM
        ,CRDIT_CARD_STUS
        ,CRT_DT
        ,CRT_USER_ID
        ,UPD_DT
        ,UPD_USER_ID
    )
    values
    (
        #{crditCardSeq}
       ,#{crditCardUserId}
       ,#{crditCardUserName}
       ,#{crditCardNo}
       ,#{chrgUserId}
       ,UPPER(#{costCentr})
       ,#{costCentrName}
       ,#{bankCode}
       ,#{bankName}
       ,#{crditCardType}
       ,#{appvCrditLimit}
       ,TO_DATE(#{crditCardExprDt}, 'MM/YYYY')
       ,#{fileGroupKey}
       ,#{crditCardRem}
       ,'A'
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<select id="selectNextIfKey" resultType="String">
/* creditCardMapper.selectNextIfKey */
    SELECT FN_CRT_IFKEY('120') FROM DUAL
</select>

<select id="selectNextSeq" parameterType="String" resultType="int">
/* creditCardMapper.selectNextSeq */
    SELECT NVL(MAX(SEQ) + 1, 1) AS SEQ FROM ITF0120M WHERE IF_KEY = #{ifKey}
</select>

<insert id="insertCrditCardInterface" parameterType="Map">
/* creditCardMapper.insertCrditCardInterface */
   INSERT INTO ITF0120M
   (
        IF_KEY
        ,SEQ
        ,IF_TYPE
        ,TRAN_STATUS_CD
        ,RGST_DT
        ,RGST_TM
        ,RGST_ID
        ,AGENT_NO
        ,AGENT_NM
        ,ACCT_ST
        ,SUPP_GROUP
    )
    values
    (
        #{ifKey}
       ,#{seq}
       ,'120'
       ,'10'
       ,TO_CHAR(SYSDATE, 'YYYYDDMM')
       ,TO_CHAR(SYSDATE, 'HH24MISS')
       ,#{userId}
       ,#{agentNo}
       ,#{agentNm}
       ,#{acctSt}
       ,'VM05'
    )
</insert>

<select id="selectCrditCardInfo" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectCrditCardInfo */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.CRDIT_CARD_SEQ
        ,T1.CRDIT_CARD_USER_ID
        ,T1.CRDIT_CARD_USER_NAME
        ,T1.CRDIT_CARD_NO
        ,T1.CHRG_USER_ID
        ,T2.NAME    AS CHRG_USER_NAME
        ,T1.COST_CENTR
        ,T1.COST_CENTR_NAME
        ,T1.BANK_CODE
        ,T1.BANK_NAME
        ,T1.CRDIT_CARD_TYPE
        ,T1.APPV_CRDIT_LIMIT
        ,TO_CHAR(T1.CRDIT_CARD_EXPR_DT, 'MM/YYYY') AS CRDIT_CARD_EXPR_DT
        ,T1.ATCH_FILE_GRP_ID
        ,T1.CRDIT_CARD_REM
        ,T1.CRDIT_CARD_STUS
        ,T1.CRT_DT
        ,T1.CRT_USER_ID
        ,T1.UPD_DT
        ,T1.UPD_USER_ID 
FROM   FCM0016M T1 LEFT JOIN ORG0001D T2 
                      ON T1.CHRG_USER_ID = T2.MEM_CODE
WHERE T1.CRDIT_CARD_SEQ = #{crditCardSeq}
</select>

<update id="updateCreditCard" parameterType="Map">
/* creditCardMapper.updateCreditCard */
   UPDATE FCM0016M
   SET CRDIT_CARD_USER_ID = #{crditCardUserId}
       ,CRDIT_CARD_USER_NAME = #{crditCardUserName}
       ,CRDIT_CARD_NO = #{crditCardNo}
       ,CHRG_USER_ID = #{chrgUserId}
       ,COST_CENTR = UPPER(#{costCentr})
       ,COST_CENTR_NAME = #{costCentrName}
       ,BANK_CODE = #{bankCode}
       ,BANK_NAME = #{bankName}
       ,CRDIT_CARD_TYPE = #{crditCardType}
       ,APPV_CRDIT_LIMIT = #{appvCrditLimit}
       ,CRDIT_CARD_EXPR_DT = TO_DATE(#{crditCardExprDt}, 'MM/YYYY')
       ,CRDIT_CARD_REM = #{crditCardRem}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CRDIT_CARD_SEQ = #{crditCardSeq}  
</update>

<update id="removeCreditCard" parameterType="Map">
/* creditCardMapper.removeCreditCard */
   UPDATE FCM0016M
   SET CRDIT_CARD_STUS = 'R'
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CRDIT_CARD_SEQ = #{crditCardSeq}  
</update>

<select id="selectReimbursementList" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectReimbursementList */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT 
T.CLM_NO, 
       T.CRDIT_CARD_USER_ID, 
       T.CRDIT_CARD_USER_NAME, 
       T.CRDIT_CARD_NO, 
       T.CHRG_USER_ID, 
       T.CHRG_USER_NAME, 
       T.COST_CENTR, 
       T.COST_CENTR_NAME, 
       T.CLM_MONTH, 
       'MYR' AS CUR,
       T.ALL_TOT_AMT, 
       T.REQST_DT,
       T.APPV_PRCSS_NO, 
       T.APPV_PRCSS_STUS_CODE, 
       T.APPV_PRCSS_STUS, 
       T.APPV_PRCSS_DT,
       T.CRT_DT
FROM (SELECT T1.CLM_NO,
T1.CRDIT_CARD_USER_ID,
T1.CRDIT_CARD_USER_NAME,
( SUBSTR(T1.CRDIT_CARD_NO, 1, 4) 
                 || '********' 
                 || SUBSTR(T1.CRDIT_CARD_NO, -4) ) AS CRDIT_CARD_NO,
T1.CHRG_USER_ID,
T2.NAME AS CHRG_USER_NAME,
T1.COST_CENTR,
T1.COST_CENTR_NAME,
TO_DATE(T1.CLM_MONTH, 'YYYYMM') AS CLM_MONTH,
T1.TOT_AMT AS ALL_TOT_AMT,
T3.REQST_DT,
T1.APPV_PRCSS_NO,
NVL (T3.APPV_PRCSS_STUS, 'T')   AS APPV_PRCSS_STUS_CODE, 
               NVL (( CASE T3.APPV_PRCSS_STUS 
                        WHEN 'R' THEN 'Request' 
                        WHEN 'P' THEN 'Approve In-Progress' 
                        WHEN 'A' THEN 'Approved' 
                        WHEN 'J' THEN 'Rejected' 
                      END ), 'Temporary Save') AS APPV_PRCSS_STUS, 
T3.APPV_PRCSS_DT,
T1.CRT_DT
FROM   FCM0017M T1
LEFT JOIN ORG0001D T2 
ON T1.CHRG_USER_ID = T2.MEM_CODE
LEFT JOIN FCM0004M T3
ON T1.APPV_PRCSS_NO = T3.APPV_PRCSS_NO) T
       WHERE 1=1
        <if test="startDt != null and startDt != ''">
        <![CDATA[ 
             OR T.CRT_DT >= TO_DATE(#{startDt}, 'DD/MM/YYYY')
        ]]>
        </if>          
        <if test="endDt != null and endDt != ''">
        <![CDATA[ 
             OR T.CRT_DT < TO_DATE(#{endDt}, 'DD/MM/YYYY') + 1
        ]]>
        </if>          
        <if test="crditCardUserId != null and crditCardUserId != ''">
             AND T.CRDIT_CARD_USER_ID LIKE '%' || #{crditCardUserId} || '%'
        </if>          
        <if test="costCenter != null and costCenter != ''">
             AND UPPER(T.COST_CENTR) = UPPER(#{costCenter})
        </if>     
        <if test="chrgUserId != null and chrgUserId != ''">
             AND T.CHRG_USER_ID LIKE '%' || #{chrgUserId} || '%'
        </if>   
        <if test="crditCardNo != null and crditCardNo != ''">
             AND T.CRDIT_CARD_NO LIKE '%' || #{crditCardNo} || '%'
        </if>
        <if test="appvPrcssStus != null and appvPrcssStus != ''">
             AND T.APPV_PRCSS_STUS_CODE IN
         <foreach item="item" collection="appvPrcssStus" index="index" open="(" separator="," close=")">
             #{item}
         </foreach>
        </if>   
        ORDER BY T.CLM_NO         
</select>

<select id="selectTaxCodeCreditCardFlag" resultType="egovMap">
/* creditCardMapper.selectTaxCodeCreditCardFlag */
    SELECT TAX_CODE ,
                INDUSTRY_CODE||' '||'('||TAX_NAME||')' AS TAX_NAME
    FROM FCM0007C
    WHERE CRDIT_CARD_FLAG = 'X'
</select>

<select id="selectCrditCardInfoByNo" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectCrditCardInfoByNo */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.CRDIT_CARD_USER_ID
        ,T1.CRDIT_CARD_USER_NAME
        ,T1.CHRG_USER_ID
        ,T2.NAME    AS CHRG_USER_NAME
        ,T1.COST_CENTR
        ,T1.COST_CENTR_NAME
        ,T1.BANK_CODE
        ,T1.BANK_NAME 
FROM   FCM0016M T1 LEFT JOIN ORG0001D T2 
                      ON T1.CHRG_USER_ID = T2.MEM_CODE
WHERE T1.CRDIT_CARD_NO = #{crditCardNo}
</select>

<select id="selectNextClmNo" resultType="String">
/* creditCardMapper.selectNextClmNo */
    SELECT    'J3'
       || TO_CHAR (SYSDATE, 'yymm')
       || NVL (TO_CHAR (MAX (SUBSTR (CLM_NO, 7, 4) + 1), 'FM0000'), '0001') AS CLM_NO
    FROM FCM0017M
    WHERE SUBSTR (CLM_NO, 3, 4) = TO_CHAR (SYSDATE, 'yymm')
</select>

<insert id="insertReimbursement" parameterType="Map">
/* creditCardMapper.insertReimbursement */
   INSERT INTO FCM0017M
   (
        CLM_NO,
        CLM_TYPE,
        CRDIT_CARD_USER_ID,
        CRDIT_CARD_USER_NAME,
        CRDIT_CARD_NO,
        CHRG_USER_ID,
        COST_CENTR,
        COST_CENTR_NAME,
        BANK_CODE,
        BANK_NAME,
        CLM_MONTH,
        TOT_AMT,
        CRT_DT,
        CRT_USER_ID,
        UPD_DT,
        UPD_USER_ID
    )
    values
    (
        #{clmNo}
       ,'J3'
       ,#{crditCardUserId}
       ,#{crditCardUserName}
       ,#{crditCardNo}
       ,#{chrgUserId}
       ,#{costCentr}
       ,#{costCentrName}
       ,#{bankCode}
       ,#{bankName}
       ,TO_CHAR(TO_DATE(#{clmMonth}, 'MM/YYYY'), 'YYYYMM')
       ,#{allTotAmt}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<select id="selectNextClmSeq" parameterType="String" resultType="int">
/* creditCardMapper.selectNextClmNo */
    SELECT NVL(MAX(CLM_SEQ) + 1, 1) AS CLM_SEQ FROM FCM0018D WHERE CLM_NO = #{clmNo}
</select>

<insert id="insertReimbursementItem" parameterType="Map">
/* creditCardMapper.insertReimbursementItem */
   INSERT INTO FCM0018D
   (
        CLM_NO,
        CLM_SEQ,
        INVC_TYPE,
        INVC_NO,
        INVC_DT,
        SUPPLY_NAME,
        EXP_TYPE,
        EXP_TYPE_NAME,
        GL_ACC_CODE,
        GL_ACC_CODE_NAME,
        BUDGET_CODE,
        BUDGET_CODE_NAME,
        TAX_CODE,
        NET_AMT,
        TAX_AMT,
        TAX_NON_CLM_AMT,
        TOT_AMT,
        ATCH_FILE_GRP_ID,
        EXP_DESC,
        CLAM_UN,
        COST_CENTR,
        COST_CENTR_NAME,
        GST_RGIST_NO,
        CRT_DT,
        CRT_USER_ID,
        UPD_DT,
        UPD_USER_ID
    )
    values
    (
        #{clmNo}
       ,#{clmSeq}
       ,#{invcType}
       ,#{invcNo}
       ,TO_DATE(#{invcDt}, 'DD/MM/YYYY')
       ,#{supplyName}
       ,#{expType}
       ,#{expTypeName}
       ,#{glAccCode}
       ,#{glAccCodeName}
       ,#{budgetCode}
       ,#{budgetCodeName}
       ,#{taxCode}
       ,#{netAmt}
       ,#{taxAmt}
       ,#{taxNonClmAmt}
       ,#{totAmt}
       ,#{atchFileGrpId}
       ,#{expDesc}
       ,#{clamUn}
       ,UPPER(#{sCostCentr})
       ,#{sCostCentrName}
       ,#{gstRgistNo}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<select id="selectReimbursementItems" parameterType="String" resultType="egovMap">
/* creditCardMapper.selectReimbursementItems */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.CLM_SEQ, 
       T3.CRDIT_CARD_USER_ID,
       T3.COST_CENTR,
       T3.COST_CENTR_NAME,
       T1.EXP_TYPE, 
       T1.EXP_TYPE_NAME, 
       T1.GL_ACC_CODE, 
       T1.GL_ACC_CODE_NAME, 
       T1.BUDGET_CODE, 
       T1.BUDGET_CODE_NAME, 
       T1.SUPPLY_NAME,
       T1.INVC_TYPE, 
       ( CASE T1.INVC_TYPE 
           WHEN 'F' THEN 'Full Tax invoice' 
           WHEN 'S' THEN 'Simplified Tax invoice' 
         END )     AS INVC_TYPE_NAME, 
       T1.INVC_NO, 
       TO_CHAR(T1.INVC_DT, 'DD/MM/YYYY') AS INVC_DT,  
       T1.TAX_CODE, 
       T2.TAX_NAME, 
       'MYR'       AS CUR, 
       T1.NET_AMT, 
       T1.TAX_AMT, 
       T1.TAX_NON_CLM_AMT,
       T1.TOT_AMT, 
       T1.ATCH_FILE_GRP_ID, 
       T1.EXP_DESC, 
       T1.CLAM_UN, 
       T1.COST_CENTR AS S_COST_CENTR,
       T1.COST_CENTR_NAME AS S_COST_CENTR_NAME,
       T1.GST_RGIST_NO,
       T3.TOT_AMT  AS ALL_TOT_AMT,
       T3.APPV_PRCSS_NO 
FROM   FCM0018D T1 
       LEFT JOIN FCM0007C T2 
              ON T1.TAX_CODE = T2.TAX_CODE 
       LEFT JOIN FCM0017M T3 
              ON T1.CLM_NO = T3.CLM_NO 
WHERE  T1.CLM_NO = #{clmNo} 
ORDER  BY T1.CLM_SEQ 
</select>

<select id="selectReimburesementInfo" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectReimburesementInfo */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.CLM_SEQ, 
       T2.CRDIT_CARD_NO,
       T2.CRDIT_CARD_USER_ID,
       T2.CRDIT_CARD_USER_NAME,
       T2.CHRG_USER_ID,
       T3.NAME  AS CHRG_USER_NAME,
       T2.COST_CENTR, 
       T2.COST_CENTR_NAME, 
       T1.COST_CENTR AS S_COST_CENTR,
       T1.COST_CENTR_NAME AS S_COST_CENTR_NAME,
       T1.GST_RGIST_NO,
       T2.BANK_CODE, 
       T2.BANK_NAME, 
       TO_CHAR(TO_DATE(T2.CLM_MONTH, 'YYYYMM'), 'MM/YYYY') AS CLM_MONTH,
       T2.APPV_PRCSS_NO,
       T1.INVC_TYPE,
       T1.INVC_NO, 
       TO_CHAR(T1.INVC_DT, 'DD/MM/YYYY') AS INVC_DT, 
       T1.SUPPLY_NAME,
       T1.EXP_TYPE, 
       T1.EXP_TYPE_NAME, 
       T1.GL_ACC_CODE, 
       T1.GL_ACC_CODE_NAME, 
       T1.BUDGET_CODE, 
       T1.BUDGET_CODE_NAME, 
       T1.TAX_CODE,
       'MYR'       AS CUR, 
       T1.NET_AMT, 
       T1.TAX_AMT, 
       T1.TAX_NON_CLM_AMT, 
       T1.TOT_AMT, 
       T1.ATCH_FILE_GRP_ID, 
       T1.EXP_DESC 
FROM   FCM0018D T1
       LEFT JOIN FCM0017M T2 
              ON T1.CLM_NO = T2.CLM_NO 
       LEFT JOIN ORG0001D T3 
              ON T2.CHRG_USER_ID = T3.MEM_CODE
WHERE T1.CLM_NO = #{clmNo} AND T1.CLM_SEQ = #{clmSeq}
</select>

<select id="selectReimburesementInfoForAppv" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectReimburesementInfoForAppv */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.CLM_SEQ, 
       T2.CRDIT_CARD_NO,
       T2.CRDIT_CARD_USER_ID,
       T2.CRDIT_CARD_USER_NAME,
       T2.CHRG_USER_ID,
       T3.NAME  AS CHRG_USER_NAME,
       T2.COST_CENTR, 
       T2.COST_CENTR_NAME, 
       T1.COST_CENTR AS S_COST_CENTR,
       T1.COST_CENTR_NAME AS S_COST_CENTR_NAME,
       T1.GST_RGIST_NO,
       T2.BANK_CODE, 
       T2.BANK_NAME, 
       TO_CHAR(TO_DATE(T2.CLM_MONTH, 'YYYYMM'), 'MM/YYYY') AS CLM_MONTH,
       T2.APPV_PRCSS_NO,
       (CASE T1.INVC_TYPE
           WHEN 'F'
              THEN 'Full Tax invoice'
           WHEN 'S'
              THEN 'Simplified Tax invoice'
        END
        ) AS INVC_TYPE,
       T1.INVC_NO, 
       TO_CHAR(T1.INVC_DT, 'DD/MM/YYYY') AS INVC_DT, 
       T1.SUPPLY_NAME,
       T1.EXP_TYPE, 
       T1.EXP_TYPE_NAME, 
       T1.GL_ACC_CODE, 
       T1.GL_ACC_CODE_NAME, 
       T1.BUDGET_CODE, 
       T1.BUDGET_CODE_NAME, 
       T1.TAX_CODE,
       'MYR'       AS CUR, 
       T1.NET_AMT, 
       T1.TAX_AMT, 
       T1.TAX_NON_CLM_AMT, 
       T1.TOT_AMT, 
       T1.ATCH_FILE_GRP_ID, 
       T1.EXP_DESC 
FROM   FCM0018D T1
       LEFT JOIN FCM0017M T2 
              ON T1.CLM_NO = T2.CLM_NO 
       LEFT JOIN ORG0001D T3 
              ON T2.CHRG_USER_ID = T3.MEM_CODE
WHERE T1.CLM_NO = #{clmNo} AND T1.CLM_SEQ = #{clmSeq}
</select>

<select id="selectReimbursementItemGrp" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectReimbursementItemGrp */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.CLM_SEQ, 
       T1.EXP_TYPE, 
       T1.EXP_TYPE_NAME, 
       T1.GL_ACC_CODE, 
       T1.GL_ACC_CODE_NAME, 
       T1.BUDGET_CODE, 
       T1.BUDGET_CODE_NAME, 
       T1.TAX_CODE, 
       T2.TAX_NAME, 
       T2.TAX_RATE, 
       'MYR' AS CUR, 
       T1.NET_AMT, 
       T1.TAX_AMT, 
       T1.TAX_NON_CLM_AMT, 
       T1.TOT_AMT, 
       T1.CLAM_UN,
       T1.ATCH_FILE_GRP_ID
FROM   FCM0018D T1 
       LEFT JOIN FCM0007C T2 
              ON T1.TAX_CODE = T2.TAX_CODE 
WHERE  T1.CLM_NO = #{clmNo} 
       AND CLAM_UN = #{clamUn}
</select>

<select id="selectAttachList" parameterType="String" resultType="egovMap">
/* creditCardMapper.selectAttachList */
            SELECT T1.ATCH_FILE_GRP_ID
                   ,T1.ATCH_FILE_ID
                   ,T2.ATCH_FILE_NAME
          FROM SYS0070M T1
          LEFT JOIN SYS0071D T2
          ON T1.ATCH_FILE_ID = T2.ATCH_FILE_ID
          WHERE T1.ATCH_FILE_GRP_ID = #{atchFileGrpId}
          ORDER BY T1.ATCH_FILE_ID         
</select>

<update id="updateReimbursement" parameterType="Map">
/* creditCardMapper.updateReimbursement */
   UPDATE FCM0017M
   SET CRDIT_CARD_USER_ID = #{crditCardUserId}
       ,CRDIT_CARD_USER_NAME = #{crditCardUserName}
       ,CRDIT_CARD_NO = #{crditCardNo}
       ,CHRG_USER_ID = #{chrgUserId}
       ,COST_CENTR = #{costCentr}
       ,COST_CENTR_NAME = #{costCentrName}
       ,BANK_CODE = #{bankCode}
       ,BANK_NAME = #{bankName}
       ,CLM_MONTH = TO_CHAR(TO_DATE(#{clmMonth}, 'MM/YYYY'), 'YYYYMM')
       ,TOT_AMT = #{allTotAmt}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CLM_NO = #{clmNo}       
</update>

<update id="updateReimbursementItem" parameterType="Map">
/* creditCardMapper.updateReimbursementItem */
   UPDATE FCM0018D
   SET EXP_TYPE = #{expType}
       ,EXP_TYPE_NAME = #{expTypeName}
       ,GL_ACC_CODE = #{glAccCode}
       ,GL_ACC_CODE_NAME = #{glAccCodeName}
       ,BUDGET_CODE = #{budgetCode}
       ,BUDGET_CODE_NAME = #{budgetCodeName}
       ,SUPPLY_NAME = #{supplyName}
       ,INVC_TYPE = #{invcType}
       ,INVC_NO = #{invcNo}
       ,INVC_DT = TO_DATE(#{invcDt}, 'DD/MM/YYYY')
       ,TAX_CODE = #{taxCode}
       ,NET_AMT = #{netAmt}
       ,TAX_AMT = #{taxAmt}
       ,TAX_NON_CLM_AMT = #{taxNonClmAmt}
       ,TOT_AMT = #{totAmt}
       ,EXP_DESC = #{expDesc}
       ,COST_CENTR = UPPER(#{sCostCentr})
       ,COST_CENTR_NAME = #{sCostCentrName}
       ,GST_RGIST_NO = #{gstRgistNo}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CLM_NO = #{clmNo}     
    AND CLM_SEQ = #{clmSeq}  
</update>

<insert id="insertApproveItems" parameterType="Map">
/* creditCardMapper.insertApproveItems */
<!-- CMM0042C_ITEM_SEQ.nextval -->
   INSERT INTO FCM0015D
   (
        APPV_PRCSS_NO
       ,APPV_ITM_SEQ
       ,INVC_NO
       ,INVC_DT
       ,INVC_TYPE
       ,MEM_ACC_ID
       ,PAY_DUE_DT
       ,EXP_TYPE
       ,EXP_TYPE_NAME
       ,COST_CENTR
       ,COST_CENTR_NAME
       ,GL_ACC_CODE
       ,GL_ACC_CODE_NAME
       ,BUDGET_CODE
       ,BUDGET_CODE_NAME
       ,TAX_CODE
       ,NET_AMT
       ,TAX_AMT
       ,TAX_NON_CLM_AMT
       ,APPV_AMT
       ,EXP_DESC
       ,ATCH_FILE_GRP_ID
       ,CLAM_UN
       ,CRT_DT
       ,CRT_USER_ID
       ,UPD_DT
       ,UPD_USER_ID
    )
    values
    (
        #{appvPrcssNo}
       ,#{appvItmSeq}
       ,#{invcNo}
       ,TO_DATE(#{invcDt}, 'DD/MM/YYYY')
       ,#{invcType}
       ,#{crditCardUserId}
       ,TO_DATE(#{payDueDt}, 'DD/MM/YYYY')
       ,#{expType}
       ,#{expTypeName}
       ,#{sCostCentr}
       ,#{sCostCentrName}
       ,#{glAccCode}
       ,#{glAccCodeName}
       ,#{budgetCode}
       ,#{budgetCodeName}
       ,#{taxCode}
       ,#{netAmt}
       ,#{taxAmt}
       ,#{taxNonClmAmt}
       ,#{totAmt}
       ,#{expDesc}
       ,#{atchFileGrpId}
       ,#{clamUn}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<update id="updateAppvPrcssNo" parameterType="Map">
/* creditCardMapper.updateAppvPrcssNo */
   UPDATE FCM0017M
   SET APPV_PRCSS_NO = #{appvPrcssNo}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CLM_NO = #{clmNo}       
</update>

<delete id="deleteReimbursement" parameterType="Map">
/* creditCardMapper.deleteReimbursement */
   DELETE FROM FCM0018D WHERE CLM_NO = #{clmNo} AND CLM_SEQ = #{clmSeq} 
</delete>

<update id="updateReimbursementTotAmt" parameterType="Map">
/* creditCardMapper.updateReimbursementTotAmt */
   UPDATE FCM0017M SET TOT_AMT = #{allTotAmt} WHERE CLM_NO = #{clmNo}
</update>

<select id="selectCreditCardNoToMgmt" resultType="egovMap">
/* creditCardMapper.selectCreditCardNoToMgmt */
SELECT CRDIT_CARD_NO AS CARD_NO, 
       ( SUBSTR(CRDIT_CARD_NO, 1, 4) 
         || '********' 
         || SUBSTR(CRDIT_CARD_NO, -4)
         || ' ' 
         || '(' 
         || CRDIT_CARD_USER_NAME 
         || ')' )    AS CARD_NAME 
FROM   FCM0016M
WHERE CRDIT_CARD_STUS = 'A'
</select>

</mapper>