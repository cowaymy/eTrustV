<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.eAccounting.creditCard.impl.CreditCardMapper">

<select id="selectCrditCardMgmtList" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectCrditCardMgmtList */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T.CRDIT_CARD_SEQ, 
       T.CRDIT_CARD_USER_ID, 
       T.CRDIT_CARD_USER_NAME, 
       T.CRDIT_CARD_NO, 
       T.CHRG_USER_ID, 
       T.CHRG_USER_NAME, 
       T.COST_CENTR, 
       T.COST_CENTR_NAME, 
       T.ATCH_FILE_GRP_ID, 
       T.ATCH_FILE_ID, 
       T.ATCH_FILE_NAME, 
       T.FILE_EXTSN, 
       T.FILE_CNT, 
       T.CRDIT_CARD_STUS_CODE, 
       T.CRDIT_CARD_STUS, 
       T.CRT_DT, 
       T.UPD_DT 
FROM   (SELECT T1.CRDIT_CARD_SEQ, 
               T1.CRDIT_CARD_USER_ID, 
               T1.CRDIT_CARD_USER_NAME, 
               ( SUBSTR(T1.CRDIT_CARD_NO, 1, 4) 
                 || '********' 
                 || SUBSTR(T1.CRDIT_CARD_NO, -4) ) AS CRDIT_CARD_NO, 
               T1.CHRG_USER_ID, 
               T2.NAME                             AS CHRG_USER_NAME, 
               T1.COST_CENTR, 
               T1.COST_CENTR_NAME, 
               T1.ATCH_FILE_GRP_ID, 
               T3.ATCH_FILE_ID, 
               T3.ATCH_FILE_NAME, 
               T3.FILE_EXTSN, 
               T3.FILE_CNT, 
               T1.CRDIT_CARD_STUS                  AS CRDIT_CARD_STUS_CODE, 
               ( CASE T1.CRDIT_CARD_STUS 
                   WHEN 'A' THEN 'Active' 
                   WHEN 'R' THEN 'Removed' 
                 END )                             AS CRDIT_CARD_STUS, 
               T1.CRT_DT, 
               T1.UPD_DT 
        FROM   FCM0016M T1 
               LEFT JOIN ORG0001D T2 
                      ON T1.CHRG_USER_ID = T2.MEM_CODE 
               LEFT JOIN (SELECT * 
                          FROM   (SELECT Row_number () 
                                           OVER ( 
                                             PARTITION BY F1.ATCH_FILE_GRP_ID 
                                             ORDER BY F1.ATCH_FILE_GRP_ID, 
                                           F2.ATCH_FILE_ID) AS 
                                         RNUM, 
                                         F1.ATCH_FILE_GRP_ID, 
                                         F2.ATCH_FILE_ID, 
                                         F2.ATCH_FILE_NAME, 
                                         F2.FILE_EXTSN, 
                                         Count (F1.ATCH_FILE_ID) 
                                           OVER ( 
                                             PARTITION BY F1.ATCH_FILE_GRP_ID) 
                                         FILE_CNT 
                                  FROM   SYS0070M F1 
                                         LEFT JOIN SYS0071D F2 
                                                ON F1.ATCH_FILE_ID = 
                                                   F2.ATCH_FILE_ID) F 
                          WHERE  F.RNUM = 1) T3 
                      ON T1.ATCH_FILE_GRP_ID = T3.ATCH_FILE_GRP_ID) T 
       WHERE 1=1
        <if test="startDt != null and startDt != ''">
        <![CDATA[ 
             AND T.UPD_DT >= TO_DATE(#{startDt}, 'DD/MM/YYYY')
        ]]>
        </if>          
        <if test="endDt != null and endDt != ''">
        <![CDATA[ 
             AND T.UPD_DT < TO_DATE(#{endDt}, 'DD/MM/YYYY') + 1
        ]]>
        </if>          
        <if test="crditCardUserId != null and crditCardUserId != ''">
             AND T.CRDIT_CARD_USER_ID LIKE '%' || #{crditCardUserId} || '%'
        </if>          
        <if test="costCenter != null and costCenter != ''">
             AND T.COST_CENTR LIKE '%' || #{costCenter} || '%'
        </if>     
        <if test="chrgUserId != null and chrgUserId != ''">
             AND T.CHRG_USER_ID LIKE '%' || #{chrgUserId} || '%'
        </if>   
        <if test="crditCardNo != null and crditCardNo != ''">
             AND T.CRDIT_CARD_NO LIKE '%' || #{crditCardNo} || '%'
        </if>
        <if test="crditCardStus != null and crditCardStus != ''">
             AND T.CRDIT_CARD_STUS_CODE IN
         <foreach item="item" collection="crditCardStus" index="index" open="(" separator="," close=")">
             #{item}
         </foreach>
        </if>   
        ORDER BY T.CRT_DT, T.UPD_DT         
</select>

<select id="selectBankCode" resultType="egovMap">
/* creditCardMapper.selectBankCode */
    SELECT CODE , NAME FROM SYS0004M
</select>

<select id="selectNextCrditCardSeq" resultType="int">
/* creditCardMapper.selectNextCrditCardSeq */
    SELECT NVL(MAX(CRDIT_CARD_SEQ) + 1, 1) AS CRDIT_CARD_SEQ FROM FCM0016M
</select>

<insert id="insertCreditCard" parameterType="Map">
/* creditCardMapper.insertCreditCard */
   INSERT INTO FCM0016M
   (
        CRDIT_CARD_SEQ
        ,CRDIT_CARD_USER_ID
        ,CRDIT_CARD_USER_NAME
        ,CRDIT_CARD_NO
        ,CHRG_USER_ID
        ,COST_CENTR
        ,COST_CENTR_NAME
        ,BANK_CODE
        ,BANK_NAME
        ,CRDIT_CARD_TYPE
        ,APPV_CRDIT_LIMIT
        ,CRDIT_CARD_EXPR_DT
        ,ATCH_FILE_GRP_ID
        ,CRDIT_CARD_REM
        ,CRDIT_CARD_STUS
        ,CRT_DT
        ,CRT_USER_ID
        ,UPD_DT
        ,UPD_USER_ID
    )
    values
    (
        #{crditCardSeq}
       ,#{crditCardUserId}
       ,#{crditCardUserName}
       ,#{crditCardNo}
       ,#{chrgUserId}
       ,#{costCentr}
       ,#{costCentrName}
       ,#{bankCode}
       ,#{bankName}
       ,#{crditCardType}
       ,#{appvCrditLimit}
       ,TO_DATE(#{crditCardExprDt}, 'MM/YYYY')
       ,#{fileGroupKey}
       ,#{crditCardRem}
       ,'A'
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<select id="selectNextIfKey" resultType="String">
/* creditCardMapper.selectNextIfKey */
    SELECT    120
       || TO_CHAR (SYSDATE, 'yymmdd')
       || '_'
       || NVL (TO_CHAR (MAX (SUBSTR (IF_KEY, 11, 7) + 1), 'FM0000000'), '0000001') AS IF_KEY
  FROM ITF0120M
 WHERE SUBSTR (IF_KEY, 4, 6) = TO_CHAR (SYSDATE, 'yymmdd')
</select>

<select id="selectNextSeq" parameterType="String" resultType="int">
/* creditCardMapper.selectNextSeq */
    SELECT NVL(MAX(SEQ) + 1, 1) AS SEQ FROM ITF0120M WHERE IF_KEY = #{ifKey}
</select>

<insert id="insertCrditCardInterface" parameterType="Map">
/* creditCardMapper.insertCrditCardInterface */
   INSERT INTO ITF0120M
   (
        IF_KEY
        ,SEQ
        ,IF_TYPE
        ,TRAN_STATUS_CD
        ,RGST_DT
        ,RGST_TM
        ,RGST_ID
        ,AGENT_NO
        ,AGENT_NM
        ,BANK_CD
        ,ACCT_ST
        ,COSTCENTER
        ,SUPP_GROUP
    )
    values
    (
        #{ifKey}
       ,#{seq}
       ,'120'
       ,'10'
       ,TO_CHAR(SYSDATE, 'YYYYDDMM')
       ,TO_CHAR(SYSDATE, 'HH24MISS')
       ,#{userId}
       ,#{agentNo}
       ,#{agentNm}
       ,#{bankCode}
       ,#{acctSt}
       ,#{costCentr}
       ,'VM05'
    )
</insert>

<select id="selectCrditCardInfo" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectCrditCardInfo */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T1.CRDIT_CARD_SEQ
        ,T1.CRDIT_CARD_USER_ID
        ,T1.CRDIT_CARD_USER_NAME
        ,T1.CRDIT_CARD_NO
        ,T1.CHRG_USER_ID
        ,T2.NAME    AS CHRG_USER_NAME
        ,T1.COST_CENTR
        ,T1.COST_CENTR_NAME
        ,T1.BANK_CODE
        ,T1.BANK_NAME
        ,T1.CRDIT_CARD_TYPE
        ,T1.APPV_CRDIT_LIMIT
        ,TO_CHAR(T1.CRDIT_CARD_EXPR_DT, 'MM/YYYY') AS CRDIT_CARD_EXPR_DT
        ,T1.ATCH_FILE_GRP_ID
        ,T1.CRDIT_CARD_REM
        ,T1.CRDIT_CARD_STUS
        ,T1.CRT_DT
        ,T1.CRT_USER_ID
        ,T1.UPD_DT
        ,T1.UPD_USER_ID 
FROM   FCM0016M T1 LEFT JOIN ORG0001D T2 
                      ON T1.CHRG_USER_ID = T2.MEM_CODE
WHERE T1.CRDIT_CARD_SEQ = #{crditCardSeq}
</select>

<update id="updateCreditCard" parameterType="Map">
/* creditCardMapper.updateCreditCard */
   UPDATE FCM0016M
   SET CRDIT_CARD_USER_ID = #{crditCardUserId}
       ,CRDIT_CARD_USER_NAME = #{crditCardUserName}
       ,CRDIT_CARD_NO = #{crditCardNo}
       ,CHRG_USER_ID = #{chrgUserId}
       ,COST_CENTR = #{costCentr}
       ,COST_CENTR_NAME = #{costCentrName}
       ,BANK_CODE = #{bankCode}
       ,BANK_NAME = #{bankName}
       ,CRDIT_CARD_TYPE = #{crditCardType}
       ,APPV_CRDIT_LIMIT = #{appvCrditLimit}
       ,CRDIT_CARD_EXPR_DT = TO_DATE(#{crditCardExprDt}, 'MM/YYYY')
       ,CRDIT_CARD_REM = #{crditCardRem}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CRDIT_CARD_SEQ = #{crditCardSeq}  
</update>

<update id="removeCreditCard" parameterType="Map">
/* creditCardMapper.removeCreditCard */
   UPDATE FCM0016M
   SET CRDIT_CARD_STUS = 'R'
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CRDIT_CARD_SEQ = #{crditCardSeq}  
</update>

<select id="selectReimbursementList" parameterType="Map" resultType="egovMap">
/* creditCardMapper.selectReimbursementList */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT 
T.CLM_NO, 
       T.CRDIT_CARD_USER_ID, 
       T.CRDIT_CARD_USER_NAME, 
       T.CRDIT_CARD_NO, 
       T.CHRG_USER_ID, 
       T.CHRG_USER_NAME, 
       T.COST_CENTR, 
       T.COST_CENTR_NAME, 
       T.CLM_MONTH, 
       T.ALL_TOT_AMT, 
       T.REQST_DT, 
       T.APPV_PRCSS_STUS_CODE, 
       T.APPV_PRCSS_STUS, 
       T.APPV_PRCSS_DT
FROM (SELECT T1.CLM_NO,
T1.CRDIT_CARD_USER_ID,
T1.CRDIT_CARD_USER_NAME,
( SUBSTR(T1.CRDIT_CARD_NO, 1, 4) 
                 || '********' 
                 || SUBSTR(T1.CRDIT_CARD_NO, -4) ) AS CRDIT_CARD_NO,
T1.CHRG_USER_ID,
T2.NAME AS CHRG_USER_NAME,
T1.COST_CENTR,
T1.COST_CENTR_NAME,
T1.CLM_MONTH,
T1.TOT_AMT AS ALL_TOT_AMT,
T3.REQST_DT,
NVL (T3.APPV_PRCSS_STUS, 'T')   AS APPV_PRCSS_STUS_CODE, 
               NVL (( CASE T3.APPV_PRCSS_STUS 
                        WHEN 'R' THEN 'Request' 
                        WHEN 'P' THEN 'Approve In-Progress' 
                        WHEN 'A' THEN 'Approved' 
                        WHEN 'J' THEN 'Rejected' 
                      END ), 'Temporary Save') AS APPV_PRCSS_STUS, 
T3.APPV_PRCSS_DT
FROM   FCM0017M T1
LEFT JOIN ORG0001D T2 
ON T1.CHRG_USER_ID = T2.MEM_CODE
LEFT JOIN FCM0004M T3
ON T1.APPV_PRCSS_NO = T3.APPV_PRCSS_NO) T
       WHERE 1=1
        <if test="startDt != null and startDt != ''">
        <![CDATA[ 
             AND T.REQST_DT >= TO_DATE(#{startDt}, 'DD/MM/YYYY')
        ]]>
        </if>          
        <if test="endDt != null and endDt != ''">
        <![CDATA[ 
             AND T.REQST_DT < TO_DATE(#{endDt}, 'DD/MM/YYYY') + 1
        ]]>
        </if>          
        <if test="crditCardUserId != null and crditCardUserId != ''">
             AND T.CRDIT_CARD_USER_ID LIKE '%' || #{crditCardUserId} || '%'
        </if>          
        <if test="costCenter != null and costCenter != ''">
             AND T.COST_CENTR LIKE '%' || #{costCenter} || '%'
        </if>     
        <if test="chrgUserId != null and chrgUserId != ''">
             AND T.CHRG_USER_ID LIKE '%' || #{chrgUserId} || '%'
        </if>   
        <if test="crditCardNo != null and crditCardNo != ''">
             AND T.CRDIT_CARD_NO LIKE '%' || #{crditCardNo} || '%'
        </if>
        <if test="appvPrcssStus != null and appvPrcssStus != ''">
             AND T.APPV_PRCSS_STUS_CODE IN
         <foreach item="item" collection="appvPrcssStus" index="index" open="(" separator="," close=")">
             #{item}
         </foreach>
        </if>   
        ORDER BY T.CLM_NO         
</select>

</mapper>