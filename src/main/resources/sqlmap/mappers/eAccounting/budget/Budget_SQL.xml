<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.eAccounting.budget.impl.BudgetMapper">
<!--                  ,(select user_name from SYS0047M where user_id = CRT_USER_ID)   -->
 <select id="selectMonthlyBudgetList" parameterType="Map" resultType="egovMap">
		        SELECT  BUDGET_PLAN_YEAR
               ,COST_CENTR              
               ,(SELECT B.COST_CENTER_TEXT FROM FCM0008M B WHERE B.COST_CENTER = A.COST_CENTR) COST_CENTER_TEXT
               ,GL_ACC_CODE
               ,(SELECT B.GL_ACC_DESC FROM FCM0009M B WHERE B.GL_ACC_CODE = A.GL_ACC_CODE) GL_ACC_DESC
               ,BUDGET_CODE
               ,(SELECT B.BUDGET_CODE_TEXT FROM FCM0010M B WHERE B.BUDGET_CODE = A.BUDGET_CODE) BUDGET_CODE_TEXT
               ,M1, M2, M3, M4, M5, M6
               ,M7, M8, M9, M10, M11, M12 
      FROM (
            SELECT BUDGET_PLAN_YEAR
                       ,COST_CENTR
                       ,GL_ACC_CODE
                       ,BUDGET_CODE
                       ,NVL(M1,0) M1, NVL(M2,0) M2, NVL(M3,0)M3, NVL(M4,0)M4, NVL(M5,0)M5, NVL(M6,0)M6
                       ,NVL(M7,0) M7, NVL(M8,0) M8, NVL(M9,0) M9, NVL(M10,0) M10, NVL(M11,0) M11, NVL(M12,0) M12
              FROM FCM0101M  
              PIVOT (MAX(CASE WHEN '0'=#{budgetPlan} THEN PLAN_AMT +  CHNG_AMT  WHEN '1'=#{budgetPlan} THEN PLAN_AMT ELSE 0 END) 
                FOR BUDGET_PLAN_MONTH IN ( '1' AS M1, '2' AS M2, '3' AS M3, '4' AS M4, '5' AS M5, '6' AS M6
                                                              ,'7' AS M7, '8' AS M8, '9' AS M9, '10' AS M10, '11' AS M11, '12' AS M12)
                        )
                ) A
         WHERE A.BUDGET_PLAN_YEAR =#{budgetPlanYear} 
          <if test="stCostCentr != null and stCostCentr != ''">
           AND COST_CENTR BETWEEN #{stCostCentr} AND #{edCostCentr}
        </if>  
          <if test="stGlAccCode != null and stGlAccCode != ''">
           AND GL_ACC_CODE BETWEEN #{stGlAccCode} AND #{edGlAccCode}
        </if>  
          <if test="stBudgetCode != null and stBudgetCode != ''">
           AND BUDGET_CODE BETWEEN #{stBudgetCode} AND #{edBudgetCode}
        </if>  
         ORDER BY COST_CENTR
  </select>
  
  <select id="selectAvailableBudgetAmt" parameterType="Map" resultType="egovMap">
  <![CDATA[
      SELECT A.PLAN_AMT
                ,A.CHNG_AMT
                ,NVL(B.TOTAL,0) AS ADJUST_AMT
                ,NVL(A.PLAN_AMT,0) + NVL(A.CHNG_AMT,0) + (NVL(B.PLUS_ADJ_AMT,0) - NVL(B.MINUS_ADJ_AMT,0)) AS TOTAL
                ,NVL(PEND_APPV_AMT,0)  PEND_APPV_AMT
                ,NVL(CONSUM_APPV_AMT,0) CONSUM_APPV_AMT
                ,NVL(A.PLAN_AMT,0) + NVL(A.CHNG_AMT,0) + NVL(B.TOTAL,0) -NVL(C.APP_AMT_TOTAL ,0) AS AVAILABLE_AMT
       FROM FCM0101M A
               LEFT OUTER JOIN ( SELECT SUM(CASE  WHEN A.SIGNAL = '+' THEN A.ADJ_AMT ELSE 0 END) AS PLUS_ADJ_AMT 
                              ,SUM(CASE  WHEN A.SIGNAL = '-' THEN A.ADJ_AMT ELSE 0 END) AS MINUS_ADJ_AMT
                              ,SUM(CASE  WHEN A.SIGNAL = '+' THEN A.ADJ_AMT ELSE 0 END)  - SUM(CASE  WHEN A.SIGNAL = '-' THEN A.ADJ_AMT ELSE 0 END) TOTAL
                              ,A.COST_CENTR
                              ,A.BUDGET_CODE
                              ,A.GL_ACC_CODE
                              ,A.BUDGET_ADJ_YEAR 
                              ,A.BUDGET_ADJ_MONTH
                       FROM FCM0103D A, FCM0102M B
                      WHERE  A.BUDGET_DOC_NO     = B.BUDGET_DOC_NO
                        AND B.APPV_STUS = 'C' 
                        GROUP BY  A.BUDGET_ADJ_YEAR, A.BUDGET_ADJ_MONTH ,A.COST_CENTR ,A.BUDGET_CODE, A.GL_ACC_CODE 
                  ) B  ON  A.BUDGET_PLAN_YEAR = B.BUDGET_ADJ_YEAR 
                        AND A.BUDGET_PLAN_MONTH  = B.BUDGET_ADJ_MONTH 
                        AND A.COST_CENTR         = B.COST_CENTR 
                        AND A.BUDGET_CODE       = B.BUDGET_CODE 
                        AND A.GL_ACC_CODE       = B.GL_ACC_CODE
                 LEFT OUTER JOIN (SELECT A.COST_CENTR 
                               ,A.BUDGET_CODE
                               ,A.GL_ACC_CODE
                               ,SUM(CASE WHEN B.APPV_PRCSS_STUS IN ( 'R' ,'P' ) THEN A.NET_AMT ELSE 0 END ) AS PEND_APPV_AMT 
                               ,SUM(CASE WHEN B.APPV_PRCSS_STUS = 'A'  THEN A.NET_AMT ELSE 0 END ) AS CONSUM_APPV_AMT  
                               ,SUM(A.NET_AMT ) APP_AMT_TOTAL
                               ,A.INVC_DT
                       FROM FCM0015D A, FCM0004M B
                     WHERE  A.APPV_PRCSS_NO   = B.APPV_PRCSS_NO
                         AND B.APPV_PRCSS_STUS IN( 'R' ,'P' ,'A') 
                     GROUP BY A.INVC_DT, A.COST_CENTR, A.BUDGET_CODE, A.GL_ACC_CODE
                 )   C          
                        ON A.BUDGET_PLAN_YEAR = TO_CHAR(C.INVC_DT, 'YYYY') 
                        AND A.BUDGET_PLAN_MONTH = TO_CHAR(C.INVC_DT, 'MM') 
                        AND A.COST_CENTR     = C.COST_CENTR 
                        AND A.BUDGET_CODE  = C.BUDGET_CODE 
                        AND A.GL_ACC_CODE  = C.GL_ACC_CODE
                        ]]>
      WHERE BUDGET_PLAN_YEAR   = #{budgetPlanYear}
        AND BUDGET_PLAN_MONTH  =#{budgetPlanMonth}
        AND A.COST_CENTR         = #{costCentr}
        AND A.BUDGET_CODE        = #{budgetCode}
        AND A.GL_ACC_CODE        = #{glAccCode}
  </select>
  
  <select id="selectAdjustmentAmount" parameterType="Map" resultType="egovMap">
  <![CDATA[
      SELECT TO_CHAR(A.UPD_DT, 'dd-mm-yyyy hh24:mi') AS CONFIRM_DATE 
		          ,B.BUDGET_ADJ_TYPE
		          ,FN_GET_CODENAME('347', B.BUDGET_ADJ_TYPE) BUDGET_ADJ_TYPE_NAME
		          ,CASE WHEN B.SIGNAL ='+' THEN 'Receiver(+)' ELSE 'Sender(-)' END SIGNAL_TEXT
		          ,B.BUDGET_ADJ_YEAR || '/' ||TO_CHAR(B.BUDGET_ADJ_MONTH, 'FM00') BUDGET_ADJ_MONTH
		          ,B.COST_CENTR
		          ,(SELECT COST_CENTER_TEXT FROM FCM0008M A WHERE A.COST_CENTER = B.COST_CENTR) COST_CENTER_TEXT
		          ,B.GL_ACC_CODE
		          ,(SELECT GL_ACC_DESC FROM FCM0009M A WHERE A.GL_ACC_CODE = B.GL_ACC_CODE) GL_ACC_DESC
		          ,B.SIGNAL 
		          ,ADJ_AMT
		          ,A.ADJ_REM    
		 FROM FCM0102M  A,  FCM0103D B
		WHERE  A.BUDGET_DOC_NO     = B.BUDGET_DOC_NO
		    AND A.APPV_STUS = 'C' 
                        ]]>
            AND B.BUDGET_ADJ_YEAR   = #{budgetPlanYear}
            AND B.BUDGET_ADJ_MONTH  = #{budgetPlanMonth}            
            AND B.COST_CENTR         = #{costCentr}
            AND B.BUDGET_CODE        = #{budgetCode}
            AND B.GL_ACC_CODE        = #{glAccCode}
  </select>
  
  <select id="selectPenConAmount" parameterType="Map" resultType="egovMap">
	  SELECT A.APPV_REQ_KEY_NO 
	           ,B.COST_CENTR_NAME       
               ,(SELECT USER_NAME FROM SYS0047M WHERE USER_ID = A.CRT_USER_ID) AS USER_NAME  
	           ,A.CRT_USER_ID
	           ,TO_CHAR(A.CRT_DT, 'dd/mm/yyyy') CRT_DT 
	           ,TO_CHAR(B.INVC_DT, 'dd/mm/yyyy') INVC_DT
	           ,TO_CHAR(B.PAY_DUE_DT, 'dd/mm/yyyy') PAY_DUE_DT
	           ,B.MEM_ACC_ID
	           ,(SELECT MEM_ACC_NAME FROM FCM0006M WHERE MEM_ACC_ID = B.MEM_ACC_ID) AS MEM_ACC_NAME
	           ,B.NET_AMT
	           ,B.EXP_DESC
	   FROM FCM0004M A, FCM0015D B
	 WHERE  A.APPV_PRCSS_NO   = B.APPV_PRCSS_NO
	 <if test='type == "Pending" '>
	     AND A.APPV_PRCSS_STUS IN ( 'R' ,'P' ) 
	 </if>
	 <if test='type == "Consumed" '>
	     AND A.APPV_PRCSS_STUS =  'A'  
	 </if>
	     AND TO_CHAR(B.INVC_DT, 'yyyy')   = #{budgetPlanYear}
	     AND TO_CHAR(B.INVC_DT, 'mm')   = #{budgetPlanMonth}          
         AND B.COST_CENTR         = #{costCentr}
         AND B.BUDGET_CODE        = #{budgetCode}
         AND B.GL_ACC_CODE        = #{glAccCode}
  </select>
  
  <select id="selectAdjustmentList" parameterType="Map" resultType="egovMap">
       <![CDATA[ 
       SELECT  CASE WHEN A.APPV_STUS = 'C' THEN 'Close' ELSE 'Open' END STATUS
		         ,A.BUDGET_DOC_NO
		         ,B.COST_CENTR
		         ,TO_CHAR(BUDGET_ADJ_MONTH, 'FM00') || '/' || BUDGET_ADJ_YEAR ADJ_YEAR_MONTH
		         ,B.BUDGET_CODE
		         ,B.GL_ACC_CODE
		         ,FN_GET_CODENAME('347', B.BUDGET_ADJ_TYPE) BUDGET_ADJ_TYPE_NAME
		         ,B.ADJ_AMT
		         ,A.ADJ_REM
		         ,A.ATCH_FILE_GRP_ID
		         ,FD.FILE_SUB_PATH
		         ,CASE WHEN A.APPV_STUS = 'C' THEN 'N' ELSE 'Y' END AS CHECK_ID                 
		FROM FCM0102M A
	   INNER JOIN FCM0103D B 
	       ON A.BUDGET_DOC_NO     = B.BUDGET_DOC_NO
	     LEFT OUTER JOIN SYS0070M FM
	       ON A.ATCH_FILE_GRP_ID = FM.ATCH_FILE_GRP_ID
	     LEFT OUTER JOIN SYS0071D FD
	       ON FM.ATCH_FILE_ID = FD.ATCH_FILE_ID
	  WHERE  TO_CHAR(BUDGET_ADJ_MONTH, 'FM00') || '/' || BUDGET_ADJ_YEAR  BETWEEN #{stYearMonth} AND #{edYearMonth}  
	  ]]>      
        <if test="costCentr != null and costCentr != ''">
          AND B.COST_CENTR    = #{costCentr}
          </if>
        <if test="budgetCode != null and budgetCode != ''">
          AND B.BUDGET_CODE  = #{budgetCode}
          </if>
        <if test="glAccCode != null and glAccCode != ''">
          AND B.GL_ACC_CODE  = #{glAccCode}
          </if>
           <if test="budgetAdjType != null and budgetAdjType != ''">
           AND B.BUDGET_ADJ_TYPE IN
         <foreach item="item" collection="budgetAdjType" index="index" open="(" separator="," close=")">
           #{item}
         </foreach>
         </if>         
        <if test="budgetDocNo != null and budgetDocNo != ''">
          AND A.BUDGET_DOC_NO LIKE '%' || #{budgetDocNo} || '%'
          </if>          
        <if test="appvStus != null and appvStus != ''">
           AND A.APPV_STUS = #{appvStus}
           </if>
  </select>
  
 
    <insert id="insertAdjustmentM" parameterType="Map">
        <selectKey keyProperty="id" resultType="int" order="BEFORE">
            SELECT TO_CHAR(SYSDATE, 'yyyymm') || NVL(TO_CHAR(MAX(SUBSTR(BUDGET_DOC_NO,7,4)) + 1, 'FM0000'), '0001') ID 
		       FROM FCM0102M
		     WHERE BUDGET_DOC_NO LIKE  TO_CHAR(SYSDATE, 'yyyymm') ||'%' 
        </selectKey>
        
		   INSERT INTO FCM0102M
		   (
		        BUDGET_DOC_NO
		       ,ADJ_REM
		       ,ATCH_FILE_GRP_ID
		       ,APPV_STUS
		       ,CRT_DT
		       ,CRT_USER_ID
		       ,UPD_DT
		       ,UPD_USER_ID
		   )
		   VALUES
		    (
		        #{id}
		       ,#{adjRem}
		       ,#{atchFileGrpId}
		       ,'O'
		       ,SYSDATE
		       ,#{userId}
		       ,SYSDATE
		       ,#{userId}
		    )
    </insert>
    
    <insert id="insertAdjustmentD" parameterType="Map">
        <selectKey keyProperty="seq" resultType="int" order="BEFORE">
            SELECT NVL(MAX(BUDGET_DOC_SEQ) +1,1) FROM FCM0103D WHERE BUDGET_DOC_NO = #{budgetDocNo}
        </selectKey>
        
		   INSERT INTO FCM0103D
		   (
		        BUDGET_DOC_NO
		       ,BUDGET_DOC_SEQ
		       ,BUDGET_ADJ_MONTH
               ,BUDGET_ADJ_YEAR
		       ,BUDGET_ADJ_TYPE
		       ,SIGNAL
		       ,COST_CENTR
		       ,BUDGET_CODE
		       ,GL_ACC_CODE
		       ,ADJ_AMT
		       ,CRT_DT
		       ,CRT_USER_ID
		       ,UPD_DT
		       ,UPD_USER_ID
		   )
		 VALUES
		   (
		        #{budgetDocNo}
		       ,#{seq}
		       ,SUBSTR(#{adjYearMonth}, 0,2)
		       ,SUBSTR(#{adjYearMonth}, 4,4)
		       ,#{budgetAdjType}
		       ,#{signal}
		       ,#{costCentr}
		       ,#{budgetCode}
		       ,#{glAccCode}
		       ,#{adjAmt}
		       ,SYSDATE
		       ,#{userId}
		       ,SYSDATE
		       ,#{userId}
		   )
    </insert>
<!-- 
  
  
  <update id="updateExpenseInfo" parameterType="Map">
   UPDATE FCM0001M
      SET  
      <if test ="disabFlag != nul and disabFlag !=''">
            ,DISAB_FLAG = #{disabFlag}            
            ,DISAB_USER_ID   = #{userId}
            ,DISAB_DT        = SYSDATE
      </if>
      <if test ="disabFlag == nul || disabFlag ==''">
             GL_ACC_CODE = #{glAccCode}
            ,GL_ACC_CODE_NAME = #{glAccCodeName}
            ,BUDGET_CODE = #{budgetCode}
            ,BUDGET_CODE_NAME = #{budgetCodeName}
    </if>    
            ,UPD_USER_ID   = #{userId}
            ,UPD_DT        = SYSDATE
    WHERE  CLM_TYPE     = #{clmType}
      AND  EXP_TYPE       = #{expType}
</update>
 -->
</mapper>