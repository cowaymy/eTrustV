<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.eAccounting.webInvoice.impl.WebInvoiceMapper">

<select id="selectWebInvoiceList" parameterType="Map" resultType="egovMap">
/* webInvoiceMapper.selectWebInvoiceList */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT   T.CLM_NO
        ,T.INVC_NO
        ,T.INVC_DT
        ,T.COST_CENTR
        ,T.COST_CENTR_NAME
        ,T.INVC_TYPE
        ,T.MEM_ACC_ID
        ,T.MEM_ACC_NAME
        ,T.TOT_AMT
        ,T.REQST_DT
        ,T.APPV_PRCSS_STUS_CODE
        ,T.APPV_PRCSS_STUS
        ,T.APPV_PRCSS_DT
    FROM (SELECT T1.CLM_NO
                ,T1.INVC_NO
                ,T1.INVC_DT
                ,T1.COST_CENTR
                ,T1.COST_CENTR_NAME
                , (CASE T1.INVC_TYPE
                      WHEN 'F'
                         THEN 'Full Tax invoice'
                      WHEN 'S'
                         THEN 'Simplified Tax invoice'
                   END
                  ) INVC_TYPE
                ,T1.MEM_ACC_ID
                ,T2.MEM_ACC_NAME
                ,NVL(T1.TOT_AMT, 0) AS TOT_AMT
                ,TO_CHAR (T3.REQST_DT, 'DD/MM/YYYY') AS REQST_DT
                ,NVL (T3.APPV_PRCSS_STUS, 'T') AS APPV_PRCSS_STUS_CODE
                ,NVL ( (CASE T3.APPV_PRCSS_STUS
                           WHEN 'R'
                              THEN 'Request'
                           WHEN 'P'
                              THEN 'Approve In-Progress'
                           WHEN 'A'
                              THEN 'Approved'
                           WHEN 'J'
                              THEN 'Reject'
                        END
                       )
                     ,'Temporary Save'
                     ) APPV_PRCSS_STUS
                ,TO_CHAR (T3.APPV_PRCSS_DT, 'DD/MM/YYYY') AS APPV_PRCSS_DT
            FROM FCM0002M T1 LEFT JOIN FCM0006M T2 ON T1.MEM_ACC_ID = T2.MEM_ACC_ID
                 LEFT JOIN FCM0004M T3 ON T1.APPV_PRCSS_NO = T3.APPV_PRCSS_NO
                 ) T
          WHERE 1=1
        <if test="startDt != null and startDt != ''">
        <![CDATA[ 
             AND T.INVC_DT >= TO_DATE(#{startDt}, 'DD/MM/YYYY')
        ]]>
        </if>          
        <if test="endDt != null and endDt != ''">
        <![CDATA[ 
             AND T.INVC_DT <= TO_DATE(#{endDt}, 'DD/MM/YYYY')
        ]]>
        </if>          
        <if test="memAccID != null and memAccID != ''">
             AND T.MEM_ACC_ID LIKE '%' || #{memAccID} || '%'
        </if>          
        <if test="costCenter != null and costCenter != ''">
             AND T.COST_CENTR LIKE '%' || #{costCenter} || '%'
        </if>     
        <if test="appvPrcssStus != null and appvPrcssStus != ''">
             AND T.APPV_PRCSS_STUS_CODE IN
         <foreach item="item" collection="appvPrcssStus" index="index" open="(" separator="," close=")">
             #{item}
         </foreach>
        </if>
        ORDER BY T.CLM_NO         
</select>

<select id="selectWebInvoiceInfo" parameterType="String" resultType="egovMap">
/* webInvoiceMapper.selectWebInvoiceInfo */
            SELECT T1.CLM_NO
                   ,T1.INVC_NO
                   ,TO_CHAR(T1.INVC_DT, 'DD/MM/YYYY') AS INVC_DT
                   ,T1.COST_CENTR
                   ,T1.COST_CENTR_NAME
                   ,T1.INVC_TYPE
                   ,T1.MEM_ACC_ID
                   ,T2.MEM_ACC_NAME
                   ,T1.GST_RGIST_NO
                   ,T1.BANK_CODE
                   ,T2.BANK_NAME
                   ,T1.BANK_ACC_NO
                   ,TO_CHAR(T1.PAY_DUE_DT, 'DD/MM/YYYY') AS PAY_DUE_DT
                   ,T1.ATCH_FILE_GRP_ID
                   ,T1.INVC_REM
                   ,NVL(T1.TOT_AMT, 0) TOT_AMT
                   ,T1.APPV_PRCSS_NO
                   ,T1.CRT_DT
                   ,T1.CRT_USER_ID
                   ,T1.TOT_AMT
          FROM FCM0002M T1
          LEFT JOIN FCM0006M T2
          ON T1.MEM_ACC_ID = T2.MEM_ACC_ID
          WHERE T1.CLM_NO = #{clmNo}
</select>

<select id="selectWebInvoiceItems" parameterType="String" resultType="egovMap">
/* webInvoiceMapper.selectWebInvoiceItems */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
            SELECT CLM_SEQ
                   ,EXP_TYPE
                   ,EXP_TYPE_NAME
                   ,GL_ACC_CODE
                   ,GL_ACC_CODE_NAME
                   ,BUDGET_CODE
                   ,BUDGET_CODE_NAME
                   ,TAX_CODE
                   ,'MYR' AS CVRR
                   ,NET_AMT
                   ,TAX_AMT
                   ,TOT_AMT
                   ,EXP_DESC
          FROM FCM0003D
          WHERE CLM_NO = #{clmNo}
          ORDER BY CLM_SEQ
</select>

<select id="selectApproveList" parameterType="Map" resultType="egovMap">
/* webInvoiceMapper.selectApproveList */
<!-- TO_CHAR(DISAB_DT, 'yyyy-mm-dd') -->
SELECT T.APPV_PRCSS_NO
      ,T.APPV_LINE_SEQ
      ,T.CLM_NO
      ,T.REQST_USER_ID
      ,T.REQST_DT
      ,T.CODE
      ,T.CODE_NAME
      ,T.COST_CENTR
      ,T.COST_CENTR_NAME
      ,T.INVC_TYPE
      ,T.INVC_DT
      ,T.MEM_ACC_ID
      ,T.MEM_ACC_NAME
      ,T.APPV_AMT
      ,T.APPV_PRCSS_STUS
      ,T.APPV_PRCSS_STUS_CODE
      ,T.ATCH_FILE_GRP_ID
      ,T.ATCH_FILE_ID
      ,T.ATCH_FILE_NAME
      ,T.FILE_EXTSN
      ,T.FILE_CNT
      ,T.APPV_PRCSS_DT
  FROM (SELECT   T1.APPV_PRCSS_NO
                ,T2.APPV_LINE_SEQ
                ,T1.APPV_REQ_KEY_NO AS CLM_NO
                ,T1.REQST_USER_ID
                ,TO_CHAR (T1.REQST_DT, 'DD/MM/YYYY') AS REQST_DT
                ,T4.CODE
                ,T4.CODE_NAME
                ,T3.COST_CENTR
                ,T3.COST_CENTR_NAME
                , (CASE T3.INVC_TYPE
                      WHEN 'F'
                         THEN 'Full Tax invoice'
                      WHEN 'S'
                         THEN 'Simplified Tax invoice'
                   END
                  ) INVC_TYPE
                ,T3.INVC_DT
                ,T3.MEM_ACC_ID
                ,T5.MEM_ACC_NAME
                ,SUM (T3.APPV_AMT) APPV_AMT
                , (CASE T1.APPV_PRCSS_STUS
                      WHEN 'R'
                         THEN 'Request'
                      WHEN 'P'
                         THEN 'Approve In-Progress'
                      WHEN 'A'
                         THEN 'Approved'
                      WHEN 'J'
                         THEN 'Reject'
                   END
                  ) APPV_PRCSS_STUS
                ,T1.APPV_PRCSS_STUS AS APPV_PRCSS_STUS_CODE
                ,T3.ATCH_FILE_GRP_ID
                ,T6.ATCH_FILE_ID
                ,T6.ATCH_FILE_NAME
                ,T6.FILE_EXTSN
                ,T6.FILE_CNT
                ,TO_CHAR (T1.APPV_PRCSS_DT, 'DD/MM/YYYY') APPV_PRCSS_DT
            FROM FCM0004M T1 LEFT JOIN FCM0005D T2 ON T1.APPV_PRCSS_NO = T2.APPV_PRCSS_NO
                 LEFT JOIN FCM0015D T3 ON T1.APPV_PRCSS_NO = T3.APPV_PRCSS_NO
                 LEFT JOIN SYS0013M T4 ON SUBSTR (T1.APPV_REQ_KEY_NO, 1, 2) = T4.CODE
                 LEFT JOIN FCM0006M T5 ON T3.MEM_ACC_ID = T5.MEM_ACC_ID
                 LEFT JOIN
                 (SELECT *
                    FROM (SELECT ROW_NUMBER () OVER (PARTITION BY F1.ATCH_FILE_GRP_ID ORDER BY F1.ATCH_FILE_GRP_ID
                                 ,F2.ATCH_FILE_ID) AS RNUM
                                ,F1.ATCH_FILE_GRP_ID
                                ,F2.ATCH_FILE_ID
                                ,F2.ATCH_FILE_NAME
                                ,F2.FILE_EXTSN
                                ,COUNT (F1.ATCH_FILE_ID) OVER (PARTITION BY F1.ATCH_FILE_GRP_ID)
                                                                                           FILE_CNT
                            FROM SYS0070M F1 LEFT JOIN SYS0071D F2 ON F1.ATCH_FILE_ID =
                                                                                     F2.ATCH_FILE_ID
                                 ) F
                   WHERE F.RNUM = 1) T6 ON T3.ATCH_FILE_GRP_ID = T6.ATCH_FILE_GRP_ID
           WHERE     T2.APPV_LINE_USER_ID = 'IVYLIM'
                 AND T1.APPV_PRCSS_STUS = 'R'
              OR     T1.APPV_PRCSS_STUS = 'P'
                 AND T2.APPV_STUS = 'R'
              OR T2.APPV_STUS = 'A'
              OR T2.APPV_STUS = 'J'
        GROUP BY T1.APPV_PRCSS_NO
                ,T2.APPV_LINE_SEQ
                ,T1.APPV_REQ_KEY_NO
                ,T1.REQST_USER_ID
                ,T1.REQST_DT
                ,T4.CODE
                ,T4.CODE_NAME
                ,T3.COST_CENTR
                ,T3.COST_CENTR_NAME
                ,T3.INVC_TYPE
                ,T3.INVC_DT
                ,T3.MEM_ACC_ID
                ,T5.MEM_ACC_NAME
                ,T1.APPV_PRCSS_STUS
                ,T3.ATCH_FILE_GRP_ID
                ,T6.ATCH_FILE_ID
                ,T6.ATCH_FILE_NAME
                ,T6.FILE_EXTSN
                ,T6.FILE_CNT
                ,T1.APPV_PRCSS_DT) T
  WHERE 1 = 1   
        <if test="startDt != null and startDt != ''">
        <![CDATA[ 
             AND T.INVC_DT >= TO_DATE(#{startDt}, 'DD/MM/YY')
        ]]>
        </if>          
        <if test="endDt != null and endDt != ''">
        <![CDATA[ 
             AND T.INVC_DT <= TO_DATE(#{endDt} || ' 23:59:59', 'DD/MM/YY HH24:MI:SS')
        ]]>
        </if>          
        <if test="memAccID != null and memAccID != ''">
             AND T.MEM_ACC_ID LIKE '%' || #{memAccID} || '%'
        </if>          
        <if test="createUser != null and createUser != ''">
             AND T.REQST_USER_ID LIKE '%' || #{createUser} || '%'
        </if>          
        <if test="costCenter != null and costCenter != ''">
             AND T.COST_CENTR LIKE '%' || #{costCenter} || '%'
        </if>     
        <if test="appvPrcssStus != null and appvPrcssStus != ''">
             AND T.APPV_PRCSS_STUS_CODE IN
         <foreach item="item" collection="appvPrcssStus" index="index" open="(" separator="," close=")">
             #{item}
         </foreach>
        </if>
        <if test="clmType != null and clmType != ''">
             AND T.CODE IN
         <foreach item="item" collection="clmType" index="index" open="(" separator="," close=")">
             #{item}
         </foreach>
        </if>
        ORDER BY T.APPV_PRCSS_NO, T.REQST_DT           
</select>

<select id="selectAppvInfoAndItems" parameterType="String" resultType="egovMap">
/* webInvoiceMapper.selectAppvInfoAndItems */
            SELECT T1.APPV_PRCSS_NO
                      ,T1.APPV_PRCSS_STUS
                      ,T1.APPV_REQ_KEY_NO AS CLM_NO
                      ,T4.CODE_NAME AS CLM_TYPE
                      ,TO_CHAR(T1.REQST_DT, 'DD/MM/YYYY') AS REQST_DT
                      ,T1.REQST_USER_ID
                      ,T1.APPV_LINE_CNT
                      ,T1.APPV_LINE_PRCSS_CNT
                      ,T2.APPV_LINE_USER_ID
                      ,TO_CHAR(T2.APPV_DT, 'DD/MM/YYYY') AS APPV_DT
                      ,T2.APPV_STUS
                      ,T3.APPV_ITM_SEQ
                      ,T3.INVC_NO
                      ,TO_CHAR(T3.INVC_DT, 'DD/MM/YYYY') AS INVC_DT
                      ,T3.MEM_ACC_ID
                      ,TO_CHAR(T3.PAY_DUE_DT, 'DD/MM/YYYY') AS PAY_DUE_DT
                      ,T3.EXP_TYPE
                      ,T3.EXP_TYPE_NAME
                      ,T3.COST_CENTR
                      ,T3.COST_CENTR_NAME
                      ,T3.GL_ACC_CODE
                      ,T3.GL_ACC_CODE_NAME
                      ,T3.BUDGET_CODE
                      ,T3.BUDGET_CODE_NAME
                      ,T3.TAX_CODE
                      ,T3.NET_AMT
                      ,T3.TAX_AMT
                      ,T3.APPV_AMT
                      ,T3.EXP_DESC
          FROM FCM0004M T1 LEFT JOIN FCM0005D T2 ON T1.APPV_PRCSS_NO = T2.APPV_PRCSS_NO
          LEFT JOIN FCM0015D T3 ON T1.APPV_PRCSS_NO = T3.APPV_PRCSS_NO
          LEFT JOIN SYS0013M T4 ON SUBSTR (T1.APPV_REQ_KEY_NO, 1, 2) = T4.CODE
          WHERE T1.APPV_PRCSS_NO = #{appvPrcssNo}
          ORDER BY T3.APPV_ITM_SEQ         
</select>

<select id="selectAttachList" parameterType="String" resultType="egovMap">
/* webInvoiceMapper.selectAttachList */
            SELECT T1.ATCH_FILE_GRP_ID
                   ,T1.ATCH_FILE_ID
                   ,T2.ATCH_FILE_NAME
                   ,T2.FILE_SUB_PATH
                   ,T2.PHYSICL_FILE_NAME
                   ,T2.FILE_EXTSN
                   ,T2.FILE_SIZE
          FROM SYS0070M T1
          LEFT JOIN SYS0071D T2
          ON T1.ATCH_FILE_ID = T2.ATCH_FILE_ID
          WHERE T1.ATCH_FILE_GRP_ID = #{atchFileGrpId}
          ORDER BY T1.ATCH_FILE_ID         
</select>

<select id="selectAttachmentInfo" parameterType="Map" resultType="egovMap">
/* webInvoiceMapper.selectAttachmentInfo */
            SELECT T1.ATCH_FILE_GRP_ID
                   ,T1.ATCH_FILE_ID
                   ,T2.ATCH_FILE_NAME
                   ,T2.FILE_SUB_PATH
                   ,T2.PHYSICL_FILE_NAME
                   ,T2.FILE_EXTSN
                   ,T2.FILE_SIZE
          FROM SYS0070M T1
          LEFT JOIN SYS0071D T2
          ON T1.ATCH_FILE_ID = T2.ATCH_FILE_ID
          WHERE T1.ATCH_FILE_GRP_ID = #{atchFileGrpId}
          AND T1.ATCH_FILE_ID = #{atchFileId}         
</select>

<insert id="insertWebInvoiceInfo" parameterType="Map">
/* webInvoiceMapper.insertWebInvoiceInfo */
   INSERT INTO FCM0002M
   (
        CLM_NO
       ,CLM_TYPE
       ,COST_CENTR
       ,COST_CENTR_NAME
       ,MEM_ACC_ID
       ,GST_RGIST_NO
       ,BANK_CODE
       ,BANK_ACC_NO
       ,INVC_TYPE
       ,INVC_NO
       ,INVC_DT
       ,PAY_DUE_DT
       ,ATCH_FILE_GRP_ID
       ,INVC_REM
       ,TOT_AMT
       ,APPV_PRCSS_NO
       ,CRT_DT
       ,CRT_USER_ID
       ,UPD_DT
       ,UPD_USER_ID
    )
    values
    (
        #{clmNo}
       ,'J1'
       ,#{costCentr}
       ,#{costCentrName}
       ,#{memAccId}
       ,#{gstRgistNo}
       ,#{bankCode}
       ,#{bankAccNo}
       ,#{invcType}
       ,#{invcNo}
       ,TO_DATE(#{invcDt}, 'DD/MM/YYYY')
       ,TO_DATE(#{payDueDt}, 'DD/MM/YYYY')
       ,#{atchFileGrpId}
       ,#{invcRem}
       ,#{totAmt}
       ,#{appvPrcssNo}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<insert id="insertWebInvoiceDetail" parameterType="Map">
/* webInvoiceMapper.insertWebInvoiceDetail */
<!-- CMM0042C_ITEM_SEQ.nextval -->
   INSERT INTO FCM0003D
   (
        CLM_NO
       ,CLM_SEQ
       ,EXP_TYPE
       ,EXP_TYPE_NAME
       ,GL_ACC_CODE
       ,GL_ACC_CODE_NAME
       ,BUDGET_CODE
       ,BUDGET_CODE_NAME
       ,TAX_CODE
       ,NET_AMT
       ,TAX_AMT
       ,TOT_AMT
       ,EXP_DESC
       ,CRT_DT
       ,CRT_USER_ID
       ,UPD_DT
       ,UPD_USER_ID
    )
    values
    (
        #{clmNo}
       ,#{clmSeq}
       ,#{expType}
       ,#{expTypeName}
       ,#{glAccCode}
       ,#{glAccCodeName}
       ,#{budgetCode}
       ,#{budgetCodeName}
       ,#{taxCode}
       ,#{netAmt}
       ,#{taxAmt}
       ,#{totAmt}
       ,#{expDesc}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<insert id="insertApproveManagement" parameterType="Map">
/* webInvoiceMapper.insertApproveManagement */
<!-- CMM0042C_ITEM_SEQ.nextval -->
   INSERT INTO FCM0004M
   (
        APPV_PRCSS_NO
       ,APPV_REQ_KEY_NO
       ,REQST_DT
       ,REQST_USER_ID
       ,APPV_PRCSS_STUS
       ,APPV_LINE_CNT
       ,APPV_LINE_PRCSS_CNT
       ,APPV_PRCSS_DESC
       ,CRT_DT
       ,CRT_USER_ID
       ,UPD_DT
       ,UPD_USER_ID
    )
    values
    (
        #{appvPrcssNo}
       ,#{clmNo}
       ,SYSDATE
       ,#{userName}
       ,'R'
       ,#{appvLineCnt}
       ,0
       ,#{appvPrcssDesc}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<insert id="insertApproveLineDetail" parameterType="Map">
/* webInvoiceMapper.insertApproveLineDetail */
<!-- CMM0042C_ITEM_SEQ.nextval -->
   INSERT INTO FCM0005D
   (
        APPV_PRCSS_NO
       ,APPV_LINE_SEQ
       ,APPV_LINE_USER_ID
       ,APPV_DT
       ,APPV_STUS
       ,CRT_DT
       ,CRT_USER_ID
       ,UPD_DT
       ,UPD_USER_ID
    )
    values
    (
        #{appvPrcssNo}
       ,#{approveNo}
       ,#{memCode}
       ,#{appvDt}
       <choose>
       <when test="#{approveNo eq 1}">
       ,'R'
       </when>
       <otherwise>
       ,'T'
       </otherwise>
       </choose>
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<insert id="insertApproveItems" parameterType="Map">
/* webInvoiceMapper.insertApproveItems */
<!-- CMM0042C_ITEM_SEQ.nextval -->
   INSERT INTO FCM0015D
   (
        APPV_PRCSS_NO
       ,APPV_ITM_SEQ
       ,INVC_NO
       ,INVC_DT
       ,INVC_TYPE
       ,MEM_ACC_ID
       ,PAY_DUE_DT
       ,EXP_TYPE
       ,EXP_TYPE_NAME
       ,COST_CENTR
       ,COST_CENTR_NAME
       ,GL_ACC_CODE
       ,GL_ACC_CODE_NAME
       ,BUDGET_CODE
       ,BUDGET_CODE_NAME
       ,TAX_CODE
       ,NET_AMT
       ,TAX_AMT
       ,APPV_AMT
       ,EXP_DESC
       ,ATCH_FILE_GRP_ID
       ,CRT_DT
       ,CRT_USER_ID
       ,UPD_DT
       ,UPD_USER_ID
    )
    values
    (
        #{appvPrcssNo}
       ,#{appvItmSeq}
       ,#{invcNo}
       ,TO_DATE(#{invcDt}, 'DD/MM/YYYY')
       ,#{invcType}
       ,#{memAccId}
       ,TO_DATE(#{payDueDt}, 'DD/MM/YYYY')
       ,#{expType}
       ,#{expTypeName}
       ,#{costCentr}
       ,#{costCentrName}
       ,#{glAccCode}
       ,#{glAccCodeName}
       ,#{budgetCode}
       ,#{budgetCodeName}
       ,#{taxCode}
       ,#{netAmt}
       ,#{taxAmt}
       ,#{totAmt}
       ,#{expDesc}
       ,#{atchFileGrpId}
       ,SYSDATE
       ,#{userId}
       ,SYSDATE
       ,#{userId}
    )
</insert>

<update id="updateWebInvoiceInfo" parameterType="Map">
/* webInvoiceMapper.updateWebInvoiceInfo */
   UPDATE FCM0002M
   SET COST_CENTR = #{costCentr}
       ,COST_CENTR_NAME = #{costCentrName}
       ,MEM_ACC_ID = #{memAccId}
       ,GST_RGIST_NO = #{gstRgistNo}
       ,BANK_CODE = #{bankCode}
       ,BANK_ACC_NO = #{bankAccNo}
       ,INVC_TYPE = #{invcType}
       ,INVC_NO = #{invcNo}
       ,INVC_DT = TO_DATE(#{invcDt}, 'DD/MM/YYYY')
       ,PAY_DUE_DT = TO_DATE(#{payDueDt}, 'DD/MM/YYYY')
       ,INVC_REM = #{invcRem}
       ,TOT_AMT = #{totAmt}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CLM_NO = #{clmNo}       
</update>

<update id="updateWebInvoiceDetail" parameterType="Map">
/* webInvoiceMapper.updateWebInvoiceDetail */
<!-- CMM0042C_ITEM_SEQ.nextval -->
   UPDATE FCM0003D
   SET EXP_TYPE = #{expType}
       ,EXP_TYPE_NAME = #{expTypeName}
       ,GL_ACC_CODE = #{glAccCode}
       ,GL_ACC_CODE_NAME = #{glAccCodeName}
       ,BUDGET_CODE = #{budgetCode}
       ,BUDGET_CODE_NAME = #{budgetCodeName}
       ,TAX_CODE = #{taxCode}
       ,NET_AMT = #{netAmt}
       ,TAX_AMT = #{taxAmt}
       ,TOT_AMT = #{totAmt}
       ,EXP_DESC = #{expDesc}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CLM_NO = #{clmNo}
    AND CLM_SEQ = #{clmSeq}
</update>

<delete id="deleteWebInvoiceDetail" parameterType="Map">
/* webInvoiceMapper.deleteWebInvoiceDetail */
    DELETE FROM FCM0003D WHERE CLM_NO = #{clmNo} AND CLM_SEQ = #{clmSeq} 
</delete>

<update id="updateAppvPrcssNo" parameterType="Map">
/* webInvoiceMapper.updateAppvPrcssNo */
   UPDATE FCM0002M
   SET APPV_PRCSS_NO = #{appvPrcssNo}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE CLM_NO = #{clmNo}       
</update>

<update id="updateAppvInfo" parameterType="Map">
/* webInvoiceMapper.updateAppvInfo */
   UPDATE FCM0004M
   SET APPV_PRCSS_STUS = #{appvPrcssStus}
       ,APPV_PRCSS_DT = SYSDATE
       ,APPV_LINE_PRCSS_CNT = #{appvLinePrcssCnt}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE APPV_PRCSS_NO = #{appvPrcssNo}       
</update>

<update id="updateAppvLine" parameterType="Map">
/* webInvoiceMapper.updateAppvLine */
   UPDATE FCM0005D
   SET APPV_STUS = #{appvStus}
       ,APPV_DT = SYSDATE
       ,REJCT_RESN = #{rejectResn}
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE APPV_PRCSS_NO = #{appvPrcssNo}
    AND APPV_LINE_SEQ = #{appvLineSeq}       
</update>

<update id="updateLastAppvLine" parameterType="Map">
/* webInvoiceMapper.updateLastAppvLine */
   UPDATE FCM0004M
   SET APPV_PRCSS_STUS = 'A'
       ,UPD_DT = SYSDATE
       ,UPD_USER_ID = #{userId}
    WHERE APPV_PRCSS_NO = #{appvPrcssNo}       
</update>

<insert id="insertEccInterface" parameterType="Map">
/* webInvoiceMapper.insertEccInterface */
<!-- CMM0042C_ITEM_SEQ.nextval -->
   INSERT INTO ITF0700M
   (
        IF_KEY
        ,SEQ
       ,IF_TYPE
       ,TRAN_STATUS_CD
       ,RGST_DT
       ,RGST_TM
       ,RGST_ID
       ,DOCENTRY
       ,DOCETY
       ,REQDATE
       ,REQPERNM
       ,REQDEPTNM
       ,DOCDATE
       ,CARDCODE
       ,LINEID
       ,INVONO
       ,REGINO
       ,REFDATE
       ,LINEMEMO
       ,ACCTCODE
       ,ACCTNAME
       ,AMT
       ,VATAMT
       ,TAMT
       ,VATCODE
       ,DIMENSION1
       ,DIMENSION2
       ,STATUS
    )
    values
    (
        #{ifKey}
       ,#{seq}
       ,'700'
       ,'10'
       ,TO_CHAR(SYSDATE, 'YYYYDDMM')
       ,TO_CHAR(SYSDATE, 'HH24MISS')
       ,#{userId}
       ,#{appvPrcssNo}
       ,SUBSTR (#{clmNo}, 1, 2)
       ,TO_CHAR(TO_DATE(#{reqstDt}, 'DD/MM/YYYY'), 'YYYYDDMM')
       ,#{reqstUserId}
       ,#{costCentrName}
       ,TO_CHAR(TO_DATE(#{invcDt}, 'DD/MM/YYYY'), 'YYYYDDMM')
       ,#{memAccId}
       ,#{appvItmSeq}
       ,#{invcNo}
       ,#{clmNo}
       ,TO_CHAR(TO_DATE(#{payDueDt}, 'DD/MM/YYYY'), 'YYYYDDMM')
       ,#{expDesc}
       ,#{glAccCode}
       ,#{glAccCodeName}
       ,#{netAmt}
       ,#{taxAmt}
       ,#{appvAmt}
       ,#{taxCode}
       ,#{costCentr}
       ,#{budgetCode}
       ,#{appvPrcssStus}
    )
</insert>

<select id="selectSupplier" parameterType="Map" resultType="egovMap">
/* webInvoiceMapper.selectSupplier */
    SELECT ACC_GRP,
                ACC_GRP_NAME,
                MEM_ACC_ID,
                MEM_ACC_NAME,
                GST_RGIST_NO,
                BANK_CODE,
                BANK_NAME,
                BANK_ACC_NO
    FROM FCM0006M
    WHERE 1=1
    <if test="memAccId != null and memAccId != ''">
    AND MEM_ACC_ID LIKE '%' || #{memAccId} || '%'
    </if>
    <if test="accGrp != null and accGrp != ''">
    AND ACC_GRP = #{accGrp}
    </if>
    <if test="memAccName != null and memAccName != ''">
    <![CDATA[
    AND MEM_ACC_NAME LIKE '%' || #{memAccName} || '%'
    ]]>
    </if>
    <if test="gstRgistNo != null and gstRgistNo != ''">
    AND GST_RGIST_NO LIKE '%' || #{gstRgistNo} || '%'
    </if>
</select>

<select id="selectCostCenter" parameterType="Map" resultType="egovMap">
/* webInvoiceMapper.selectCostCenter */
    SELECT COST_CENTER,
                COST_CENTER_TEXT
    FROM FCM0008M
    WHERE 1=1
    <if test="costCenter != null and costCenter != ''">
    AND COST_CENTER LIKE '%' || #{costCenter} || '%'
    </if>
    <if test="costCenterText != null and costCenterText != ''">
    AND COST_CENTER_TEXT LIKE '%' || #{costCenterText} || '%'
    </if>
</select>

<select id="selectTaxCodeWebInvoiceFlag" resultType="egovMap">
/* webInvoiceMapper.selectTaxCodeWebInvoiceFlag */
    SELECT TAX_CODE ,
                TAX_CODE||' '||'('||TAX_NAME||')' AS TAX_NAME 
    FROM FCM0007C
    WHERE WEB_INVC_FLAG = 'X'
</select>

<select id="selectNextClmNo" resultType="String">
/* webInvoiceMapper.selectNextClmNo */
    SELECT    'J1'
       || TO_CHAR (SYSDATE, 'yymm')
       || NVL (TO_CHAR (MAX (SUBSTR (CLM_NO, 7, 4) + 1), 'FM0000'), '0001') AS CLM_NO
    FROM FCM0002M
    WHERE SUBSTR (CLM_NO, 3, 4) = TO_CHAR (SYSDATE, 'yymm')
</select>

<select id="selectNextClmSeq" parameterType="String" resultType="int">
/* webInvoiceMapper.selectNextClmNo */
    SELECT NVL(MAX(CLM_SEQ) + 1, 1) AS CLM_SEQ FROM FCM0003D WHERE CLM_NO = #{clmNo}
</select>

<select id="selectNextAppvPrcssNo" resultType="String">
/* webInvoiceMapper.selectNextAppvPrcssNo */
    SELECT    TO_CHAR (SYSDATE, 'yyyy')
       || NVL (TO_CHAR (MAX (SUBSTR (APPV_PRCSS_NO, 5, 6) + 1), 'FM000000'), '000001') AS APPV_PRCSS_NO
    FROM FCM0004M
    WHERE SUBSTR (APPV_PRCSS_NO, 1, 4) = TO_CHAR (SYSDATE, 'yyyy')
</select>

<select id="selectNextAppvItmSeq" parameterType="String" resultType="int">
/* webInvoiceMapper.selectNextAppvItmSeq */
    SELECT NVL(MAX(APPV_ITM_SEQ) + 1, 1) AS APPV_ITM_SEQ FROM FCM0015D WHERE APPV_PRCSS_NO = #{appvPrcssNo}
</select>

<select id="selectAppvLineCnt" parameterType="String" resultType="int">
/* webInvoiceMapper.selectAppvLineCnt */
    SELECT APPV_LINE_CNT FROM FCM0004M WHERE APPV_PRCSS_NO = #{appvPrcssNo}
</select>

<select id="selectAppvLinePrcssCnt" parameterType="String" resultType="int">
/* webInvoiceMapper.selectAppvLinePrcssCnt */
    SELECT APPV_LINE_PRCSS_CNT FROM FCM0004M WHERE APPV_PRCSS_NO = #{appvPrcssNo}
</select>

<select id="selectNextIfKey" resultType="String">
/* webInvoiceMapper.selectNextIfKey */
    SELECT    700
       || TO_CHAR (SYSDATE, 'yyyymmdd')
       || NVL (TO_CHAR (MAX (SUBSTR (IF_KEY, 11, 6) + 1), 'FM000000'), '000001') AS IF_KEY
  FROM ITF0700M
 WHERE SUBSTR (IF_KEY, 4, 8) = TO_CHAR (SYSDATE, 'yyyymmdd')
</select>

<select id="selectNextSeq" parameterType="String" resultType="int">
/* webInvoiceMapper.selectNextSeq */
    SELECT NVL(MAX(SEQ) + 1, 1) AS SEQ FROM ITF0700M WHERE IF_KEY = #{ifKey}
</select>

<select id="budgetCheck" parameterType="Map" resultType="String">
/* webInvoiceMapper.budgetCheck */
    SELECT FN_GET_BUDGET_AMT(#{year}, #{month}, #{costCentr}, #{budgetCode}, #{glAccCode}, #{netAmt}) FROM DUAL
</select>

</mapper>