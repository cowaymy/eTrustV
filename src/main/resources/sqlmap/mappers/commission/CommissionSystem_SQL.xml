<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.coway.trust.biz.commission.system.impl.CommissionSystemMapper">

	<resultMap id="clobMap" type="EgovMap">
		<result property="cdDs" column="cdDs" jdbcType="CLOB"
			javaType="java.lang.String" />
	</resultMap>

	<!-- searchOrganization Gruop List -->
	<select id="selectOrgGrList" parameterType="Map" resultMap="clobMap">
		SELECT
		T2.CODE_MASTER_ID AS mstId ,
		T1.CODE_MASTER_NAME AS mstNm,
		T2.CODE_ID AS cdId,
		T2.CODE AS cd,
		T2.CODE_NAME AS cdNm,
		T2.CODE_DESC AS cdDs
		FROM SYS0012M T1
		JOIN SYS0013M T2
		ON T1.CODE_MASTER_ID = T2.CODE_MASTER_ID
		WHERE 1=1
		<if test="mstId != null and mstId != ''">
			AND T1.CODE_MASTER_ID = #{mstId}
			AND T2.CODE_ID IN (1,2,3)
		</if>
		ORDER BY T2.CODE
	</select>

	<!-- search Organization List -->
	<select id="selectOrgList" parameterType="Map" resultMap="clobMap">
    <![CDATA[
        SELECT
            T2.CODE_MASTER_ID AS mstId ,
            T1.CODE_MASTER_NAME AS mstNm,
            T2.CODE_ID AS cdId,
            T2.CODE AS cd,
            T2.CODE_NAME AS cdNm,
            T2.CODE_DESC AS cdDs
        FROM SYS0012M T1
        JOIN SYS0013M T2
            ON T1.CODE_MASTER_ID = T2.CODE_MASTER_ID
        WHERE 1=1
         ]]>
		<if test="mstId != null and mstId != ''">
			AND T1.CODE_MASTER_ID = #{mstId}
		</if>
           <![CDATA[   
        ORDER BY T2.CODE_ID
         ]]>
	</select>

	<!-- search rule book management List -->
	<select id="selectRuleBookMngList" parameterType="Map"
		resultMap="clobMap">
    <![CDATA[   
         SELECT
          ORG_GR_CD,
	      ORG_GR_NM,
	      ORG_SEQ,
	      ORG_CD,
	      ORG_NM,
	      USE_YN,
	      CASE WHEN END_YEARMONTH IS NOT NULL AND LENGTH(END_YEARMONTH)=6 
		  THEN SUBSTR(END_YEARMONTH,5) || '/' || SUBSTR(END_YEARMONTH,0,4) 
		  ELSE END_YEARMONTH END END_DT ,
	     T2.CODE_DESC AS cdDs
	      FROM CMM0041C T1 JOIN SYS0013M T2
	      ON T1.ORG_CD = T2.CODE_ID
        WHERE 1=1
         ]]>
		<if test="orgRgCombo != null and orgRgCombo != ''">
			AND T1.ORG_GR_CD = #{orgRgCombo}
		</if>
		<if test="orgCombo != null and orgCombo != ''">
			AND T1.ORG_CD = #{orgCombo}
		</if>
		 <if test="useYnCombo != null and useYnCombo != ''">
      AND T1.USE_YN = #{useYnCombo}
    </if>
		<if test="searchDt != null and searchDt != ''">
			AND #{searchDt} BETWEEN START_YEARMONTH AND END_YEARMONTH
		</if>
       <![CDATA[   
        ORDER BY T1.ORG_GR_NM , T2.CODE_ID     
         ]]>
	</select>

<!-- add coommission rule book management -->
	<insert id="addCommissionGrid" parameterType="Map">
		INSERT INTO CMM0041C (
		ORG_GR_CD,
		ORG_CD,
		ORG_SEQ,
		ORG_GR_NM,
		ORG_NM,
		USE_YN,
		START_YEARMONTH,
		END_YEARMONTH,
		CRT_USER_ID,
		CRT_DT,
		UPD_USER_ID,
		UPD_DT
		)
		VALUES (
		#{orgGrCd},
		#{orgCd},
		CMM0041C_ORG_SEQ.nextval ,
		#{orgGrNm},
		#{orgNm},
		#{useYn},
		(SELECT TO_CHAR(SYSDATE,'YYYYMM') FROM DUAL),
		#{endDt},
		#{crtUserId},
		SYSDATE,
		#{updUserId},
		SYSDATE
		)
	</insert>

<!-- search coommission rule book checking data -->
	<select id="selectRuleBookMngChk" parameterType="Map" resultMap="clobMap">
    <![CDATA[   
         SELECT
          ORG_GR_CD,
          ORG_CD,
          ORG_SEQ
          FROM CMM0041C
        WHERE END_YEARMONTH=#{endDt} AND ORG_GR_CD=#{orgGrCd} AND ORG_CD=#{orgCd}       
         ]]>
	</select>

<!-- update coommission rule book management : end_dt -->
	<update id="udtCommissionGridEndDt">
		UPDATE CMM0041C
		SET
		END_YEARMONTH=(SELECT TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM') FROM DUAL)
		, UPD_USER_ID=#{updUserId}
		, UPD_DT=SYSDATE
		WHERE ORG_GR_CD=#{orgGrCd} AND ORG_CD=#{orgCd} AND ORG_SEQ=#{orgSeq}
	</update>

<!-- update coommission rule book management : use_yn -->
	<update id="udtCommissionGridUseYn">
		UPDATE CMM0041C
		SET
		USE_YN=#{useYn}
		, UPD_USER_ID=#{updUserId}
		, UPD_DT=SYSDATE
		WHERE ORG_GR_CD=#{orgGrCd} AND ORG_CD=#{orgCd} AND ORG_SEQ=#{orgSeq}
	</update>

<!-- delete coommission rule book management-->
	<delete id="delCommissionGrid">
		DELETE FROM CMM0041C
		WHERE ORG_GR_CD=#{orgGrCd} AND ORG_CD=#{orgCd} AND ORG_SEQ=#{orgSeq}
	</delete>
</mapper>