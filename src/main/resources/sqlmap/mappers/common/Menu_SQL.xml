<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.common.impl.MenuMapper">

    <select id="selectMenuList" parameterType="sessionVO" resultType="egovMap">
        SELECT     MENU.MENU_LVL
                  ,MENU.MENU_CODE
                  ,MENU.UPPER_MENU_CODE
                  ,MENU.MENU_NAME
                  ,MENU.PGM_CODE
                  ,MENU.PGM_PATH
                  ,MENU.FUNC_VIEW
                  ,MENU.MENU_ORDER
                  ,CONNECT_BY_ISLEAF AS IS_LEAF
                  ,SYS_CONNECT_BY_PATH (MENU.MENU_CODE, '|!|') AS PATH_CODE
                  ,SYS_CONNECT_BY_PATH (MENU.MENU_NAME, '|!|') AS PATH_NAME
              FROM (SELECT DISTINCT MENU.*
                                   ,PGM.PGM_PATH
                                   ,PGM.FUNC_VIEW
                               FROM SYS0051M MENU, SYS0050M PGM
                              WHERE MENU.PGM_CODE = PGM.PGM_CODE(+)
                         START WITH MENU.MENU_CODE IN (
                                  SELECT DISTINCT I.MENU_CODE
                                  FROM (SELECT DISTINCT H.MENU_CODE
                                                       ,H.PGM_TRN_CODE
                                                       ,H.VALID_DT_FROM
                                                       ,H.VALID_DT_TO
                                                       ,H.FUNC_YN
                                                       ,H.EXIST_YN
                                                       ,RANK () OVER (PARTITION BY H.MENU_CODE, H.PGM_TRN_CODE ORDER BY H.FUNC_YN DESC
                                                        ,H.EXIST_YN, H.VALID_DT_FROM, H.VALID_DT_TO DESC) AS RNK
                                                   FROM (
                                                         /* 선택한 권한*/
                                                         SELECT NULL AS AUTH_CODE
                                                               ,G.MENU_CODE
                                                               ,G.PGM_TRN_CODE
                                                               ,G.VALID_DT_FROM
                                                               ,G.VALID_DT_TO
                                                               ,G.FUNC_YN
                                                               ,'N' AS EXIST_YN
                                                           FROM SYS0057M G
                                                          WHERE G.USER_ID = #{userId}
                                                          AND G.FUNC_YN = 'Y'
                                                         UNION
                                                         /* 선택한 권한의 매핑된 Role의 상위 권한 */
                                                         SELECT E.AUTH_CODE
                                                               ,E.MENU_CODE
                                                               ,E.PGM_TRN_CODE
                                                               ,NULL AS VALID_DT_FROM
                                                               ,NULL AS VALID_DT_TO
                                                               ,E.FUNC_YN
                                                               ,CASE
                                                                   WHEN F.OWN_USER_ID IS NULL
                                                                   AND E.FUNC_YN = 'Y'
                                                                      THEN 'Y'
                                                                   ELSE 'N'
                                                                END AS EXIST_YN
                                                           FROM SYS0056M E
                                                               , (SELECT D.ROLE_ID
                                                                        ,D.AUTH_CODE
                                                                        ,C.USER_ID AS OWN_USER_ID
                                                                    FROM (SELECT     B.USER_ID
                                                                                    ,A.ROLE_ID
                                                                                FROM SYS0044M A, SYS0045M B
                                                                               WHERE A.ROLE_ID = B.ROLE_ID(+)
                                                                                 AND B.USER_ID(+) = #{userId}
                                                                          START WITH A.ROLE_ID = B.ROLE_ID
                                                                          CONNECT BY A.ROLE_ID = PRIOR A.PARENT_ROLE) C
                                                                        ,SYS0054M D
                                                                   WHERE C.ROLE_ID = D.ROLE_ID) F
                                                          WHERE E.AUTH_CODE = F.AUTH_CODE
                                                          AND E.FUNC_YN = 'Y'
                                                         UNION
                                                         /* 예외적으로 부여받은 개인권한 */
                                                         SELECT A.AUTH_CODE
                                                               ,A.MENU_CODE
                                                               ,A.PGM_TRN_CODE
                                                               ,B.VALID_DT_FROM
                                                               ,B.VALID_DT_TO
                                                               ,A.FUNC_YN
                                                               ,CASE
                                                                   WHEN A.FUNC_YN = 'Y'
                                                                      THEN 'Y'
                                                                   ELSE 'N'
                                                                END AS EXIST_YN
                                                           FROM SYS0056M A, SYS0055M B
                                                          WHERE A.AUTH_CODE = B.AUTH_CODE
                                                            AND B.USER_ID = #{userId}
                                                            AND A.FUNC_YN = 'Y'
                                                            ) H) I
                                 WHERE I.RNK = 1
                         )
                         CONNECT BY PRIOR UPPER_MENU_CODE = MENU_CODE) MENU
        START WITH MENU.UPPER_MENU_CODE IS NULL
        CONNECT BY PRIOR MENU_CODE = UPPER_MENU_CODE
          ORDER SIBLINGS BY MENU_ORDER
    </select>

    <select id="getFavoritesList" parameterType="sessionVO" resultType="egovMap">
        /*
        TODO :  로그인한 유저가 가진 마이메뉴를 조회 하도록 구현 필요. 현재 임시.
        */
        SELECT   FAVORITES.MYMENU_CODE
            ,FAVORITES.MYMENU_NAME
            ,MENU.MENU_CODE
            ,MENU.MENU_NAME
            ,PGM.PGM_PATH
            , (SELECT        '|!|'
                      || RTRIM (REVERSE (SYS_CONNECT_BY_PATH (REVERSE (A.MENU_NAME), '|!|') )
                               ,'|!|') AS PATH_NAME
                 FROM SYS0051M A
                WHERE CONNECT_BY_ISLEAF = 1
           START WITH A.MENU_CODE = MENU.MENU_CODE
           CONNECT BY PRIOR A.UPPER_MENU_CODE = A.MENU_CODE) AS PATH_NAME
        FROM SYS0059M FAVORITES, SYS0060D MAPP, SYS0051M MENU, SYS0050M PGM
       WHERE FAVORITES.MYMENU_CODE = MAPP.MYMENU_CODE
         AND MAPP.MENU_CODE = MENU.MENU_CODE
         AND MENU.PGM_CODE = PGM.PGM_CODE(+)
         AND FAVORITES.USE_YN = 'Y'
         -- AND PGM.FUNC_VIEW(+) = 'Y'
         AND FAVORITES.CRT_USER_ID = #{userId}
    ORDER BY FAVORITES.MYMENU_ORDER
    </select>

    <select id="selectPageAuth" parameterType="Map" resultType="pageAuthVO">
/*
TODO : path 로 권한을 가져오는 쿼리 구현 필요. 현재 임시.
 */
        SELECT
            'Y' AS  funcView
            ,'Y' AS  funcChange
            ,'Y' AS  funcPrint
            ,'Y' AS  funcUserDefine1
            ,'Y' AS  funcUserDefine2
            ,'Y' AS  funcUserDefine3
            ,'Y' AS  funcUserDefine4
            ,'Y' AS  funcUserDefine5
        FROM dual
    </select>
</mapper>