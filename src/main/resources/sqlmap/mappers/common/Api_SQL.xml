<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.common.impl.ApiMapper">

<!--
**************************************
 * Author                  Date                    Remark
 * Chew Kah Kit        2019/04/11           API for customer portal
**************************************
 -->

	<select id="selectCowayCustNricOrPassport" parameterType="Map" resultType="egovMap">
		SELECT *
		FROM CP1001V EXTENT1
		WHERE 1=1
		AND ROWNUM <![CDATA[ <= ]]> 1
		AND EXTENT1.NRIC_OR_PASSPORT = #{nricOrPassport}
	</select>

    <select id="isNricOrPassportMatchInvoiceNo" parameterType="Map" resultType="egovMap">
        SELECT
            CASE WHEN COUNT(*) > 0 THEN 'YES' ELSE 'NO' END NRIC_MATCH_INVOICE
        FROM SAL0029D EXTENT1
		JOIN SAL0001D EXTENT2 ON EXTENT2.CUST_ID = EXTENT1.CUST_ID
		JOIN (
			SELECT RENT_SO_ID ORD_ID, RENT_DOC_NO INVOICE_NO FROM PAY0022D WHERE RENT_DOC_NO LIKE 'BR%'
			UNION
			SELECT SRV_SALES_ORD_ID ORD_ID, SRV_LDGR_REF_NO INVOICE_NO FROM PAY0023D WHERE SRV_LDGR_REF_NO LIKE 'BR%'
			UNION
			SELECT SRV_MEM_ORD_ID ORD_ID, SRV_MEM_BATCH_NO INVOICE_NO FROM PAY0024D WHERE SRV_MEM_BATCH_NO LIKE 'BR%'
			UNION
			SELECT TRADE_SO_ID ORD_ID, TRADE_DOC_NO INVOICE_NO FROM PAY0035D WHERE TRADE_DOC_NO LIKE 'BR%'
			) EXTENT3 ON EXTENT3.ORD_ID = EXTENT2.SALES_ORD_ID
		WHERE 1=1
        AND EXTENT1.NRIC = #{nricOrPassport} AND EXTENT3.INVOICE_NO = #{invoiceNo}
    </select>

     <select id="selectInvoiceSubscriptionsList" parameterType="Map" resultType="egovMap">
       SELECT
            EXTENT1.CUST_BILL_EMAIL EMAIL,
            EXTENT2.NAME FULL_NAME
		FROM SAL0024D EXTENT1
		JOIN SAL0029D EXTENT2 ON EXTENT1.CUST_BILL_CUST_ID = EXTENT2.CUST_ID
		WHERE EXTENT1.CUST_BILL_IS_ESTM = 1
		AND EXTENT1.CUST_BILL_CUST_ID = #{cowayCustId}
    </select>

     <select id="selectAccountCode" parameterType="Map" resultType="egovMap">
        SELECT CUST_BILL_ID
        FROM SAL0024D
            WHERE 1 = 1
            AND CUST_BILL_CUST_ID = #{cowayCustId}
            AND CUST_BILL_STUS_ID = 1
    </select>

    <select id="selectCustTotalProductsCount" parameterType="Map" resultType="egovMap">
        SELECT COUNT(*) TOTAL_PRODUCT_COUNT
        FROM SAL0001D
            WHERE 1=1
            AND STUS_CODE_ID = 4
            AND CUST_ID = #{cowayCustId}
    </select>

    <select id="selectLastPayment" parameterType="Map" resultType="egovMap">
       SELECT TOT_AMT,PAY_DATE FROM (
            SELECT EXTENT1.TOT_AMT,EXTENT2.CUST_ID,EXTENT3.CUST_BILL_ID,
                TO_CHAR(EXTENT1.PAY_DATA,'YYYY/MM/DD HH24:MI:SS') PAY_DATE,
                RANK() OVER(PARTITION BY EXTENT2.CUST_ID ORDER BY EXTENT1.PAY_ID DESC) RANK
            FROM PAY0064D EXTENT1
            JOIN SAL0001D EXTENT2 ON EXTENT1.SALES_ORD_ID = EXTENT2.SALES_ORD_ID
            JOIN SAL0024D EXTENT3 ON EXTENT3.CUST_BILL_ID = EXTENT2.CUST_BILL_ID
        )
        WHERE RANK = 1
          AND CUST_ID = #{cowayCustId}
          AND CUST_BILL_ID = #{accountCode}
    </select>

    <select id="getCustTotalOutstanding" parameterType="Map" resultType="egovMap">
        SELECT
            EXTENT1.OTSTND_AMT
        FROM CP1007V EXTENT1
        WHERE EXTENT1.CUST_ID = #{cowayCustId}
    </select>

    <select id="getTotalMembershipExpired" parameterType="Map" resultType="egovMap">
        SELECT
            EXTENT1.EXPIRED_MEMBERSHIP
        FROM CP1008V EXTENT1
        WHERE EXTENT1.CUST_ID = #{cowayCustId}
    </select>

	<select id="selectCustVANo" parameterType="Map" resultType="egovMap">
        SELECT CUST_VA_NO CustomerVirtualAccountNumber
        FROM SAL0029D EXTENT1
        WHERE 1=1
        AND ROWNUM <![CDATA[ <= ]]> 1
        AND EXTENT1.CUST_ID = #{cowayCustId}
    </select>

    <select id="selectAutoDebitEnrolmentsList" parameterType="Map" resultType="egovMap">
        SELECT
			STATUS ,
			ORDER_NO ,
			CARD_NO ,
			EFFECTIVE_DATE ,
			PAYMENT_METHOD ,
			SUBMISSION_DATE ,
			TRANSACTION_AMOUNT ,
			RENT_PAY_MODE_CODE ,
			CODE_NAME
         FROM CP1010V
         WHERE CUST_ID = #{cowayCustId}
     </select>

     <select id="selectCowayAccountProductPreviewList" parameterType="Map" resultType="egovMap">
		SELECT
			NVL((PRODUCT_TOTAL_OUTSTANDING + MEMBERSHIP_OUTSTANDING),0) TOTAL_OUTSTANDING,
			PRODUCT_TOTAL_OUTSTANDING,
			MEMBERSHIP_OUTSTANDING,
			ORDER_STUS,
			INSTALL_DT ,

			LAST_SERVICE_DT ,
			STK_CODE ,
			STK_DESC ,
			SALES_ORD_NO
		FROM CP1013V
		WHERE CUST_ID = #{cowayCustId}
     </select>

     <select id="selectCowayAccountProductPreviewListByAccountCode" parameterType="Map" resultType="egovMap">
		SELECT
			NVL((PRODUCT_TOTAL_OUTSTANDING + MEMBERSHIP_OUTSTANDING),0) TOTAL_OUTSTANDING,
			LAST_SERVICE_DT ,
			INSTALL_DT ,

			STK_CODE ,
			STK_DESC ,
			SALES_ORD_NO
		FROM CP1013V
		WHERE ACCOUNT_CODE = #{accountCode}
     </select>

    <select id="selectProductDetail" parameterType="Map" resultType="egovMap">
        SELECT
            PRODUCT_TOTAL_OUTSTANDING ,
            MEMBERSHIP_OUTSTANDING ,
            INSTALL_DT ,
            LAST_SERVICE_DT ,
            SALES_ORD_NO ,
            APP_TYPE ,
            STK_CODE ,
            SERIAL_NO ,
            STK_DESC ,
            ADD1 ,
            ADD2 ,
            POSTCODE ,
            AREA ,
            STATE_NAME ,
            BILLER_CODE ,
            JOMPAY_REF ,
            MONTHLY_RENTAL ,
            CODY_CONTACT ,
            CODY_NAME ,
            MAIL_CNT_NAME ,
            MAIL_CNT_TELM ,
            MAIL_CNT_EMAIL ,
            MAIL_CNT_NRIC ,
            ACCOUNT_CODE
        FROM CP1013V
        WHERE SALES_ORD_NO = #{orderNo}
    </select>

    <select id="selectLatestMembership" parameterType="Map" resultType="egovMap">
         SELECT
                MEMBERSHIP_TYPE ,
                MEMBERSHIP_START_DATE ,
                MEMBERSHIP_EXPIRY_DATE ,
                MEMBERSHIP_FEE
            FROM CP1025V
        WHERE SALES_ORD_NO = #{orderNo}
    </select>

    <select id="selectMembershipExpiredDate" parameterType="Map" resultType="egovMap">
         SELECT
                MEMBERSHIP_EXPIRY_DATE
            FROM CP1025V
        WHERE SALES_ORD_NO = #{salesOrdNo}
    </select>

    <select id="selectHeartServiceList" parameterType="Map" resultType="egovMap">
        SELECT
            BS_NO ,
            CODY_NO ,
            CODY_NAME ,
            LAST_SERVICE_DATE
         FROM CP1014V
         WHERE ORD_NO = #{orderNo}
    </select>

    <select id="selectTechnicianServicesList" parameterType="Map" resultType="egovMap">
        SELECT
			AS_NO ,
			CT_NAME ,
			CT_NO ,
			LAST_AS_DT
		 FROM CP1015V
         WHERE ORD_NO = #{orderNo}
    </select>

    <select id="isUserHasOrdNo" parameterType="Map" resultType="egovMap">
        SELECT
            CASE WHEN COUNT(*) > 0 THEN 'YES' ELSE 'NO' END IS_USER_HAS_ORD_NO
        FROM SAL0001D
        WHERE 1 = 1
        AND CUST_ID = #{cowayCustId}
        AND SALES_ORD_NO = #{orderNo}
    </select>

        <select id="selectInvoiceListByOrderNumber" parameterType="Map" resultType="egovMap">
    <if test='type == "REN" or type == "RENSVM"'>
        SELECT
            EXTENT2.TAX_INVC_ID,EXTENT2.TAX_INVC_CHRG AMOUNT,EXTENT1.INVC_ITM_ORD_NO SALES_ORD_NO,TO_CHAR(EXTENT2.TAX_INVC_REF_DT,'YYYY/MM/DD HH24:MI:SS') INVOICE_DT, EXTENT2.TAX_INVC_REF_NO
        FROM PAY0030D EXTENT1
        JOIN PAY0029D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
    </if>
    <if test='type == "SVM"'>
        SELECT
           EXTENT2.TAX_INVC_ID,EXTENT2.TAX_INVC_CHRG AMOUNT,EXTENT1.INVC_ITM_ORD_NO SALES_ORD_NO,TO_CHAR(EXTENT2.TAX_INVC_REF_DT,'YYYY/MM/DD HH24:MI:SS') INVOICE_DT, EXTENT2.TAX_INVC_REF_NO
        FROM PAY0032D EXTENT1
        JOIN PAY0031D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
    </if>
    <if test='type == "OUT"'>
        SELECT
            EXTENT2.TAX_INVC_ID,EXTENT2.TAX_INVC_CHRG AMOUNT,EXTENT1.INVC_ITM_ORD_NO SALES_ORD_NO,TO_CHAR(EXTENT2.TAX_INVC_REF_DT,'YYYY/MM/DD HH24:MI:SS') INVOICE_DT, EXTENT2.TAX_INVC_REF_NO
        FROM PAY0034D EXTENT1
        JOIN PAY0033D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
    </if>
    WHERE 1 = 1
    AND EXTENT1.INVC_ITM_ORD_NO = #{orderNo}
        <if test='type == "REN"'>      AND TAX_INVC_BILL_TYPE = 133</if>
        <if test='type == "RENSVM"'>AND TAX_INVC_BILL_TYPE = 134</if>
    </select>

    <select id="selectTransactionHistoryList" parameterType="Map" resultType="egovMap">
    SELECT
	    SALES_ORD_NO ,
	    ACCOUNT_CODE ,
	    RECEIPT_NO ,
	    TO_CHAR(PAY_DATE,'YYYY/MM/DD HH24:MI:SS')  PAY_DATE,
	    AMOUNT
        FROM (
            SELECT
                SALES_ORD_NO,
                ACCOUNT_CODE ,
                RECEIPT_NO ,
                PAY_DATE,
                AMOUNT,
                MAX(PAY_DATE) OVER (PARTITION BY SALES_ORD_NO,ACCOUNT_CODE) LAST_PAY_DATE
            FROM CP1018V
            WHERE 1 = 1
		) WHERE TO_DATE(PAY_DATE,'DD/MM/YYYY') >= ADD_MONTHS(TO_DATE(LAST_PAY_DATE,'DD/MM/YYYY'), -5)
		AND SALES_ORD_NO = #{orderNo}
		ORDER BY PAY_DATE DESC
    </select>

    <select id="isUserHasTaxInvoiceRefNo" parameterType="Map" resultType="egovMap">
		SELECT
		   CASE WHEN COUNT(*) > 0 THEN 'YES' ELSE 'NO' END IS_USER_HAS_TAX_INVOICE_REF_NO
		FROM
		SAL0001D EXTENT1
		JOIN (
		SELECT TAX_INVC_REF_NO,INVC_ITM_ORD_NO
		    FROM PAY0030D EXTENT1
		    JOIN PAY0029D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
		UNION
		SELECT TAX_INVC_REF_NO,INVC_ITM_ORD_NO
		    FROM PAY0032D EXTENT1
		    JOIN PAY0031D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
		UNION
		SELECT TAX_INVC_REF_NO,INVC_ITM_ORD_NO
		    FROM PAY0034D EXTENT1
		    JOIN PAY0033D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
		    )EXTENT2 ON EXTENT1.SALES_ORD_NO = EXTENT2.INVC_ITM_ORD_NO
	    WHERE 1 = 1
	       AND CUST_ID = #{cowayCustId}
	       AND TAX_INVC_REF_NO = #{taxInvoiceRefNo}
    </select>

    <select id="selectInvoiceDetailByTaxInvoiceRefNo" parameterType="Map" resultType="egovMap">
    <if test='type == "REN" or type == "RENSVM"'>
        SELECT
            EXTENT2.TAX_INVC_ID,EXTENT2.TAX_INVC_CHRG AMOUNT,EXTENT1.INVC_ITM_ORD_NO SALES_ORD_NO,TO_CHAR(EXTENT2.TAX_INVC_REF_DT,'YYYY/MM/DD HH24:MI:SS') INVOICE_DT, EXTENT2.TAX_INVC_REF_NO
        FROM PAY0030D EXTENT1
        JOIN PAY0029D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
    </if>
    <if test='type == "SVM"'>
	    SELECT
	       EXTENT2.TAX_INVC_ID,EXTENT2.TAX_INVC_CHRG AMOUNT,EXTENT1.INVC_ITM_ORD_NO SALES_ORD_NO,TO_CHAR(EXTENT2.TAX_INVC_REF_DT,'YYYY/MM/DD HH24:MI:SS') INVOICE_DT, EXTENT2.TAX_INVC_REF_NO
	    FROM PAY0032D EXTENT1
	    JOIN PAY0031D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
    </if>
    <if test='type == "OUT"'>
        SELECT
            EXTENT2.TAX_INVC_ID,EXTENT2.TAX_INVC_CHRG AMOUNT,EXTENT1.INVC_ITM_ORD_NO SALES_ORD_NO,TO_CHAR(EXTENT2.TAX_INVC_REF_DT,'YYYY/MM/DD HH24:MI:SS') INVOICE_DT, EXTENT2.TAX_INVC_REF_NO
        FROM PAY0034D EXTENT1
        JOIN PAY0033D EXTENT2 ON EXTENT1.TAX_INVC_ID = EXTENT2.TAX_INVC_ID
    </if>
    WHERE 1 = 1
    AND EXTENT2.TAX_INVC_REF_NO = #{taxInvoiceRefNo}
        <if test='type == "REN"'>      AND TAX_INVC_BILL_TYPE = 133</if>
        <if test='type == "RENSVM"'>AND TAX_INVC_BILL_TYPE = 134</if>
    </select>

    <select id="selectOrderNumberList" parameterType="Map" resultType="egovMap">
        SELECT
            TOTAL_OUTSTANDING ,
            PRODUCT_TOTAL_OUTSTANDING ,
            MEMBERSHIP_OUTSTANDING ,
            ORDER_STATUS ,
            SALES_ORD_NO
        FROM CP1023V
        WHERE CUST_ID = #{cowayCustId}
    </select>

    <select id="selectMembershipProgrammesList" parameterType="Map" resultType="egovMap">
	   SELECT * FROM CP1024V
	</select>

	<insert id="addOrEditPersonInCharge" parameterType="Map">
		INSERT INTO CP0001T
			(CP_ID ,
			CUST_ID ,
			PIC_NAME ,
			PIC_NRIC ,
			PIC_MOBILE ,
			PIC_EMAIL ,
			STUS_ID ,
			CRT_USR_ID ,
			CRT_DT,
			CP_TYPE_ID
		) VALUES(
		   CP0001T_CP_ID_SEQ.NEXTVAL
			, #{cowayCustId}
			<choose><when test="picName != null and picName !=''">,#{picName}</when><otherwise>,NULL</otherwise></choose>
            <choose><when test="picIcNric != null and picIcNric !=''">,#{picIcNric}</when><otherwise>,NULL</otherwise></choose>
            <choose><when test="picMobile != null and picMobile !=''">,#{picMobile}</when><otherwise>,NULL</otherwise></choose>
            <choose><when test="picEmail != null and picEmail !=''">,#{picEmail}</when><otherwise>,NULL</otherwise></choose>
			, 1
			, 100910
			, SYSDATE
			, 5502
		)
	</insert>

	<insert id="addOrEditCustomerInfo" parameterType="Map">
		INSERT INTO CP0001T
	            (CP_ID ,
	            CUST_ID ,
	            CUST_MOBILE ,
	            CUST_EMAIL ,
	            STUS_ID ,
	            CRT_USR_ID ,
	            CRT_DT,
	            CP_TYPE_ID
	        ) VALUES(
	           CP0001T_CP_ID_SEQ.NEXTVAL
	            , #{cowayCustId}
	            <choose><when test="cowayCustMobile != null and cowayCustMobile !=''">,#{cowayCustMobile}</when><otherwise>,NULL</otherwise></choose>
	            <choose><when test="cowayCustEmail != null and cowayCustEmail !=''">,#{cowayCustEmail}</when><otherwise>,NULL</otherwise></choose>
	            , 1
	            , 100910
	            , SYSDATE
	            , 5503
	        )
    </insert>

    <insert id="addEInvoiceSubscription" parameterType="Map">
	    INSERT INTO CP0001T
	                (CP_ID
	               , CUST_ID
	               , CUST_EMAIL
	               , CUST_NAME
	               , CUST_EMAIL_VERIFY_STUS
	               , STUS_ID
	               , CRT_USR_ID
	               , CRT_DT
	               , CP_TYPE_ID
	               , ACTN_TYPE
	            ) VALUES(
	               CP0001T_CP_ID_SEQ.NEXTVAL
	                , #{cowayCustId}
	                <choose><when test="email != null and email !=''">,#{email}</when><otherwise>,NULL</otherwise></choose>
	                <choose><when test="fullName != null and fullName !=''">,#{fullName}</when><otherwise>,NULL</otherwise></choose>
	                <choose><when test="emailVerifyStatus != null and emailVerifyStatus !=''">,#{emailVerifyStatus}</when><otherwise>,NULL</otherwise></choose>
	                , 1
	                , 100910
	                , SYSDATE
	                , 5504
	                , UPPER(#{actionType})
	            )
    </insert>

   <insert id="insertApiAccessLog" parameterType="Map">
   INSERT INTO SYS0097M
   (
        RESP_ID
       ,REQ_PARAM
       ,RESP_PARAM
       ,RESP_CODE
       ,RESP_TM
       ,IP_ADDR
       ,PGM_PATH
       ,ERR_MSG
       ,CRT_DT
       ,CRT_USER_ID
    ) VALUES (
        SYS0097M_RESP_ID_SEQ.NEXTVAL
        , #{reqParam}
        , #{respParam}
        , #{respCde}
        , #{respTm}
        , #{ipAddr}
        , #{prgPath}
        , #{errMsg}
        , SYSDATE
        , 100910
    )

    </insert>

</mapper>