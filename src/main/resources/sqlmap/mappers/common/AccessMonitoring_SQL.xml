<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.common.impl.AccessMonitoringMapper">

<select id="selectAccessMonitoringList" parameterType="Map" resultType="egovMap">
    SELECT a.system_id ,
               (SELECT a.code_name
	               FROM SYS0013M a
	             WHERE a.code_master_id = 336
	                 AND a.code = a.system_id) AS system_nm ,
               a.pgm_code ,
               b.pgm_name ,
               a.pgm_path ,
               a.user_id,
               a.user_name,
               a.ip_addr,
               a.access_dtm
       FROM SYS0078M a ,
                SYS0050M b
     WHERE 1=1
         AND a.pgm_code = b.pgm_code
         AND a.system_id = #{systemId}
         AND TO_DATE(a.access_dtm,'YYYYMMDDHH24MISSSSS') BETWEEN TO_DATE(REPLACE('0000'||#{frDate},'/',''),'MIHH24DDMMYYYY') AND TO_DATE(REPLACE('5923'||#{toDate},'/',''),'MIHH24DDMMYYYY') /* Essential Param*/
         <if test="pgmCode != null and pgmCode !=''">
         AND (UPPER(a.pgm_code) LIKE  UPPER(#{pgmCode}) || '%' OR
                UPPER(b.pgm_name) LIKE '%' || UPPER(#{pgmCode}) || '%')
         </if>
         <if test="userId != null and userId !=''">
         AND (UPPER(a.user_id) LIKE  UPPER(#{userId}) || '%' OR
                UPPER(a.user_name) LIKE '%' || UPPER(#{userId}) || '%')
         </if>
         <if test="ipAddr != null and ipAddr !=''">
         AND a.ip_addr LIKE #{ipAddr} || '%'
         </if>
      ORDER BY a.system_id , a.access_dtm desc
</select>

<select id="selectAccessMonitoringDtmList" parameterType="Map" resultType="egovMap">
    SELECT DISTINCT a.system_id ,
               (SELECT a.code_name
                   FROM SYS0013M a
                 WHERE a.code_master_id = 336
                     AND a.code = a.system_id) AS system_nm ,
               a.pgm_code ,
               b.pgm_name ,
               SUBSTR(a.access_dtm,1,8) as access_day ,
               SUBSTR(a.access_dtm,9,2) as access_time ,
               COUNT(a.access_dtm) OVER(PARTITION BY SUBSTR(a.access_dtm,1,10), a.pgm_code, a.system_id) as access_dtm_cnt
       FROM SYS0078M a ,
               SYS0050M b
     WHERE 1=1
         AND a.pgm_code = b.pgm_code
         AND a.system_id = #{systemId}
         AND TO_DATE(a.access_dtm,'YYYYMMDDHH24MISSSSS') BETWEEN TO_DATE(REPLACE('0000'||#{frDate},'/',''),'MIHH24DDMMYYYY') AND TO_DATE(REPLACE('5923'||#{toDate},'/',''),'MIHH24DDMMYYYY') /* Essential Param*/
         <if test="pgmCode != null and pgmCode !=''">
         AND (UPPER(a.pgm_code) LIKE  UPPER(#{pgmCode}) || '%' OR
                UPPER(b.pgm_name) LIKE '%' || UPPER(#{pgmCode}) || '%')
         </if>
        ORDER BY a.system_id , b.pgm_name
</select>

<select id="selectAccessMonitoringUserList" parameterType="Map" resultType="egovMap">
    SELECT a.user_id ,
               a.user_name ,
               a.access_dtm
      FROM SYS0078M a ,
               SYS0050M b
     WHERE 1=1
         AND a.pgm_code = b.pgm_code
         AND a.system_id = #{systemId}
         AND a.pgm_code = #{pgmCode}
         AND SUBSTR(a.access_dtm,1,10) = #{searchDt}
      ORDER BY a.access_dtm
</select>


<insert id="insertAccessMonitoring" parameterType="Map">

   INSERT INTO SYS0078M
   (
	    system_id
	   ,access_dtm
	   ,user_id
	   ,user_name
	   ,ip_addr
	   ,pgm_code
	   ,pgm_path
	   ,acces_day
	)
	SELECT #{systemId}
	         , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISSSSS')
	         , #{userId}
	         , #{userName}
	         , #{ipAddr}
	         , a.pgm_code
	         , a.pgm_path
	         , TO_CHAR(SYSDATE,'YYYYMMDD')
      FROM SYS0050M a
     WHERE a.pgm_path = #{pgmPath}
</insert>


</mapper>