<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.common.impl.MainNoticeMapper">

	<select id="selectDailyCount" parameterType="Map" resultType="egovMap">
	<![CDATA[

WITH VIEW_COUNT AS
(SELECT /* view [Vw_NeoSales] */
        (SELECT  /* use_nl( SAL1058V.M SAL1058V.D) */  COUNT(1)
         FROM SAL1058V) NEO_SALES ,/*(rental) (66)*/

        (SELECT  /*+ index(salesorderm_idx13) */  COUNT(SALES_ORD_ID)
         FROM SAL0001D
         WHERE PV_YEAR = (SELECT EXTRACT(YEAR FROM SYSDATE) FROM DUAL)
           AND PV_MONTH = (SELECT EXTRACT(MONTH FROM SYSDATE) FROM DUAL)
            AND APP_TYPE_ID=66) RENTAL ,/*OUTRIGHT (67)*/

        (SELECT /*+ index(salesorderm_idx13) */  COUNT(SALES_ORD_ID)
         FROM SAL0001D
         WHERE PV_YEAR = (SELECT EXTRACT(YEAR FROM SYSDATE)  FROM DUAL)
           AND PV_MONTH =  (SELECT EXTRACT(MONTH FROM SYSDATE)  FROM DUAL)
           AND APP_TYPE_ID=67 ) OUT_RIGHT ,/* Installment (68) */

       (SELECT /*+ index(salesorderm_idx13) */ COUNT(SALES_ORD_ID)
          FROM SAL0001D
         WHERE PV_YEAR = (SELECT EXTRACT(YEAR FROM SYSDATE) FROM DUAL)
           AND PV_MONTH = (SELECT EXTRACT(MONTH FROM SYSDATE) FROM DUAL)
           AND APP_TYPE_ID= 68 ) INSTALLMENT
                                          ,/*SALES(Key_in)*/

     (SELECT /*+ index(salesorderm_idx14) */ COUNT(SALES_ORD_ID)
        FROM SAL0001D
       WHERE CRT_DT >= (select to_date('01/' || EXTRACT(MONTH FROM SYSDATE) || '/' || EXTRACT(YEAR FROM SYSDATE) , 'DD/MM/YYYY' ) from dual)
         AND CRT_DT < (select ADD_MONTHS(to_date('01/' || EXTRACT(MONTH FROM SYSDATE) || '/' || EXTRACT(YEAR FROM SYSDATE) , 'DD/MM/YYYY' ) ,1) from dual)
         AND 8 <> STUS_CODE_ID
         AND APP_TYPE_ID IN (66,67,68) ) SALES,

         (SELECT COUNT(1)
           FROM SAL0001D S
           LEFT JOIN SAL0071D F  ON F.SALES_ORD_ID = S.SALES_ORD_ID
           JOIN (SELECT  X.SALES_ORD_NO FROM (
             SELECT S.SALES_ORD_NO , D.SRV_START_DT, D.SRV_EXPR_DT
             FROM SAL0001D S
             JOIN SAL0095D D on S.SALES_ORD_ID = D.SRV_SALES_ORD_ID
             WHERE D.SRV_STUS_CODE_ID = 4 AND CURRENT_TIMESTAMP BETWEEN D.SRV_START_DT AND D.SRV_EXPR_DT
             UNION ALL
             SELECT S.SALES_ORD_NO , SS.SRV_PRD_START_DT , SS.SRV_PRD_EXPR_DT
             FROM SAL0001D S
             JOIN SAL0090D D on D.SRV_SO_ID = S.SALES_ORD_ID
             JOIN SAL0088D SS on SS.SRV_CONFIG_ID = D.SRV_CONFIG_ID
             WHERE SS.SRV_PRD_STUS_ID = 1 AND CURRENT_TIMESTAMP BETWEEN SS.SRV_PRD_START_DT AND SS.SRV_PRD_EXPR_DT AND SRV_PRD_CNTRCT_ID <>0  )X)Y ON Y.SALES_ORD_NO = S.SALES_ORD_NO
             WHERE S.APP_TYPE_ID IN (66,67,68)  AND S.STUS_CODE_ID = 4
             AND (F.STUS_CODE_ID IN ('REG','INV') OR F.STUS_CODE_ID IS NULL ) )  ACC_ACT_ACCOUNT
FROM DUAL )

SELECT
       NEO_SALES ,
       SALES ,
       RENTAL ,
       OUT_RIGHT ,
       INSTALLMENT ,
       (RENTAL + OUT_RIGHT + INSTALLMENT) TOTAL,
       ACC_ACT_ACCOUNT
FROM VIEW_COUNT
	]]>
	</select>


	<select id="selectMainNotice" parameterType="Map" resultType="egovMap">
		<![CDATA[
		SELECT *
		FROM (
				SELECT   NTCE_NO
						,NTCE_SUBJECT
						,RGST_USER_NM
						,READ_CNT
						,CRT_DT
						,EMGNCY_FLAG
						,SYSDATE
						,CASE
							WHEN SYSDATE - CRT_DT >= 1
							   THEN 'N'
							ELSE 'Y'
						 END IMG_FLAG
					FROM SYS0069M
				   WHERE STUS_FLAG = 'N'
					 AND (    SYSDATE >= NVL (NTCE_START_DT, TO_DATE ('19900101', 'YYYYMMDD') )
						  AND SYSDATE < NVL (NTCE_END_DT, TO_DATE ('29900101', 'YYYYMMDD') ) + 1
						 )
				ORDER BY NVL (EMGNCY_FLAG, 'N') DESC, NTCE_NO DESC
		) TBL
		WHERE ROWNUM < 5
		]]>
	</select>

	<select id="selectTagStatus" parameterType="Map" resultType="egovMap">
	SELECT Z.customer,
               Z.main_inquiry,
               Z.sub_inquiry,
               Z.main_department,
               Z.sub_department,
               Z.claim_note,
               Z.status,
               z.Ord_no sales_order
 FROM (SELECT A.CUR_SEQNO
			, A.CUST_NO as Customer
			, DECODE(GBSLCVD.FN_GET_COMMCD(1, TGT_DVCD), '', GBSLCVD.FN_GET_COMMCD(8, TGT_DVCD), GBSLCVD.FN_GET_COMMCD(1, TGT_DVCD)) AS TGT_DVNM
			, A.CUST_NM
			, CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_LRGCLAS_CD, 'ms-MY') AS main_inquiry
			, CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_MEDCLAS_CD, 'ms-MY') AS sub_inquiry
			, CALLCENTERUSER.FN_CNSL_CD_NM(A.CNSL_SMLCLAS_CD, 'ms-MY') AS claim_note
			, CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('M', A.DEPT_CODE) AS main_department
			, CALLCENTERUSER.FN_ERP_TAG_DEPT_NM('S', A.SUB_DEPT_CDE) AS sub_department
			, A.DEPT_CODE
			, A.SUB_DEPT_CDE
			, DECODE(B.STUS_CODE_ID, '', 'Active', CALLCENTERUSER.FN_ERP_GET_STUS_NM(B.STUS_CODE_ID)) as Status
			, to_date(Substr(a.REG_DTM, 1, 8 ),'YYYY/MM/DD') Reg_date
			, A.Ord_no
			FROM CALLCENTERUSER.T_CUR_HIST A
			LEFT OUTER JOIN GBSLCVD.CCR0006D B
			ON A.CUR_SEQNO = B.CUR_SEQ_NO
			WHERE A.TR_DVCD         = 'T'
			AND CUR_SEQNO NOT IN (
			SELECT CUR_SEQ_NO
			FROM GBSLCVD.CCR0006D
			WHERE CUR_SEQ_NO IS NOT NULL
			AND STUS_CODE_ID NOT IN (1, 35, 44)
	     ) )Z
     WHERE 1=1
	         <if test="initYn != null and initYn !=''">
	         <![CDATA[
	         AND ROWNUM < 5
		     ]]>
	     </if>
	     order by z.Reg_date desc
    </select>

    <select id="selectDailyPerformance" parameterType="Map" resultType="egovMap">
        SELECT A.DIV_CODE
				 , A.DIV_NAME
				 , A.PERIOD
                 , A.KEY_IN_QTY_TODAY
				 , A.KEY_IN_QTY_ACCUM
				 , A.KEY_IN_QTY_MONTH_END
				 , A.BY_PRD_CTGRY_WPURIFIER
				 , A.BY_PRD_CTGRY_APURIFIER
				 , A.BY_PRD_CTGRY_BIDET
				 , A.BY_PRD_CTGRY_SOFTNER
				 , A.BY_SALES_CTGRY_RENTAL
				 , A.BY_SALES_CTGRY_OUT_INS
				 , A.BY_SALES_CTGRY_MBR_SHIP
				 , A.BY_SALES_CTGRY_EXTRADE
				 , A.NET_SALES_ACCUM
				 , A.NET_SALES_MONTH_END
          FROM SYS0083S A
    </select>

</mapper>