<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.callcenter.impl.TokenMapper">

    <select id="selectToken" parameterType="Map" resultType="string">
	<![CDATA[
        SELECT
            TOKEN
	  FROM CCR0011M
	  WHERE TOKEN = #{_TOKEN}

        ]]>
	</select>

    <select id="selectSubAuthInfo" parameterType="Map" resultType="loginSubAuthVO">
        <![CDATA[
        SELECT a.user_id
                , a.auth_div_code
                , (SELECT a.code_name
                     FROM SYS0013M a
                    WHERE a.code_master_id = 316
                      AND a.code = a.auth_div_code) AS auth_div_name
                , auth_code
             FROM SYS0058M a
            WHERE a.user_id = #{userId}
              AND TO_CHAR(SYSDATE,'YYYYMMDDHH24') BETWEEN a.valid_dt_from|| '00' AND a.valid_dt_to || '23'
        ]]>
    </select>

    <select id="selectLanguages" resultType="egovMap">
    <![CDATA[

        SELECT   LANGUAGE
		    FROM SYS0052M
		GROUP BY LANGUAGE

        ]]>
    </select>

    <update id="updatePassWord" parameterType="Map">
        UPDATE SYS0047M
        SET USER_PASSWD = #{newPasswordConfirmTxt}
        ,USER_PASSWD_LAST_UPD_DT = SYSDATE
        <choose>
            <when test=' newUserIdTxt != null and newUserIdTxt != "" '>
                WHERE USER_ID = #{newUserIdTxt}
            </when>
            <otherwise>
                WHERE USER_ID = #{searchLoginId}
            </otherwise>
        </choose>
    </update>

    <select id="selectFindUserIdPop" parameterType="Map" resultType="loginVO">
   SELECT 
          SYS47M.USER_NAME    userName
         ,SYS47M.USER_ID      userId
         ,SYS47M.USER_PASSWD  userPassWord
         ,SYS47M.USER_SEC_QUES_ID  userSecQuesId
         ,SYS47M.USER_SEC_QUES_ANS userSecQuesAns
         ,SYS32M.RESN_DESC         securityQuestion
    FROM  SYS0047M SYS47M
        , SYS0032M SYS32M
    WHERE SYS47M.USER_NAME = #{userIdFindPopTxt}
      AND (SYS32M.RESN_ID = SYS47M.USER_SEC_QUES_ID  OR SYS47M.USER_SEC_QUES_ID = 0  )
      AND ROWNUM = 1
  </select>

    <insert id="insertLoginHistory" parameterType="loginHistory">
        INSERT INTO SYS0077M
        (
            system_id
           ,login_dtm
           ,user_id
           ,user_nm
           ,login_type
           ,ip_addr
           ,os
           ,browser
        )
        VALUES
        (
            #{systemId}
            ,SYSDATE
            ,#{userId}
            ,#{userNm}
            ,#{loginType}
            ,#{ipAddr}
            ,#{os}
            ,#{browser}
        )
    </insert>
    
    <update id="updateUserSetting" parameterType="loginVO">
	    UPDATE SYS0047M
	       SET USER_EMAIL  =  #{eMail}  
	          ,USER_UPD_DT =  SYSDATE
	          ,USER_NRIC    = #{nricNo} 
	          ,USER_WORK_NO = #{userWorkNo}
	          ,USER_MOBILE_NO = #{mobileNo}
	          ,USER_EXT_NO =  #{exNo}
	     WHERE USER_ID = #{updUserId}
    </update>
    
    <select id="selectSecureResnList" parameterType="Map" resultType="egovMap">
	    SELECT RESN_ID
	         , Code ||' - '||RESN_DESC SECURE_RESN
	      FROM SYS0032M 
	     WHERE RESN_TYPE_ID = #{resnTypeId}
	     ORDER BY Code 
    </select>
</mapper>