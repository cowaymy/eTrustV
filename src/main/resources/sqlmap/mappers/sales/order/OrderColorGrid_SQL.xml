<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.sales.order.impl.OrderColorGridMapper">

  <select id="colorGridList" parameterType="Map" resultType="egovMap">
    SELECT D1.ORD_ID ,
           D1.ORD_NO ,
           D1.APP_TYPE_CODE ,
           D1.CUST_NAME ,
           D1.CUST_IC   ,
           D1.STK_CODE   ,
           D1.SALESMAN_CODE  ,
           D1.TOP_ORG_CODE  ,
           D1.ORG_CODE  ,
           D1.GRP_CODE  ,
           D1.DEPT_CODE  ,
           D1.MEM_CODE ,
           D1.IS_NET  ,
           D1.NET_MONTH   ,
           D1.INSTALL_STUS_ID ,
           D1.INSTALL_STUS ,
           D1.INSTALL_FAIL_RESN,
           D1.COM_DT ,
           D1.PAY_COM_DT ,
           D1.PROMO_CODE ,
           D1.PROMO_DESC ,
      <!-- D1.MAIL_CNT_TEL_M ,
           D1.MAIL_CNT_TEL_O ,
           D1.MAIL_CNT_TEL_R ,
           D1.MAIL_CNT_TEL_F ,
           D1.INST_CNT_TEL_M ,
           D1.INST_CNT_TEL_O ,
           D1.INST_CNT_TEL_R ,
           D1.INST_CNT_TEL_F ,
           D1.CUST_ID , -->
           D1.C1 ,
           D1.ORD_DT ,
           D1.STUS_ID ,
           D1.STUS_CODE ,
           D1.C5 ,
           D1.C6 ,
           D1.C7 ,
           D1.C8 ,
           D1.C9
    FROM ( SELECT DISTINCT F1.OrderID1 ORD_ID ,
                           F1.ORD_NO ,
                           F1.APP_TYPE_CODE ,
                           UPPER(F1.CUST_NAME) CUST_NAME,
                           UPPER(F1.CUST_IC) CUST_IC,
                           F1.STK_CODE ,
                           UPPER(F1.SALESMAN_CODE) SALESMAN_CODE ,
                           F1.TOP_ORG_CODE ,
                           UPPER(F1.ORG_CODE) ORG_CODE ,
                           UPPER(F1.GRP_CODE) GRP_CODE ,
                           UPPER(F1.DEPT_CODE) DEPT_CODE ,
                           F1.MEM_CODE ,
                           F1.IS_NET ,
                           F1.NET_MONTH ,
                           F1.INSTALL_STUS_ID ,
                           F1.INSTALL_STUS ,
                           F1.INSTALL_FAIL_RESN ,
                           F1.COM_DT ,
                           F1.PAY_COM_DT ,
                           UPPER(F1.PROMO_CODE) PROMO_CODE ,
                           F1.PROMO_DESC ,
                      <!-- F1.MAIL_CNT_TEL_M ,
                           F1.MAIL_CNT_TEL_O ,
                           F1.MAIL_CNT_TEL_R ,
                           F1.MAIL_CNT_TEL_F ,
                           F1.INST_CNT_TEL_M ,
                           F1.INST_CNT_TEL_O ,
                           F1.INST_CNT_TEL_R ,
                           F1.INST_CNT_TEL_F ,
                           E4.CUST_ID , -->
                           1 C1 ,
                           CASE WHEN ( F1.ORD_DT IS NOT NULL )
                                  THEN F1.ORD_DT
                                  ELSE TO_DATE('1900-01-01', 'YYYY-MM-DD') END ORD_DT ,
                           CASE WHEN ( F1.STUS_ID IS NOT NULL )
                                  THEN F1.STUS_ID
                                  ELSE 0 END STUS_ID ,
                           CASE WHEN ( F1.STUS_CODE IS NOT NULL )
                                  THEN F1.STUS_CODE
                                  ELSE ' ' END STUS_CODE ,
                           CASE WHEN ( F1.APP_TYPE_ID IS NOT NULL )
                                  THEN F1.APP_TYPE_ID
                                  ELSE 0 END C5 ,
                           CASE WHEN ( F1.STK_ID IS NOT NULL )
                                  THEN F1.STK_ID
                                  ELSE 0 END C6 ,
                           F1.PV_MONTH C7 ,
                           F1.PV_YEAR C8 ,
                           F1.TOT_OTSTND C9
           FROM ( SELECT E1.ORD_ID OrderID1 ,
                         E1.ORD_NO  ,
                         E1.ORD_DT  ,
                         E1.APP_TYPE_ID  ,
                         E1.APP_TYPE_CODE  ,
                         E1.CUST_NAME  ,
                         E1.CUST_IC  ,
                         E1.STK_ID  ,
                         E1.STK_CODE  ,
                         E1.SALESMAN_CODE  ,
                         E1.STUS_ID  ,
                         E1.STUS_CODE  ,
                         E1.TOP_ORG_CODE  ,
                         E1.ORG_CODE  ,
                         E1.GRP_CODE  ,
                         E1.DEPT_CODE  ,
                         E1.MEM_CODE,
                         E1.IS_NET  ,
                         E1.NET_MONTH  ,
                         E1.PV_MONTH  ,
                         E1.PV_YEAR  ,
                         E1.INSTALL_STUS_ID  ,
                         E1.INSTALL_STUS  ,
                         E1.INSTALL_FAIL_RESN  ,
                         E1.COM_DT  ,
                         E1.PAY_COM_DT  ,
                         E1.TOT_OTSTND  ,
                         E1.PROMO_CODE  ,
                         E1.PROMO_DESC ,
                         1
                    <!-- E2.MAIL_CNT_TEL_M  ,
                         E2.MAIL_CNT_TEL_O  ,
                         E2.MAIL_CNT_TEL_R  ,
                         E2.MAIL_CNT_TEL_F  ,
                         E3.INST_CNT_TEL_M ,
                         E3.INST_CNT_TEL_O ,
                         E3.INST_CNT_TEL_R ,
                         E3.INST_CNT_TEL_F  -->
                         FROM ( SELECT vC.ORD_ID ,
                                       vC.ORD_NO ,
                                       vC.ORD_DT ,
                                       vC.APP_TYPE_ID ,
                                       vC.APP_TYPE_CODE ,
                                       vC.CUST_NAME ,
                                       vC.CUST_IC ,
                                       vC.STK_ID ,
                                       vC.STK_CODE ,
                                       vC.SALESMAN_CODE ,
                                       vC.STUS_ID ,
                                       vC.STUS_CODE ,
                                       vC.TOP_ORG_CODE ,
                                       vC.ORG_CODE ,
                                       vC.GRP_CODE ,
                                       vC.DEPT_CODE ,
                                       vC.MEM_CODE ,
                                       vC.IS_NET ,
                                       vC.NET_MONTH ,
                                       vC.PV_MONTH ,
                                       vC.PV_YEAR ,
                                       vC.INSTALL_STUS_ID ,
                                       vC.INSTALL_STUS ,
                                       vC.INSTALL_FAIL_RESN ,
                                       vC.COM_DT ,
                                       vC.PAY_COM_DT ,
                                       vC.TOT_CNT ,
                                       vC.TOT_OTSTND ,
                                       vC.PROMO_CODE ,
                                       vC.PROMO_DESC ,
                                       vC.MEM_TYPE ,
                                       vC.CUST_TYPE_ID ,
                                       vC.CORP_TYPE_ID
                                FROM SAL1008V vC ) E1

                        <if test="contactNum != null and contactNum != ''">
                        /*
                          JOIN (SELECT vM.ORD_ID
                                FROM SAL1011V vM
                                WHERE vM.MAIL_CNT_TEL_M = contactNum
                                   OR vM.MAIL_CNT_TEL_O = contactNum
                                   OR vM.MAIL_CNT_TEL_F = contactNum
                                   OR vM.MAIL_CNT_TEL_R = contactNum
                          ) E2 ON E2.ORD_ID = E1.ORD_ID
                          JOIN ( SELECT vI.ORD_ID
                                 FROM SAL1010V vI
                                 WHERE vI.INST_CNT_TEL_M = contactNum
                                    OR vI.INST_CNT_TEL_F = contactNum
                                    OR vI.INST_CNT_TEL_O = contactNum
                                    OR vI.INST_CNT_TEL_R = contactNum
                          ) E3 ON E3.ORD_ID = E1.ORD_ID
                        */
                        JOIN (
                            SELECT A.SALES_ORD_ID
                            FROM SAL0001D A
                            JOIN SAL0027D C ON A.CUST_CNT_ID = C.CUST_CNTC_ID
                            WHERE TEL_M1 = #{contactNum}
                            OR TEL_O = #{contactNum}
                            OR TEL_R = #{contactNum}
                            OR TELF = #{contactNum}
                        ) E2 ON E2.SALES_ORD_ID = E1.ORD_ID
                        JOIN (
                            SELECT A.SALES_ORD_ID
                            FROM sal0045d A
                            JOIN SAL0027D B ON B.CUST_CNTC_ID = A.CNT_ID
                            WHERE B.TEL_M1 = #{contactNum}
                            OR B.TEL_O = #{contactNum}
                            OR B.TEL_R = #{contactNum}
                            OR B.TELF = #{contactNum}
                        ) E3 ON E3.SALES_ORD_ID = E1.ORD_ID
                        </if>

                        <!-- JOIN ( SELECT vM.ORD_ID ,
                                      vM.MAIL_CNTY ,
                                      vM.MAIL_STATE ,
                                      vM.MAIL_AREA ,
                                      vM.MAIL_POST_CODE ,
                                      vM.MAIL_CNT_NAME ,
                                      vM.MAIL_CNT_NRIC ,
                                      vM.MAIL_CNT_EMAIL ,
                                      vM.MAIL_CNT_TEL_M ,
                                      vM.MAIL_CNT_TEL_O ,
                                      vM.MAIL_CNT_TEL_R ,
                                      vM.MAIL_CNT_TEL_F ,
                                      vM.MAIL_CNT_GENDER ,
                                      vM.BILL_GRP_NO ,
                                      vM.BILL_STATE_EMAIL ,
                                      vM.BILL_STATE ,
                                      vM.BILL_SMS ,
                                      vM.BILL_POST ,
                                      vM.MAIL_CNTC_ID ,
                                      vM.MAIL_ADDR_ID ,
                                      vM.MAIL_CNT_DEPT ,
                                      vM.MAIL_CNT_POST
                               FROM SAL1011V vM ) E2 ON E2.ORD_ID = E1.ORD_ID
                        JOIN ( SELECT vI.ORD_ID ,
                                      vI.INST_COUNTRY ,
                                      vI.INST_STATE ,
                                      vI.INST_AREA ,
                                      vI.INST_POSTCODE ,
                                      vI.INST_CNT_NAME ,
                                      vI.INST_CNT_NRIC ,
                                      vI.INST_CNT_EMAIL ,
                                      vI.INST_CNT_TEL_M ,
                                      vI.INST_CNT_TEL_O ,
                                      vI.INST_CNT_TEL_R ,
                                      vI.INST_CNT_TEL_F ,
                                      vI.INST_CNT_GENDER ,
                                      vI.FIRST_INSTALL_NO ,
                                      vI.FIRST_INSTALL_CT_CODE ,
                                      vI.FIRST_INSTALL_CT_NAME ,
                                      vI.FIRST_INSTALL_DT ,
                                      vI.FIRST_INSTALL_REM ,
                                      vI.FIRST_INSTALL_SIRIM_NO ,
                                      vI.FIRST_INSTALL_SERIAL_NO ,
                                      vI.LAST_INSTALL_NO ,
                                      vI.LAST_INSTALL_CT_CODE ,
                                      vI.LAST_INSTALL_CT_NAME ,
                                      vI.LAST_INSTALL_DT ,
                                      vI.LAST_INSTALL_REM ,
                                      vI.LAST_INSTALL_SIRIM_NO ,
                                      vI.LAST_INSTALL_SERIAL_NO ,
                                      vI.DSC_ID ,
                                      vI.DSC_CODE ,
                                      vI.DSC_NAME ,
                                      vI.INSTCT ,
                                      vI.PREFER_INST_DT ,
                                      vI.PREFER_INST_TM ,
                                      vI.INSTALL_ADDR_ID ,
                                      vI.INSTALL_CNTC_ID ,
                                      vI.INST_CNT_DEPT ,
                                      vI.INST_CNT_POST ,
                                      vI.VRIFY_REM
                                FROM SAL1010V vI ) E3 ON E3.ORD_ID = E1.ORD_ID -->

                        WHERE  1 = 1
                        <if test="cmbAppTypeList != null and cmbAppTypeList != ''">
                          AND E1.APP_TYPE_ID IN
                            <foreach item="item" collection="cmbAppTypeList" index="index" open="(" separator="," close=")">
                              #{item}
                            </foreach>
                        </if>
                        <if test="cmbCondition == 1 ">
                            AND E1.STUS_ID = 1
                        </if>
                        <if test="cmbCondition == 2 ">
                          AND E1.STUS_ID = 10
                        </if>
                        <if test="cmbCondition == 3 ">
                            AND E1.STUS_ID = 4
                            AND E1.PV_YEAR <![CDATA[>]]> 0
                            AND E1.PV_MONTH <![CDATA[>]]> 0
                        </if>
                        <if test="cmbCondition == 4 ">
                            AND E1.STUS_ID = 4
                            AND E1.PV_YEAR = 0
                            AND E1.PV_MONTH = 0
                        </if>
                        <if test="cmbCondition == 5 ">
                            AND E1.INSTALL_STUS_ID = 21
                            AND E1.STUS_ID != 10
                        </if>
                        <if test="cmbCondition == 6 ">
                            AND E1.INSTALL_STUS_ID = 1
                            AND E1.STUS_ID != 10
                        </if>


                         <if test="orgCode != null and orgCode != ''">
				            AND E1.ORG_CODE = #{orgCode}
				          </if>
				          <if test="grpCode != null and grpCode != ''">
				            AND E1.GRP_CODE = #{grpCode}
				          </if>
				          <if test="deptCode != null and deptCode != ''">
				            AND E1.DEPT_CODE = #{deptCode}
				          </if>
				          <if test="memCode != null and memCode != ''" >
				            AND E1.MEM_CODE = #{memCode}
				          </if>
				          <if test="ordNo != null and ordNo != ''">
				            AND E1.ORD_NO = #{ordNo}
				          </if>
				          <if test="custName != null and custName != ''">
				            AND E1.CUST_NAME LIKE '%'|| #{custName} || '%'
				          </if>
				          <if test="custIc != null and custIc != ''">
				            AND E1.CUST_IC LIKE '%'|| #{custIc} || '%'
				          </if>
				          <if test="createStDate != null and createStDate != ''">
				            AND E1.ORD_DT <![CDATA[>=]]> TO_DATE(#{createStDate}||' 00:00:00', 'DD/MM/YYYY HH24:MI:SS')
				          </if>
				          <if test="createEnDate != null and createEnDate != ''">
				            AND E1.ORD_DT <![CDATA[<=]]> TO_DATE(#{createEnDate} ||' 23:59:59', 'DD/MM/YYYY HH24:MI:SS')
				          </if>
				          <if test="cmbProduct != null and cmbProduct != ''">
				            AND E1.STK_ID = #{cmbProduct}
				          </if>
				          <if test="netSalesMonth != null and netSalesMonth != ''">
				          <!-- AND E1.PV_YEAR = #{pvYear}
				               AND E1.PV_MONTH = #{pvMonth} -->
				            AND E1.PV_YEAR = EXTRACT(YEAR FROM TO_DATE(#{netSalesMonth},'MM/YYYY'))
				            AND E1.PV_MONTH = EXTRACT(MONTH FROM TO_DATE(#{netSalesMonth},'MM/YYYY'))
				          </if>
				          <if test="salesmanCode != null and salesmanCode != ''">
				            AND E1.SALESMAN_CODE = #{salesmanCode}
				          </if>
				          <if test="promoCode != null and promoCode != ''">
				            AND E1.PROMO_CODE = #{promoCode}
				          </if>
                          <if test="memtype != null and memtype != ''">
                            AND E1.MEM_TYPE = #{memtype}
                          </if>
                          <if test="cmbCustomerType != null and cmbCustomerType != ''">
                              AND E1.CUST_TYPE_ID IN
                              <foreach item="item" collection="cmbCustomerType" index="index" open="(" separator="," close=")">
                                    #{item}
                              </foreach>
                          </if>
                          <if test="cmbCorpTypeId != null and cmbCorpTypeId != ''">
                              AND E1.CORP_TYPE_ID IN
                              <choose>
                              <when test="Individual !=null and Individual !=''">
                                  <foreach item="item" collection="cmbCorpTypeId" index="index" open="(" separator="," close=" ">
                                      #{item}
                                  </foreach>
                                   ,0)
                              </when>
                              <otherwise>
                                  <foreach item="item" collection="cmbCorpTypeId" index="index" open="(" separator="," close=")">
                                      #{item}
                                 </foreach>
                              </otherwise>
                             </choose>
                          </if>

           ) F1
          <!--   LEFT JOIN ORG0001D MEM ON MEM.MEM_CODE = F1.MEM_CODE
    	   JOIN SYS0013M S13 ON S13.CODE_ID = MEM.MEM_TYPE AND CODE_MASTER_ID = 1
    	   JOIN SAL0029D S29 ON S29.NRIC = F1.CUST_IC-->
          WHERE 1 = 1
           <!-- <if test="memtype != null and memtype != ''">
            AND MEM_TYPE = #{memtype}
          </if> -->
    ) D1
    ORDER BY D1.ORD_ID DESC
  </select>

  <select id="colorGridCmbProduct" resultType="egovMap">
    SELECT S.STK_ID CODE_ID
         , S.STK_CODE || ' - ' || S.STK_DESC CODE_NAME
         , C.CODE_NAME GROUP_CD
    FROM SYS0026M S, SAL0016M P, SYS0013M C
    WHERE S.STK_ID = P.STK_ID
      AND S.STK_CTGRY_ID = C.CODE_ID
      AND S.IS_NCV <![CDATA[<>]]> 1
      AND S.STUS_CODE_ID = 1
      AND S.STK_TYPE_ID = 61
      AND P.AMT <![CDATA[>]]> 0
    GROUP BY s.STK_ID,
             s.STK_CODE,
             s.STK_DESC,
             c.CODE_NAME
    ORDER BY c.CODE_NAME,
             s.STK_DESC
  </select>
</mapper>