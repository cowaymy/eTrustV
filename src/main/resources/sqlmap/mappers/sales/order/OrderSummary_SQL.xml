<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.sales.order.impl.OrderSummaryMapper">

   <select id="selectOrderSummary" parameterType="Map" resultType="egovMap">
    /* [com.coway.trust.biz.sales.order.service.impl.OrderSummaryMapper.selectOrderSummary] 20191002 - KR OHK */
         SELECT T.ORD_ID
                  , T.CUST_VA_NO
                  , T.ORD_NO
                  , T.CUST_NAME
                  , T.JOM_PAY_REF
                  , T.CORP_TYPE_ID
                  , T.CUST_TYPE
                  , T.CUST_ID
                  , T.ORD_STUS_CODE
                  , T.ORD_DT
                  , T.INST_AREA
                  , T.INST_STATE
                  , T.STK_CODE
                  , T.APP_TYPE_CODE
                  , T.RENT_PAY_MODE_DESC
                  , T.RENTAL_STUS
                  , T.NOR_RNT_FEE
                  , T.CURR_MTH_CHRG
                  , T.CURR_NO_MONTH_OF_RENTAL_BILL
                  , T.RENT_CURR_OTSTND
                  , T.RPF_BILL_AMT
                  , T.RPF_PAY_AMT
                  , T.RPF_ADJ_AMT
                  , T.ORD_UNBILL_AMT
                  , T.RENTAL_BILL_NO
                  , T.ORD_LAST_PAY_DT
                  , T.WEB_RENT_LEDGER
                  , T.CUST_BILL_GRP_NO
                  , T.SRV_CNTRCT_NO
                  , T.APP_TYPE_DESC
                  , T.ORG_CODE
                  , T.GRP_CODE
                  , T.DEPT_CODE
                  , T.ORD_MEM_CODE
                  , T.ORD_MEM_NAME
                  , T.ORD_PROMO_CODE
                  , T.ORD_PROMO_DESC
                  , T.ORD_PV_MONTH || '/' ||T.ORD_PV_YEAR  NET_SALE_MONTH
           FROM (SELECT A.ORD_ID
                             , A.CUST_VA_NO
						     , A.ORD_NO
						     , A.CUST_NAME
						     , A.JOM_PAY_REF
						     , E.CUST_TYPE_CMPNY AS CORP_TYPE_ID
						     , A.CUST_TYPE
						     , A.CUST_ID
						     , A.ORD_STUS_CODE
						     , A.ORD_DT

						     , E.INST_AREA
						     , E.INST_STATE

						     , '( ' || A.STOCK_CODE || ' ) ' || A.STOCK_DESC STK_CODE
						     , A.APP_TYPE_CODE

						     , E.ORD_PAY_MODE AS RENT_PAY_MODE_DESC
						     , A.RENTAL_STUS
						     , A.NOR_RNT_FEE
						     , E.CURR_MTH_CHRG
						     , E.CURR_NO_MONTH_OF_RENTAL_BILL
						     , E.RENT_CURR_OTSTND
						     , E.RPF_BILL_AMT
						     , E.RPF_PAY_AMT
						     , E.RPF_ADJ_AMT
						     , E.UN_BILL_AMT AS ORD_UNBILL_AMT
						     , E.RENTAL_BILL_NO
						     , E.ORD_LAST_PAY_DT
						     , E.WEB_RENT_LDGR_CURR_OTSTND AS WEB_RENT_LEDGER

						     , A.CUST_BILL_GRP_NO

						     , E.SRV_CNTRCT_NO
						     , A.APP_TYPE_DESC
						     , A.ORD_ORG_CODE AS ORG_CODE
					         , A.ORD_GRP_CODE AS GRP_CODE
					         , A.ORD_DEPT_CODE AS DEPT_CODE

					         , A.ORD_MEM_CODE
					         , A.ORD_MEM_NAME

					         , A.ORD_PROMO_CODE
					         , A.ORD_PROMO_DESC

					         , A.ORD_PV_YEAR
					         , A.ORD_PV_MONTH

						FROM SAL1006V A
                             LEFT OUTER JOIN REP0010S E ON E.ORD_ID = A.ORD_ID

						     <if test="cmbCondition == 5 or cmbCondition == 6">
						     LEFT OUTER JOIN SAL0046D K ON K.SALES_ORD_ID = A.ORD_ID AND K.INSTALL_ENTRY_ID = FN_GET_SAL0046D_MAX_ID (A.ORD_ID, '3')
						     </if>
						WHERE 1 =1
						  <if test="ordNo != null and ordNo != ''">
                            AND A.ORD_NO = #{ordNo}
                          </if>
                          <if test="custIc != null and custIc != ''">
                            AND A.CUST_NRIC = #{custIc}
                          </if>
                          <if test="groupNo != null and groupNo != ''">
                            AND A.CUST_BILL_GRP_NO = #{groupNo}
                          </if>
						  <if test='(ordNo == null or ordNo == "") and (custIc == null or custIc == "") and (groupNo == null or groupNo == "")'>
							  <if test="orgCode != null and orgCode != ''">
	                            AND A.ORD_ORG_CODE = #{orgCode}
	                          </if>
	                          <if test="grpCode != null and grpCode != ''">
	                            AND A.ORD_GRP_CODE = #{grpCode}
	                          </if>
	                          <if test="deptCode != null and deptCode != ''">
	                            AND A.ORD_DEPT_CODE = #{deptCode}
	                          </if>
	                          <if test="memCode != null and memCode != ''" >
					            AND A.ORD_MEM_CODE = #{memCode}
					          </if>
	                          <if test="custId != null and custId != ''">
                                AND A.CUST_ID = #{custId}
                              </if>
	                          <if test="custName != null and custName != ''">
	                            AND A.CUST_NAME LIKE '%'|| #{custName} || '%'
	                          </if>
	                          <if test="cmbAppTypeList != null and cmbAppTypeList != ''">
	                            AND A.APP_TYPE_ID IN
	                              <foreach item="item" collection="cmbAppTypeList" index="index" open="(" separator="," close=")">
	                                #{item}
	                              </foreach>
	                          </if>
	                          <if test='createStDate != null and createStDate != "" and createEnDate != null and createEnDate != ""'>
							     AND A.ORD_DT <![CDATA[>=]]>TO_DATE(#{createStDate}, 'DD/MM/YYYY')
							     AND A.ORD_DT <![CDATA[<]]>TO_DATE(#{createEnDate}, 'DD/MM/YYYY') +1
							  </if>
							  <if test="cmbProduct != null and cmbProduct != ''">
	                            AND A.STOCK_ID = #{cmbProduct}
	                          </if>
	                          <if test="netSalesMonth != null and netSalesMonth != ''">
	                            AND A.ORD_PV_YEAR = EXTRACT(YEAR FROM TO_DATE(#{netSalesMonth},'MM/YYYY'))
	                            AND A.ORD_PV_MONTH = EXTRACT(MONTH FROM TO_DATE(#{netSalesMonth},'MM/YYYY'))
	                          </if>
	                          <if test="salesmanCode != null and salesmanCode != ''">
	                            AND A.ORD_MEM_CODE = #{salesmanCode}
	                          </if>

							  <if test="cmbCondition == 1 ">
	                            AND A.ORD_STUS_ID = 1
		                      </if>
		                      <if test="cmbCondition == 2 ">
		                        AND A.ORD_STUS_ID = 10
		                      </if>
		                      <if test="cmbCondition == 3 ">
		                        AND A.ORD_STUS_ID = 4
		                        AND A.ORD_PV_YEAR <![CDATA[>]]> 0
		                        AND A.ORD_PV_MONTH <![CDATA[>]]> 0
		                      </if>
		                      <if test="cmbCondition == 4 ">
		                        AND A.ORD_STUS_ID = 4
		                        AND A.ORD_PV_YEAR = 0
		                        AND A.ORD_PV_MONTH = 0
		                      </if>
		                      <if test="cmbCondition == 5 ">
		                        AND K.STUS_CODE_ID = 21
		                        AND A.ORD_STUS_ID != 10
		                      </if>
		                      <if test="cmbCondition == 6 ">
		                        AND K.STUS_CODE_ID = 1
		                        AND A.ORD_STUS_ID != 10
		                      </if>
		                      <if test="promoCode != null and promoCode != ''">
					            AND A.ORD_PROMO_CODE = #{promoCode}
					          </if>
	                      </if>
                   ) T
		   ORDER BY T.ORD_ID DESC
    </select>

</mapper>