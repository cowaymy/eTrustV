<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.sales.rcms.impl.RCMSAgentManageMapper">

<select id="selectAgentTypeList" parameterType="Map" resultType="egovMap">
	SELECT 
	    CODE_ID,
	    CODE,
	    CODE_NAME,
	    DISAB
	FROM 
	    SYS0013M
	WHERE
	    CODE_MASTER_ID = #{codeMasterId}
</select>

<select id="chkUserNameByUserId" parameterType="Map" resultType="egovMap">
	SELECT 
	    USER_NAME 
	FROM 
	    SYS0047M
	WHERE
	    USER_NAME = #{userId}
	AND
	<![CDATA[   
	   ROWNUM <= 1
	]]>   
</select>

<select id="getSeqSAL0148M" resultType="java.lang.Integer">
    SELECT SAL0148M_AGENT_ID_SEQ.NEXTVAL FROM DUAL
</select>

<insert id="insAgentMaster" parameterType="Map">
		INSERT INTO SAL0148M(
											AGENT_ID,
											AGENT_TYPE,
											AGENT_NAME,
											STUS_ID,
											USER_ID,
											CRT_USER_ID,
											CRT_DT,
											UPD_USER_ID,
											UPD_DT
									)
							VALUES(
											#{agentSeq},
											#{agentType},
											#{agentName},
											#{stusId},
											#{userId},
											#{crtUserId},
											SYSDATE,
											#{crtUserId},
							                SYSDATE
							)
</insert>

<update id="updAgentMaster" parameterType="Map">
    UPDATE
        SAL0148M
    SET
        AGENT_TYPE = #{agentType},
        AGENT_NAME = #{agentName},
        STUS_ID = #{stusId},
        USER_ID = #{userId},
        UPD_USER_ID = #{crtUserId},
        UPD_DT = SYSDATE
    WHERE
        AGENT_ID = #{agentId}  
</update>


<select id="chkDupWebId" parameterType="Map" resultType="egovMap">
    SELECT 
        USER_ID 
    FROM 
        SAL0148M
    WHERE
        USER_ID = #{userId}
    AND
    <![CDATA[   
       ROWNUM <= 1
    ]]>   
</select>

<select id="selectAgentList" parameterType="Map" resultType="egovMap">
			SELECT 
			    AGENT_ID,
			    AGENT_TYPE,
			    AGENT_NAME,
			    STUS_ID,
			    USER_ID,
			    CRT_USER_ID,
			    TO_CHAR(CRT_DT , 'DD/MM/YYYY') CRT_DT,
			    UPD_USER_ID,
			    TO_CHAR(UPD_DT , 'DD/MM/YYYY') UPD_DT
			FROM
			    SAL0148M
			WHERE
			    1 = 1
			    <if test=" agentName != null and agentName != '' ">
                    AND UPPER(AGENT_NAME) LIKE '%'||UPPER(#{agentName})||'%'	
			    </if>
			    <if test="typeList != null and typeList.length > 0 ">
			        AND AGENT_TYPE IN
			        <foreach collection="typeList" item="item" open="(" separator="," close=")">
			             #{item}
			        </foreach>
			    </if>
			    <if test="statusList != null and statusList.length > 0">
			         AND STUS_ID IN
			         <foreach collection="statusList" item="item" open="(" separator="," close=")">
			             #{item}
			         </foreach>
			    </if>
</select>

<select id="selectRosCaller" parameterType="Map"  resultType="egovMap">
	SELECT A.AGENT_ID
	           ,B.CODE || '_'||A.AGENT_ID||'_'||A.AGENT_NAME AGENT_NAME  
	  FROM SAL0148M A
	    JOIN SYS0013M B ON A.AGENT_TYPE = B.CODE_ID 
	                             AND B.CODE_MASTER_ID = 329  
	                             AND DISAB = 0
	 WHERE 1=1
	 <if test="stus != null and stus != '' ">
	      AND A.STUS_ID = 1     
	 </if>
     <if test="userName != null and userName != '' "> 
          AND A.USER_ID= #{userName}                   
      </if>     
</select>

<select id="selectAssignAgentList" parameterType="Map" resultType="egovMap">
	SELECT C.SALES_ORD_NO 
		        ,A.SALES_ORD_ID
		        ,A.CUST_ID
		        ,B.NAME 
		        ,CASE WHEN B.CORP_TYPE_ID = 0 THEN null ELSE B.CORP_TYPE_ID  END  CORP_TYPE_ID  
		        ,A.COLCT_TRGET
		         <choose>
                  <when test="appType == 66">                   
                      ,(SELECT SUM(RENT_AMT) AS CURRENT_OS
                    FROM PAY0022D
                    WHERE RENT_SO_ID = C.SALES_ORD_ID
                    GROUP BY RENT_SO_ID) RENT_AMT
                  </when>
                  <otherwise>  
                      ,(SELECT SUM(TRADE_AMT) AS CURRENT_OS
                    FROM PAY0035D
                    WHERE RENT_SO_ID = C.SALES_ORD_ID
                    GROUP BY RENT_SO_ID) RENT_AMT
                  </otherwise>
                 </choose>  		            
		        
		        ,A.OPEN_MTH_AGING
		        ,CASE WHEN A.AGENT_ID = 0 THEN null ELSE  A.AGENT_ID END AGENT_ID
		        ,CASE WHEN A.PREV_AGENT_ID = 0 THEN null ELSE A.PREV_AGENT_ID END ORI_PREV_AGENT_ID
		        ,CASE WHEN A.AGENT_ID = 0 THEN null ELSE A.AGENT_ID END PREV_AGENT_ID
		        ,CASE WHEN A.AGENT_ID = 0 THEN  (SELECT NVL(AGENT_ID, 0) FROM SAL0149D WHERE CUST_ID = A.CUST_ID AND AGENT_ID <![CDATA[<>]]> 0 AND ROWNUM =1)  ELSE A.AGENT_ID  END SUGGEST_AGENT
		        ,CASE WHEN A.AGENT_ID = 0 THEN 'N' ELSE 'Y' END ASSIGNED 
		        ,CASE WHEN A.SENSITIVE_FG = 0 THEN 'N' ELSE 'Y' END SENSITIVE_FG
		        ,A.CURR_RENTAL_STUS
		        ,C.STUS_CODE_ID
		        ,B.TYPE_ID
		        ,TO_CHAR(A.UPD_AGENT_DT, 'dd/mm/yyyy') UPD_AGENT_DT
		        ,A.REM 
		 FROM SAL0149D A JOIN SAL0029D B  ON A.CUST_ID = B.CUST_ID
		    JOIN SAL0001D C ON A.SALES_ORD_ID = C.SALES_ORD_ID
		WHERE 1=1 
		
		<choose>
            <when test="orderNo != null and orderNo !=''">   
                AND C.SALES_ORD_NO = #{orderNo}
	            <if test="customerId != null and customerId !='' ">
	                AND A.CUST_ID = #{customerId}
	            </if>
            </when>
            <when test="customerId != null and customerId !='' "> 
                AND A.CUST_ID = #{customerId}
            </when>
            <otherwise>
				  <if test="appType != null and appType !='' ">
				    AND C.APP_TYPE_ID = #{appType} 
				  </if>
				  <if test="orderStatus != null and orderStatus !='' ">
				    AND C.STUS_CODE_ID = #{orderStatus} 
				  </if>
				  
				  <if test="rentalStatus != null and rentalStatus != ''">
			          AND A.OPEN_RENTAL_STUS IN
			        <foreach item="item" collection="rentalStatus" index="index" open="(" separator="," close=")">
			          #{item}
			        </foreach>
			      </if>
				    
			      <if test="customerType != null and customerType !='' ">
				    AND B.TYPE_ID = #{customerType} 
				  </if>
				    	 
				  <if test='customerType== "965" '>  	 
					  <if test="companyType != null and companyType != ''">
				          AND B.CORP_TYPE_ID IN
				        <foreach item="item" collection="companyType" index="index" open="(" separator="," close=")">
				          #{item}
				        </foreach>
				      </if>
				    </if>
			     <if test="openMonth != null and openMonth != ''">
			          AND ( A.OPEN_MTH_AGING IN
			        <foreach item="item" collection="openMonth" index="index" open="(" separator="," close=")">
			          #{item}
			        </foreach>             
	                  <if test="month != null and month !='' ">
	                  OR A.OPEN_MTH_AGING <![CDATA[>=]]> #{month}
	                  </if>
	                  )
			      </if>	
			      
			      <if test="rosCaller != null and rosCaller != ''">
			          AND A.AGENT_ID IN
			        <foreach item="item" collection="rosCaller" index="index" open="(" separator="," close=")">
			          #{item}
			        </foreach>
			      </if>
			      	
		          <if test="assignYn != null and assignYn !='' ">
		            AND A.AGENT_ID <![CDATA[<>]]> 0
		            </if>
	            </otherwise>
	            </choose>
	      <!-- <if test="orderNo != null and orderNo !='' ">
		    AND C.SALES_ORD_NO = #{orderNo}
		    </if>	    
	      <if test="customerId != null and customerId !='' ">
		    AND A.CUST_ID = #{customerId}
		    </if> -->
		    ORDER BY SALES_ORD_NO
</select>

    <update id="updateAgent" parameterType="Map">
		UPDATE SAL0149D
		   SET AGENT_ID = #{agentId},
		       PREV_AGENT_ID = #{prevAgentId},
		       UPD_AGENT_DT = SYSDATE,
		       UPD_USER_ID = #{userId},
		       UPD_DT = SYSDATE
		 WHERE SALES_ORD_ID = #{salesOrdId}
	 </update>
	 
    <update id="updateRemark" parameterType="Map">
		UPDATE SAL0149D
		   SET REM = #{remark},
		       SENSITIVE_FG = #{sensitiveFg},
		       UPD_USER_ID = #{userId},
		       UPD_DT = SYSDATE
		 WHERE SALES_ORD_ID = #{salesOrdId}
	 </update>
	 
    <update id="updateCompany" parameterType="Map">
		UPDATE SAL0029D
		   SET CORP_TYPE_ID = #{corpTypeId}, 
		   UPD_USER_ID = #{userId}, 
		   UPD_DT = SYSDATE
		 WHERE CUST_ID = #{custId}
	 </update>
	 
	 <select id="checkOrderNo" parameterType="Map" resultType="int">
		 SELECT count(-1) cnt
		  FROM SAL0149D A JOIN SAL0001D B 
		                              ON A.SALES_ORD_ID = B.SALES_ORD_ID
		                              AND B.APP_TYPE_ID = 66
		 WHERE B.SALES_ORD_NO =  #{orderNo} 
	 </select>
	 
	 <select id="checkAgentId" parameterType="Map" resultType="int">
	    SELECT COUNT(-1) CNT
	      FROM SAL0148M A
	        JOIN SYS0013M B ON A.AGENT_TYPE = B.CODE_ID 
	                                 AND B.CODE_MASTER_ID = 329  
	                                 AND DISAB = 0
	      WHERE A.AGENT_ID = #{agentId}                                 
    </select>
    
    <select id="selectRcmsInfo" parameterType="Map" resultType="egovMap">
         SELECT A.SALES_ORD_ID, 
                    A.AGENT_ID, 
                    A.REM, 
                    A.SENSITIVE_FG, 
                    B.SALES_ORD_NO
          FROM SAL0149D A JOIN SAL0001D B 
                                      ON A.SALES_ORD_ID = B.SALES_ORD_ID
                                      AND B.APP_TYPE_ID = 66
         WHERE B.SALES_ORD_NO =  #{orderNo}    
     </select>
     
     <select id="selectAssignedList" parameterType="Map" resultType="egovMap">
		   SELECT C.SALES_ORD_ID
			        ,C.SALES_ORD_NO
			        ,C.CUST_BILL_ID
			        ,TO_CHAR(C.SALES_DT, 'dd/mm/yyyy') SALES_DT
			        ,C.APP_TYPE_ID
			        ,G.CODE
			        ,A.OPEN_RENTAL_STUS
			        ,E.ITM_STK_ID
			        ,F.STK_DESC
			        ,A.CUST_ID
			        ,B.NAME 
			        ,B.NRIC
			        ,MAX(A.COLCT_TRGET)    COLCT_TRGET 
                 <choose>
                  <when test="appType == 66">                   
                     ,MAX((SELECT SUM(RENT_AMT) AS CURRENT_OS
                    FROM PAY0022D
                    WHERE RENT_SO_ID = C.SALES_ORD_ID
                    GROUP BY RENT_SO_ID)) RENT_AMT
                  </when>
                  <otherwise>  
                      ,MAX((SELECT SUM(TRADE_AMT) AS CURRENT_OS
                    FROM PAY0035D
                    WHERE RENT_SO_ID = C.SALES_ORD_ID
                    GROUP BY RENT_SO_ID)) RENT_AMT
                  </otherwise>
                 </choose>                      
                 ,A.OPEN_MTH_AGING
			     ,CASE WHEN A.SENSITIVE_FG = 0 THEN 'N' ELSE 'Y' END SENSITIVE_FG                
			FROM SAL0149D A JOIN SAL0029D B  ON A.CUST_ID = B.CUST_ID
			            JOIN SAL0001D C ON A.SALES_ORD_ID = C.SALES_ORD_ID
			            JOIN MSC0013D D ON  A.SALES_ORD_ID = D.SALES_ORD_ID
			            JOIN sal0002d E ON A.SALES_ORD_ID = E.SALES_ORD_ID
			            JOIN SYS0026M F ON E.ITM_STK_ID = F.STK_ID
			            JOIN SYS0013M G ON C.APP_TYPE_ID = G.CODE_ID
			        WHERE A.AGENT_ID = #{rosCaller}
			            AND TO_CHAR(A.COLLECT_DT, 'yyyymm') = TO_CHAR(SYSDATE, 'yyyymm')
        
        <choose>
            <when test="orderNo != null and orderNo !=''">   
                AND C.SALES_ORD_NO = #{orderNo}
                <if test="customerId != null and customerId !='' ">
                    AND A.CUST_ID = #{customerId}
                </if>
            </when>
            <when test="customerId != null and customerId !='' "> 
                AND A.CUST_ID = #{customerId}
            </when>
            <otherwise>
                  <if test="appType != null and appType !='' ">
                    AND C.APP_TYPE_ID = #{appType} 
                  </if>
                  <if test="orderStatus != null and orderStatus !='' ">
                    AND C.STUS_CODE_ID = #{orderStatus} 
                  </if>
                  
                  <if test="rentalStatus != null and rentalStatus != ''">
                      AND A.OPEN_RENTAL_STUS IN
                    <foreach item="item" collection="rentalStatus" index="index" open="(" separator="," close=")">
                      #{item}
                    </foreach>
                  </if>
                    
                  <if test="customerType != null and customerType !='' ">
                    AND B.TYPE_ID = #{customerType} 
                  </if>
                         
                  <if test='customerType== "965" '>      
                      <if test="companyType != null and companyType != ''">
                          AND B.CORP_TYPE_ID IN
                        <foreach item="item" collection="companyType" index="index" open="(" separator="," close=")">
                          #{item}
                        </foreach>
                      </if>
                    </if>
                 <if test="openMonth != null and openMonth != ''">
                      AND ( A.OPEN_MTH_AGING IN
                    <foreach item="item" collection="openMonth" index="index" open="(" separator="," close=")">
                      #{item}
                    </foreach>             
                      <if test="month != null and month !='' ">
                      OR A.OPEN_MTH_AGING <![CDATA[>=]]> #{month}
                      </if>
                      )
                  </if>                 
                  <if test="rosStatus != null and rosStatus != ''">
                    AND D.ROS_STUS = #{rosStatus}
                   </if>
                   
                   <if test="reCallDtYmd != null and reCallDtYmd != '' ">
                   AND TO_CHAR(D.ROS_CALL_RECALL_DT, 'yyyymmdd') = TO_CHAR( TO_DATE(#{reCallDtYmd}, 'dd/mm/yyyy'), 'yyyymmdd')
                   </if> 
                   <if test="stReCallTime != null and stReCallTime != '' ">
                   AND TO_CHAR(D.ROS_CALL_RECALL_DT , 'HH24MISS') <![CDATA[>=]]> TO_CHAR( TO_DATE(#{stReCallTime}, 'HH24:MI:SS'),  'HH24MISS')
                   </if> 
                   <if test="edReCallTime != null and edReCallTime != '' ">
                   AND TO_CHAR(D.ROS_CALL_CRT_DT ,  'HH24MISS') <![CDATA[<=]]> TO_CHAR( TO_DATE(#{edReCallTime}, 'HH24:MI:SS'),  'HH24MISS')
                    </if> 
                   <if test="stPtpDate != null and stPtpDate != '' ">
                   AND TO_CHAR(D.PTP_DT, 'yyyymmdd') <![CDATA[>=]]> TO_CHAR( TO_DATE(#{stPtpDate}, 'dd/mm/yyyy'), 'yyyymmdd')            
                    </if> 
                   <if test="edPptpDate != null and edPptpDate != '' ">
                   AND TO_CHAR(D.PTP_DT, 'yyyymmdd') <![CDATA[<=]]> TO_CHAR( TO_DATE(#{edPptpDate}, 'dd/mm/yyyy'), 'yyyymmdd')
                    </if> 
                                     
                </otherwise>
                </choose>
	            GROUP BY  C.SALES_ORD_ID
					        ,C.SALES_ORD_NO
					        ,C.CUST_BILL_ID
					        ,SALES_DT
					        ,C.APP_TYPE_ID
					        ,G.CODE
					        ,A.OPEN_RENTAL_STUS
					        ,E.ITM_STK_ID
					        ,F.STK_DESC
					        ,A.CUST_ID
					        ,B.NAME 
					        ,B.NRIC
					        ,A.COLCT_TRGET
					        ,A.OPEN_MTH_AGING 
					        ,A.SENSITIVE_FG
				ORDER BY SALES_ORD_NO        
    </select>
     
    <select id="selectRosCallDetailList" parameterType="map" resultType="egovMap">
     SELECT ROS_YEAR || '/' || ROS_MONTH ROS_DT
	          ,  , CASE WHEN ROS_CALLER_USER_ID = 0 THEN null ELSE ROS_CALLER_USER_ID END ROS_CALLER_USER_ID
	  FROM MSC0013D
	 WHERE SALES_ORD_ID = #{salesOrdId}
	     
     </select>
     
	 
</mapper>