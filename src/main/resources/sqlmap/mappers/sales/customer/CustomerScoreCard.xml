<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.coway.trust.biz.sales.customer.impl.CustomerScoreCardMapper">

	<select id="customerScoreCardList" parameterType="Map"
		resultType="egovMap">

		SELECT D1.ORD_NO AS ORD_NO,
		D1.REN_STUS AS ORD_STUS_CODE,
		D1.APP_TYPE AS APP_TYPE_CODE,
		D1.SALES_DT AS ORD_DT,
		D1.INSTALL_DT AS INS_DT,
		D1.STK_CODE AS PRODUCT_CODE,
		D1.STK_DESC AS PRODUCT_NAME ,
		UPPER (D1.INST_ADD) AS INS_ADDR,
		D1.PAY_MODE as PAY_MODE,
		D1.AGING_MTH AS AGING_MONTH,
		D1.OUT_AMT AS OUT_AMT,
		D1.SRV_STUS AS MEM_STUS

		FROM (
		SELECT D.SALES_ORD_NO AS ORD_NO,F.STUS_CODE_ID AS REN_STUS , M.CODE AS
		APP_TYPE , D.SALES_DT, IR.INSTALL_DT, ST.STK_CODE, ST.STK_DESC ,
		case when (INS.STUS_CODE_ID =1 or INS.STUS_CODE_ID =4) then
        UPPER(INSA.ADDR_DTL ||' '||INSA.STREET ||' ' ||B.AREA ||' '|| B.POSTCODE ||' '|| B.CITY ||', '|| B.STATE ||', '|| B.COUNTRY)
        ELSE '-'
        END
        AS INST_ADD,
		M1.CODE as PAY_MODE, RC.ACC_DEBT_SUB_CURR_OTSTND_AGING AGING_MTH,
		RC.ACC_DEBT_SUB_TOT_OTSTND OUT_AMT,
		(CASE WHEN SRV.SRV_EXPR_DT >= SYSDATE THEN 'ACTIVE' ELSE 'EXPIRED' END)
		SRV_STUS
		FROM SAL0029D C
		JOIN SAL0001D D ON D.CUST_ID = C.CUST_ID
		JOIN SAL0002D E ON E.SALES_ORD_ID = D.SALES_ORD_ID
		JOIN SYS0026M ST ON ST.STK_ID = E.ITM_STK_ID
		LEFT JOIN SAL0071D F ON F.SALES_ORD_ID = D.SALES_ORD_ID
		LEFT JOIN SYS0013M M ON M.CODE_ID = D.APP_TYPE_ID
		LEFT JOIN SAL0046D IE ON IE.INSTALL_ENTRY_ID = FN_GET_SAL0046D_MAX_ID(
		D.SALES_ORD_ID ,'2' )
		LEFT JOIN SAL0047D IR ON IR.ENTRY_ID = IE.INSTALL_ENTRY_ID
		LEFT JOIN SAL0045D INS ON INS.SALES_ORD_ID = D.SALES_ORD_ID AND
		(INS.STUS_CODE_ID =1 or INS.STUS_CODE_ID =4)
		LEFT JOIN SAL0023D INSA ON INSA.CUST_ADD_ID = INS.ADD_ID
		LEFT OUTER JOIN SYS0064M B ON B.AREA_ID = INSA.AREA_ID AND B.STATUS_ID = 1
		LEFT JOIN SAL0074D P ON P.SALES_ORD_ID = D.SALES_ORD_ID
		LEFT JOIN SYS0013M M1 ON M1.CODE_ID = P.MODE_ID
		LEFT JOIN PAY0053S RC ON RC.ACC_DEBT_ORD_ID = D.SALES_ORD_ID
		LEFT JOIN SAL0095D SRV ON SRV.SRV_MEM_ID =
		FN_GET_SAL0095D_MAX_ID(D.SALES_ORD_ID,'1')
		WHERE 1=1
		<if test="custId != null and custId != ''">
			AND UPPER(C.CUST_ID) = UPPER(#{custId})
		</if>

		<!-- <if test="custName != null and custName != ''"> AND UPPER(C.CUST_NAME)
			like '%'|| UPPER(#{custName}) ||'%' </if> -->

		<if test="custIc != null and custIc != ''">
			AND UPPER(C.NRIC) = UPPER(#{custIc})
		</if>
		UNION ALL
		SELECT D.SRV_ORD_NO ,F.STUS_CODE_ID AS REN_STUS , M.CODE AS APP_TYPE ,
		D.SALES_DT, IR.INSTALL_DT, ST.STK_CODE, ST.STK_DESC ,
		case when (INS.STUS_CODE_ID =1 or INS.STUS_CODE_ID =4) then
        UPPER(INSA.ADDR_DTL ||' '||INSA.STREET ||' ' ||B.AREA ||' '|| B.POSTCODE ||' '|| B.CITY ||', '|| B.STATE ||', '|| B.COUNTRY)
        ELSE '-'
        END
        AS INST_ADD,
		M1.CODE as PAY_MODE, RC.ACC_DEBT_SUB_CURR_OTSTND_AGING AGING_MTH,
		RC.ACC_DEBT_SUB_TOT_OTSTND OUT_AMT,
		(CASE WHEN SRV.SRV_EXPR_DT >= SYSDATE THEN 'ACTIVE' ELSE 'EXPIRED' END)
		SRV_STUS
		FROM SAL0029D C
		JOIN SAL0225D D ON D.CUST_ID = C.CUST_ID
		JOIN SAL0002D E ON E.SALES_ORD_ID = D.SRV_ORD_ID
		JOIN SYS0026M ST ON ST.STK_ID = E.ITM_STK_ID
		LEFT JOIN SAL0071D F ON F.SALES_ORD_ID = D.SRV_ORD_ID
		LEFT JOIN SYS0013M M ON M.CODE_ID = D.APP_TYPE_ID
		LEFT JOIN SAL0046D IE ON IE.INSTALL_ENTRY_ID = FN_GET_SAL0046D_MAX_ID(
		D.SRV_ORD_ID ,'2' )
		LEFT JOIN SAL0047D IR ON IR.ENTRY_ID = IE.INSTALL_ENTRY_ID
		LEFT JOIN SAL0045D INS ON INS.SALES_ORD_ID = D.SRV_ORD_ID AND
		(INS.STUS_CODE_ID =1 or INS.STUS_CODE_ID =4)
		LEFT JOIN SAL0023D INSA ON INSA.CUST_ADD_ID = INS.ADD_ID
		LEFT OUTER JOIN SYS0064M B ON B.AREA_ID = INSA.AREA_ID AND B.STATUS_ID = 1
		LEFT JOIN SAL0074D P ON P.SALES_ORD_ID = D.SRV_ORD_ID
		LEFT JOIN SYS0013M M1 ON M1.CODE_ID = P.MODE_ID
		LEFT JOIN PAY0053S RC ON RC.ACC_DEBT_ORD_ID = D.SRV_ORD_ID
		LEFT JOIN SAL0095D SRV ON SRV.SRV_MEM_ID =
		FN_GET_SAL0095D_MAX_ID(D.SRV_ORD_ID,'1')
		WHERE 1=1
		<if test="custId != null and custId != ''">
			AND UPPER(C.CUST_ID) = UPPER(#{custId})
		</if>

		<!-- <if test="custName != null and custName != ''"> AND UPPER(C.CUST_NAME)
			like '%'|| UPPER(#{custName}) ||'%' </if> -->

		<if test="custIc != null and custIc != ''">
			AND UPPER(C.NRIC) = UPPER(#{custIc})
		</if>
		) D1
		ORDER BY D1.ORD_NO

	</select>


</mapper>