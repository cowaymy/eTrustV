<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.sales.ccp.impl.PreCcpRegisterMapper">


<insert id="submitPreCcpSubmission" parameterType="java.util.Map">
	    INSERT INTO SAL0343D
	    (
		      PRECCP_SEQ
			, CUST_NAME
			, CUST_IC
			, CUST_MOBILENO
			, CUST_EMAIL
			, CRT_DT
			, CRT_ID
			, CUST_ID
			, CHS_STATUS
			, CHS_RSN
			, DISAB
	    )
	    VALUES
	    (
	          SAL0343D_PRECCP_SEQ.NEXTVAL
	        , #{customerName}
	        , #{customerNric}
	        , #{customerMobileNo}
	        , #{customerEmailAddr}
	        , SYSDATE
	        , #{userId}
	        , #{custId}
	        , #{chsStatus}
	        , #{chsRsn}
	        , 0
	    )
</insert>

<select id="getExistCustomer" parameterType="Map" resultType="egovMap">
		 SELECT
		        A.CUST_ID
		     ,  CASE WHEN B.CHS_STUS IS NULL THEN '-' ELSE B.CHS_STUS END CHS_STATUS
		     ,  B.CHS_RSN
		FROM SAL0029D A
		LEFT JOIN SAL0262D B ON A.CUST_ID = B.CUST_ID AND CHS_YEAR = TO_CHAR(TRUNC(SYSDATE),'YYYY') AND CHS_MONTH = TO_CHAR(TRUNC(SYSDATE),'MM')
		WHERE A.NRIC = #{customerNric} AND ROWNUM = 1
</select>

<select id="selectPreCcpStatus"  parameterType="Map" resultType="egovMap">
        SELECT CODE AS CODE_ID,
               CODE_NAME AS CODE_NAME
        FROM SYS0094M
        WHERE IND = 'PRECCP_STA'
          AND DISB = 0
        ORDER BY LPAD(CODE,4)
</select>

<select id="searchPreCcpRegisterList" parameterType="Map" resultType="egovMap">
	   SELECT
		      A.PRECCP_SEQ
            , A.CUST_NAME
		    , A.CUST_IC
		    , A.CUST_MOBILENO
		    , A.CUST_EMAIL
		    , A.CUST_ID
		    , CASE WHEN A.CHS_STATUS = 'GREEN'   THEN A.CHS_STATUS
                       WHEN A.CHS_STATUS = 'YELLOW' THEN A.CHS_STATUS || '_' || A.CHS_RSN
                                                                          ELSE '-'
              END CHS_STATUS
		    , TO_CHAR(A.CRT_DT,'YYYY/MM/DD') CRT_DT
		    , B.USER_NAME CREATOR
	   FROM SAL0343D A
	   JOIN SYS0047M B ON A.CRT_ID = B.USER_ID
       WHERE DISAB = 0
	   <if test="custName != null and custName != '' ">
             AND ( A.CUST_NAME LIKE '%'||#{custName}||'%')
       </if>

       <if test="nric != null and nric != '' ">
             AND ( A.CUST_IC LIKE '%'||#{nric}||'%')
       </if>

       <if test="mobileNo != null and mobileNo != '' ">
             AND ( A.CUST_MOBILENO LIKE '%'||#{mobileNo}||'%')
       </if>

       <if test="emailAddr != null and emailAddr != '' ">
             AND ( A.CUST_EMAIL LIKE '%'||#{emailAddr}||'%')
       </if>

	   <if test="preCcpRegisterList != null and preCcpRegisterList != '' ">
            AND A.CHS_STATUS IN
           <foreach item="item" collection="preCcpRegisterList" index="index" open="(" separator="," close=")">
            #{item}
           </foreach>
       </if>

       <if test=" registerDtFrm  != null  and registerDtFrm !='' and registerDtTo != null  and registerDtTo != ''  ">
             AND  A.CRT_DT  BETWEEN TO_DATE(#{registerDtFrm}, 'DD/MM/YYYY') AND TO_DATE(#{registerDtTo}||' 23:59:59', 'DD/MM/YYYY HH24:MI:SS')
       </if>

       <if test="requestor != null and requestor != '' ">
             AND ( B.USER_NAME LIKE '%'||#{requestor}||'%')
       </if>
</select>

</mapper>