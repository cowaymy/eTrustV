<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coway.trust.biz.sales.promotion.impl.PromotionMapper">

    <select id="selectPromotionList" parameterType="Map" resultType="egovMap">
        SELECT T1.PROMO_ID
             , T1.PROMO_MTCH_ID
             , T1.PROMO_CODE
             , T1.PROMO_DESC
             , T1.PROMO_TYPE_ID
             , T3.CODE_NAME AS PROMO_TYPE_NAME
             , T1.PROMO_APP_TYPE_ID
             , T2.CODE_NAME AS PROMO_APP_TYPE_NAME
             , T1.PROMO_SRV_MEM_PAC_ID
             , TO_CHAR(T1.PROMO_DT_FROM, 'DD/MM/YYYY') AS PROMO_DT_FROM
             , TO_CHAR(T1.PROMO_DT_END,  'DD/MM/YYYY') AS PROMO_DT_END
             , T1.PROMO_STUS_ID
             , T1.PROMO_UPD_DT
             , T1.PROMO_UPD_USER_ID
             , T1.PROMO_IS_TRIAL_CNVR
             , T1.PROMO_PRC_PRCNT
             , T1.PROMO_CUST_TYPE
             , T1.PROMO_DISC_TYPE
             , T1.PROMO_RPF_DISC_AMT
             , T1.PROMO_DISC_PERIOD_TP
             , T1.PROMO_DISC_PERIOD
             , T1.PROMO_FREESVC_PERIOD_TP
             , T1.PROMO_ADD_DISC_PRC
             , T1.PROMO_ADD_DISC_PV
             , T1.EMP_CHK
             , T1.EX_TRADE
          FROM SAL0017D T1
          LEFT OUTER
          JOIN SYS0013M T2
            ON T1.PROMO_APP_TYPE_ID = T2.CODE_ID
           AND T2.CODE_MASTER_ID = '320'
          LEFT OUTER
          JOIN SYS0013M T3
            ON T1.PROMO_TYPE_ID = T3.CODE_ID
           AND T3.CODE_MASTER_ID = '76'
         WHERE 1 = 1
         <if test='arrPromoAppTypeId != null and arrPromoAppTypeId != ""'>
           AND T1.PROMO_APP_TYPE_ID IN
           <foreach item="item" collection="arrPromoAppTypeId" index="index" open="(" separator="," close=")">
             #{item}
           </foreach>
         </if>
         <if test='arrPromoTypeId != null and arrPromoTypeId !=""'>
           AND T1.PROMO_TYPE_ID IN
           <foreach item="item" collection="arrPromoTypeId" index="index" open="(" separator="," close=")">
             #{item}
           </foreach>
         </if>
         <if test='promoDt != null and promoDt !=""'>
           AND #{promoDt} BETWEEN TO_CHAR(T1.PROMO_DT_FROM, 'YYYY-MM-DD') AND TO_CHAR(T1.PROMO_DT_END, 'YYYY-MM-DD')
         </if>
         <if test='promoStusId != null and promoStusId !=""'>
           AND T1.PROMO_STUS_ID = #{promoStusId}
         </if>
         <if test='promoCode != null and promoCode !=""'>
           AND UPPER(T1.PROMO_CODE) LIKE '%'||UPPER(#{promoCode})||'%'
         </if>
         <if test='promoDesc != null and promoDesc !=""'>
           AND UPPER(T1.PROMO_DESC) LIKE '%'||UPPER(#{promoDesc})||'%'
         </if>
    </select>

    <update id="updatePromoStatus" parameterType="salesPromoMVO">
        UPDATE SAL0017D
           SET PROMO_STUS_ID = #{promoStusId}
             , PROMO_UPD_DT = SYSDATE
             , PROMO_UPD_USER_ID = #{promoUpdUserId}
         WHERE PROMO_ID = #{promoId}
    </update>
    
    <select id="selectMembershipPkg" parameterType="Map" resultType="egovMap">
		SELECT CODE_ID
		     , CODE_NAME
		  FROM
		     ( SELECT T1.SRV_CNTRCT_PAC_ID AS CODE_ID
		            , T1.SRV_CNTRCT_PAC_DESC AS CODE_NAME
		         FROM SAL0081D T1
		        WHERE T1.SRV_CNTRCT_PAC_STUS_ID = 1
		          AND T1.PAC_TYPE IN ('0', '2')
		          AND '1' = #{selType}
		        UNION ALL
		       SELECT T1.SRV_CNTRCT_PAC_ID AS CODE_ID
		            , T1.SRV_CNTRCT_PAC_DESC AS CODE_NAME
		         FROM SAL0081D T1
		        WHERE T1.SRV_CNTRCT_PAC_STUS_ID = 1
		          AND T1.PAC_TYPE = '1'
		          AND '2' = #{selType}
		        UNION ALL
		       SELECT T1.SRV_MEM_PAC_ID AS CODE_ID
		            , T1.SRV_MEM_DESC AS CODE_NAME
		         FROM SAL0091M T1
		        WHERE T1.SRV_MEM_STUS_ID = 1
		          AND T1.PAC_TYPE IN ('0', '2')
		          AND '3' = #{selType}
		        UNION ALL
		       SELECT T1.SRV_MEM_PAC_ID AS CODE_ID
		            , T1.SRV_MEM_DESC AS CODE_NAME
		         FROM SAL0091M T1
		        WHERE T1.SRV_MEM_STUS_ID = 1
		          AND T1.PAC_TYPE = '1'
		          AND '4' = #{selType}
		     )
		 ORDER BY CODE_ID
    </select>
    
    <select id="selectPriceInfo" parameterType="Map" resultType="egovMap">
        SELECT T1.PRC_ID
             , T1.MEM_PAC_ID
             , T1.STK_ID
             , T1.AMT
             , T1.UOM_ID
             , T1.UOM_CONV
             , T1.START_DT
             , T1.END_DT
             , T1.CNTY_ID
             , T1.APP_TYPE_ID
             , T1.PRIOD
             , T1.PRC_RPF
             , T1.PRC_PV
             , T1.TRADE_IN_PV
             , T1.CRT_USER_ID
             , T1.CRT_DT
             , T1.UPD_USER_ID
             , T1.UPD_DT
             , T1.PRC_CHRG
             , T1.PRC_COSTING
             , T1.STUS_CODE_ID
          FROM SAL0016M T1
         WHERE T1.STK_ID = #{stkId}
           AND T1.APP_TYPE_ID = #{appTypeId}
    </select>
    
    <insert id="insertSalesPromoM" parameterType="salesPromoMVO">
      <selectKey keyProperty="promoId" resultType="Integer" order="BEFORE">
        SELECT SAL0017D_PROMO_ID_SEQ.NEXTVAL FROM DUAL
      </selectKey>
        INSERT
          INTO SAL0017D 
             ( PROMO_ID
             , PROMO_MTCH_ID
             , PROMO_CODE
             , PROMO_DESC
             , PROMO_TYPE_ID
             , PROMO_APP_TYPE_ID
             , PROMO_SRV_MEM_PAC_ID
             , PROMO_DT_FROM
             , PROMO_DT_END
             , PROMO_STUS_ID
             , PROMO_UPD_DT
             , PROMO_UPD_USER_ID
             , PROMO_IS_TRIAL_CNVR
             , PROMO_PRC_PRCNT
             , PROMO_CUST_TYPE
             , PROMO_DISC_TYPE
             , PROMO_RPF_DISC_AMT
             , PROMO_DISC_PERIOD_TP
             , PROMO_DISC_PERIOD
             , PROMO_FREESVC_PERIOD_TP
             , PROMO_ADD_DISC_PRC
             , PROMO_ADD_DISC_PV
             , EMP_CHK
             , EX_TRADE
             , CRT_USER_ID
             , CRT_DT
             , UPD_USER_ID
             , UPD_DT
             , IS_NEW)
        VALUES
             ( #{promoId}
             , #{promoMtchId}
             , FN_GET_PROMO_CODE(#{promoAppTypeId}, #{promoTypeId}, TO_CHAR(SYSDATE, 'YYMMDD'))
             , #{promoDesc}
             , #{promoTypeId}
             , #{promoAppTypeId}
             , #{promoSrvMemPacId}
             , TO_DATE(#{promoDtFrom}, 'YYYY-MM-DD')
             , TO_DATE(#{promoDtEnd}, 'YYYY-MM-DD')
             , #{promoStusId}
             , SYSDATE
             , #{promoUpdUserId}
             , #{promoIsTrialCnvr}
             , #{promoPrcPrcnt}
             , #{promoCustType}
             , #{promoDiscType}
             , #{promoRpfDiscAmt}
             , #{promoDiscPeriodTp}
             , #{promoDiscPeriod}
             , #{promoFreesvcPeriodTp}
             , #{promoAddDiscPrc}
             , #{promoAddDiscPv}
             , #{empChk}
             , #{exTrade}
             , #{crtUserId}
             , SYSDATE
             , #{updUserId}
             , SYSDATE
             , #{isNew})
    </insert>

    <insert id="insertSalesPromoD" parameterType="salesPromoDVO">
      <selectKey keyProperty="promoItmId" resultType="Integer" order="BEFORE">
        SELECT SAL0018D_PROMO_ITM_ID_SEQ.NEXTVAL FROM DUAL
      </selectKey>
        INSERT
          INTO SAL0018D
             ( PROMO_ITM_ID
             , PROMO_ID
             , PROMO_ITM_STK_ID
             , PROMO_ITM_CUR_ID
             , PROMO_ITM_PV
             , PROMO_ITM_STUS_ID
             , PROMO_ITM_UPD_USER_ID
             , PROMO_ITM_UPD_DT
             , CRT_USER_ID
             , CRT_DT
             , UPD_USER_ID
             , UPD_DT
             , PROMO_ITM_PV_GST
             ) 
        VALUES
             ( #{promoItmId}
             , #{promoId}
             , #{promoItmStkId}
             , #{promoItmCurId}
             , #{promoItmPv}
             , #{promoItmStusId}
             , #{promoItmUpdUserId}
             , SYSDATE
             , #{crtUserId}
             , SYSDATE
             , #{updUserId}
             , SYSDATE
             , #{promoItmPvGst}
             )
    </insert>
    
    <insert id="insertSalesPromoFreeGift" parameterType="salesPromoFreeGiftVO">
      <selectKey keyProperty="promoFreeGiftId" resultType="Integer" order="BEFORE">
        SELECT SAL0019D_FREE_GIFT_ID_SEQ.NEXTVAL FROM DUAL
      </selectKey>
        INSERT
          INTO SAL0019D
             ( PROMO_FREE_GIFT_ID
             , PROMO_FREE_GIFT_PROMO_ID
             , PROMO_FREE_GIFT_STK_ID
             , PROMO_FREE_GIFT_STUS_ID
             , PROMO_FREE_GIFT_START_DT
             , PROMO_FREE_GIFT_EXPR_DT
             , PROMO_FREE_GIFT_CRT_USER_ID
             , PROMO_FREE_GIFT_CRT_DT
             , PROMO_FREE_GIFT_QTY)
        VALUES
             ( #{promoFreeGiftId}
             , #{promoFreeGiftPromoId}
             , #{promoFreeGiftStkId}
             , #{promoFreeGiftStusId}
             , TO_DATE('1900-01-01', 'YYYY-MM-DD')
             , TO_DATE('9999-12-31', 'YYYY-MM-DD')
             , #{promoFreeGiftCrtUserId}
             , SYSDATE
             , #{promoFreeGiftQty})
    </insert>
     
    <select id="selectPromotionDetail" parameterType="Map" resultType="egovMap">
        SELECT T1.PROMO_ID
             , T1.PROMO_MTCH_ID
             , T1.PROMO_CODE
             , T1.PROMO_DESC
             , T1.PROMO_TYPE_ID
             , T1.PROMO_APP_TYPE_ID
             , T1.PROMO_SRV_MEM_PAC_ID
             , TO_CHAR(T1.PROMO_DT_FROM, 'DD/MM/YYYY') AS PROMO_DT_FROM
             , TO_CHAR(T1.PROMO_DT_END,  'DD/MM/YYYY') AS PROMO_DT_END
             , T1.PROMO_STUS_ID
             , T1.PROMO_UPD_DT
             , T1.PROMO_UPD_USER_ID
             , T1.PROMO_IS_TRIAL_CNVR
             , T1.PROMO_PRC_PRCNT
             , T1.PROMO_CUST_TYPE
             , T1.PROMO_DISC_TYPE
             , T1.PROMO_RPF_DISC_AMT
             , T1.PROMO_DISC_PERIOD_TP
             , T1.PROMO_DISC_PERIOD
             , T1.PROMO_FREESVC_PERIOD_TP
             , T1.PROMO_ADD_DISC_PRC
             , T1.PROMO_ADD_DISC_PV
             , T1.EMP_CHK
             , T1.EX_TRADE
          FROM SAL0017D T1
         WHERE T1.PROMO_ID = #{promoId}
    </select>

    <select id="selectPromotionPrdList" parameterType="Map" resultType="egovMap">
        SELECT T1.PROMO_ITM_ID
             , T1.PROMO_ID
             , T1.PROMO_ITM_STK_ID
             , T2.STK_CODE AS ITMCD
             , T2.STK_DESC AS ITMNAME
             , T1.PROMO_ITM_CUR_ID
             , T1.PROMO_ITM_PRC
             , T1.PROMO_ITM_PV
             , T1.PROMO_ITM_STUS_ID
             , T1.PROMO_ITM_UPD_USER_ID
             , T1.PROMO_ITM_UPD_DT
             , T1.PROMO_ITM_RENTAL
             , T1.PROMO_ITM_RENT_PRIOD
             , T1.PROMO_ITM_OBLIG_PRIOD
             , T1.PROMO_ITM_PV_GST
          FROM SAL0018D T1
          LEFT OUTER
          JOIN SYS0026M T2
            ON T1.PROMO_ITM_STK_ID = T2.STK_ID
         WHERE T1.PROMO_ID = #{promoId}
           AND T1.PROMO_ITM_STUS_ID = 1
    </select>

    <select id="selectPromotionPrdWithPriceList" parameterType="Map" resultType="egovMap">
        SELECT T1.PROMO_ITM_ID
             , T1.PROMO_ID
             , T1.PROMO_ITM_STK_ID
             , T2.STK_CODE AS ITMCD
             , T2.STK_DESC AS ITMNAME
             , T1.PROMO_ITM_CUR_ID
             , T1.PROMO_ITM_PRC
             , T4.AMT
             , T4.PRC_RPF
             , T4.PRC_PV
             , FLOOR(T4.AMT - DECODE(T3.PROMO_DISC_TYPE, 0, T4.AMT*(T3.PROMO_PRC_PRCNT/100), T3.PROMO_PRC_PRCNT) - T3.PROMO_ADD_DISC_PRC) AS PROMO_AMT
             , T4.PRC_RPF - T3.PROMO_RPF_DISC_AMT AS PROMO_PRC_RPF
             , T1.PROMO_ITM_PV
          FROM SAL0018D T1
          LEFT OUTER
          JOIN SYS0026M T2
            ON T1.PROMO_ITM_STK_ID = T2.STK_ID
          LEFT OUTER
          JOIN SAL0017D T3
            ON T1.PROMO_ID = T3.PROMO_ID
          LEFT OUTER
          JOIN SAL0016M T4
            ON T4.STK_ID = T1.PROMO_ITM_STK_ID
           AND T4.APP_TYPE_ID = #{appTypeId}
         WHERE T1.PROMO_ID = #{promoId}
           AND T1.PROMO_ITM_STUS_ID = 1
         ORDER BY PROMO_ITM_ID ASC
    </select>

    <select id="selectPromotionFreeGiftList" parameterType="Map" resultType="egovMap">
        SELECT T1.PROMO_FREE_GIFT_ID
             , T1.PROMO_FREE_GIFT_PROMO_ID
             , T1.PROMO_FREE_GIFT_STK_ID
             , T2.ITM_CODE AS ITMCD
             , T2.ITM_NAME AS ITMNAME
             , T1.PROMO_FREE_GIFT_STUS_ID
             , T1.PROMO_FREE_GIFT_START_DT
             , T1.PROMO_FREE_GIFT_EXPR_DT
             , T1.PROMO_FREE_GIFT_CRT_USER_ID
             , T1.PROMO_FREE_GIFT_CRT_DT
             , T1.PROMO_FREE_GIFT_QTY
          FROM SAL0019D T1
          LEFT OUTER
          JOIN MSC0039D T2
            ON T1.PROMO_FREE_GIFT_STK_ID = T2.ITM_ID
         WHERE T1.PROMO_FREE_GIFT_PROMO_ID = #{promoId}
           AND T1.PROMO_FREE_GIFT_STUS_ID = 1
    </select>
    
    <update id="updateSalesPromoM" parameterType="salesPromoMVO">
        UPDATE SAL0017D
           SET PROMO_DESC              = #{promoDesc}
             , PROMO_DT_FROM           = TO_DATE(#{promoDtFrom}, 'YYYY-MM-DD')
             , PROMO_DT_END            = TO_DATE(#{promoDtEnd}, 'YYYY-MM-DD')
             , PROMO_UPD_DT            = SYSDATE
             , PROMO_UPD_USER_ID       = #{promoUpdUserId}
             , PROMO_IS_TRIAL_CNVR     = #{promoIsTrialCnvr}
             , PROMO_PRC_PRCNT         = #{promoPrcPrcnt}
             , PROMO_CUST_TYPE         = #{promoCustType}
             , PROMO_DISC_TYPE         = #{promoDiscType}
             , PROMO_RPF_DISC_AMT      = #{promoRpfDiscAmt}
             , PROMO_DISC_PERIOD_TP    = #{promoDiscPeriodTp}
             , PROMO_DISC_PERIOD       = #{promoDiscPeriod}
             , PROMO_FREESVC_PERIOD_TP = #{promoFreesvcPeriodTp}
             , PROMO_ADD_DISC_PRC      = #{promoAddDiscPrc}
             , PROMO_ADD_DISC_PV       = #{promoAddDiscPv}
             , EMP_CHK                 = #{empChk}
             , EX_TRADE                = #{exTrade}
             , UPD_USER_ID             = #{updUserId}
             , UPD_DT                  = SYSDATE
         WHERE PROMO_ID                = #{promoId}
    </update>
    
    <update id="updateSalesPromoD" parameterType="salesPromoDVO">
        UPDATE SAL0018D
           SET PROMO_ITM_PV          = #{promoItmPv}
             , PROMO_ITM_STUS_ID     = #{promoItmStusId}
             , PROMO_ITM_UPD_USER_ID = #{promoItmUpdUserId}
             , PROMO_ITM_UPD_DT      = SYSDATE
         WHERE PROMO_ITM_ID          = #{promoItmId}
    </update>
    
    <update id="updateSalesPromoFreeGift" parameterType="salesPromoFreeGiftVO">
        UPDATE SAL0019D
           SET PROMO_FREE_GIFT_STUS_ID = #{promoFreeGiftStusId}
             , PROMO_FREE_GIFT_QTY     = #{promoFreeGiftQty}
         WHERE PROMO_FREE_GIFT_ID      = #{promoFreeGiftId}
    </update>

    <!--Product 정보 조회 -->
    <select id="selectProductCodeList" parameterType="Map" resultType="egovMap">
        SELECT itemid
             , itemcode
             , itemname
             , cateid
             , typeid
             , stateid
             , catename
             , statusname
          FROM
             (
            <if test='stkType != null and stkType == "1"'>
		       SELECT T1.STK_ID       itemid
		            , T1.STK_CODE     itemcode
		            , T1.STK_DESC     itemname
		            , T1.STK_CTGRY_ID cateid
		            , T1.STK_TYPE_ID  typeid
		            , T1.STUS_CODE_ID stateid
		            , (SELECT CODE_NAME
		                 FROM SYS0013M
		                WHERE CODE_ID = T1.STK_CTGRY_ID) catename
		            , (SELECT CODE_NAME
		                 FROM SYS0013M
		                WHERE CODE_ID = T1.STK_TYPE_ID)
		                 typename
		            , (SELECT SYS0038M.NAME
		                 FROM SYS0038M
		                WHERE SYS0038M.STUS_CODE_ID = T1.STUS_CODE_ID) statusname
                 FROM SYS0026M T1
                    , SAL0082D T2
                    , SYS0013M T3
                WHERE T1.STK_ID = T2.SRV_PAC_ITM_PRODUCT_ID
                  AND T1.STK_CTGRY_ID = T3.CODE_ID
                  AND 1 = T2.SRV_PAC_ITM_STUS_ID
                  AND T2.SRV_CNTRCT_PAC_ID = #{srvPacId}
            </if>
            <if test='stkType != null and stkType == "2"'>
               SELECT T1.STK_ID       itemid
                    , T1.STK_CODE     itemcode
                    , T1.STK_DESC     itemname
                    , T1.STK_CTGRY_ID cateid
                    , T1.STK_TYPE_ID  typeid
                    , T1.STUS_CODE_ID stateid
                    , (SELECT CODE_NAME
                         FROM SYS0013M
                        WHERE CODE_ID = T1.STK_CTGRY_ID) catename
                    , (SELECT CODE_NAME
                         FROM SYS0013M
                        WHERE CODE_ID = T1.STK_TYPE_ID)
                         typename
                    , (SELECT SYS0038M.NAME
                         FROM SYS0038M
                        WHERE SYS0038M.STUS_CODE_ID = T1.STUS_CODE_ID) statusname
                 FROM SYS0026M T1
                    , SAL0092M T2
                    , SYS0013M T3
                WHERE T1.STK_ID = T2.SRV_MEM_ITM_STK_ID
                  AND T1.STK_CTGRY_ID = T3.CODE_ID
                  AND 1 = T2.SRV_MEM_ITM_STUS_ID
                  AND T2.SRV_MEM_PAC_ID = #{srvPacId}
            </if>
             )
         WHERE 1 = 1
       <if test="scode != null and scode !=''">
           AND itemcode LIKE  #{scode}||'%'
       </if>
       <if test="sname != null and sname !=''">
           AND itemname LIKE '%'|| #{sname} ||'%'
       </if>                
       <if test="cateid != null and cateid !=''">
           AND cateid =  #{cateid}
       </if>
       <if test="typeid != null and typeid !=''">
           AND typeid =  #{typeid}
       </if>
         ORDER BY itemname ASC
    </select>

    <select id="selectProductCategoryList" resultType="egovMap">
		SELECT T2.CODE_ID
		     , T2.CODE
		     , T2.CODE_NAME
		  FROM
		     ( SELECT DISTINCT STK_CTGRY_ID
		         FROM SYS0026M
		        WHERE STK_TYPE_ID = '61'
		          AND STK_CTGRY_ID IS NOT NULL) T1
		     , SYS0013M T2
		 WHERE T1.STK_CTGRY_ID = T2.CODE_ID
		 ORDER BY T2.CODE_ID
    </select>
</mapper>